<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Novelist's Atelier — 1.2 Beta</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&family=JetBrains+Mono:wght@300;400&display=swap"
    rel="stylesheet">
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    :root {
      --ui-scale: 1;
      /* Theme: Default Dark */
      --bg: #090807;
      --bg2: #0b0908;
      --bg3: #0e0c09;
      --bg4: #111009;
      --bg5: #141209;
      --border: #181510;
      --border2: #1c1912;
      --border3: #1e1a12;
      --border4: #252015;
      --text: #e0d3bc;
      --text2: #c8a660;
      --text3: #a89868;
      --text4: #80786a;
      --text5: #50483a;
      --accent: #c8a660;
      --accent2: #7aac74;
      --accent3: #c06050;
    }

    /* Theme: Soft Beach */
    body.theme-soft-beach {
      --bg: #1a2328;
      --bg2: #1e2a30;
      --bg3: #223238;
      --bg4: #263040;
      --bg5: #2a3840;
      --border: #2f4048;
      --border2: #384854;
      --border3: #405060;
      --border4: #485868;
      --text: #d0e8f0;
      --text2: #51e2f5;
      --text3: #9df9ef;
      --text4: #7ac8d8;
      --text5: #5088a0;
      --accent: #51e2f5;
      --accent2: #9df9ef;
      --accent3: #edf756;
    }

    /* Theme: Pink Sand */
    body.theme-pink-sand {
      --bg: #2a1f24;
      --bg2: #302429;
      --bg3: #36292e;
      --bg4: #3c2e34;
      --bg5: #42343a;
      --border: #4a3a40;
      --border2: #504046;
      --border3: #56464c;
      --border4: #5c4c52;
      --text: #f0d8e0;
      --text2: #ffa8b6;
      --text3: #ffc8d0;
      --text4: #d8a0b0;
      --text5: #a87888;
      --accent: #ffa8b6;
      --accent2: #ffb6c8;
      --accent3: #a28089;
    }

    /* Theme: Dark Sand */
    body.theme-dark-sand {
      --bg: #1a1819;
      --bg2: #1e1c1d;
      --bg3: #222021;
      --bg4: #262425;
      --bg5: #2a2829;
      --border: #302c2d;
      --border2: #363233;
      --border3: #3c3839;
      --border4: #423e3f;
      --text: #d8d0c8;
      --text2: #a28089;
      --text3: #b8a098;
      --text4: #908078;
      --text5: #686058;
      --accent: #a28089;
      --accent2: #b8a098;
      --accent3: #c8a080;
    }

    /* Theme: Ice Cold */
    body.theme-ice-cold {
      --bg: #1a2028;
      --bg2: #1e2832;
      --bg3: #22303c;
      --bg4: #263844;
      --bg5: #2a4050;
      --border: #2f4858;
      --border2: #385068;
      --border3: #415878;
      --border4: #486088;
      --text: #d0e8f8;
      --text2: #a0d2eb;
      --text3: #b8e0f0;
      --text4: #90c0d8;
      --text5: #70a0c0;
      --accent: #a0d2eb;
      --accent2: #b8e0f0;
      --accent3: #e5eaf5;
    }

    /* Theme: Freeze Purple */
    body.theme-freeze-purple {
      --bg: #1a1a24;
      --bg2: #202028;
      --bg3: #26262c;
      --bg4: #2c2c34;
      --bg5: #32323c;
      --border: #3a3a44;
      --border2: #42424c;
      --border3: #4a4a54;
      --border4: #52525c;
      --text: #e0e0f0;
      --text2: #e5eaf5;
      --text3: #f0f0ff;
      --text4: #c0c0d8;
      --text5: #a0a0b8;
      --accent: #e5eaf5;
      --accent2: #d0bdf4;
      --accent3: #c0b0e8;
    }

    /* Theme: Medium Purple */
    body.theme-medium-purple {
      --bg: #1a1824;
      --bg2: #201c2c;
      --bg3: #262034;
      --bg4: #2c243c;
      --bg5: #322844;
      --border: #3a2c4c;
      --border2: #443458;
      --border3: #4e3c64;
      --border4: #584470;
      --text: #e0d8f0;
      --text2: #d0bdf4;
      --text3: #e0c8ff;
      --text4: #b8a8d8;
      --text5: #9888b8;
      --accent: #d0bdf4;
      --accent2: #e0c8ff;
      --accent3: #8458b3;
    }

    /* Theme: Purple Pain */
    body.theme-purple-pain {
      --bg: #181420;
      --bg2: #1c1828;
      --bg3: #201c30;
      --bg4: #242038;
      --bg5: #282440;
      --border: #2c2848;
      --border2: #342c50;
      --border3: #3c3058;
      --border4: #443460;
      --text: #d8d0e8;
      --text2: #8458b3;
      --text3: #a068c8;
      --text4: #9048a0;
      --text5: #683878;
      --accent: #8458b3;
      --accent2: #a068c8;
      --accent3: #c060a0;
    }

    /* Theme: Heavy Purple */
    body.theme-heavy-purple {
      --bg: #201820;
      --bg2: #281c28;
      --bg3: #302030;
      --bg4: #382438;
      --bg5: #402840;
      --border: #483048;
      --border2: #503858;
      --border3: #584068;
      --border4: #604878;
      --text: #e8d8e0;
      --text2: #a28089;
      --text3: #b898a0;
      --text4: #887878;
      --text5: #685858;
      --accent: #a28089;
      --accent2: #b898a0;
      --accent3: #ff1d58;
    }

    /* Theme: Yass Queen */
    body.theme-yass-queen {
      --bg: #1a0a14;
      --bg2: #200c1a;
      --bg3: #280e20;
      --bg4: #301026;
      --bg5: #38122c;
      --border: #401432;
      --border2: #481838;
      --border3: #501c3e;
      --border4: #582044;
      --text: #f8d0e0;
      --text2: #ff1d58;
      --text3: #ff4080;
      --text4: #d81848;
      --text5: #a01038;
      --accent: #ff1d58;
      --accent2: #ff4080;
      --accent3: #fff685;
    }

    /* Theme: Sister Sister */
    body.theme-sister-sister {
      --bg: #1a1420;
      --bg2: #201828;
      --bg3: #281c30;
      --bg4: #302038;
      --bg5: #382440;
      --border: #402848;
      --border2: #482c50;
      --border3: #503058;
      --border4: #583460;
      --text: #f0d8f0;
      --text2: #f75990;
      --text3: #ff78a8;
      --text4: #d84878;
      --text5: #a83860;
      --accent: #f75990;
      --accent2: #ff78a8;
      --accent3: #fff685;
    }

    /* Theme: Crown Yellow */
    body.theme-crown-yellow {
      --bg: #1a1a10;
      --bg2: #202018;
      --bg3: #282820;
      --bg4: #303028;
      --bg5: #383830;
      --border: #404038;
      --border2: #484840;
      --border3: #505048;
      --border4: #585850;
      --text: #e8e8d0;
      --text2: #fff685;
      --text3: #ffffa0;
      --text4: #d8d870;
      --text5: #b0b058;
      --accent: #fff685;
      --accent2: #ffffa0;
      --accent3: #00ddff;
    }

    /* Theme: Blue Light */
    body.theme-blue-light {
      --bg: #081820;
      --bg2: #0a2028;
      --bg3: #0c2830;
      --bg4: #0e3038;
      --bg5: #103840;
      --border: #124048;
      --border2: #144850;
      --border3: #165058;
      --border4: #185860;
      --text: #d0f0f8;
      --text2: #00ddff;
      --text3: #40e0ff;
      --text4: #00b8d8;
      --text5: #0090b0;
      --accent: #00ddff;
      --accent2: #40e0ff;
      --accent3: #0049b7;
    }

    /* Theme: Brutal Blue */
    body.theme-brutal-blue {
      --bg: #080c18;
      --bg2: #0a1020;
      --bg3: #0c1428;
      --bg4: #0e1830;
      --bg5: #101c38;
      --border: #122040;
      --border2: #142448;
      --border3: #162850;
      --border4: #182c58;
      --text: #d0d8f0;
      --text2: #0049b7;
      --text3: #2060d8;
      --text4: #003898;
      --text5: #002870;
      --accent: #0049b7;
      --accent2: #2060d8;
      --accent3: #51e2f5;
    }

    html,
    body {
      height: 100%;
      overflow: auto
    }

    body {
      background: var(--bg);
      font-family: 'Crimson Pro', Georgia, serif;
      color: var(--text)
    }

    /* Main content scaled */
    #app-main {
      zoom: var(--ui-scale, 1);
    }

    /* Mobile Layout */
    @media (max-width: 768px) {
      body.mobile-enabled {
        overflow-x: auto;
      }

      body.mobile-enabled #app {
        min-width: 120vw;
        flex-direction: row;
      }

      body.mobile-enabled .ctx-scroll {
        min-width: 100vw;
      }

      body.mobile-enabled .p-sidebar {
        width: 120px;
        flex-shrink: 0;
      }

      body.mobile-enabled .p-list {
        width: 160px;
        flex-shrink: 0;
      }

      body.mobile-enabled .panel {
        min-width: 100vw;
      }

      body.mobile-enabled #panel-prompts {
        flex-direction: row !important;
        min-width: calc(120px + 160px + 300px);
      }
    }

    .mobile-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-left: 10px;
    }

    .mobile-toggle label {
      font-size: 8px;
      color: #50483a;
    }

    ::-webkit-scrollbar {
      width: 4px;
      height: 4px
    }

    ::-webkit-scrollbar-track {
      background: transparent
    }

    ::-webkit-scrollbar-thumb {
      background: #2a2118;
      border-radius: 2px
    }

    /* ─── LAYOUT ─────────────────────────────────────── */
    #app {
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: auto;
      background: var(--bg)
    }

    #app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      height: 50px;
      border-bottom: 1px solid var(--border);
      background: #0b0a08;
      flex-shrink: 0;
      font-size: 17px;
      position: relative;
    }

    .brand {
      display: flex;
      align-items: baseline;
      gap: 10px
    }

    .brand-logo {
      height: 24px;
      vertical-align: middle;
      border-radius: 3px
    }

    .brand-title {
      font-family: 'Playfair Display', serif;
      font-size: 17px;
      font-weight: 700;
      color: #e0d3bc;
      letter-spacing: .02em
    }

    .brand-ver {
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      color: #3a3020;
      letter-spacing: .1em
    }

    .save-indicator {
      display: inline-block;
      margin-left: 12px;
      font-size: 11px;
      color: #4a8
    }

    .save-indicator.saving {
      color: #d80
    }

    .save-indicator.error {
      color: #d44
    }

    .save-time {
      font-size: 10px;
      color: #605840;
      margin-left: 8px
    }

    .backup-list {
      max-height: 150px;
      overflow-y: auto
    }

    .backup-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 4px 0;
      border-bottom: 1px solid #252015;
      font-size: 11px
    }

    .backup-time {
      color: #c8a660;
      flex: 1
    }

    .backup-restore {
      background: transparent;
      border: 1px solid #3a3020;
      color: #a09080;
      padding: 2px 6px;
      font-size: 10px;
      cursor: pointer;
      border-radius: 2px
    }

    .backup-restore:hover {
      background: #252015;
      color: #c8a660
    }

    .scene-navigator {
      position: fixed;
      top: 0;
      right: -320px;
      width: 300px;
      height: 100vh;
      background: #0f0c09;
      border: 1px solid #252015;
      z-index: 1500;
      transition: right .3s ease;
      overflow-y: auto
    }

    .scene-navigator.open {
      right: 0
    }

    .scene-nav-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: #141209;
      border-bottom: 1px solid #252015;
      position: sticky;
      top: 0
    }

    .scene-nav-header h3 {
      margin: 0;
      font-size: 13px;
      color: #c8a660
    }

    .scene-nav-close {
      background: none;
      border: none;
      color: #605840;
      font-size: 18px;
      cursor: pointer
    }

    .scene-nav-close:hover {
      color: #c8a660
    }

    .scene-nav-toggle {
      background: transparent;
      border: none;
      color: #605840;
      font-size: 10px;
      cursor: pointer;
      margin-left: 12px;
      padding: 4px 8px
    }

    .scene-nav-toggle:hover {
      color: #c8a660
    }

    .search-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 2000;
      align-items: center;
      justify-content: center
    }

    .search-modal-overlay.open {
      display: flex
    }

    .search-modal {
      background: #1a1512;
      border: 1px solid #3a3020;
      width: 90%;
      max-width: 600px;
      border-radius: 4px;
      max-height: 80vh;
      display: flex;
      flex-direction: column
    }

    .search-modal-hd {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      background: #141209;
      border-bottom: 1px solid #252015;
      gap: 10px
    }

    .search-modal-hd h3 {
      margin: 0;
      font-size: 14px;
      color: #c8a660;
      flex: 1
    }

    .search-input {
      flex: 1;
      padding: 8px;
      background: #0f0c09;
      border: 1px solid #3a3020;
      color: #c8a660;
      font-size: 14px
    }

    .search-input:focus {
      outline: none;
      border-color: #c8a660
    }

    .search-options {
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 8px 16px;
      background: #141209;
      border-bottom: 1px solid #252015
    }

    .search-options label {
      font-size: 11px;
      color: #605840;
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer
    }

    .search-options input[type="checkbox"] {
      accent-color: #c8a660
    }

    .search-results {
      max-height: 400px;
      overflow-y: auto;
      padding: 8px
    }

    .search-result-item {
      padding: 8px 12px;
      margin-bottom: 4px;
      background: #141209;
      border: 1px solid #252015;
      border-radius: 3px;
      cursor: pointer
    }

    .search-result-item:hover {
      border-color: #c8a660
    }

    .search-result-type {
      font-size: 10px;
      color: #c8a660;
      text-transform: uppercase;
      margin-bottom: 2px
    }

    .search-result-title {
      font-size: 12px;
      color: #c8a660;
      margin-bottom: 2px
    }

    .search-result-snippet {
      font-size: 11px;
      color: #a09080;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis
    }

    .search-result-snippet mark {
      background: #c8a66033;
      color: #c8a660;
      padding: 0 2px
    }

    .search-results-count {
      font-size: 11px;
      color: #605840;
      padding: 8px 16px;
      border-top: 1px solid #252015
    }

    .search-modal-ft {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      padding: 12px 16px;
      background: #141209;
      border-top: 1px solid #252015
    }

    .search-btn {
      padding: 8px 16px;
      border-radius: 2px;
      font-size: 12px;
      cursor: pointer;
      background: transparent;
      border: 1px solid #3a3020;
      color: #a09080
    }

    .search-btn:hover {
      background: #252015;
      color: #c8a660
    }

    .search-btn-primary {
      background: #c8a660;
      border: none;
      color: #090807
    }

    .search-btn-primary:hover {
      background: #e0c080
    }

    .search-tab-btn {
      padding: 6px 12px;
      background: transparent;
      border: 1px solid #3a3020;
      color: #a09080;
      font-size: 11px;
      cursor: pointer;
      border-radius: 2px
    }

    .search-tab-btn:hover {
      background: #252015;
      color: #c8a660
    }

    .search-tab-btn.active {
      background: #c8a660;
      border-color: #c8a660;
      color: #090807
    }

    .scene-nav-content {
      padding: 12px
    }

    .scene-nav-item {
      padding: 8px;
      margin-bottom: 6px;
      background: #141209;
      border: 1px solid #252015;
      border-radius: 3px;
      cursor: pointer
    }

    .scene-nav-item:hover {
      border-color: #c8a660
    }

    .scene-nav-item-title {
      font-size: 12px;
      color: #c8a660;
      margin-bottom: 4px
    }

    .scene-nav-item-meta {
      font-size: 10px;
      color: #605840
    }

    .project-selector {
      position: relative;
      margin-left: auto
    }

    .project-current {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: #1a1512;
      border: 1px solid #3a3020;
      border-radius: 2px;
      color: #c8a660;
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      cursor: pointer;
      letter-spacing: .03em
    }

    .project-current:hover {
      background: #252015;
      border-color: #c8a660
    }

    .project-caret {
      font-size: 8px;
      color: #605840
    }

    .project-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      min-width: 180px;
      background: #1a1512;
      border: 1px solid #3a3020;
      border-radius: 2px;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5)
    }

    .project-dropdown.open {
      display: block
    }

    .project-list {
      max-height: 200px;
      overflow-y: auto;
      border-bottom: 1px solid #252015
    }

    .project-item {
      padding: 8px 12px;
      font-size: 11px;
      color: #a09080;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center
    }

    .project-item:hover {
      background: #252015;
      color: #e0d3bc
    }

    .project-item.active {
      background: #252015;
      color: #c8a660
    }

    .project-actions {
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px
    }

    .project-action {
      padding: 6px 10px;
      background: transparent;
      border: 1px solid #3a3020;
      color: #807060;
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      cursor: pointer;
      border-radius: 2px;
      text-align: left
    }

    .project-action:hover {
      background: #252015;
      color: #c8a660;
      border-color: #c8a660
    }

    .stats-badge {
      margin-left: 12px;
      padding: 4px 10px;
      background: #1a1512;
      border: 1px solid #3a3020;
      border-radius: 2px;
      color: #605840;
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      cursor: default;
      letter-spacing: .03em
    }

    .stats-badge:hover {
      border-color: #504830;
      color: #a09080
    }

    .tab-nav {
      display: flex;
      gap: 2px
    }

    .tab-btn {
      padding: 5px 14px;
      background: transparent;
      border: 1px solid transparent;
      color: #50483a;
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      letter-spacing: .08em;
      text-transform: uppercase;
      cursor: pointer;
      border-radius: 2px;
      transition: all .12s;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .tab-btn:hover {
      color: #a09070;
      border-color: #2a2118
    }

    .tab-btn.active {
      color: #c8a660;
      border-color: #3a3020;
      background: #141109
    }

    .tab-dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: #c8a660;
      opacity: .7
    }

    #app-main {
      flex: 1;
      overflow: hidden;
      position: relative;
      background: var(--bg2)
    }

    .panel {
      position: absolute;
      inset: 0;
      overflow: hidden;
      display: none;
      background: var(--bg)
    }

    .panel.active {
      display: flex;
      flex-direction: column
    }

    #panel-settings {
      overflow-y: auto
    }

    /* ─── CONTEXT TABS (series/book/chapter) ─────────── */
    .ctx-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 20px 24px
    }

    .ctx-head {
      margin-bottom: 20px;
      padding-bottom: 14px;
      border-bottom: 1px solid #181510
    }

    .ctx-head h2 {
      font-family: 'Playfair Display', serif;
      font-size: 22px;
      font-style: italic;
      color: #e0d3bc;
      margin-bottom: 3px
    }

    .ctx-head p {
      font-size: 13px;
      color: #50483a;
      font-style: italic
    }

    .home-section {
      margin-bottom: 28px
    }

    .home-section h3 {
      font-family: 'Playfair Display', serif;
      font-size: 16px;
      color: #c8a660;
      margin-bottom: 12px;
      border-bottom: 1px solid #252015;
      padding-bottom: 6px
    }

    .home-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px
    }

    .home-card {
      background: #0f0d0a;
      border: 1px solid #1e1a12;
      border-radius: 4px;
      padding: 14px;
      transition: border-color .15s, background .15s
    }

    .home-card:hover {
      background: #12100a;
      border-color: #3a3020
    }

    .home-card h4 {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: #e0d3bc;
      margin: 8px 0 6px;
      text-transform: uppercase;
      letter-spacing: .05em
    }

    .home-card p {
      font-size: 12px;
      color: #706858;
      line-height: 1.5;
      margin: 0
    }

    .home-icon {
      font-size: 20px;
      color: #c8a660
    }

    .home-modes {
      font-size: 12px;
      color: #a89868;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px
    }

    .mode-badge {
      padding: 2px 8px;
      border-radius: 3px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      text-transform: uppercase;
      margin-right: 4px
    }

    .mode-badge.full {
      background: #121a10;
      color: #80b07a;
      border: 1px solid #263422
    }

    .mode-badge.brief {
      background: #101520;
      color: #7a9ec0;
      border: 1px solid #222636
    }

    .mode-badge.extended {
      background: #201510;
      color: #c8a060;
      border: 1px solid #3d2a1a
    }

    .mode-badge.custom {
      background: #1a1520;
      color: #a080c0;
      border: 1px solid #352a3d
    }

    .mode-badge.off {
      background: #150f0f;
      color: #705858;
      border: 1px solid #2a1f1f
    }

    /* Ko-fi widget positioning */
    @keyframes kofifix {
      from {
        left: auto;
        right: 20px
      }

      to {
        left: auto;
        right: 20px
      }
    }

    .ko-fi-widget-container,
    .kf-bottom-left,
    .floating-chat,
    .kofiwidgetOverlay {
      right: 20px !important;
      left: auto !important;
      animation: kofifix 1s
    }

    .kofi-btn {
      display: inline-block;
      padding: 10px 20px;
      background: #c8a660;
      color: #1a1510;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      text-decoration: none;
      border-radius: 4px;
      transition: background .2s
    }

    .kofi-btn:hover {
      background: #d4b574
    }

    /* meta row */
    .meta-row {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
      flex-wrap: wrap
    }

    .meta-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
      min-width: 140px
    }

    .meta-field.narrow {
      max-width: 80px;
      flex: 0 0 auto
    }

    .mlabel {
      font-family: 'JetBrains Mono', monospace;
      font-size: 8px;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: #40382a
    }

    .help-icon {
      display: inline-block;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #1a1510;
      border: 1px solid #40382a;
      color: #6a5a4a;
      font-size: 9px;
      font-family: 'JetBrains Mono', monospace;
      text-align: center;
      line-height: 12px;
      cursor: help;
      margin-left: 4px;
      vertical-align: middle
    }

    .help-icon:hover {
      background: #252015;
      color: #c8a660
    }

    .tooltip {
      position: fixed;
      background: #1a1510;
      border: 1px solid #c8a660;
      color: #e0d3bc;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 11px;
      max-width: 250px;
      z-index: 10000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      font-family: 'Crimson Pro', serif;
      line-height: 1.4
    }

    .tooltip-close {
      position: absolute;
      top: 4px;
      right: 6px;
      background: none;
      border: none;
      color: #6a5a4a;
      cursor: pointer;
      font-size: 12px
    }

    input.minput,
    select.minput {
      background: #0d0b08;
      border: 1px solid #1e1a12;
      border-radius: 2px;
      color: #b8a878;
      font-family: 'Crimson Pro', serif;
      font-size: 14px;
      padding: 5px 9px;
      outline: none;
      transition: border-color .12s;
      width: 100%;
    }

    input.minput:focus,
    select.minput:focus {
      border-color: #4a4028;
      background: #0f0d0a
    }

    input.minput::placeholder {
      color: #252015
    }

    select.minput option {
      background: #0d0b08;
      color: #b8a878
    }

    /* section block */
    .sb {
      margin-bottom: 14px;
      border: 1px solid var(--border);
      border-radius: 3px;
      overflow: hidden;
      transition: border-color .15s
    }

    .sb:focus-within {
      border-color: #252015
    }

    .sb-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 7px 11px;
      background: #0e0b09;
      border-bottom: 1px solid #181510;
      flex-wrap: wrap;
      gap: 7px;
    }

    .sb-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0
    }

    .sb-title {
      font-family: 'Crimson Pro', serif;
      font-size: 13px;
      font-weight: 600;
      color: #b8a878
    }

    .sb-desc {
      font-size: 11px;
      color: #40382a;
      font-style: italic
    }

    .sb-ctrls {
      display: flex;
      align-items: center;
      gap: 5px;
      flex-shrink: 0
    }

    /* inclusion toggle */
    .itog {
      display: flex;
      border: 1px solid #1e1a12;
      border-radius: 2px;
      overflow: hidden
    }

    .ibtn {
      padding: 2px 7px;
      background: transparent;
      border: none;
      border-right: 1px solid #1e1a12;
      color: #3a3020;
      font-family: 'JetBrains Mono', monospace;
      font-size: 8px;
      letter-spacing: .05em;
      cursor: pointer;
      transition: all .12s;
    }

    .ibtn:last-child {
      border-right: none
    }

    .ibtn:hover {
      color: #7a6848;
      background: #141109
    }

    .ibtn.i-full.on {
      background: #121a10;
      color: #80b07a
    }

    .ibtn.i-brief.on {
      background: #101520;
      color: #7a9ec0
    }

    .ibtn.i-extended.on {
      background: #201510;
      color: #c8a060
    }

    .ibtn.i-custom.on {
      background: #102030;
      color: #60a0c8
    }

    .ibtn.i-off.on {
      background: #1a1010;
      color: #b06060
    }

    .smbtn {
      padding: 2px 8px;
      background: #111009;
      border: 1px solid #252015;
      border-radius: 2px;
      color: #60584a;
      font-family: 'JetBrains Mono', monospace;
      font-size: 8px;
      letter-spacing: .05em;
      cursor: pointer;
      transition: all .12s;
      white-space: nowrap;
    }

    .smbtn:hover {
      color: #c8a660;
      border-color: #4a3a18
    }

    .smbtn:disabled {
      opacity: .3;
      cursor: not-allowed
    }

    .sb-ta {
      width: 100%;
      background: #0b0908;
      border: none;
      color: #a89868;
      font-family: 'Crimson Pro', serif;
      font-size: 14px;
      line-height: 1.7;
      padding: 9px 11px;
      resize: vertical;
      outline: none;
      min-height: 90px;
    }

    .sb-ta::placeholder {
      color: #201c10
    }

    .sb-ta:focus {
      background: #0d0b08
    }

    /* list management */
    .list-hd {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px
    }

    .list-lbl {
      font-family: 'JetBrains Mono', monospace;
      font-size: 8px;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: #3a3020
    }

    .add-btn {
      padding: 2px 9px;
      background: transparent;
      border: 1px dashed #252015;
      border-radius: 2px;
      color: #4a4030;
      font-family: 'JetBrains Mono', monospace;
      font-size: 8px;
      cursor: pointer;
      transition: all .12s;
      letter-spacing: .06em;
    }

    .add-btn:hover {
      border-color: #c8a660;
      color: #c8a660
    }

    .list-item {
      position: relative;
      margin-bottom: 8px
    }

    .rm-btn {
      position: absolute;
      top: 7px;
      right: 7px;
      width: 17px;
      height: 17px;
      background: #180f0f;
      border: 1px solid #2a1818;
      border-radius: 2px;
      color: #604040;
      font-size: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1;
      transition: all .12s;
    }

    .rm-btn:hover {
      background: #241414;
      color: #d06060
    }

    /* chapter mode toggle */
    .mtog {
      display: flex;
      border: 1px solid #1e1a12;
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 14px
    }

    .mbtn {
      flex: 1;
      padding: 6px 12px;
      background: transparent;
      border: none;
      border-right: 1px solid #1e1a12;
      color: #3a3020;
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      letter-spacing: .08em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all .12s;
    }

    .mbtn:last-child {
      border-right: none
    }

    .mbtn.mon {
      background: #141109;
      color: #c8a660
    }

    /* export bar */
    .export-bar {
      margin-top: 8px;
      padding: 9px 13px;
      background: #0b0908;
      border: 1px solid #181510;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .export-lbl {
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      color: #4a4030;
      letter-spacing: .06em
    }

    .export-btn {
      padding: 4px 13px;
      background: #181610;
      border: 1px solid #3a3018;
      border-radius: 2px;
      color: #c8a660;
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      cursor: pointer;
      transition: all .12s;
      letter-spacing: .05em;
    }

    .export-btn:hover {
      background: #201e12;
      border-color: #c8a660
    }

    .divider {
      border: none;
      border-top: 1px solid #181510;
      margin: 16px 0
    }

    /* ─── PROMPTS PANEL ───────────────────────────────── */
    #panel-prompts {
      flex-direction: row !important
    }

    .p-sidebar {
      width: 180px;
      flex-shrink: 0;
      border-right: 1px solid var(--border);
      overflow-y: auto;
      padding: 10px 0;
      background: var(--bg2)
    }

    .p-sidebar-lbl {
      font-family: 'JetBrains Mono', monospace;
      font-size: 7px;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: #302818;
      padding: 4px 13px 7px
    }

    .p-sidebar-sec {
      font-family: 'JetBrains Mono', monospace;
      font-size: 6px;
      letter-spacing: .16em;
      text-transform: uppercase;
      color: #4a3a20;
      padding: 12px 13px 4px;
      border-top: 1px solid #181510;
      margin-top: 4px
    }

    .pcatbtn {
      width: 100%;
      padding: 6px 13px;
      background: transparent;
      border: none;
      border-left: 2px solid transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 7px;
      font-family: 'Crimson Pro', serif;
      font-size: 13px;
      color: #60584a;
      text-align: left;
      transition: all .12s;
    }

    .pcatbtn:hover {
      color: #a89868;
      background: #0f0d09
    }

    .pcatbtn.pca {
      color: #e0d3bc;
      background: #0f0d09;
      border-left-color: var(--cc)
    }

    .pci {
      font-size: 12px;
      color: var(--cc);
      opacity: .7;
      flex-shrink: 0
    }

    .pcatbtn.pca .pci {
      opacity: 1
    }

    .p-list {
      width: 230px;
      flex-shrink: 0;
      border-right: 1px solid var(--border);
      overflow-y: auto;
      padding: 10px 0;
      background: var(--bg2)
    }

    .p-list-hd {
      padding: 4px 11px 11px;
      border-bottom: 1px solid #181510;
      margin-bottom: 5px
    }

    .p-list-bar {
      height: 1px;
      background: var(--cc);
      opacity: .45;
      margin-bottom: 7px
    }

    .p-list-name {
      font-family: 'Playfair Display', serif;
      font-size: 14px;
      color: #e0d3bc;
      display: flex;
      align-items: center;
      gap: 6px
    }

    .p-list-cnt {
      font-family: 'JetBrains Mono', monospace;
      font-size: 8px;
      color: #302818;
      margin-top: 2px;
      letter-spacing: .06em
    }

    .pcrd {
      margin: 3px 7px;
      padding: 7px 9px;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 3px;
      cursor: pointer;
      text-align: left;
      transition: all .12s;
      width: calc(100% - 14px);
    }

    .pcrd:hover {
      background: #0f0d09;
      border-color: #1e1910
    }

    .pcrd.pcra {
      background: #120f08;
      border-color: var(--cc)
    }

    .pcrd-t {
      font-family: 'Crimson Pro', serif;
      font-size: 13px;
      font-weight: 600;
      color: #a89868;
      margin-bottom: 2px
    }

    .pcra .pcrd-t {
      color: #e0d3bc
    }

    .pcrd-d {
      font-size: 11px;
      color: #40382a;
      font-style: italic;
      line-height: 1.4
    }

    /* prompt editor */
    .p-editor {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden
    }

    .p-empty {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: #281e14
    }

    .p-empty h3 {
      font-family: 'Playfair Display', serif;
      font-size: 17px;
      font-style: italic
    }

    .p-empty p {
      font-size: 12px;
      color: #201810
    }

    .p-ehd {
      padding: 13px 18px 11px;
      border-bottom: 1px solid #181510;
      flex-shrink: 0
    }

    .p-etit {
      font-family: 'Playfair Display', serif;
      font-size: 17px;
      color: #e0d3bc;
      margin-bottom: 3px
    }

    .p-edesc {
      font-size: 12px;
      color: #50483a;
      font-style: italic
    }

    .p-ebody {
      flex: 1;
      overflow-y: auto;
      padding: 14px 18px;
      display: flex;
      flex-direction: column;
      gap: 11px;
      min-height: 0
    }

    .pfl {
      display: flex;
      flex-direction: column;
      gap: 4px
    }

    .pfl label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 8px;
      letter-spacing: .1em;
      text-transform: uppercase;
      color: #50483a
    }

    .pfl input,
    .pfl textarea {
      background: #0a0907;
      border: 1px solid #1a1810;
      border-radius: 2px;
      color: #a89868;
      font-family: 'Crimson Pro', serif;
      font-size: 14px;
      padding: 6px 9px;
      outline: none;
      transition: border-color .12s;
      resize: vertical;
      width: 100%;
    }

    .pfl input:focus,
    .pfl textarea:focus {
      border-color: #3a3018;
      background: #0c0a08
    }

    .pfl input::placeholder,
    .pfl textarea::placeholder {
      color: #201c10
    }

    .pfl textarea {
      min-height: 85px;
      line-height: 1.65
    }

    /* context bar */
    .ctx-bar {
      flex-shrink: 0;
      padding: 5px 18px;
      background: #0c0a08;
      border-top: 1px solid #181510;
      display: flex;
      align-items: center;
      gap: 7px;
      flex-wrap: wrap;
    }

    .ctx-bar-lbl {
      font-family: 'JetBrains Mono', monospace;
      font-size: 8px;
      color: #3a3020;
      letter-spacing: .08em;
      text-transform: uppercase;
      flex-shrink: 0
    }

    .ctx-pills {
      display: flex;
      gap: 3px;
      flex-wrap: wrap;
      align-items: center
    }

    .cpill {
      padding: 1px 6px;
      border-radius: 9px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 7px;
      letter-spacing: .06em;
      border: 1px solid;
    }

    .cpill.cfull {
      border-color: #263422;
      color: #7aac74;
      background: #0f180d
    }

    .ctx-none {
      font-family: 'JetBrains Mono', monospace;
      font-size: 8px;
      color: #281e14;
      font-style: italic
    }

    /* output area */
    .out-area {
      flex-shrink: 0;
      border-top: 1px solid #181510;
      background: #070605;
      display: flex;
      flex-direction: column;
      max-height: 45vh;
      min-height: 120px;
    }

    .out-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 18px;
      border-bottom: 1px solid #141209;
      flex-shrink: 0;
      gap: 8px;
      flex-wrap: wrap;
    }

    .out-status {
      font-family: 'JetBrains Mono', monospace;
      font-size: 8px;
      color: #3a3020;
      letter-spacing: .08em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .spin {
      display: inline-block;
      width: 8px;
      height: 8px;
      border: 1px solid #3a3020;
      border-top-color: #c8a660;
      border-radius: 50%;
      animation: spin .6s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg)
      }
    }

    .out-btns {
      display: flex;
      gap: 5px
    }

    .run-btn {
      padding: 4px 14px;
      background: #c8a660;
      color: #090807;
      border: none;
      border-radius: 2px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      font-weight: 500;
      cursor: pointer;
      letter-spacing: .05em;
      transition: all .12s;
    }

    .run-btn:hover {
      background: #dbb870
    }

    .run-btn:disabled {
      background: #2a2418;
      color: #504830;
      cursor: not-allowed
    }

    .run-btn.running {
      background: #8a6a30;
      color: #e0d3bc
    }

    .stop-btn {
      padding: 4px 10px;
      background: #2a1010;
      border: 1px solid #4a2020;
      border-radius: 2px;
      color: #c06050;
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      cursor: pointer;
      transition: all .12s;
      letter-spacing: .05em;
    }

    .stop-btn:hover {
      background: #381818;
      border-color: #c06050
    }

    .sec-btn {
      padding: 4px 10px;
      background: #141209;
      border: 1px solid #252015;
      border-radius: 2px;
      color: #60584a;
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      cursor: pointer;
      transition: all .12s;
      letter-spacing: .05em;
    }

    .sec-btn:hover {
      color: #c8a660;
      border-color: #4a3a18
    }

    .sec-btn.ok {
      border-color: #263422;
      color: #7aac74;
      background: #0f180d
    }

    .out-text {
      flex: 1;
      overflow-y: auto;
      padding: 10px 18px;
      font-family: 'Crimson Pro', serif;
      font-size: 14px;
      color: #80786a;
      line-height: 1.75;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .out-placeholder {
      font-style: italic;
      color: #281e14;
      font-size: 13px
    }

    .cursor-blink {
      display: inline-block;
      width: 2px;
      height: 1em;
      background: #c8a660;
      animation: blink .8s ease-in-out infinite;
      vertical-align: text-bottom;
      margin-left: 1px
    }

    @keyframes blink {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: 0
      }
    }

    /* ─── PIPELINE PANEL ──────────────────────────────── */
    #panel-pipeline {
      flex-direction: column !important
    }

    .pipe-layout {
      flex: 1;
      display: flex;
      overflow: hidden;
      gap: 0
    }

    .pipe-builder {
      width: 420px;
      flex-shrink: 0;
      border-right: 1px solid var(--border);
      overflow-y: auto;
      padding: 16px;
      background: var(--bg2)
    }

    .pipe-results {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 0;
      background: var(--bg)
    }

    .pipe-hd {
      margin-bottom: 14px
    }

    .pipe-hd h2 {
      font-family: 'Playfair Display', serif;
      font-size: 18px;
      font-style: italic;
      color: #e0d3bc;
      margin-bottom: 3px
    }

    .pipe-hd p {
      font-size: 12px;
      color: #50483a;
      font-style: italic
    }

    /* pipeline mode toggle */
    .pipe-mode {
      display: flex;
      border: 1px solid #1e1a12;
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 14px
    }

    .pm-btn {
      flex: 1;
      padding: 6px;
      background: transparent;
      border: none;
      border-right: 1px solid #1e1a12;
      color: #3a3020;
      font-family: 'JetBrains Mono', monospace;
      font-size: 8px;
      letter-spacing: .07em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all .12s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    .pm-btn:last-child {
      border-right: none
    }

    .pm-btn.pmon {
      background: #141109;
      color: #c8a660
    }

    .pm-btn span:last-child {
      font-size: 7px;
      opacity: .6;
      font-style: italic;
      letter-spacing: .04em
    }

    /* pipeline step */
    .pipe-step {
      margin-bottom: 10px;
      border: 1px solid #1e1a12;
      border-radius: 3px;
      overflow: hidden;
      background: #0b0908;
    }

    .pipe-step-hd {
      display: flex;
      align-items: center;
      padding: 7px 10px;
      background: #0f0d09;
      border-bottom: 1px solid #1a1710;
      gap: 8px;
    }

    .step-num {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 1px solid #3a3020;
      background: #181410;
      color: #c8a660;
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .step-selects {
      display: flex;
      gap: 6px;
      flex: 1;
      min-width: 0
    }

    .step-sel {
      background: #0a0907;
      border: 1px solid #1a1810;
      border-radius: 2px;
      color: #a89868;
      font-family: 'Crimson Pro', serif;
      font-size: 12px;
      padding: 3px 6px;
      outline: none;
      flex: 1;
      min-width: 0;
      transition: border-color .12s;
    }

    .step-sel:focus {
      border-color: #3a3018
    }

    .step-sel option {
      background: #0a0907;
      color: #a89868
    }

    .step-rm {
      width: 20px;
      height: 20px;
      background: #180f0f;
      border: 1px solid #2a1818;
      border-radius: 2px;
      color: #604040;
      font-size: 11px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all .12s;
    }

    .step-rm:hover {
      background: #241414;
      color: #d06060
    }

    .step-body {
      padding: 9px 10px;
      display: flex;
      flex-direction: column;
      gap: 7px
    }

    .pipe-tog {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 5px 8px;
      background: #111009;
      border: 1px solid #1a1710;
      border-radius: 2px;
    }

    .pipe-tog label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 8px;
      color: #60584a;
      letter-spacing: .06em;
      cursor: pointer;
      flex: 1
    }

    .pipe-tog input[type=checkbox] {
      accent-color: #c8a660;
      cursor: pointer
    }

    .step-field {
      display: flex;
      flex-direction: column;
      gap: 3px
    }

    .step-field label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 8px;
      color: #40382a;
      letter-spacing: .08em;
      text-transform: uppercase
    }

    .step-field input,
    .step-field textarea {
      background: #090806;
      border: 1px solid #181510;
      border-radius: 2px;
      color: #a89868;
      font-family: 'Crimson Pro', serif;
      font-size: 13px;
      padding: 5px 8px;
      outline: none;
      resize: vertical;
      width: 100%;
      transition: border-color .12s;
    }

    .step-field input:focus,
    .step-field textarea:focus {
      border-color: #3a3018
    }

    .step-field input::placeholder,
    .step-field textarea::placeholder {
      color: #1c1810
    }

    .step-field textarea {
      min-height: 70px;
      line-height: 1.6
    }

    .step-piped {
      padding: 5px 8px;
      background: #0e1208;
      border: 1px solid #1e2618;
      border-radius: 2px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 8px;
      color: #7aac74;
      letter-spacing: .05em;
      font-style: italic;
    }

    .connector {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 3px 0;
      color: #3a3020;
      font-size: 12px;
    }

    /* pipe controls */
    .pipe-controls {
      display: flex;
      gap: 7px;
      flex-wrap: wrap;
      margin-bottom: 14px;
      padding: 10px;
      background: #0b0908;
      border: 1px solid #181510;
      border-radius: 3px;
    }

    .pipe-run-btn {
      flex: 1;
      padding: 7px 16px;
      background: #c8a660;
      color: #090807;
      border: none;
      border-radius: 2px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      font-weight: 500;
      cursor: pointer;
      letter-spacing: .06em;
      transition: all .12s;
      min-width: 120px;
    }

    .pipe-run-btn:hover {
      background: #dbb870
    }

    .pipe-run-btn:disabled {
      background: #2a2418;
      color: #504830;
      cursor: not-allowed
    }

    .pipe-run-btn.running {
      background: #8a6a30;
      color: #e0d3bc
    }

    .pipe-clear-btn {
      padding: 7px 13px;
      background: #141209;
      border: 1px solid #252015;
      border-radius: 2px;
      color: #60584a;
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      cursor: pointer;
      transition: all .12s;
      letter-spacing: .05em;
    }

    .pipe-clear-btn:hover {
      color: #c8a660;
      border-color: #4a3a18
    }

    .pipe-save-btn {
      padding: 7px 13px;
      background: #0f180d;
      border: 1px solid #263422;
      border-radius: 2px;
      color: #7aac74;
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      cursor: pointer;
      transition: all .12s;
      letter-spacing: .05em;
    }

    .pipe-save-btn:hover {
      border-color: #7aac74
    }

    .pipe-save-btn:disabled {
      opacity: .3;
      cursor: not-allowed
    }

    /* results */
    .res-hd {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 1px solid #181510;
    }

    .res-title {
      font-family: 'Playfair Display', serif;
      font-size: 16px;
      font-style: italic;
      color: #e0d3bc
    }

    .res-empty {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #281e14;
      font-family: 'Playfair Display', serif;
      font-style: italic;
      font-size: 15px;
    }

    .res-step {
      margin-bottom: 16px
    }

    .res-step-hd {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 7px;
      padding: 5px 9px;
      background: #0b0908;
      border: 1px solid #181510;
      border-radius: 2px;
    }

    .res-step-num {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 1px solid #3a3020;
      background: #181410;
      color: #c8a660;
      font-family: 'JetBrains Mono', monospace;
      font-size: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .res-step-name {
      font-family: 'Crimson Pro', serif;
      font-size: 13px;
      font-weight: 600;
      color: #b8a878;
      flex: 1
    }

    .res-step-status {
      font-family: 'JetBrains Mono', monospace;
      font-size: 8px;
      color: #50483a;
      letter-spacing: .06em;
    }

    .res-step-status.running {
      color: #c8a660
    }

    .res-step-status.done {
      color: #7aac74
    }

    .res-step-status.err {
      color: #c06050
    }

    .res-step-text {
      background: #080706;
      border: 1px solid #141209;
      border-radius: 2px;
      padding: 10px 13px;
      font-family: 'Crimson Pro', serif;
      font-size: 13px;
      color: #80786a;
      line-height: 1.75;
      white-space: pre-wrap;
      word-break: break-word;
      min-height: 60px;
    }

    /* ─── SETTINGS PANEL ──────────────────────────────── */
    .settings-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 24px
    }

    .settings-section {
      max-width: 580px
    }

    .settings-hd {
      margin-bottom: 20px;
      padding-bottom: 14px;
      border-bottom: 1px solid #181510
    }

    .settings-hd h2 {
      font-family: 'Playfair Display', serif;
      font-size: 22px;
      font-style: italic;
      color: #e0d3bc;
      margin-bottom: 3px
    }

    .settings-hd p {
      font-size: 13px;
      color: #50483a;
      font-style: italic
    }

    .scard {
      margin-bottom: 18px;
      border: 1px solid var(--border);
      border-radius: 3px;
      overflow: hidden
    }

    .scard-hd {
      padding: 9px 13px;
      background: var(--bg3);
      border-bottom: 1px solid var(--border);
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      letter-spacing: .1em;
      text-transform: uppercase;
      color: var(--text5);
    }

    .scard-hd #lmstudio_help_hd {
      display: inline;
      margin-right: 4px
    }

    .scard-body {
      padding: 13px
    }

    .stats-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #141209;
      border-radius: 3px;
      margin-bottom: 12px
    }

    .stats-label {
      color: #605840;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .1em
    }

    .stats-value {
      color: #c8a660;
      font-size: 22px;
      font-family: 'JetBrains Mono', monospace
    }

    .stats-breakdown {
      padding: 0 4px
    }

    .stats-row {
      display: flex;
      gap: 10px;
      padding: 6px 0;
      border-bottom: 1px solid #1f1a12;
      font-size: 12px;
      color: #a89868
    }

    .stats-row:last-child {
      border-bottom: none
    }

    .stats-sec {
      min-width: 90px;
      color: #605840
    }

    .stats-num {
      font-family: 'JetBrains Mono', monospace;
      color: #c8a660;
      margin-left: auto
    }

    .stats-active {
      color: #504830;
      font-size: 10px;
      margin-left: 6px
    }

    .stats-counts {
      display: flex;
      gap: 16px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #252015;
      font-size: 11px;
      color: #605840
    }

    .template-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      align-items: center;
      justify-content: center
    }

    .template-modal-overlay.open {
      display: flex
    }

    .template-modal {
      background: #1a1512;
      border: 1px solid #3a3020;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      border-radius: 4px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6)
    }

    .template-modal-hd {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: #141209;
      border-bottom: 1px solid #252015
    }

    .template-modal-hd h3 {
      margin: 0;
      font-size: 14px;
      color: #c8a660;
      font-weight: normal
    }

    .template-modal-close {
      background: none;
      border: none;
      color: #605840;
      font-size: 18px;
      cursor: pointer;
      padding: 0;
      line-height: 1
    }

    .template-modal-close:hover {
      color: #c8a660
    }

    .template-modal-body {
      padding: 16px
    }

    .template-field {
      margin-bottom: 12px;
      padding: 10px;
      background: #141209;
      border: 1px solid #252015;
      border-radius: 3px
    }

    .template-field-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 6px
    }

    .template-field-row input {
      flex: 1;
      padding: 6px 8px;
      background: #1a1512;
      border: 1px solid #3a3020;
      color: #c8a660;
      font-size: 12px
    }

    .template-field-row select {
      padding: 6px;
      background: #1a1512;
      border: 1px solid #3a3020;
      color: #c8a660;
      font-size: 12px
    }

    .template-field-remove {
      color: #b05040;
      cursor: pointer;
      font-size: 14px;
      padding: 4px
    }

    .template-field-remove:hover {
      color: #e07060
    }

    .template-add-field {
      padding: 6px 12px;
      background: transparent;
      border: 1px solid #3a3020;
      color: #807060;
      font-size: 11px;
      cursor: pointer;
      border-radius: 2px;
      margin-bottom: 12px
    }

    .template-add-field:hover {
      background: #252015;
      color: #c8a660
    }

    .template-tpl-label {
      font-size: 11px;
      color: #605840;
      margin-bottom: 6px;
      display: block
    }

    .template-tpl textarea {
      width: 100%;
      min-height: 120px;
      padding: 10px;
      background: #141209;
      border: 1px solid #3a3020;
      color: #c8a660;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      line-height: 1.5;
      resize: vertical
    }

    .template-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #252015
    }

    .template-btn {
      padding: 8px 16px;
      border-radius: 2px;
      font-size: 12px;
      cursor: pointer;
      transition: all .12s
    }

    .template-btn-primary {
      background: #c8a660;
      color: #090807;
      border: none
    }

    .template-btn-primary:hover {
      background: #e0c080
    }

    .template-btn-secondary {
      background: transparent;
      border: 1px solid #3a3020;
      color: #a09080
    }

    .template-btn-secondary:hover {
      background: #252015;
      color: #c8a660
    }

    .template-preview {
      margin-top: 12px;
      padding: 12px;
      background: #141209;
      border: 1px solid #252015;
      border-radius: 3px;
      font-size: 12px;
      color: #a09080;
      white-space: pre-wrap;
      max-height: 150px;
      overflow-y: auto
    }

    .create-template-btn {
      width: 100%;
      padding: 6px 10px;
      background: #1a1512;
      border: 1px solid #3a3020;
      color: #c8a660;
      font-size: 11px;
      cursor: pointer;
      border-radius: 2px;
      transition: all .12s
    }

    .create-template-btn:hover {
      background: #252015;
      border-color: #c8a660
    }

    .p-custom-header {
      padding: 8px 10px;
      font-size: 10px;
      color: #605840;
      text-transform: uppercase;
      letter-spacing: .1em;
      border-bottom: 1px solid #1f1a12;
      margin-top: 8px
    }

    .custom-prompt {
      position: relative;
      border-left: 3px solid #c8a660 !important
    }

    .custom-badge {
      font-size: 8px;
      padding: 1px 5px;
      background: #c8a660;
      color: #090807;
      border-radius: 2px;
      margin-left: 4px
    }

    .pcrd-actions {
      display: none;
      position: absolute;
      top: 6px;
      right: 6px;
      gap: 4px
    }

    .custom-prompt:hover .pcrd-actions {
      display: flex
    }

    .pcrd-edit,
    .pcrd-delete {
      font-size: 9px;
      padding: 2px 6px;
      background: #1a1512;
      border: 1px solid #3a3020;
      border-radius: 2px;
      cursor: pointer
    }

    .pcrd-edit:hover {
      color: #c8a660;
      border-color: #c8a660
    }

    .pcrd-delete:hover {
      color: #b05040;
      border-color: #b05040
    }

    .rel-item {
      padding: 10px;
      margin: 6px 0;
      background: #141209;
      border: 1px solid #252015;
      border-radius: 3px
    }

    .rel-names {
      font-size: 12px;
      color: #c8a660;
      margin-bottom: 4px
    }

    .rel-arrow {
      color: #605840;
      margin: 0 6px
    }

    .rel-type {
      font-size: 10px;
      color: #807060;
      text-transform: uppercase;
      letter-spacing: .05em
    }

    .rel-desc {
      font-size: 11px;
      color: #a09080;
      margin-top: 6px;
      font-style: italic
    }

    .rel-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px
    }

    .rel-edit,
    .rel-delete {
      font-size: 9px;
      padding: 3px 8px;
      background: #1a1512;
      border: 1px solid #3a3020;
      border-radius: 2px;
      cursor: pointer;
      color: #a09080
    }

    .rel-edit:hover {
      color: #c8a660;
      border-color: #c8a660
    }

    .rel-delete:hover {
      color: #b05040;
      border-color: #b05040
    }

    .empty-msg {
      color: #504830;
      font-size: 12px;
      font-style: italic;
      padding: 12px
    }

    .divider {
      border: 0;
      border-top: 1px solid #252015;
      margin: 16px 0
    }

    .rel-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      align-items: center;
      justify-content: center
    }

    .rel-modal-overlay.open {
      display: flex
    }

    .rel-modal {
      background: #1a1512;
      border: 1px solid #3a3020;
      width: 90%;
      max-width: 400px;
      border-radius: 4px
    }

    .rel-modal-hd {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: #141209;
      border-bottom: 1px solid #252015
    }

    .rel-modal-hd h3 {
      margin: 0;
      font-size: 14px;
      color: #c8a660
    }

    .rel-modal-close {
      background: none;
      border: none;
      color: #605840;
      font-size: 18px;
      cursor: pointer
    }

    .rel-modal-close:hover {
      color: #c8a660
    }

    .rel-modal-body {
      padding: 16px
    }

    .rel-field {
      margin-bottom: 12px
    }

    .rel-field label {
      display: block;
      font-size: 11px;
      color: #605840;
      margin-bottom: 4px
    }

    .rel-field select,
    .rel-field textarea {
      width: 100%;
      padding: 8px;
      background: #141209;
      border: 1px solid #3a3020;
      color: #c8a660;
      font-size: 12px
    }

    .rel-field textarea {
      min-height: 60px;
      resize: vertical
    }

    .rel-actions-row {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 16px
    }

    .rel-btn-cancel,
    .rel-btn-save {
      padding: 8px 16px;
      border-radius: 2px;
      font-size: 12px;
      cursor: pointer
    }

    .rel-btn-cancel {
      background: transparent;
      border: 1px solid #3a3020;
      color: #a09080
    }

    .rel-btn-cancel:hover {
      background: #252015
    }

    .rel-btn-save {
      background: #c8a660;
      border: none;
      color: #090807
    }

    .rel-btn-save:hover {
      background: #e0c080
    }

    .rel-map-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 2000;
      align-items: center;
      justify-content: center
    }

    .rel-map-overlay.open {
      display: flex
    }

    .rel-map-modal {
      background: #1a1512;
      border: 1px solid #3a3020;
      width: 95%;
      height: 90%;
      max-width: 1200px;
      border-radius: 4px;
      display: flex;
      flex-direction: column
    }

    .rel-map-hd {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: #141209;
      border-bottom: 1px solid #252015
    }

    .rel-map-hd h3 {
      margin: 0;
      font-size: 14px;
      color: #c8a660
    }

    .rel-map-close {
      background: none;
      border: none;
      color: #605840;
      font-size: 18px;
      cursor: pointer
    }

    .rel-map-close:hover {
      color: #c8a660
    }

    .rel-map-body {
      flex: 1;
      position: relative;
      overflow: hidden
    }

    .rel-map-body canvas {
      width: 100%;
      height: 100%;
      display: block
    }

    .story-subtabs {
      display: flex;
      gap: 2px;
      margin-bottom: 16px;
      border-bottom: 1px solid #252015
    }

    .story-subtab {
      padding: 10px 20px;
      background: transparent;
      border: none;
      color: #605840;
      font-size: 12px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all .12s
    }

    .story-subtab:hover {
      color: #a09080
    }

    .story-subtab.active {
      color: #c8a660;
      border-bottom-color: #c8a660
    }

    .ch-item {
      padding: 12px;
      margin: 8px 0;
      background: #141209;
      border: 1px solid #252015;
      border-radius: 3px
    }

    .ch-item-hd {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px
    }

    .ch-num {
      font-size: 10px;
      color: #504830;
      min-width: 20px
    }

    .ch-title {
      font-size: 13px;
      color: #c8a660
    }

    .ch-item-bd {
      font-size: 11px;
      color: #a09080;
      line-height: 1.4;
      margin-bottom: 8px
    }

    .ch-item-ft {
      display: flex;
      gap: 8px
    }

    .ch-edit,
    .ch-delete {
      font-size: 9px;
      padding: 3px 8px;
      background: #1a1512;
      border: 1px solid #3a3020;
      border-radius: 2px;
      cursor: pointer;
      color: #a09080
    }

    .ch-edit:hover {
      color: #c8a660;
      border-color: #c8a660
    }

    .ch-delete:hover {
      color: #b05040;
      border-color: #b05040
    }

    .timeline-item {
      padding: 12px;
      margin: 8px 0;
      background: #141209;
      border: 1px solid #252015;
      border-radius: 3px
    }

    .timeline-title {
      font-size: 13px;
      color: #c8a660;
      margin-bottom: 4px
    }

    .timeline-type {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: .05em;
      margin-bottom: 6px
    }

    .timeline-desc {
      font-size: 11px;
      color: #a09080;
      margin-bottom: 6px;
      font-style: italic
    }

    .timeline-meta {
      font-size: 10px;
      color: #605840;
      margin-bottom: 8px
    }

    .timeline-actions {
      display: flex;
      gap: 8px
    }

    .timeline-edit,
    .timeline-delete {
      font-size: 9px;
      padding: 3px 8px;
      background: #1a1512;
      border: 1px solid #3a3020;
      border-radius: 2px;
      cursor: pointer;
      color: #a09080
    }

    .timeline-edit:hover {
      color: #c8a660;
      border-color: #c8a660
    }

    .timeline-delete:hover {
      color: #b05040;
      border-color: #b05040
    }

    .timeline-modal-overlay,
    .timeline-visual-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      align-items: center;
      justify-content: center
    }

    .timeline-modal-overlay.open,
    .timeline-visual-overlay.open {
      display: flex
    }

    .timeline-modal {
      background: #1a1512;
      border: 1px solid #3a3020;
      width: 90%;
      max-width: 450px;
      border-radius: 4px
    }

    .timeline-visual-modal {
      background: #1a1512;
      border: 1px solid #3a3020;
      width: 95%;
      height: 90%;
      max-width: 1000px;
      border-radius: 4px;
      display: flex;
      flex-direction: column
    }

    .timeline-modal-hd,
    .timeline-visual-hd {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: #141209;
      border-bottom: 1px solid #252015
    }

    .timeline-modal-hd h3,
    .timeline-visual-hd h3 {
      margin: 0;
      font-size: 14px;
      color: #c8a660
    }

    .timeline-modal-close,
    .timeline-visual-close {
      background: none;
      border: none;
      color: #605840;
      font-size: 18px;
      cursor: pointer
    }

    .timeline-modal-close:hover,
    .timeline-visual-close:hover {
      color: #c8a660
    }

    .timeline-modal-body {
      padding: 16px
    }

    .timeline-field {
      margin-bottom: 12px
    }

    .timeline-field label {
      display: block;
      font-size: 11px;
      color: #605840;
      margin-bottom: 4px
    }

    .timeline-field input,
    .timeline-field textarea,
    .timeline-field select {
      width: 100%;
      padding: 8px;
      background: #141209;
      border: 1px solid #3a3020;
      color: #c8a660;
      font-size: 12px
    }

    .timeline-field textarea {
      min-height: 60px;
      resize: vertical
    }

    .timeline-actions-row {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 16px
    }

    .timeline-btn-cancel,
    .timeline-btn-save {
      padding: 8px 16px;
      border-radius: 2px;
      font-size: 12px;
      cursor: pointer
    }

    .timeline-btn-cancel {
      background: transparent;
      border: 1px solid #3a3020;
      color: #a09080
    }

    .timeline-btn-cancel:hover {
      background: #252015
    }

    .timeline-btn-save {
      background: #c8a660;
      border: none;
      color: #090807
    }

    .timeline-btn-save:hover {
      background: #e0c080
    }

    .timeline-visual-body {
      flex: 1;
      overflow: auto;
      padding: 20px
    }

    .timeline-visual-scroll {
      position: relative;
      padding: 20px 0
    }

    .timeline-visual-line {
      position: absolute;
      left: 50px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #252015
    }

    .timeline-visual-event {
      position: relative;
      margin-bottom: 20px;
      padding-left: 70px
    }

    .timeline-visual-dot {
      position: absolute;
      left: 42px;
      top: 10px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--color, #c8a660);
      border: 2px solid #1a1512
    }

    .timeline-visual-card {
      background: #141209;
      border: 1px solid #252015;
      border-radius: 4px;
      padding: 12px
    }

    .timeline-visual-title {
      font-size: 13px;
      color: #c8a660;
      margin-bottom: 4px
    }

    .timeline-visual-type {
      font-size: 10px;
      color: #807060;
      text-transform: uppercase;
      margin-bottom: 6px
    }

    .timeline-visual-desc {
      font-size: 11px;
      color: #a09080;
      margin-bottom: 6px
    }

    .timeline-visual-date {
      font-size: 10px;
      color: #605840
    }

    .help-subtabs {
      display: flex;
      gap: 2px;
      margin-bottom: 16px;
      border-bottom: 1px solid #252015
    }

    .help-subtab {
      padding: 10px 20px;
      background: transparent;
      border: none;
      color: #605840;
      font-size: 12px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all .12s
    }

    .help-subtab:hover {
      color: #a09080
    }

    .help-subtab.active {
      color: #c8a660;
      border-bottom-color: #c8a660
    }

    .help-section {
      color: #a89868
    }

    .help-section h3 {
      color: #c8a660;
      margin: 0 0 12px;
      font-size: 16px;
      font-weight: normal
    }

    .help-section h4 {
      color: #c8a660;
      margin: 16px 0 8px;
      font-size: 13px;
      font-weight: normal
    }

    .help-section p {
      line-height: 1.6;
      margin-bottom: 12px
    }

    .help-section ol,
    .help-section ul {
      padding-left: 20px
    }

    .help-section li {
      margin-bottom: 4px
    }

    .help-shortcut-group {
      margin-bottom: 16px
    }

    .help-shortcut-group h4 {
      color: #c8a660;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .05em;
      margin-bottom: 8px
    }

    .help-shortcut {
      display: flex;
      gap: 12px;
      padding: 6px 0;
      border-bottom: 1px solid #1f1a12
    }

    .help-key {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: #c8a660;
      min-width: 120px
    }

    .help-desc {
      font-size: 12px;
      color: #807060
    }

    .help-guide {
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid #1f1a12
    }

    .help-guide h4 {
      color: #c8a660;
      margin: 0 0 6px;
      font-size: 13px;
      font-weight: normal
    }

    .activity-log {
      max-height: 400px;
      overflow-y: auto;
      background: #141209;
      border: 1px solid #252015;
      border-radius: 4px;
      padding: 12px
    }

    .activity-entry {
      padding: 8px 0;
      border-bottom: 1px solid #1f1a12
    }

    .activity-entry:last-child {
      border-bottom: none
    }

    .activity-time {
      font-size: 10px;
      color: #504830;
      margin-bottom: 4px
    }

    .activity-desc {
      font-size: 12px;
      color: #a09080
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    .api-row {
      display: flex;
      gap: 7px;
      align-items: flex-end
    }

    .api-row .meta-field {
      flex: 1
    }

    .api-key-wrap {
      position: relative
    }

    .api-key-wrap input {
      padding-right: 60px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      letter-spacing: .06em
    }

    .api-show {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      padding: 2px 7px;
      background: #141209;
      border: 1px solid #252015;
      border-radius: 2px;
      color: #60584a;
      font-family: 'JetBrains Mono', monospace;
      font-size: 8px;
      cursor: pointer;
      transition: all .12s;
      letter-spacing: .05em;
    }

    .api-show:hover {
      color: #c8a660;
      border-color: #4a3a18
    }

    .test-btn {
      padding: 6px 14px;
      background: #141209;
      border: 1px solid #3a3020;
      border-radius: 2px;
      color: #c8a660;
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      cursor: pointer;
      transition: all .12s;
      letter-spacing: .05em;
      white-space: nowrap;
      flex-shrink: 0;
      margin-bottom: 1px;
    }

    .test-btn:hover {
      background: #1c1a10;
      border-color: #c8a660
    }

    .api-status {
      margin-top: 6px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      letter-spacing: .06em;
      min-height: 16px;
    }

    .api-status.ok {
      color: #7aac74
    }

    .api-status.err {
      color: #c06050
    }

    .api-status.checking {
      color: #c8a660
    }

    .api-note {
      margin-top: 7px;
      font-size: 12px;
      color: #40382a;
      line-height: 1.5;
      font-style: italic
    }

    .api-note a {
      color: #c8a660;
      text-decoration: none
    }

    .api-note a:hover {
      text-decoration: underline
    }

    /* model selector */
    .model-grid {
      display: flex;
      flex-direction: column;
      gap: 5px
    }

    .model-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 7px 9px;
      border: 1px solid #1c1912;
      border-radius: 2px;
      cursor: pointer;
      transition: all .12s;
      background: transparent;
    }

    .model-row:hover {
      background: #0d0b08;
      border-color: #252015
    }

    .model-row.msel {
      background: #120f08;
      border-color: var(--mc)
    }

    .model-radio {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 1px solid #3a3020;
      background: #111009;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .12s;
    }

    .model-row.msel .model-radio {
      border-color: var(--mc);
      background: var(--mc)
    }

    .model-radio-dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: #090807;
      display: none
    }

    .model-row.msel .model-radio-dot {
      display: block
    }

    .model-info {
      flex: 1;
      min-width: 0
    }

    .model-name {
      font-family: 'Crimson Pro', serif;
      font-size: 14px;
      font-weight: 600;
      color: #a89868
    }

    .model-row.msel .model-name {
      color: #e0d3bc
    }

    .model-meta {
      font-family: 'JetBrains Mono', monospace;
      font-size: 8px;
      color: #3a3020;
      letter-spacing: .04em;
      margin-top: 1px
    }

    .model-provider {
      font-family: 'JetBrains Mono', monospace;
      font-size: 8px;
      padding: 1px 6px;
      border-radius: 9px;
      border: 1px solid;
      flex-shrink: 0;
    }

    .model-section-lbl {
      font-family: 'JetBrains Mono', monospace;
      font-size: 7px;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: #302818;
      padding: 6px 0 4px;
      margin-top: 4px;
    }

    .model-collapse-hd {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      padding: 4px 0;
      margin-bottom: 4px;
    }

    .model-collapse-hd:hover {
      color: #c8a660
    }

    .model-collapse-icon {
      transition: transform .2s
    }

    .model-collapse-hd.collapsed .model-collapse-icon {
      transform: rotate(-90deg)
    }

    #model_grid.collapsed {
      display: none
    }

    .clear-all-btn {
      padding: 6px 14px;
      background: #1a1010;
      border: 1px solid #3a2020;
      border-radius: 2px;
      color: #b05040;
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      cursor: pointer;
      transition: all .12s;
      letter-spacing: .05em;
    }

    .clear-all-btn:hover {
      background: #221414;
      border-color: #b05040
    }

    .export-import-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 8px
    }

    .export-btn,
    .import-btn {
      padding: 6px 14px;
      background: #1a1010;
      border: 1px solid #3a3020;
      border-radius: 2px;
      color: #c8a660;
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      cursor: pointer;
      transition: all .12s;
      letter-spacing: .05em;
    }

    .export-btn:hover,
    .import-btn:hover {
      background: #252015;
      border-color: #c8a660
    }


    .max-tok-row {
      display: flex;
      align-items: center;
      gap: 10px
    }

    .tok-note {
      font-size: 12px;
      color: #40382a;
      font-style: italic
    }

    /* Mobile Layout */
    @media (max-width: 768px) {
      body.mobile-enabled {
        overflow-x: auto;
      }

      body.mobile-enabled #app {
        min-width: 150vw;
        flex-direction: row;
      }

      body.mobile-enabled .ctx-scroll {
        min-width: 100vw;
      }

      body.mobile-enabled .p-sidebar {
        width: 100px;
        flex-shrink: 0;
      }

      body.mobile-enabled .p-list {
        width: 140px;
        flex-shrink: 0;
      }

      body.mobile-enabled .panel {
        min-width: 100vw;
      }

      body.mobile-enabled #panel-prompts {
        flex-direction: row !important;
        min-width: calc(100px + 140px + 300px);
      }

      body.mobile-enabled #panel-pipeline {
        min-width: 100vw;
        flex-direction: column;
      }

      body.mobile-enabled .pipe-layout {
        flex-direction: column;
      }

      body.mobile-enabled .pipe-builder {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #181510;
      }
    }

    .mobile-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-left: 10px
    }

    .mobile-toggle input[type=checkbox] {
      width: 14px;
      height: 14px;
      accent-color: #c8a660
    }

    .mobile-toggle label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 8px;
      color: #50483a;
      letter-spacing: .05em
    }

    /* Writing Prefs */
    .pref-section {
      margin-bottom: 16px
    }

    .pref-section-lbl {
      font-family: 'JetBrains Mono', monospace;
      font-size: 8px;
      letter-spacing: .1em;
      text-transform: uppercase;
      color: #50483a;
      margin-bottom: 6px
    }

    .pref-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px
    }

    .pref-row label {
      flex: 1;
      font-size: 13px;
      color: #a89868
    }

    .pref-row input[type=checkbox] {
      width: 16px;
      height: 16px;
      accent-color: #c8a660
    }

    .pref-toggle {
      position: relative;
      width: 36px;
      height: 20px
    }

    .pref-toggle input {
      opacity: 0;
      width: 0;
      height: 0
    }

    .pref-toggle-slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background: #1a1810;
      border: 1px solid #2a2520;
      border-radius: 10px;
      transition: .12s
    }

    .pref-toggle-slider:before {
      content: '';
      position: absolute;
      height: 14px;
      width: 14px;
      left: 2px;
      bottom: 2px;
      background: #60584a;
      border-radius: 50%;
      transition: .12s
    }

    .pref-toggle input:checked+.pref-toggle-slider {
      background: #1a2810;
      border-color: #3a5030
    }

    .pref-toggle input:checked+.pref-toggle-slider:before {
      transform: translateX(16px);
      background: #7aac74
    }

    .pref-radio {
      display: flex;
      gap: 8px;
      flex-wrap: wrap
    }

    .pref-radio label {
      font-size: 12px;
      color: #a89868;
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer
    }

    .pref-radio input {
      accent-color: #c8a660
    }

    .pref-group {
      border: 1px solid #1e1a12;
      border-radius: 2px;
      padding: 8px;
      margin-bottom: 8px
    }

    .pref-group-lbl {
      font-family: 'JetBrains Mono', monospace;
      font-size: 8px;
      letter-spacing: .08em;
      color: #c8a660;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px
    }

    .pref-sub {
      margin-left: 16px;
      margin-top: 4px
    }

    .pref-sub .pref-row {
      margin-bottom: 4px
    }

    .pref-sub label {
      font-size: 11px;
      color: #80786a
    }

    .dnu-text {
      width: 100%;
      min-height: 60px;
      font-family: 'Crimson Pro', serif;
      font-size: 13px;
      background: #0a0907;
      border: 1px solid #1a1810;
      border-radius: 2px;
      color: #a89868;
      padding: 6px;
      resize: vertical
    }

    /* Genre Compare */
    .genre-compare-row {
      display: flex;
      gap: 8px;
      align-items: flex-end;
      margin-bottom: 10px
    }

    .genre-compare-row .meta-field {
      flex: 1
    }

    .gc-select {
      background: #0d0b08;
      border: 1px solid #1e1a12;
      border-radius: 2px;
      color: #a89868;
      font-family: 'Crimson Pro', serif;
      font-size: 13px;
      padding: 5px 9px;
      outline: none;
      width: 100%
    }

    .gc-ref-text {
      min-height: 80px;
      width: 100%;
      background: #0a0907;
      border: 1px solid #1a1810;
      border-radius: 2px;
      color: #a89868;
      font-family: 'Crimson Pro', serif;
      font-size: 13px;
      padding: 8px;
      resize: vertical
    }

    /* Extract Section */
    .extract-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap
    }

    .extract-btn {
      padding: 6px 12px;
      background: #141209;
      border: 1px solid #252015;
      border-radius: 2px;
      color: #a89868;
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      cursor: pointer;
      transition: all .12s
    }

    .extract-btn:hover {
      background: #1c1a10;
      border-color: #c8a660
    }

    .extract-result {
      margin-top: 10px;
      padding: 10px;
      background: #0b0908;
      border: 1px solid #181510;
      border-radius: 2px;
      max-height: 200px;
      overflow-y: auto
    }

    .extract-result textarea {
      width: 100%;
      min-height: 100px;
      background: transparent;
      border: none;
      color: #a89868;
      font-family: 'Crimson Pro', serif;
      font-size: 12px;
      resize: vertical
    }

    /* Full Chapters */
    .fc-toggle {
      display: flex;
      border: 1px solid #1e1a12;
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 14px
    }

    .fc-btn {
      flex: 1;
      padding: 6px;
      background: transparent;
      border: none;
      border-right: 1px solid #1e1a12;
      color: #3a3020;
      font-family: 'JetBrains Mono', monospace;
      font-size: 8px;
      letter-spacing: .07em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all .12s
    }

    .fc-btn:last-child {
      border-right: none
    }

    .fc-btn.fcon {
      background: #141109;
      color: #c8a660
    }

    .fc-chapters {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 14px
    }

    .fc-chap {
      flex: 1;
      border: 1px solid #181510;
      border-radius: 3px;
      overflow: hidden
    }

    .fc-chap-hd {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 10px;
      background: #0e0b09;
      border-bottom: 1px solid #181510
    }

    .fc-chap-lbl {
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      color: #c8a660;
      letter-spacing: .06em
    }

    .fc-chap textarea {
      width: 100%;
      min-height: 120px;
      background: #0b0908;
      border: none;
      color: #a89868;
      font-family: 'Crimson Pro', serif;
      font-size: 13px;
      padding: 8px;
      resize: vertical
    }

    .fc-chap textarea::placeholder {
      color: #252015
    }

    .fc-warning {
      padding: 8px 12px;
      background: #1a1410;
      border: 1px solid #4a3020;
      border-radius: 2px;
      color: #c8a660;
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 6px
    }

    .fc-warning.hidden {
      display: none
    }

    /* Pipeline Copy All */
    .res-actions {
      display: flex;
      gap: 5px
    }

    .token-warning {
      font-family: 'JetBrains Mono', monospace;
      font-size: 8px;
      padding: 2px 6px;
      border-radius: 2px;
      margin-left: 8px
    }

    .token-warning.ok {
      color: #7aac74;
      background: #0f180d
    }

    .token-warning.warn {
      color: #c8a660;
      background: #1a1810
    }

    .token-warning.err {
      color: #c06050;
      background: #1a1010
    }

    /* Bible Creation */
    .bible-creation-row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap
    }

    .bible-opt {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: #0d0b08;
      border: 1px solid #1e1a12;
      border-radius: 2px
    }

    .bible-opt input[type=checkbox] {
      accent-color: #c8a660
    }

    .bible-opt label {
      font-size: 12px;
      color: #a89868;
      cursor: pointer
    }

    /* Character Match */
    .char-match-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
      padding: 8px;
      background: #1a1410;
      border: 1px solid #3a3020;
      border-radius: 2px
    }

    .char-match-row label {
      font-size: 12px;
      color: #c8a660;
      flex: 1
    }

    .char-match-toggle {
      font-size: 11px;
      color: #7aac74;
      cursor: pointer
    }

    /* Pipeline Style Option */
    .pipeline-style-opt {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: #0d0b08;
      border: 1px solid #1e1a12;
      border-radius: 2px;
      margin-bottom: 10px
    }

    .pipeline-style-opt input[type=checkbox] {
      accent-color: #c8a660
    }

    .pipeline-style-opt label {
      font-size: 12px;
      color: #a89868;
      flex: 1
    }
  </style>

  <!-- REDESIGN GOOGLE FONTS -->
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Lora:ital,wght@0,400;0,600&display=swap"
    rel="stylesheet">
  <!-- REDESIGN STYLES -->
  <style>
    /* Modern Overrides */
    :root {
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
      --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.15);
      --shadow-focus: 0 0 0 3px color-mix(in srgb, var(--accent) 30%, transparent);
      --glass-bg: color-mix(in srgb, var(--bg) 80%, transparent);
      --glass-border: color-mix(in srgb, var(--border) 50%, transparent);
      --font-ui: 'Inter', sans-serif;
      --font-heading: 'Lora', serif;
    }

    html,
    body {
      font-family: var(--font-ui) !important;
      /* subtle gradient background */
      background: radial-gradient(circle at 50% 0%, color-mix(in srgb, var(--bg2) 80%, var(--accent) 10%), var(--bg) 60%) !important;
      background-attachment: fixed !important;
    }

    h1,
    h2,
    h3,
    .brand-title,
    .ctx-head h2,
    .settings-hd h2,
    .pipe-hd h2 {
      font-family: var(--font-heading) !important;
    }

    .brand-title {
      font-size: 22px !important;
      letter-spacing: -0.02em !important;
    }

    #app-header {
      background: var(--glass-bg) !important;
      backdrop-filter: blur(12px) !important;
      -webkit-backdrop-filter: blur(12px) !important;
      border-bottom: 1px solid var(--glass-border) !important;
      height: 64px !important;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05) !important;
      z-index: 2000 !important;
    }

    /* Cards & Containers */
    .home-card,
    .sb,
    .p-list,
    .pipe-step,
    .ch-item,
    .timeline-item,
    .scard {
      background: color-mix(in srgb, var(--bg) 95%, transparent) !important;
      border-radius: var(--radius-md) !important;
      border: 1px solid var(--border) !important;
      box-shadow: var(--shadow-sm) !important;
      transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.2s ease, border-color 0.2s ease !important;
    }

    .home-card:hover,
    .ch-item:hover,
    .timeline-item:hover {
      transform: translateY(-4px) !important;
      box-shadow: var(--shadow-md) !important;
      border-color: color-mix(in srgb, var(--accent) 50%, transparent) !important;
    }

    /* Inputs, Textareas, Selects */
    .sb-ta,
    input.minput,
    select.minput,
    .step-sel,
    .step-field input,
    .step-field textarea,
    .pfl input,
    .pfl textarea,
    .template-field-row input,
    .template-field-row select,
    .api-key-wrap input,
    .fc-chap textarea {
      border-radius: var(--radius-sm) !important;
      background: color-mix(in srgb, var(--bg) 70%, rgba(0, 0, 0, 0.1)) !important;
      border: 1px solid var(--border) !important;
      font-family: var(--font-ui) !important;
      transition: all 0.2s ease !important;
    }

    .sb-ta:focus,
    input.minput:focus,
    select.minput:focus,
    .step-field input:focus,
    .step-field textarea:focus,
    .pfl input:focus,
    .pfl textarea:focus,
    .api-key-wrap input:focus,
    .fc-chap textarea:focus {
      border-color: var(--accent) !important;
      box-shadow: var(--shadow-focus) !important;
      background: var(--bg) !important;
      outline: none !important;
    }

    /* Primary Buttons */
    .run-btn,
    .search-btn-primary,
    .template-btn-primary,
    .rel-btn-save,
    .timeline-btn-save,
    .pipe-run-btn {
      border-radius: var(--radius-sm) !important;
      font-family: var(--font-ui) !important;
      font-weight: 600 !important;
      text-transform: uppercase !important;
      letter-spacing: 0.05em !important;
      box-shadow: 0 4px 10px color-mix(in srgb, var(--accent) 20%, transparent) !important;
      transition: all 0.2s ease !important;
      padding: 8px 16px !important;
    }

    .run-btn:hover,
    .search-btn-primary:hover,
    .template-btn-primary:hover,
    .rel-btn-save:hover,
    .timeline-btn-save:hover,
    .pipe-run-btn:hover {
      transform: translateY(-2px) !important;
      box-shadow: 0 6px 14px color-mix(in srgb, var(--accent) 35%, transparent) !important;
    }

    /* Stop / Danger Buttons */
    .stop-btn,
    .pcrd-delete,
    .ch-delete,
    .timeline-delete,
    .rel-delete {
      border-radius: var(--radius-sm) !important;
    }

    /* Secondary Buttons */
    .sec-btn,
    .search-btn,
    .template-btn-secondary,
    .project-current,
    .tab-btn {
      border-radius: var(--radius-sm) !important;
      font-family: var(--font-ui) !important;
      transition: all 0.2s ease !important;
    }

    /* Tabs */
    .tab-btn {
      padding: 8px 16px !important;
      font-weight: 500 !important;
      border: 1px solid transparent !important;
    }

    .tab-btn.active {
      background: color-mix(in srgb, var(--accent) 10%, transparent) !important;
      color: var(--accent) !important;
      border-color: color-mix(in srgb, var(--accent) 30%, transparent) !important;
      box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--accent) 20%, transparent) !important;
    }

    /* Headlines Redesign */
    .ctx-head h2,
    .settings-hd h2,
    .pipe-hd h2 {
      font-family: var(--font-heading) !important;
      font-weight: 600 !important;
      font-style: normal !important;
      font-size: 32px !important;
      background: linear-gradient(135deg, var(--text) 0%, var(--accent) 100%) !important;
      -webkit-background-clip: text !important;
      -webkit-text-fill-color: transparent !important;
      margin-bottom: 12px !important;
    }

    /* Layout Padding Fixes for breathing room */
    .ctx-scroll,
    .settings-scroll,
    .pipe-results {
      padding: 32px 40px !important;
    }

    /* Icons replacement (Using borders and backgrounds to make them look like soft badges) */
    .home-icon {
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
      background: color-mix(in srgb, var(--accent) 15%, transparent) !important;
      width: 48px !important;
      height: 48px !important;
      border-radius: 50% !important;
      margin-bottom: 16px !important;
      font-size: 24px !important;
      box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--accent) 20%, transparent) !important;
    }

    /* Modals */
    .search-modal,
    .template-modal,
    .rel-modal,
    .timeline-modal,
    .timeline-visual-modal,
    .rel-map-modal {
      border-radius: var(--radius-lg) !important;
      border: 1px solid var(--border) !important;
      box-shadow: 0 32px 80px rgba(0, 0, 0, 0.5) !important;
      background: color-mix(in srgb, var(--bg) 95%, transparent) !important;
      backdrop-filter: blur(16px) !important;
    }

    .search-modal-hd,
    .template-modal-hd,
    .rel-modal-hd,
    .timeline-modal-hd,
    .timeline-visual-hd,
    .rel-map-hd {
      border-top-left-radius: var(--radius-lg) !important;
      border-top-right-radius: var(--radius-lg) !important;
      background: transparent !important;
      border-bottom: 1px solid var(--border) !important;
      padding: 16px 24px !important;
    }

    /* Micro animations */
    .home-card h4::after {
      content: '';
      display: block;
      width: 20px;
      height: 2px;
      background: var(--accent);
      margin-top: 8px;
      transition: width 0.3s ease;
      border-radius: 2px;
    }

    .home-card:hover h4::after {
      width: 40px;
    }

    /* Scrollbars Overrides */
    ::-webkit-scrollbar {
      width: 8px !important;
      height: 8px !important;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border) !important;
      border-radius: 4px !important;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: color-mix(in srgb, var(--accent) 50%, var(--border)) !important;
    }
  </style>
</head>

<body>
  <div id="app">
    <header id="app-header">
      <div class="brand">
        <a href="NALogo.png" target="_blank"><img src="NALogo.png" class="brand-logo" alt="Logo"></a>
        <span class="brand-title">The Novelist's Atelier</span>
        <span class="brand-ver">1.1 Beta</span>
        <div class="project-selector" id="project_selector">
          <button class="project-current" id="project_current_btn">
            <span id="project_name_display">My Novel</span>
            <span class="project-caret">▾</span>
          </button>
          <span id="save_indicator" class="save-indicator"></span>
          <span id="save_time" class="save-time"></span>
          <span id="style_dna_indicator" class="save-time" style="cursor:pointer"
            onclick="APP.tab='story';showTab('story');document.querySelector('[data-subtab=\'styledna\']').click()"></span>
          <button id="scene_nav_toggle" class="scene-nav-toggle" onclick="toggleSceneNavigator()"
            title="Scene Navigator (Ctrl+J)">☰ Scenes</button>
          <button id="search_btn" class="scene-nav-toggle" onclick="openSearchModal()"
            title="Search (Ctrl+F)">🔍</button>
          <div class="project-dropdown" id="project_dropdown">
            <div class="project-list" id="project_list"></div>
            <div class="project-actions">
              <button class="project-action" id="project_new">+ New Project</button>
              <button class="project-action" id="project_load">Load</button>
              <button class="project-action" id="project_save">Save</button>
              <button class="project-action" id="project_import">Import</button>
              <button class="project-action" id="project_export">Export</button>
              <button class="project-action" id="project_rename">Rename</button>
              <button class="project-action" id="project_delete">Delete</button>
            </div>
          </div>
        </div>
        <div class="stats-badge" id="stats_badge" title="Click for detailed stats">0 words</div>
      </div>
      <nav class="tab-nav" id="tab-nav"></nav>
    </header>
    <main id="app-main">
      <div id="panel-home" class="panel"></div>
      <div id="panel-series" class="panel"></div>
      <div id="panel-book" class="panel"></div>
      <div id="panel-chapter" class="panel"></div>
      <div id="panel-story" class="panel"></div>
      <div id="panel-prompts" class="panel"></div>
      <div id="panel-pipeline" class="panel"></div>
      <div id="panel-settings" class="panel"></div>
      <div id="panel-help" class="panel"></div>
      <div id="scene-navigator" class="scene-navigator">
        <div class="scene-nav-header">
          <h3>Scene Navigator</h3>
          <button class="scene-nav-close" onclick="toggleSceneNavigator()">×</button>
        </div>
        <div class="scene-nav-content" id="scene_nav_content"></div>
      </div>
      <input type="file" id="import_file" accept=".json" style="display:none">
    </main>
  </div>

  <script>
    'use strict';

    // ═══════════════════════════════════════════════════════════
    // CONSTANTS
    // ═══════════════════════════════════════════════════════════

    const TABS = [
      { id: 'home', icon: '⌂', label: 'Home' },
      { id: 'series', icon: '◈', label: 'Series' },
      { id: 'book', icon: '◉', label: 'Book' },
      { id: 'chapter', icon: '❒', label: 'Chapter' },
      { id: 'story', icon: '📖', label: 'Story' },
      { id: 'prompts', icon: '◆', label: 'Prompts' },
      { id: 'pipeline', icon: '⟹', label: 'Pipeline' },
      { id: 'settings', icon: '⚙', label: 'Settings' },
      { id: 'help', icon: '?', label: 'Help' },
    ];

    const MODELS = [
      // OpenRouter (Default)
      { id: 'anthropic/claude-opus-4', name: 'Claude Opus 4', provider: 'openrouter', ctx: '200k', color: '#c87a50' },
      { id: 'anthropic/claude-sonnet-4-5', name: 'Claude Sonnet 4.5', provider: 'openrouter', ctx: '200k', color: '#c87a50' },
      { id: 'anthropic/claude-haiku-4-5', name: 'Claude Haiku 4.5', provider: 'openrouter', ctx: '200k', color: '#c87a50' },
      { id: 'openai/gpt-4o', name: 'GPT-4o', provider: 'openrouter', ctx: '128k', color: '#50a878' },
      { id: 'openai/gpt-4.5-preview', name: 'GPT-4.5 Preview', provider: 'openrouter', ctx: '128k', color: '#50a878' },
      { id: 'openai/o3-mini', name: 'o3-mini', provider: 'openrouter', ctx: '200k', color: '#50a878' },
      { id: 'google/gemini-2.5-pro-preview', name: 'Gemini 2.5 Pro', provider: 'openrouter', ctx: '1M', color: '#5080c8' },
      { id: 'google/gemini-2.0-flash-001', name: 'Gemini 2.0 Flash', provider: 'openrouter', ctx: '1M', color: '#5080c8' },
      { id: 'meta-llama/llama-3.3-70b-instruct', name: 'Llama 3.3 70B', provider: 'openrouter', ctx: '128k', color: '#8050c8' },
      { id: 'mistralai/mistral-large', name: 'Mistral Large', provider: 'openrouter', ctx: '128k', color: '#c85078' },
      { id: 'deepseek/deepseek-r1', name: 'DeepSeek R1', provider: 'openrouter', ctx: '128k', color: '#50b8c8' },
      { id: 'deepseek/deepseek-v3', name: 'DeepSeek V3', provider: 'openrouter', ctx: '128k', color: '#50b8c8' },
      { id: 'x-ai/grok-2-1212', name: 'Grok 2', provider: 'openrouter', ctx: '32k', color: '#a0a0a0' },
      // Anthropic Direct
      { id: 'claude-opus-4-20250514', name: 'Claude Opus 4', provider: 'anthropic', ctx: '200k', color: '#d4a574' },
      { id: 'claude-sonnet-4-20250514', name: 'Claude Sonnet 4', provider: 'anthropic', ctx: '200k', color: '#d4a574' },
      { id: 'claude-haiku-3-5-20250520', name: 'Claude Haiku 3.5', provider: 'anthropic', ctx: '200k', color: '#d4a574' },
      // OpenAI Direct
      { id: 'gpt-4o', name: 'GPT-4o', provider: 'openai', ctx: '128k', color: '#10a37f' },
      { id: 'gpt-4o-mini', name: 'GPT-4o Mini', provider: 'openai', ctx: '128k', color: '#10a37f' },
      { id: 'gpt-4.5', name: 'GPT-4.5', provider: 'openai', ctx: '128k', color: '#10a37f' },
      // Google Direct
      { id: 'gemini-2.5-pro-preview-06-05', name: 'Gemini 2.5 Pro', provider: 'google', ctx: '1M', color: '#4285f4' },
      { id: 'gemini-2.0-flash-001', name: 'Gemini 2.0 Flash', provider: 'google', ctx: '1M', color: '#4285f4' },
      { id: 'gemini-1.5-flash-8b', name: 'Gemini 1.5 Flash 8B', provider: 'google', ctx: '1M', color: '#4285f4' },
      { id: 'gemini-1.5-flash', name: 'Gemini 1.5 Flash', provider: 'google', ctx: '1M', color: '#4285f4' },
      { id: 'gemini-1.5-pro', name: 'Gemini 1.5 Pro', provider: 'google', ctx: '2M', color: '#4285f4' },
      // LM Studio (Local)
      { id: 'local', name: 'Load model in LM Studio, then click Test', provider: 'lmstudio', ctx: 'varies', color: '#888888' },
    ];

    // ═══════════════════════════════════════════════════════════
    // CUSTOM PROMPT TEMPLATES (GLOBAL)
    // ═══════════════════════════════════════════════════════════

    function getCustomTemplates() {
      try {
        return JSON.parse(localStorage.getItem('na_custom_templates')) || {};
      } catch { return {}; }
    }

    function saveCustomTemplates(templates) {
      localStorage.setItem('na_custom_templates', JSON.stringify(templates));
    }

    function getCustomTemplatesForCategory(catId) {
      const all = getCustomTemplates();
      return all[catId] || [];
    }

    function addCustomTemplate(catId, template) {
      const all = getCustomTemplates();
      if (!all[catId]) all[catId] = [];
      template.id = 'custom-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6);
      all[catId].push(template);
      saveCustomTemplates(all);
      return template.id;
    }

    function updateCustomTemplate(catId, templateId, template) {
      const all = getCustomTemplates();
      if (!all[catId]) return false;
      const idx = all[catId].findIndex(t => t.id === templateId);
      if (idx === -1) return false;
      template.id = templateId;
      all[catId][idx] = template;
      saveCustomTemplates(all);
      return true;
    }

    function deleteCustomTemplate(catId, templateId) {
      const all = getCustomTemplates();
      if (!all[catId]) return false;
      all[catId] = all[catId].filter(t => t.id !== templateId);
      saveCustomTemplates(all);
      return true;
    }

    function getAllCustomTemplates() {
      return getCustomTemplates();
    }

    function importCustomTemplates(jsonData, merge) {
      const imported = JSON.parse(jsonData);
      const all = merge ? getCustomTemplates() : {};
      const cats = ['character', 'world', 'location', 'developmental', 'copy', 'line', 'punch', 'paragraph', 'custom'];
      cats.forEach(cat => {
        if (imported[cat] && Array.isArray(imported[cat])) {
          if (!all[cat]) all[cat] = [];
          imported[cat].forEach(t => {
            if (typeof t.id !== 'string' || typeof t.title !== 'string' || typeof t.tpl !== 'string' || !Array.isArray(t.fields)) return;
            if (!all[cat].find(existing => existing.id === t.id)) {
              all[cat].push(t);
            }
          });
        }
      });
      saveCustomTemplates(all);
    }

    function exportCustomTemplates() {
      return JSON.stringify(getCustomTemplates(), null, 2);
    }

    // ═══════════════════════════════════════════════════════════
    // CHARACTER RELATIONSHIP MAP
    // ═══════════════════════════════════════════════════════════

    const DEFAULT_RELATIONSHIP_TYPES = [
      { id: 'family', label: 'Family', color: '#e07070' },
      { id: 'friend', label: 'Friend', color: '#70c0a0' },
      { id: 'enemy', label: 'Enemy', color: '#8b3030' },
      { id: 'romantic', label: 'Romantic', color: '#d87093' },
      { id: 'mentor', label: 'Mentor', color: '#70b0e0' },
      { id: 'rival', label: 'Rival', color: '#e0a070' },
      { id: 'ally', label: 'Ally', color: '#70a0a0' },
    ];

    function getRelationshipTypes() {
      try {
        const saved = JSON.parse(localStorage.getItem('na_relationship_types'));
        if (saved && saved.length > 0) return saved;
      } catch { }
      return [...DEFAULT_RELATIONSHIP_TYPES, { id: 'custom', label: 'Custom', color: '#c8a660' }];
    }

    function saveRelationshipTypes(types) {
      localStorage.setItem('na_relationship_types', JSON.stringify(types));
    }

    function getBookRelationships() {
      return APP.book?.relationships || [];
    }

    function saveBookRelationships(rels) {
      if (!APP.book) APP.book = {};
      APP.book.relationships = rels;
      saveState();
    }

    function addRelationship(char1Id, char2Id, type, description, bidirectional) {
      const rels = getBookRelationships();
      const id = 'rel-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6);
      rels.push({ id, char1Id, char2Id, type, description, bidirectional });
      saveBookRelationships(rels);
      return id;
    }

    function updateRelationship(id, updates) {
      const rels = getBookRelationships();
      const idx = rels.findIndex(r => r.id === id);
      if (idx !== -1) {
        rels[idx] = { ...rels[idx], ...updates };
        saveBookRelationships(rels);
        return true;
      }
      return false;
    }

    function deleteRelationship(id) {
      const rels = getBookRelationships();
      saveBookRelationships(rels.filter(r => r.id !== id));
    }

    function getCharacterById(id) {
      return (APP.book?.chars || []).find(c => c.id === id);
    }

    function getRelationshipTypeColor(typeId) {
      const types = getRelationshipTypes();
      const t = types.find(t => t.id === typeId);
      return t ? t.color : '#c8a660';
    }

    // ═══════════════════════════════════════════════════════════
    // TIMELINE (Series Level)
    // ═══════════════════════════════════════════════════════════

    const DEFAULT_EVENT_TYPES = [
      { id: 'major', label: 'Major Plot', color: '#c8a660' },
      { id: 'subplot', label: 'Subplot', color: '#70b0e0' },
      { id: 'arc', label: 'Character Arc', color: '#70c0a0' },
      { id: 'world', label: 'World Event', color: '#a070c0' },
      { id: 'conflict', label: 'Conflict', color: '#e07070' },
      { id: 'resolution', label: 'Resolution', color: '#70a0a0' },
    ];

    function getEventTypes() {
      try {
        const saved = JSON.parse(localStorage.getItem('na_event_types'));
        if (saved && saved.length > 0) return saved;
      } catch { }
      return [...DEFAULT_EVENT_TYPES];
    }

    function getEventTypeColor(typeId) {
      const types = getEventTypes();
      const t = types.find(t => t.id === typeId);
      return t ? t.color : '#c8a660';
    }

    function getSeriesTimeline() {
      return APP.series?.timeline || [];
    }

    function saveSeriesTimeline(timeline) {
      if (!APP.series) APP.series = { name: '', subName: '', bible: mkSec() };
      APP.series.timeline = timeline;
      saveState();
    }

    function addTimelineEvent(title, description, eventType, bookId, chapterId, date) {
      const timeline = getSeriesTimeline();
      const id = 'event-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6);
      timeline.push({ id, title, description, eventType, bookId, chapterId, date, order: timeline.length });
      saveSeriesTimeline(timeline);
      return id;
    }

    function updateTimelineEvent(id, updates) {
      const timeline = getSeriesTimeline();
      const idx = timeline.findIndex(e => e.id === id);
      if (idx !== -1) {
        timeline[idx] = { ...timeline[idx], ...updates };
        saveSeriesTimeline(timeline);
        return true;
      }
      return false;
    }

    function deleteTimelineEvent(id) {
      saveSeriesTimeline(getSeriesTimeline().filter(e => e.id !== id));
    }

    const CATEGORIES = [
      { id: 'character', label: 'Character', icon: '◑', color: '#e07070' },
      { id: 'world', label: 'World Building', icon: '◒', color: '#70b0e0' },
      { id: 'location', label: 'Locations', icon: '◓', color: '#70c0a0' },
      { id: 'developmental', label: 'Developmental', icon: '◉', color: '#8fbc8b' },
      { id: 'copy', label: 'Copy Editor', icon: '◎', color: '#87afc7' },
      { id: 'line', label: 'Line Editor', icon: '◐', color: '#c987c7' },
      { id: 'punch', label: 'Impact & Punch', icon: '◆', color: '#e0b870' },
      { id: 'paragraph', label: 'Paragraph', icon: '¶', color: '#d8a098' },
      { id: 'sentence', label: 'Sentence', icon: '—', color: '#98c8d8' },
      { id: 'chapter', label: 'Chapter Review', icon: '❒', color: '#a098d8' },
      { id: 'style', label: 'Style Analysis', icon: '◈', color: '#c9a96e' },
      { id: 'custom', label: 'Custom', icon: '✎', color: '#c8a660' },
    ];

    const CATEGORY_SECTIONS = [
      { id: 'create', label: 'Create', cats: ['character', 'world', 'location'] },
      { id: 'editors', label: 'Editors', cats: ['developmental', 'copy', 'line'] },
      { id: 'improve', label: 'Improve', cats: ['punch', 'paragraph', 'sentence'] },
      { id: 'polish', label: 'Polish', cats: ['chapter', 'style', 'custom'] },
    ];

    const GENRE_PRESETS = {
      'fantasy': 'High fantasy with magic systems, world-building focus, epic scope',
      'sci-fi': 'Science fiction with technology focus, futuristic settings',
      'thriller': 'Fast-paced, high stakes, tension-driven narrative',
      'romance': 'Relationship-focused, emotional stakes, character-driven',
      'horror': 'Atmospheric, fear, psychological tension',
      'literary': 'Literary fiction with prose style, thematic depth',
      'mystery': 'Puzzle-driven, clues and red herrings, detective POV',
      'adventure': 'Action-driven, external stakes, fast plot',
      'custom': 'Custom reference text'
    };

    const WRITING_PREFS_DEFAULT = {
      pov: 'mixed',
      innerMonologue: false,
      punctuation: true,
      avoidEmDashes: true,
      avoidSemicolons: true,
      avoidColons: true,
      avoidTriplet: true,
      avoidGoldenSunset: true,
      avoidInspirationalPivot: true,
      avoidShowDontSummarize: true,
      avoidFavoriteWords: true,
      avoidFloweryProse: true,
      avoidAdjectiveOverload: true,
      varySentenceStructure: true,
      filterWords: true,
      snappyDialogue: true,
      specificOverGeneric: true,
      doNotUseWords: ''
    };

    // ═══════════════════════════════════════════════════════════
    // PROMPT DATA
    // ═══════════════════════════════════════════════════════════
    // Each prompt: { id, title, desc, fields:[{key,label,type}], tpl(fields)=>string }
    // type: 'text' | 'textarea'
    // The first 'textarea' field is the "primary" field used for pipeline piping

    const PROMPTS = {
      style: [
        {
          id: 's1', title: 'Capture My Writing DNA', desc: 'Deep analysis of your unique voice and style fingerprint',
          fields: [{ key: 'sample', label: 'Paste 3–5 pages of your best writing', type: 'textarea' }],
          tpl: (f) => `You are a literary analyst specializing in author voice. Analyze the following writing sample and produce a comprehensive "Style DNA" document.

Cover:
- Sentence structure patterns (average length, variation, rhythm)
- Vocabulary tier and register (literary, colloquial, technical mix)
- Dialogue style (how characters speak, tags, beats)
- POV handling and narrative distance
- Pacing signature (scene vs. summary ratio)
- Emotional tone and how you convey interiority
- Recurring stylistic tics (good and ones to watch)
- 3–5 "rules" that seem to govern the prose instinctively

End with a one-paragraph "author voice statement" to use as a north star.

WRITING SAMPLE:
---
${f.sample || '[PASTE YOUR WRITING SAMPLE HERE]'}
---`},
        {
          id: 's2', title: 'Consistency Check Against My Style', desc: 'Flag passages that drift from your established voice',
          fields: [{ key: 'style_doc', label: 'Your Style DNA document', type: 'textarea' }, { key: 'new_text', label: 'New text to check', type: 'textarea' }],
          tpl: (f) => `You are a line editor protecting an author's voice. Using the Style DNA below, analyze the new text and flag any passages that drift from the established voice.

For each flag:
- Quote the offending phrase/sentence
- Explain what rule or pattern it breaks
- Suggest a corrected version in the author's voice

STYLE DNA:
---
${f.style_doc || '[PASTE STYLE DNA]'}
---
NEW TEXT:
---
${f.new_text || '[PASTE NEW TEXT]'}
---`},
      ],
      developmental: [
        {
          id: 'd1', title: 'Chapter Structure Audit', desc: 'Big-picture analysis of a chapter\'s structural integrity',
          fields: [{ key: 'synopsis', label: 'Story context / where we are in the novel', type: 'text' }, { key: 'chapter', label: 'Paste the chapter (or leave empty to use Chapter tab)', type: 'textarea' }],
          tpl: (f) => {
            const chapterText = f.chapter?.trim() || '[SEE CONTEXT SECTION ABOVE FOR CHAPTER TEXT]';
            return `You are a world-class developmental editor. Read this chapter and provide a structural audit.

Analyze:
1. **Scene Goals** — Does every scene have a clear goal, conflict, and outcome?
2. **Pacing** — Where does momentum stall? Where does it rush?
3. **Stakes** — Are the stakes clear and felt? Do they escalate?
4. **Character Agency** — Are characters driving the plot or being dragged?
5. **Promise & Payoff** — What does this chapter promise? Does it deliver?
6. **Structural Issues** — Plot holes, logic gaps, continuity problems?
7. **Chapter Arc** — Does the chapter have its own satisfying micro-arc?

End with: Top 3 Priority Fixes ranked by impact.

STORY CONTEXT: ${f.synopsis || '[CONTEXT]'}
CHAPTER:
---
${chapterText}
---`;
          }
        },
        {
          id: 'd2', title: 'Pacing Analysis', desc: 'Scene-by-scene pacing map with recommendations',
          fields: [{ key: 'text', label: 'Paste the text (or leave empty to use Chapter tab)', type: 'textarea' }],
          tpl: (f) => {
            const text = f.text?.trim() || '[SEE CONTEXT SECTION ABOVE FOR CHAPTER TEXT]';
            return `You are a developmental editor specializing in narrative pacing. Create a pacing map of this text.

For each distinct scene or section:
- Label it (Scene 1, Scene 2, etc.)
- Assign a pace rating: Crawl / Walk / Jog / Run / Sprint
- One sentence on what drives or kills momentum here
- Flag any pace whiplash (jarring transitions between speeds)

Then provide:
- Overall pacing assessment
- The 2–3 most critical pacing interventions
- Specific suggestions for slow sections
- Specific suggestions for rushed sections

TEXT:
---
${text}
---`;
          }
        },
        {
          id: 'd3', title: 'Character Arc Tracker', desc: 'Track emotional and behavioral change across a section',
          fields: [{ key: 'character', label: 'Character name', type: 'text' }, { key: 'arc_goal', label: 'Intended arc in this section (optional)', type: 'text' }, { key: 'text', label: 'Paste the text (or leave empty to use Chapter tab)', type: 'textarea' }],
          tpl: (f) => {
            const text = f.text?.trim() || '[SEE CONTEXT SECTION ABOVE FOR CHAPTER TEXT]';
            return `You are a developmental editor analyzing character arc. Track ${f.character || '[CHARACTER]'}'s internal journey through this text.

Map:
- Their emotional state at the START
- Key moments where their internal world shifts (quote the line, explain the shift)
- Their emotional state at the END
- Whether their external actions align with their internal state
- Any moments where they act inconsistently without earned reason

Intended arc: ${f.arc_goal || 'Not specified — infer from context'}

Assess: Is the arc visible and felt, or merely stated? What's the single biggest gap?

TEXT:
---
${text}
---`;
          }
        },
      ],
      copy: [
        {
          id: 'c1', title: 'Full Copy Edit Pass', desc: 'Grammar, consistency, fact-checking, and correctness',
          fields: [{ key: 'text', label: 'Paste the text (or leave empty to use Chapter tab)', type: 'textarea' }],
          tpl: (f) => {
            const text = f.text?.trim() || '[SEE CONTEXT SECTION ABOVE FOR CHAPTER TEXT]';
            return `You are a meticulous copy editor. Perform a full copy edit pass.

Flag and correct:
1. Grammar & Syntax — errors, unintentional fragments, run-ons
2. Punctuation — commas, em-dashes, ellipses, dialogue punctuation
3. Spelling — typos, homophones, name consistency
4. Continuity — character names, physical descriptions, timeline logic
5. Word Repetition — same word used too close together
6. Tense Consistency — any unintended tense shifts
7. POV Consistency — head-hopping or POV violations

Format: numbered list. For each: Quote original → corrected version → one-line explanation.
Preserve intentional style choices (fragments for effect, unconventional punctuation for voice).

TEXT:
---
${text}
---`;
          }
        },
        {
          id: 'c2', title: 'Dialogue Mechanics Check', desc: 'Audit all dialogue tags, beats, and punctuation',
          fields: [{ key: 'text', label: 'Paste the text (or leave empty to use Chapter tab)', type: 'textarea' }],
          tpl: (f) => {
            const text = f.text?.trim() || '[SEE CONTEXT SECTION ABOVE FOR CHAPTER TEXT]';
            return `You are a copy editor specializing in dialogue. Audit all dialogue in this text.

Check for:
- Incorrect dialogue punctuation (comma vs. period before/after tags)
- Overuse of "said" replacements — flag where "said" would be stronger
- Missing or unnecessary dialogue tags
- Action beats that could replace tags for better effect
- Characters speaking in ways inconsistent with their established voice
- Dialogue that sounds unnatural or on-the-nose

Present as: original → corrected format.

TEXT:
---
${text}
---`;
          }
        },
      ],
      line: [
        {
          id: 'l1', title: 'Line Edit for Clarity & Flow', desc: 'Sharpen prose without changing the author\'s voice',
          fields: [{ key: 'text', label: 'Paste the text (or leave empty to use Chapter tab)', type: 'textarea' }],
          tpl: (f) => {
            const text = f.text?.trim() || '[SEE CONTEXT SECTION ABOVE FOR CHAPTER TEXT]';
            return `You are a line editor. Cardinal rule: never sacrifice the author's voice for clarity.

Target:
- Sentences that are tangled or require re-reading
- Abrupt or muddy transitions
- Passive constructions that drain energy (flag — don't blindly fix)
- Vague, abstract language where concrete detail would land harder
- Filler phrases: "it was," "there were," "began to"
- Overwritten moments that undercut their own emotional impact

Present as: Original → Suggested Revision + one-line note on why. Always note if original is a valid style choice.

TEXT:
---
${text}
---`;
          }
        },
        {
          id: 'l2', title: 'Show vs. Tell Audit', desc: 'Find telling that should be showing, and vice versa',
          fields: [{ key: 'text', label: 'Paste the text (or leave empty to use Chapter tab)', type: 'textarea' }],
          tpl: (f) => {
            const text = f.text?.trim() || '[SEE CONTEXT SECTION ABOVE FOR CHAPTER TEXT]';
            return `You are a line editor. Audit this text for show vs. tell balance.

TELLING TO FLAG Abstract emotional statements, (needs showing): character trait announcements, summarized reactions that could be dramatized.

SHOWING TO FLAG (could be told): Scenes over-dramatized when a quick summary would serve better. Not all telling is bad — flag only where it actively weakens impact.

For each flag: Quote → label (NEEDS SHOWING or OVER-SHOWN) → rewritten example.

End with: The ratio feels [too much telling / balanced / too much showing] because ___

TEXT:
---
${text}
---`;
          }
        },
        {
          id: 'l3', title: 'Sensory Depth Pass', desc: 'Identify where sensory detail is missing or underdeveloped',
          fields: [{ key: 'text', label: 'Paste the text (or leave empty to use Chapter tab)', type: 'textarea' }],
          tpl: (f) => {
            const text = f.text?.trim() || '[SEE CONTEXT SECTION ABOVE FOR CHAPTER TEXT]';
            return `You are a line editor. Do a sensory depth pass on this text.

Map which senses are active in each scene: sight, sound, smell, touch, taste, proprioception, temperature.

For each scene or section:
- List which senses are present
- Flag which are absent or underused where they'd deepen immersion
- Identify passages that feel visually over-loaded
- Suggest 2–3 specific sensory additions (concrete, not generic) that would most elevate the scene

TEXT:
---
${text}
---`;
          }
        },
      ],
      character: [
        {
          id: 'ch1', title: 'New Character Creation', desc: 'Build a fully realized character from concept',
          fields: [{ key: 'concept', label: 'Character concept / role in story', type: 'text' }, { key: 'genre', label: 'Genre and tone', type: 'text' }, { key: 'context', label: 'Relevant story context', type: 'text' }],
          tpl: (f) => `You are a creative collaborator and character development expert.

Concept: ${f.concept || '[CHARACTER CONCEPT]'}
Genre/tone: ${f.genre || '[GENRE]'}
Context: ${f.context || '[CONTEXT]'}

Develop:
1. Core Identity — Name options, age, background, appearance (distinctive, not generic)
2. Psychology — Core wound, deepest fear, greatest desire, fatal flaw
3. Voice — How they speak (rhythm, vocabulary, verbal tics, what they never say)
4. Contradiction — The internal tension that makes them human
5. Relationships — How they relate to power, love, strangers
6. Arc Potential — What they need to learn, what they'll resist
7. Scene Presence — How they enter a room, how they behave under pressure
8. Three Revealing Details — Small, specific details that instantly characterize them

End with: One sentence capturing their essence — their through-line.`},
        {
          id: 'ch2', title: 'Character Voice Workshop', desc: 'Develop and test a character\'s distinct dialogue voice',
          fields: [{ key: 'character_desc', label: 'Character description and background', type: 'textarea' }, { key: 'scene', label: 'Scene context for the dialogue', type: 'text' }],
          tpl: (f) => `You are a dialogue coach and character voice specialist.

CHARACTER:
${f.character_desc || '[CHARACTER DESCRIPTION]'}

SCENE CONTEXT: ${f.scene || '[SCENE]'}

First, define this character's Voice Rules:
- Sentence length tendency (clipped? flowing? interrupted?)
- Vocabulary level and register
- What they use instead of saying things directly
- What topics they deflect from and how
- Their emotional tell (how does stress/joy/anger show in speech?)
- 3 phrases they'd use; 3 phrases they'd NEVER use

Then write 8–10 lines of sample dialogue across different emotional registers: neutral, defensive, excited, lying, grieving.

Finally: write the same scene beat twice — once in their voice, once "generic" — to show the contrast.`},
        {
          id: 'ch3', title: 'Character Consistency Audit', desc: 'Check if a character\'s behavior is consistent and motivated',
          fields: [{ key: 'character', label: 'Character name', type: 'text' }, { key: 'profile', label: 'Brief character profile / known traits', type: 'textarea' }, { key: 'text', label: 'Text to audit', type: 'textarea' }],
          tpl: (f) => `You are a developmental editor checking character consistency.

CHARACTER: ${f.character || '[CHARACTER]'}
PROFILE: ${f.profile || '[PROFILE]'}

Flag:
- Any action, decision, or reaction inconsistent with established character
- Dialogue that sounds like a different character or authorial voice
- Moments where the character is too conveniently helpful/obstructive
- Emotional reactions that aren't earned or set up
- Inconsistency in stated beliefs vs. behavior

For each flag: quote it, explain the inconsistency, suggest a fix.

TEXT:
---
${f.text || '[PASTE TEXT]'}
---`},
      ],
      world: [
        {
          id: 'w1', title: 'World Building Bible Entry', desc: 'Create a structured reference entry for any world element',
          fields: [{ key: 'element', label: 'Element to document (magic system, government, etc.)', type: 'text' }, { key: 'what_i_know', label: 'What you already know about it', type: 'textarea' }, { key: 'genre', label: 'Genre / tone', type: 'text' }],
          tpl: (f) => `You are a world-building consultant.

ELEMENT: ${f.element || '[ELEMENT]'}
GENRE/TONE: ${f.genre || '[GENRE]'}
WHAT I KNOW SO FAR:
${f.what_i_know || '[YOUR NOTES]'}

Develop into a full World Bible entry:
1. Core Concept — One clear sentence definition
2. Rules & Logic — Internal laws (consistent, exploitable, with costs)
3. History & Origin — How it came to be, key turning points
4. Current State — How it exists in the world now
5. Factions & Perspectives — How different groups relate to this element
6. Sensory Reality — What it looks, sounds, smells, feels like
7. Story Potential — 5 conflict seeds this element could generate
8. Consistency Traps — Questions to answer to avoid plot holes

Flag any logical contradictions in what I've provided.`},
        {
          id: 'w2', title: 'World Consistency Check', desc: 'Audit a passage for world-building errors',
          fields: [{ key: 'world_rules', label: 'Relevant world rules / bible notes', type: 'textarea' }, { key: 'text', label: 'Passage to check', type: 'textarea' }],
          tpl: (f) => `You are a continuity editor specializing in world-building. Check this passage against the established world rules.

WORLD RULES:
---
${f.world_rules || '[PASTE WORLD RULES]'}
---

Check for:
- Violations of established world rules
- Technology, magic, or social structures used inconsistently
- Anachronistic language or concepts for this world
- Details that contradict earlier established facts
- Missed opportunities to reinforce world-building organically

Present as: Issue → Quote → Explanation → Suggested Fix

TEXT:
---
${f.text || '[PASTE TEXT]'}
---`},
      ],
      location: [
        {
          id: 'loc1', title: 'Location Deep Build', desc: 'Develop a location into a vivid, story-ready setting',
          fields: [{ key: 'location', label: 'Location name and basic concept', type: 'text' }, { key: 'role', label: 'Its narrative role', type: 'text' }, { key: 'genre', label: 'Genre / tone', type: 'text' }],
          tpl: (f) => `You are a setting development specialist.

LOCATION: ${f.location || '[LOCATION]'}
NARRATIVE ROLE: ${f.role || '[ROLE]'}
GENRE/TONE: ${f.genre || '[GENRE]'}

Develop:
1. Establishing Shot — One paragraph introduction as a reader would first encounter it
2. Sensory Atlas — Dominant impressions across all senses, time-of-day variations
3. History Embedded in Space — What does this place carry from its past?
4. Living Ecosystem — What lives here? What rhythms govern it?
5. Emotional Register — What mood does it impose on characters?
6. Scene Potential — 4 different scene types this location enables
7. Symbolic Resonance — What could this place mean thematically?
8. 3 Unique Details — Specific, unusual details no other location would have

End with: A single image that captures the essence of this place.`},
        {
          id: 'loc2', title: 'Location Scene Enhancement', desc: 'Deepen an existing location scene for atmosphere and immersion',
          fields: [{ key: 'text', label: 'Paste the location scene', type: 'textarea' }],
          tpl: (f) => `You are a line editor specializing in setting and atmosphere.

Assess:
1. Is the setting earning its place on the page, or is it wallpaper?
2. What sensory channels are underused?
3. Does the setting reflect or contrast the POV character's emotional state?
4. Are there missed opportunities for the setting to do story work?
5. Is there any over-description slowing the scene?

Then: Provide a rewritten version of the most underdeveloped descriptive passage, showing how to deepen it without adding length.

TEXT:
---
${f.text || '[PASTE TEXT]'}
---`},
      ],
      punch: [
        {
          id: 'p1', title: 'Impact Rewrite — Multiple Options', desc: 'Get 4 punchy rewrites of any passage',
          fields: [{ key: 'text', label: 'Paste the passage to punch up', type: 'textarea' }, { key: 'goal', label: 'What should this passage DO emotionally? (optional)', type: 'text' }],
          tpl: (f) => `You are a master prose stylist. Rewrite this passage 4 times, each time using a different technique to maximize impact.

ORIGINAL:
---
${f.text || '[PASTE PASSAGE]'}
---
Emotional goal: ${f.goal || 'Infer from context'}

REWRITE 1 — Compression: Strip it to its most essential form. Every word earns its place.
REWRITE 2 — Rhythm: Deliberate sentence-length variation for emotional punch. Short sentences land blows.
REWRITE 3 — Concrete Detail: Replace abstractions with specific, physical, visceral detail.
REWRITE 4 — Subtext: Pull back. Let the emotion live beneath the surface. Trust the reader.

After each rewrite: one sentence on what you sacrificed and what you gained.
Then: Which approach best serves this moment and why?`},
        {
          id: 'p2', title: 'Opening Line Workshop', desc: 'Generate and critique multiple opening line options',
          fields: [{ key: 'chapter_summary', label: 'What this chapter/scene is about', type: 'text' }, { key: 'current_opening', label: 'Your current opening line (optional)', type: 'text' }, { key: 'tone', label: 'Desired tone', type: 'text' }],
          tpl: (f) => `You are a master of first lines.

WHAT THIS CHAPTER IS ABOUT: ${f.chapter_summary || '[SUMMARY]'}
DESIRED TONE: ${f.tone || '[TONE]'}
CURRENT OPENING: ${f.current_opening || 'None yet'}

Generate 8 different opening lines, each using a different technique:
1. In medias res — action already happening
2. Disorientation — reader doesn't yet know where they are
3. Voice-first — pure character voice
4. Sensory ambush — lead with a striking sense impression
5. Paradox or contradiction — something that doesn't add up
6. The ordinary made strange
7. The last line of the previous scene as echo
8. Pure momentum — the first domino that starts everything falling

For each: one sentence on what it promises the reader.
Then: If forced to pick one, it would be ___ because ___.`},
        {
          id: 'p3', title: 'Closing Line Workshop', desc: 'Craft a chapter-ending line with maximum resonance',
          fields: [{ key: 'chapter_summary', label: 'What happened in this chapter', type: 'text' }, { key: 'what_comes_next', label: 'What\'s coming next (briefly)', type: 'text' }, { key: 'current_closing', label: 'Your current closing line (optional)', type: 'text' }],
          tpl: (f) => `You are a prose stylist specializing in chapter endings.

WHAT HAPPENED: ${f.chapter_summary || '[SUMMARY]'}
WHAT\'S COMING: ${f.what_comes_next || '[NEXT]'}
CURRENT CLOSING: ${f.current_closing || 'None yet'}

Generate 6 closing line options:
1. The gut-punch — an image or fact that lands like a blow
2. The quiet devastation — understated, the weight arrives after
3. The question — leaves the reader unable to stop thinking
4. The reframe — changes how the reader sees everything before it
5. The echo — callbacks a word or image from the chapter's opening
6. The door — ends mid-motion, pure momentum into the next chapter

For each: what emotion it leaves behind.
Then: My recommendation for this chapter's emotional needs is ___ because ___.`},
      ],
      chapter: [
        {
          id: 'cr0', title: 'Overused Phrases & Words', desc: 'Find repetitive or clichéd language and suggest alternatives',
          fields: [{ key: 'context', label: 'Novel context / character names / setting notes', type: 'text' }, { key: 'chapter', label: 'Paste the chapter (or leave empty to use Chapter tab)', type: 'textarea' }],
          tpl: (f) => {
            const chapterText = f.chapter?.trim() || '[SEE CONTEXT SECTION ABOVE FOR CHAPTER TEXT]';
            return `You are a prose editor specializing in eliminating overused, repetitive, and clichéd language.

NOVEL CONTEXT: ${f.context || '[CONTEXT]'}

Scan the following chapter for:
1. **Repeated words** — Words used too frequently (especially adjectives, adverbs, verbs)
2. **Clichés** — Overused phrases and expressions
3. **Filter words** — "He saw", "She heard", "He felt", "She noticed" etc.
4. **Weak constructions** — "There was", "It was", "He was", "She had"
5. **Redundancies** — Words or phrases that say the same thing twice
6. **Said-isms** — Overuse of "said" or weak dialogue tags
7. ** Telling instead of Showing** — Instances where showing would be stronger

For each issue found, provide:
- The problematic phrase (quoted exactly)
- The line number or location
- Why it's problematic
- A suggested replacement (or "cut" if it can be removed)

Finally, provide a revised version of the first 500 words with your corrections applied.

CHAPTER:
---
${chapterText}
---`;
          }
        },
        {
          id: 'cr1a', title: 'Pronoun Usage Analysis', desc: 'Check pronoun density and sentence-start pronouns',
          fields: [{ key: 'context', label: 'Main POV character name(s)', type: 'text' }, { key: 'chapter', label: 'Paste the chapter (or leave empty to use Chapter tab)', type: 'textarea' }],
          tpl: (f) => {
            const chapterText = f.chapter?.trim() || '[SEE CONTEXT SECTION ABOVE FOR CHAPTER TEXT]';
            return `You are a prose editor specializing in varied, strong sentence construction.

Analyze the following chapter for pronoun usage patterns. The goal is to keep total pronoun usage under 15% and sentences starting with pronouns under 30%.

TARGETS:
- Total pronoun usage: under 15% of all words
- Sentence-start pronouns: under 30% of all sentences

Calculate and report:
1. **Total word count** and **total pronoun count**
2. **Pronoun density percentage** (pronouns ÷ total words × 100)
3. **Total sentences** and **sentences starting with pronouns**
4. **Initial pronoun percentage** (sentence-start pronouns ÷ total sentences × 100)

For each category, note if it passes or fails the target.

If OVER the targets, identify the specific problem sentences and provide revised versions with:
- Stronger sentence openers (action verbs, sensory details, setting, subject presence)
- Name substitutions where appropriate
- Varied sentence structures

Also identify any sentences that could be combined or restructured for better flow.

CHAPTER:
---
${chapterText}
---`;
          }
        },
        {
          id: 'cr1', title: 'Full Chapter Review', desc: 'Comprehensive editorial read covering all dimensions',
          fields: [{ key: 'context', label: 'Where are we in the novel? Stakes, what just happened', type: 'text' }, { key: 'chapter', label: 'Paste the chapter (or leave empty to use Chapter tab)', type: 'textarea' }],
          tpl: (f) => {
            const chapterText = f.chapter?.trim() || '[SEE CONTEXT SECTION ABOVE FOR CHAPTER TEXT]';
            return `You are a senior editor at a major literary publishing house. Full editorial read.

NOVEL CONTEXT: ${f.context || '[CONTEXT]'}

**THE CHAPTER IN ONE SENTENCE** — What actually happens here (not what was intended, what's on the page).

**WHAT'S WORKING** — Specific. Quote the lines or moments that are genuinely excellent.

**THE CORE ISSUE** — If there's one structural or thematic problem, name it clearly.

**SCENE BY SCENE** — Walk through each scene: Goal / Conflict / Outcome. Flag scenes that don't change anything.

**CHARACTER** — Is everyone acting like themselves? Any character doing something for plot convenience?

**PACING** — Where does it breathe well? Where does it stall or rush?

**PROSE** — Flag the 3 weakest prose moments and the 3 strongest. Be specific.

**READER EXPERIENCE** — What will the reader feel at the end? Is that what the novel needs?

**3 PRIORITY ACTIONS** — If you could only change three things, in order of impact?

CHAPTER:
---
${chapterText}
---`;
          }
        },
      ],
      paragraph: [
        {
          id: 'par1', title: 'Paragraph Dissection', desc: 'Sentence-level analysis and improvement of a single paragraph',
          fields: [{ key: 'para', label: 'Paste the paragraph', type: 'textarea' }],
          tpl: (f) => `You are a line editor. Dissect this paragraph at the sentence level.

For each sentence:
- Assess its function (advance action, reveal character, set mood, provide information?)
- Rate effectiveness: Strong / Adequate / Weak
- If Weak: explain why and provide a rewrite

Assess the paragraph as a whole:
- Does it have a clear through-line?
- Is the rhythm varied and intentional?
- Does it earn its length?
- What is the single most impactful change?

Finally: Provide a polished rewrite incorporating your best suggestions (keep the author's voice).

PARAGRAPH:
---
${f.para || '[PASTE PARAGRAPH]'}
---`},
        {
          id: 'par2', title: 'Transition Repair', desc: 'Fix a jarring or unclear transition between paragraphs or scenes',
          fields: [{ key: 'before', label: 'Paragraph/section BEFORE the transition', type: 'textarea' }, { key: 'after', label: 'Paragraph/section AFTER the transition', type: 'textarea' }],
          tpl: (f) => `You are a line editor specializing in flow and transitions. The transition between these sections isn't working. Diagnose and offer solutions.

Diagnose:
- What is the logical/emotional gap between these sections?
- Is this a tonal shift, a time jump, a POV distance change, a pace change?
- What's currently bridging them (if anything)?
- Why isn't it working?

Then provide 3 different transition options:
1. A bridging sentence or short paragraph
2. A structural fix (scene break, section break, different ending)
3. A rewrite of one or both endings/openings to create natural flow

BEFORE:
---
${f.before || '[PASTE FIRST SECTION]'}
---
AFTER:
---
${f.after || '[PASTE SECOND SECTION]'}
---`},
      ],
      sentence: [
        {
          id: 'sen1', title: 'Sentence Surgery — 5 Options', desc: 'Get five distinct rewrites of any sentence',
          fields: [{ key: 'sentence', label: 'The sentence to rewrite', type: 'textarea' }, { key: 'context', label: 'Surrounding context (1–2 sentences before/after)', type: 'textarea' }, { key: 'issue', label: 'What\'s wrong with it? (optional)', type: 'text' }],
          tpl: (f) => `You are a prose stylist. Rewrite this sentence 5 times, each version solving a different problem or pursuing a different strength.

ORIGINAL: ${f.sentence || '[PASTE SENTENCE]'}
CONTEXT: ${f.context || '[SURROUNDING CONTEXT]'}
KNOWN ISSUE: ${f.issue || 'Diagnose yourself'}

VERSION 1 — Tighter: Cut every unnecessary word. Minimum viable sentence.
VERSION 2 — Punchier rhythm: Reorder for a stronger landing. End on the word with most weight.
VERSION 3 — More concrete: Replace abstractions or vague verbs with specific, physical language.
VERSION 4 — More voice: Push the character or narrator's voice harder. Make it more "theirs."
VERSION 5 — Syntactic experiment: Try a completely different sentence structure (fragment, inversion, list, etc.)

For each: one phrase explaining what changed and why it works.`},
        {
          id: 'sen2', title: 'Verb Audit', desc: 'Replace weak or passive verbs with muscular, specific alternatives',
          fields: [{ key: 'text', label: 'Paste the text', type: 'textarea' }],
          tpl: (f) => `You are a line editor. Do a verb audit on this text.

Flag every instance of:
- "To be" constructions that could be cut or made active
- Vague motion verbs: went, came, moved, got — replace with specific action
- "Began to" / "started to" constructions — usually just cut them
- Passive voice (flag it, don't automatically fix — sometimes it's right)
- Verbs propped up by adverbs — find one strong verb instead

For each flag: Original → Suggested Verb(s) → one-word reason.
Then: A rewritten version of the 3 weakest sentences with upgraded verbs.

TEXT:
---
${f.text || '[PASTE TEXT]'}
---`},
      ],
    };

    // ═══════════════════════════════════════════════════════════
    // STATE
    // ═══════════════════════════════════════════════════════════

    function mkSec(text = '', inclusion = 'full') { return { text, inclusion } }
    function mkId() { return Date.now().toString(36) + Math.random().toString(36).slice(2) }

    const APP = {
      tab: localStorage.getItem('na_tab') || 'home',
      theme: localStorage.getItem('na_theme') || 'default',
      uiScale: parseFloat(localStorage.getItem('na_uiscale')) || 1.5,
      headerScale: parseFloat(localStorage.getItem('na_hscale')) || 1,
      provider: localStorage.getItem('na_provider') || 'openrouter',
      apiKeys: {
        openrouter: localStorage.getItem('na_key') || '',
        anthropic: localStorage.getItem('na_anthropic_key') || '',
        openai: localStorage.getItem('na_openai_key') || '',
        google: localStorage.getItem('na_google_key') || '',
        lmstudio: localStorage.getItem('na_lmstudio_key') || ''
      },
      lmstudioUrl: localStorage.getItem('na_lmstudio_url') || 'http://localhost:1234',
      get apiKey() { return this.apiKeys[this.provider] || ''; },
      model: localStorage.getItem('na_model') || 'anthropic/claude-sonnet-4-5',
      maxTokens: parseInt(localStorage.getItem('na_maxtok') || '4000'),
      writingPrefs: JSON.parse(localStorage.getItem('na_writing_prefs') || 'null') || { ...WRITING_PREFS_DEFAULT },
      genreCompare: JSON.parse(localStorage.getItem('na_genre') || 'null') || { preset: 'fantasy', customText: '' },
      series: { name: '', subName: '', bible: mkSec() },
      book: { title: '', bookNum: '', totalBooks: '', subNum: '', totalSub: '', bible: mkSec(), outline: mkSec(), chars: [{ id: mkId(), ...mkSec() }] },
      chapter: { mode: 'chapter', chapterNum: '', sceneNum: '', useFullChapters: true, fullChapters: [], breakdown: mkSec(), settings: [{ id: mkId(), ...mkSec() }] },
      prompts: { cat: localStorage.getItem('na_prompts_cat') || 'character', promptId: null, fields: {}, output: '', running: false, abortCtrl: null },
      pipeline: { mode: 'refine', steps: [], running: false, results: [], abortCtrl: null, useWritingStyle: false },
    };

    // Apply UI scale and mobile
    document.documentElement.style.setProperty('--ui-scale', APP.uiScale);
    if (APP.headerScale && APP.headerScale !== 1) {
      const h = document.getElementById('app-header');
      h.style.transform = 'scale(' + APP.headerScale + ')';
      h.style.transformOrigin = 'left center';
      h.style.height = (50 * APP.headerScale) + 'px';
      h.style.whiteSpace = 'nowrap';
    }
    if (APP.theme && APP.theme !== 'default') document.body.classList.add('theme-' + APP.theme);

    // ═══════════════════════════════════════════════════════════
    // SECURE KEY STORAGE
    // ═══════════════════════════════════════════════════════════

    let APP_KEY_PASSWORD = '';
    let SESSION_CACHED_KEYS = {};

    function getStorageMode() {
      return localStorage.getItem('na_storage_mode') || 'encrypted';
    }

    function setStorageMode(mode) {
      localStorage.setItem('na_storage_mode', mode);
      if (mode !== 'encrypted') {
        APP_KEY_PASSWORD = '';
        localStorage.removeItem('na_key_salt');
        localStorage.removeItem('na_encrypted_keys');
      }
    }

    async function generateSalt() {
      const arr = new Uint8Array(16);
      crypto.getRandomValues(arr);
      return Array.from(arr).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function deriveKey(password, salt) {
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey(
        'raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']
      );
      return crypto.subtle.deriveKey(
        { name: 'PBKDF2', salt: enc.encode(salt), iterations: 100000, hash: 'SHA-256' },
        keyMaterial, { name: 'AES-GCM', length: 256 }, false, ['encrypt', 'decrypt']
      );
    }

    async function encryptKeys(keys, password) {
      const salt = await generateSalt();
      const key = await deriveKey(password, salt);
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const enc = new TextEncoder();
      const encrypted = await crypto.subtle.encrypt(
        { name: 'AES-GCM', iv: iv }, key, enc.encode(JSON.stringify(keys))
      );
      const encryptedArr = new Uint8Array(encrypted);
      const combined = new Uint8Array(iv.length + encryptedArr.length);
      combined.set(iv);
      combined.set(encryptedArr, iv.length);
      return JSON.stringify({ salt: salt, data: Array.from(combined) });
    }

    async function decryptKeys(encryptedBlob, password) {
      const { salt, data } = JSON.parse(encryptedBlob);
      const combined = new Uint8Array(data);
      const iv = combined.slice(0, 12);
      const encrypted = combined.slice(12);
      const key = await deriveKey(password, salt);
      const dec = new TextDecoder();
      const decrypted = await crypto.subtle.decrypt(
        { name: 'AES-GCM', iv: iv }, key, encrypted
      );
      return JSON.parse(dec.decode(decrypted));
    }

    function getAllApiKeys() {
      return {
        openrouter: APP.apiKeys.openrouter,
        anthropic: APP.apiKeys.anthropic,
        openai: APP.apiKeys.openai,
        google: APP.apiKeys.google,
        lmstudio: APP.apiKeys.lmstudio
      };
    }

    function setAllApiKeys(keys) {
      APP.apiKeys.openrouter = keys.openrouter || '';
      APP.apiKeys.anthropic = keys.anthropic || '';
      APP.apiKeys.openai = keys.openai || '';
      APP.apiKeys.google = keys.google || '';
      APP.apiKeys.lmstudio = keys.lmstudio || '';
    }

    async function saveKeysSecurely(password) {
      const mode = getStorageMode();
      const keys = getAllApiKeys();
      if (mode === 'plaintext') {
        localStorage.setItem('na_key', keys.openrouter);
        localStorage.setItem('na_anthropic_key', keys.anthropic);
        localStorage.setItem('na_openai_key', keys.openai);
        localStorage.setItem('na_google_key', keys.google);
        localStorage.setItem('na_lmstudio_key', keys.lmstudio);
      } else if (mode === 'session') {
        sessionStorage.setItem('na_key', keys.openrouter);
        sessionStorage.setItem('na_anthropic_key', keys.anthropic);
        sessionStorage.setItem('na_openai_key', keys.openai);
        sessionStorage.setItem('na_google_key', keys.google);
        sessionStorage.setItem('na_lmstudio_key', keys.lmstudio);
      } else if (mode === 'encrypted') {
        const encrypted = await encryptKeys(keys, password);
        localStorage.setItem('na_key_salt', 'set');
        localStorage.setItem('na_encrypted_keys', encrypted);
        APP_KEY_PASSWORD = password;
      }
    }

    async function loadKeysByMode() {
      const mode = getStorageMode();
      if (mode === 'prompt') {
        return { openrouter: '', anthropic: '', openai: '', google: '', lmstudio: '' };
      } else if (mode === 'session') {
        return {
          openrouter: sessionStorage.getItem('na_key') || '',
          anthropic: sessionStorage.getItem('na_anthropic_key') || '',
          openai: sessionStorage.getItem('na_openai_key') || '',
          google: sessionStorage.getItem('na_google_key') || '',
          lmstudio: sessionStorage.getItem('na_lmstudio_key') || ''
        };
      } else if (mode === 'encrypted') {
        const encrypted = localStorage.getItem('na_encrypted_keys');
        if (encrypted && APP_KEY_PASSWORD) {
          try {
            return await decryptKeys(encrypted, APP_KEY_PASSWORD);
          } catch (e) {
            console.error('Failed to decrypt keys:', e);
            return { openrouter: '', anthropic: '', openai: '', google: '', lmstudio: '' };
          }
        }
        return { openrouter: '', anthropic: '', openai: '', google: '', lmstudio: '' };
      }
      return {
        openrouter: localStorage.getItem('na_key') || '',
        anthropic: localStorage.getItem('na_anthropic_key') || '',
        openai: localStorage.getItem('na_openai_key') || '',
        google: localStorage.getItem('na_google_key') || '',
        lmstudio: localStorage.getItem('na_lmstudio_key') || ''
      };
    }

    function isKeysLocked() {
      return getStorageMode() === 'encrypted' && !APP_KEY_PASSWORD;
    }

    async function showUnlockKeysModal() {
      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.id = 'unlock-keys-overlay';
        overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:99999;display:flex;align-items:center;justify-content:center;';
        overlay.innerHTML = `
      <div style="background:#1a1512;border:1px solid #c8a660;padding:30px;width:400px;border-radius:4px">
        <h3 style="color:#c8a660;margin:0 0 15px">🔐 Unlock API Keys</h3>
        <p style="color:#a89070;font-size:13px;margin-bottom:15px">Enter your password to decrypt your API keys.</p>
        <input type="password" id="unlock-password" placeholder="Password" style="width:100%;padding:10px;background:#0b0908;border:1px solid #252015;color:#c8a660;font-family:monospace;margin-bottom:15px">
        <div style="display:flex;gap:10px;justify-content:flex-end">
          <button id="unlock-cancel" style="padding:8px 16px;background:transparent;border:1px solid #555;color:#888;cursor:pointer">Cancel</button>
          <button id="unlock-confirm" style="padding:8px 16px;background:#c8a660;border:none;color:#0b0908;cursor:pointer;font-weight:bold">Unlock</button>
        </div>
      </div>
    `;
        document.body.appendChild(overlay);

        const input = overlay.querySelector('#unlock-password');
        input.focus();

        overlay.querySelector('#unlock-cancel').onclick = () => {
          overlay.remove();
          resolve(null);
        };
        overlay.querySelector('#unlock-confirm').onclick = async () => {
          const password = input.value;
          if (!password) return;
          const encrypted = localStorage.getItem('na_encrypted_keys');
          try {
            const keys = await decryptKeys(encrypted, password);
            APP_KEY_PASSWORD = password;
            setAllApiKeys(keys);
            overlay.remove();
            resolve(true);
          } catch (e) {
            input.style.borderColor = '#c06060';
            input.value = '';
            input.placeholder = 'Wrong password';
          }
        };
        input.onkeydown = (e) => { if (e.key === 'Enter') overlay.querySelector('#unlock-confirm').click(); };
      });
    }

    async function showPromptKeyModal(provider) {
      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.id = 'prompt-key-overlay';
        overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:99999;display:flex;align-items:center;justify-content:center;';
        const labels = { openrouter: 'OpenRouter', anthropic: 'Anthropic', openai: 'OpenAI', google: 'Google', lmstudio: 'LM Studio' };
        overlay.innerHTML = `
      <div style="background:#1a1512;border:1px solid #c8a660;padding:30px;width:450px;border-radius:4px">
        <h3 style="color:#c8a660;margin:0 0 15px">🔑 Enter ${labels[provider]} Key</h3>
        <p style="color:#a89070;font-size:13px;margin-bottom:15px">This key will be used for this session only and won't be stored.</p>
        <input type="password" id="session-key-input" placeholder="API Key" style="width:100%;padding:10px;background:#0b0908;border:1px solid #252015;color:#c8a660;font-family:monospace;margin-bottom:15px">
        <div style="display:flex;gap:10px;justify-content:flex-end">
          <button id="prompt-key-cancel" style="padding:8px 16px;background:transparent;border:1px solid #555;color:#888;cursor:pointer">Cancel</button>
          <button id="prompt-key-confirm" style="padding:8px 16px;background:#c8a660;border:none;color:#0b0908;cursor:pointer;font-weight:bold">Use Key</button>
        </div>
      </div>
    `;
        document.body.appendChild(overlay);

        const input = overlay.querySelector('#session-key-input');
        input.focus();

        overlay.querySelector('#prompt-key-cancel').onclick = () => {
          overlay.remove();
          resolve(null);
        };
        overlay.querySelector('#prompt-key-confirm').onclick = () => {
          const key = input.value.trim();
          if (key) {
            SESSION_CACHED_KEYS[provider] = key;
            APP.apiKeys[provider] = key;
            overlay.remove();
            resolve(key);
          }
        };
        input.onkeydown = (e) => { if (e.key === 'Enter') overlay.querySelector('#prompt-key-confirm').click(); };
      });
    }

    async function getApiKeyForProvider(provider) {
      const mode = getStorageMode();
      if (mode === 'prompt') {
        if (SESSION_CACHED_KEYS[provider]) {
          APP.apiKeys[provider] = SESSION_CACHED_KEYS[provider];
          return SESSION_CACHED_KEYS[provider];
        }
        return await showPromptKeyModal(provider);
      } else if (mode === 'encrypted' && isKeysLocked()) {
        const unlocked = await showUnlockKeysModal();
        if (!unlocked) return null;
        return APP.apiKeys[provider] || '';
      }
      return APP.apiKeys[provider] || '';
    }

    // Initialize keys based on storage mode
    (async function initKeys() {
      const mode = getStorageMode();

      // If encrypted mode but no password set yet, prompt to create one
      if (mode === 'encrypted' && !localStorage.getItem('na_encrypted_keys')) {
        const password = prompt('Set a password to encrypt your API keys:');
        if (!password) {
          // User cancelled, fall back to plaintext
          setStorageMode('plaintext');
        } else {
          const confirm = prompt('Confirm password:');
          if (confirm !== password) {
            alert('Passwords do not match. Switching to plaintext mode.');
            setStorageMode('plaintext');
          } else {
            // Save the current keys (if any) with the new password
            const currentKeys = {
              openrouter: localStorage.getItem('na_key') || '',
              anthropic: localStorage.getItem('na_anthropic_key') || '',
              openai: localStorage.getItem('na_openai_key') || '',
              google: localStorage.getItem('na_google_key') || '',
              lmstudio: localStorage.getItem('na_lmstudio_key') || ''
            };
            setAllApiKeys(currentKeys);
            await saveKeysSecurely(password);
          }
        }
      }

      const keys = await loadKeysByMode();
      APP.apiKeys.openrouter = keys.openrouter;
      APP.apiKeys.anthropic = keys.anthropic;
      APP.apiKeys.openai = keys.openai;
      APP.apiKeys.google = keys.google;
      APP.apiKeys.lmstudio = keys.lmstudio;
    })();

    // ═══════════════════════════════════════════════════════════
    // PROJECT MANAGEMENT
    // ═══════════════════════════════════════════════════════════

    function generateProjectName() {
      const s = APP.series?.name || '';
      const b = APP.book?.title || '';
      if (s || b) return (s + ' - ' + b).trim();
      return 'My Novel';
    }

    function getProjects() {
      try { return JSON.parse(localStorage.getItem('na_projects') || 'null') || []; }
      catch { return []; }
    }

    function saveProjects(projects) {
      localStorage.setItem('na_projects', JSON.stringify(projects));
    }

    function getCurrentProjectId() {
      return localStorage.getItem('na_current_project') || 'default';
    }

    function setCurrentProjectId(pid) {
      localStorage.setItem('na_current_project', pid);
    }

    function getProjectState(pid) {
      try { return JSON.parse(localStorage.getItem('na_state_' + pid) || 'null'); }
      catch { return null; }
    }

    function saveProjectState(pid) {
      showSaveIndicator('saving');
      try {
        const data = { series: APP.series, book: APP.book, chapter: APP.chapter };
        localStorage.setItem('na_state_' + pid, JSON.stringify(data));
        localStorage.setItem('na_last_saved_' + pid, Date.now());
        updateLastSavedTime(pid);
        showSaveIndicator('saved');
      } catch (e) {
        console.error('Save error:', e);
        showSaveIndicator('error');
      }
    }

    function showSaveIndicator(status) {
      const el = document.getElementById('save_indicator');
      if (!el) return;
      el.className = 'save-indicator ' + status;
      if (status === 'saving') el.textContent = 'Saving...';
      else if (status === 'saved') el.textContent = 'Saved';
      else if (status === 'error') el.textContent = 'Error';
    }

    function updateLastSavedTime(pid) {
      const el = document.getElementById('save_time');
      if (!el) return;
      const ts = localStorage.getItem('na_last_saved_' + pid);
      if (!ts) { el.textContent = ''; return; }
      const diff = Date.now() - parseInt(ts);
      const mins = Math.floor(diff / 60000);
      if (mins < 1) el.textContent = 'just now';
      else if (mins === 1) el.textContent = '1 min ago';
      else if (mins < 60) el.textContent = mins + ' mins ago';
      else {
        const date = new Date(parseInt(ts));
        el.textContent = 'at ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }
    }

    function autoSaveLoop() {
      const pid = getCurrentProjectId();
      if (pid) saveProjectState(pid);
    }

    function createHourlyBackup(pid) {
      if (!pid) return;
      const hour = new Date().toISOString().slice(0, 13);
      const data = { series: APP.series, book: APP.book, chapter: APP.chapter, timestamp: Date.now() };
      localStorage.setItem('na_backup_' + pid + '_' + hour, JSON.stringify(data));
      cleanupOldBackups(pid);
    }

    function cleanupOldBackups(pid) {
      const now = Date.now();
      const maxAge = 24 * 60 * 60 * 1000;
      const keysToRemove = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('na_backup_' + pid + '_')) {
          const ts = parseInt(key.split('_').pop());
          if (now - ts > maxAge) {
            keysToRemove.push(key);
          }
        }
      }
      keysToRemove.forEach(k => localStorage.removeItem(k));
    }

    function getBackupList(pid) {
      const backups = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('na_backup_' + pid + '_')) {
          const hourKey = key.replace('na_backup_' + pid + '_', '');
          try {
            const data = JSON.parse(localStorage.getItem(key));
            backups.push({ key, hour: hourKey, timestamp: data.timestamp });
          } catch (e) { }
        }
      }
      return backups.sort((a, b) => b.timestamp - a.timestamp);
    }

    function renderBackupList() {
      const pid = getCurrentProjectId();
      const el = document.getElementById('backup_list');
      if (!el) return;
      if (!pid) { el.innerHTML = '<p style="font-size:11px;color:#605840">No project selected</p>'; return; }
      const backups = getBackupList(pid);
      if (backups.length === 0) {
        el.innerHTML = '<p style="font-size:11px;color:#605840">No backups yet. Backups created hourly.</p>';
        return;
      }
      el.innerHTML = backups.slice(0, 24).map(b => {
        const date = new Date(b.timestamp);
        const timeStr = date.toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        return '<div class="backup-item"><span class="backup-time">' + timeStr + '</span><button class="backup-restore" onclick="restoreBackup(\'' + pid + '\', \'' + b.hour + '\')">Restore</button></div>';
      }).join('');
    }

    function restoreBackup(pid, hourKey) {
      const key = 'na_backup_' + pid + '_' + hourKey;
      const data = localStorage.getItem(key);
      if (!data) { alert('Backup not found'); return; }
      if (confirm('Restore this backup? Current unsaved changes will be lost.')) {
        try {
          const parsed = JSON.parse(data);
          APP.series = parsed.series;
          APP.book = parsed.book;
          APP.chapter = parsed.chapter;
          saveProjectState(pid);
          renderAll();
          showToast('Backup restored');
        } catch (e) { alert('Failed to restore: ' + e.message); }
      }
    }
    window.restoreBackup = restoreBackup;

    function toggleSceneNavigator() {
      const nav = document.getElementById('scene-navigator');
      if (nav.classList.contains('open')) {
        nav.classList.remove('open');
      } else {
        nav.classList.add('open');
        renderSceneNavigator();
      }
    }
    window.toggleSceneNavigator = toggleSceneNavigator;

    // ═══════════════════════════════════════════════════════════
    // SEARCH FUNCTIONS
    // ═══════════════════════════════════════════════════════════

    function openSearchModal() {
      const modal = document.getElementById('search_modal');
      modal.classList.add('open');
      const input = document.getElementById('search_input');
      input.value = '';
      document.getElementById('search_results').innerHTML = '';
      document.getElementById('search_results_count').innerHTML = '';
      input.focus();

      // Add event listener for searching as you type
      input.oninput = function () {
        if (input.value.trim().length >= 2) {
          performSearch();
        }
      };

      // Add event listener for Enter key
      input.onkeydown = function (e) {
        if (e.key === 'Enter') {
          performSearch();
        }
      };
    }
    window.openSearchModal = openSearchModal;

    function closeSearchModal() {
      document.getElementById('search_modal').classList.remove('open');
    }
    window.closeSearchModal = closeSearchModal;

    function performSearch() {
      const query = document.getElementById('search_input').value.trim();
      if (!query) return;

      const useRegex = document.getElementById('search_regex').checked;
      const caseSensitive = document.getElementById('search_case').checked;

      const results = searchAll(query, { useRegex, caseSensitive });
      displaySearchResults(results, query);
    }
    window.performSearch = performSearch;

    function searchAll(query, options) {
      const results = [];
      const maxResults = 100;
      const { useRegex, caseSensitive } = options;

      let regex;
      try {
        if (useRegex) {
          regex = new RegExp(query, caseSensitive ? 'g' : 'gi');
        } else {
          const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          regex = new RegExp(escaped, caseSensitive ? 'g' : 'gi');
        }
      } catch (e) {
        return results;
      }

      const sources = [
        { data: APP.book?.chars || [], fields: ['name', 'text', 'tags'], label: 'Character', getTitle: (item) => item.name },
        { data: APP.chapter?.fullChapters || [], fields: ['title', 'text', 'synopsis'], label: 'Chapter', getTitle: (item, idx) => item.title || 'Chapter ' + (idx + 1) },
        { data: APP.chapter?.breakdowns || [], fields: ['text'], label: 'Breakdown', getTitle: (item, idx) => 'Breakdown ' + (idx + 1) },
        { data: APP.chapter?.settings || [], fields: ['text'], label: 'Setting', getTitle: (item, idx) => item.title || 'Setting ' + (idx + 1) },
        { data: APP.series?.bible ? [APP.series.bible] : [], fields: ['text'], label: 'Series Bible', getTitle: () => APP.series?.name || 'Series Bible' },
        { data: APP.book?.bible ? [APP.book.bible] : [], fields: ['text'], label: 'Book Bible', getTitle: () => APP.book?.title || 'Book Bible' },
        { data: APP.book?.outline ? [APP.book.outline] : [], fields: ['text'], label: 'Outline', getTitle: () => 'Outline' },
        { data: APP.series?.timeline || [], fields: ['title', 'description'], label: 'Timeline', getTitle: (item) => item.title },
        { data: APP.book?.relationships || [], fields: ['description'], label: 'Relationship', getTitle: (item) => 'Relationship' },
      ];

      for (const source of sources) {
        if (results.length >= maxResults) break;

        for (let i = 0; i < source.data.length; i++) {
          if (results.length >= maxResults) break;

          const item = source.data[i];
          const title = source.getTitle(item, i);

          for (const field of source.fields) {
            if (results.length >= maxResults) break;

            const value = item[field];
            if (!value) continue;

            const strValue = Array.isArray(value) ? value.join(' ') : String(value);
            const matches = strValue.match(regex);

            if (matches && matches.length > 0) {
              results.push({
                type: source.label,
                title: title,
                field: field,
                matchCount: matches.length,
                snippet: getSnippet(strValue, query, useRegex),
                item: item,
                index: i,
                fieldName: field
              });
              break;
            }
          }
        }
      }

      return results;
    }

    function getSnippet(text, query, useRegex) {
      const maxLen = 100;
      const lowerText = text.toLowerCase();
      let idx;

      if (useRegex) {
        try {
          const regex = new RegExp(query, 'gi');
          const match = regex.exec(text);
          idx = match ? match.index : -1;
        } catch (e) {
          idx = -1;
        }
      } else {
        idx = lowerText.indexOf(query.toLowerCase());
      }

      if (idx === -1) {
        return text.substring(0, maxLen) + (text.length > maxLen ? '...' : '');
      }

      const start = Math.max(0, idx - 40);
      const end = Math.min(text.length, idx + query.length + 40);
      let snippet = '';

      if (start > 0) snippet += '...';
      snippet += text.substring(start, end);
      if (end < text.length) snippet += '...';

      return snippet;
    }

    function displaySearchResults(results, query) {
      const container = document.getElementById('search_results');
      const countEl = document.getElementById('search_results_count');

      if (results.length === 0) {
        container.innerHTML = '<p style="font-size:12px;color:#605840;text-align:center;padding:20px">No results found</p>';
        countEl.innerHTML = '';
        return;
      }

      const totalResults = results.length;
      const displayResults = results.slice(0, 100);

      countEl.innerHTML = totalResults > 100
        ? 'Showing first 100 of ' + totalResults + ' results'
        : 'Found ' + totalResults + ' results';

      const useRegex = document.getElementById('search_regex').checked;
      let highlightRegex;
      try {
        if (useRegex) {
          highlightRegex = new RegExp('(' + query + ')', 'gi');
        } else {
          const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          highlightRegex = new RegExp('(' + escaped + ')', 'gi');
        }
      } catch (e) {
        highlightRegex = null;
      }

      container.innerHTML = displayResults.map((r, idx) => {
        const escaped = escapeHtml(r.snippet);
        const highlighted = highlightRegex
          ? escaped.replace(highlightRegex, '<mark>$1</mark>')
          : escaped.replace(new RegExp('(' + escapeRegex(query) + ')', 'gi'), '<mark>$1</mark>');

        return '<div class="search-result-item" onclick="navigateToSearchResult(' + idx + ')">' +
          '<div class="search-result-type">' + r.type + '</div>' +
          '<div class="search-result-title">' + escapeHtml(r.title) + '</div>' +
          '<div class="search-result-snippet">' + highlighted + '</div>' +
          '</div>';
      }).join('');

      window._currentSearchResults = displayResults;
    }

    function escapeRegex(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function escapeHtml(str) {
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function navigateToSearchResult(idx) {
      const result = window._currentSearchResults[idx];
      if (!result) return;

      closeSearchModal();

      if (result.type === 'Character') {
        APP.tab = 'story';
        showTab('story');
        setTimeout(function () {
          const charEls = document.querySelectorAll('.ch-item');
          if (charEls[result.index]) {
            charEls[result.index].scrollIntoView({ behavior: 'smooth', block: 'center' });
            charEls[result.index].style.boxShadow = '0 0 10px #c8a660';
            setTimeout(function () { charEls[result.index].style.boxShadow = ''; }, 3000);
          }
        }, 100);
      } else if (result.type === 'Chapter' || result.type === 'Breakdown') {
        APP.tab = 'chapter';
        showTab('chapter');
        setTimeout(function () {
          const chapterEls = document.querySelectorAll('.chapter-card');
          if (chapterEls[result.index]) {
            chapterEls[result.index].scrollIntoView({ behavior: 'smooth', block: 'center' });
            chapterEls[result.index].style.boxShadow = '0 0 10px #c8a660';
            setTimeout(function () { chapterEls[result.index].style.boxShadow = ''; }, 3000);
          }
        }, 100);
      } else if (result.type === 'Setting') {
        APP.tab = 'chapter';
        showTab('chapter');
      } else if (result.type === 'Series Bible' || result.type === 'Book Bible' || result.type === 'Outline') {
        APP.tab = 'story';
        showTab('story');
      } else if (result.type === 'Timeline') {
        APP.tab = 'story';
        showTab('story');
        setTimeout(function () {
          const timelineItems = document.querySelectorAll('.timeline-item');
          if (timelineItems[result.index]) {
            timelineItems[result.index].scrollIntoView({ behavior: 'smooth', block: 'center' });
            timelineItems[result.index].style.boxShadow = '0 0 10px #c8a660';
            setTimeout(function () { timelineItems[result.index].style.boxShadow = ''; }, 3000);
          }
        }, 100);
      }
    }
    window.navigateToSearchResult = navigateToSearchResult;

    function showSearchTab(tab) {
      document.getElementById('search_tab_content').style.display = tab === 'search' ? 'block' : 'none';
      document.getElementById('find_tab_content').style.display = tab === 'find' ? 'block' : 'none';
      document.getElementById('findall_tab_content').style.display = tab === 'findall' ? 'block' : 'none';
      document.getElementById('search_tab_btn').className = tab === 'search' ? 'search-tab-btn active' : 'search-tab-btn';
      document.getElementById('find_tab_btn').className = tab === 'find' ? 'search-tab-btn active' : 'search-tab-btn';
      document.getElementById('findall_tab_btn').className = tab === 'findall' ? 'search-tab-btn active' : 'search-tab-btn';

      if (tab === 'search') {
        document.getElementById('search_input').focus();
      } else if (tab === 'find') {
        document.getElementById('find_input').focus();
      } else if (tab === 'findall') {
        document.getElementById('findall_input').focus();
      }
    }
    window.showSearchTab = showSearchTab;

    function openFindReplacePanel() {
      document.getElementById('search_modal').classList.add('open');
      showSearchTab('find');
    }
    window.openFindReplacePanel = openFindReplacePanel;

    function getFindRegex(inputId, caseId, regexId) {
      const query = document.getElementById(inputId).value;
      if (!query) return null;

      const useRegex = document.getElementById(regexId).checked;
      const caseSensitive = document.getElementById(caseId).checked;

      try {
        if (useRegex) {
          return new RegExp(query, caseSensitive ? 'g' : 'gi');
        } else {
          const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          return new RegExp(escaped, caseSensitive ? 'g' : 'gi');
        }
      } catch (e) {
        return null;
      }
    }

    function findNext() {
      const regex = getFindRegex('find_input', 'find_case', 'find_regex');
      if (!regex) return;

      const allChapters = document.getElementById('find_all_chapters').checked;
      // For now, just show alert - actual implementation would search in the editor
      alert('Find Next: ' + regex + (allChapters ? ' (all chapters)' : ' (current chapter)'));
    }
    window.findNext = findNext;

    function replaceOne() {
      const regex = getFindRegex('find_input', 'find_case', 'find_regex');
      const replaceWith = document.getElementById('replace_input').value;
      if (!regex) return;

      alert('Replace One: ' + regex + ' with ' + replaceWith);
    }
    window.replaceOne = replaceOne;

    function replaceAll() {
      const regex = getFindRegex('find_input', 'find_case', 'find_regex');
      const replaceWith = document.getElementById('replace_input').value;
      const allChapters = document.getElementById('find_all_chapters').checked;
      if (!regex) return;

      let count = 0;
      const chapters = APP.chapter?.fullChapters || [];

      for (const chap of chapters) {
        if (chap.text) {
          const matches = chap.text.match(regex);
          if (matches) count += matches.length;
        }
        if (chap.scenes) {
          for (const scene of chap.scenes) {
            if (scene.content) {
              const matches = scene.content.match(regex);
              if (matches) count += matches.length;
            }
          }
        }
      }

      if (count > 0 && confirm('Replace ' + count + ' occurrences?')) {
        // Perform the replacements
        for (const chap of chapters) {
          if (chap.text) {
            chap.text = chap.text.replace(regex, replaceWith);
          }
          if (chap.scenes) {
            for (const scene of chap.scenes) {
              if (scene.content) {
                scene.content = scene.content.replace(regex, replaceWith);
              }
            }
          }
        }
        saveProjectState(getCurrentProjectId());
        renderAll();
        alert('Replaced ' + count + ' occurrences!');
      }
    }
    window.replaceAll = replaceAll;

    function findAllOccurrences() {
      const regex = getFindRegex('findall_input', 'findall_case', 'findall_regex');
      if (!regex) return;

      const results = [];
      const maxResults = 100;
      const chapters = APP.chapter?.fullChapters || [];

      for (let cIdx = 0; cIdx < chapters.length && results.length < maxResults; cIdx++) {
        const chap = chapters[cIdx];
        const chapTitle = chap.title || 'Chapter ' + (cIdx + 1);

        // Search in chapter text
        if (chap.text) {
          let match;
          const regexCopy = new RegExp(regex.source, regex.flags);
          while ((match = regexCopy.exec(chap.text)) !== null) {
            const start = Math.max(0, match.index - 30);
            const end = Math.min(chap.text.length, match.index + match[0].length + 30);
            let snippet = '';
            if (start > 0) snippet += '...';
            snippet += chap.text.substring(start, end);
            if (end < chap.text.length) snippet += '...';

            results.push({
              type: 'Chapter',
              index: cIdx,
              title: chapTitle,
              snippet: snippet,
              match: match[0],
              field: 'text'
            });

            if (results.length >= maxResults) break;
          }
        }

        // Search in scenes
        if (chap.scenes) {
          for (let sIdx = 0; sIdx < chap.scenes.length && results.length < maxResults; sIdx++) {
            const scene = chap.scenes[sIdx];
            if (scene.content) {
              let match;
              const regexCopy = new RegExp(regex.source, regex.flags);
              while ((match = regexCopy.exec(scene.content)) !== null) {
                const start = Math.max(0, match.index - 30);
                const end = Math.min(scene.content.length, match.index + match[0].length + 30);
                let snippet = scene.content.substring(start, end);
                if (start > 0) snippet = '...' + snippet;
                if (end < scene.content.length) snippet += '...';

                results.push({
                  type: 'Scene',
                  index: cIdx,
                  sceneIndex: sIdx,
                  title: chapTitle + ' - Scene ' + (sIdx + 1),
                  snippet: snippet,
                  match: match[0],
                  field: 'content'
                });

                if (results.length >= maxResults) break;
              }
            }
          }
        }
      }

      const container = document.getElementById('findall_results');
      const countEl = document.getElementById('findall_count');

      if (results.length === 0) {
        container.innerHTML = '<p style="font-size:12px;color:#605840;text-align:center;padding:20px">No occurrences found</p>';
        countEl.innerHTML = '';
        return;
      }

      const totalResults = results.length;
      const displayResults = results.slice(0, 100);

      countEl.innerHTML = totalResults > 100
        ? 'Showing first 100 of ' + totalResults + ' occurrences'
        : 'Found ' + totalResults + ' occurrences';

      container.innerHTML = displayResults.map(function (r, idx) {
        const highlighted = r.snippet.replace(regex, '<mark>' + r.match + '</mark>');
        return '<div class="search-result-item" onclick="goToFindResult(' + r.index + ', ' + (r.sceneIndex || 0) + ', \'' + r.field + '\')">' +
          '<div class="search-result-type">' + r.type + '</div>' +
          '<div class="search-result-title">' + escapeHtml(r.title) + '</div>' +
          '<div class="search-result-snippet">' + highlighted + '</div>' +
          '</div>';
      }).join('');

      window._findAllResults = displayResults;
    }
    window.findAllOccurrences = findAllOccurrences;

    function goToFindResult(chapIdx, sceneIdx, field) {
      closeSearchModal();
      APP.tab = 'chapter';
      showTab('chapter');

      setTimeout(function () {
        const chapterEls = document.querySelectorAll('.chapter-card');
        if (chapterEls[chapIdx]) {
          chapterEls[chapIdx].scrollIntoView({ behavior: 'smooth', block: 'center' });
          chapterEls[chapIdx].style.boxShadow = '0 0 10px #c8a660';
          setTimeout(function () { chapterEls[chapIdx].style.boxShadow = ''; }, 3000);
        }
      }, 100);
    }
    window.goToFindResult = goToFindResult;

    // ═══════════════════════════════════════════════════════════
    // STYLE DNA FUNCTIONS
    // ═══════════════════════════════════════════════════════════

    function getStyleDNA() {
      return APP.writingPrefs?.styleDNA || '';
    }
    window.getStyleDNA = getStyleDNA;

    function isStyleDNA() {
      return !!getStyleDNA();
    }
    window.isStyleDNA = isStyleDNA;

    function isStyleDNALocked() {
      return APP.writingPrefs?.styleDNALocked || false;
    }
    window.isStyleDNALocked = isStyleDNALocked;

    function lockStyleDNA(text) {
      if (!text || !text.trim()) {
        alert('No Style DNA content to lock');
        return;
      }
      if (isStyleDNA() && !confirm('Replace existing Style DNA?')) return;
      if (!APP.writingPrefs) APP.writingPrefs = {};
      APP.writingPrefs.styleDNA = text.trim();
      APP.writingPrefs.styleDNALocked = true;
      APP.writingPrefs.styleDNATimestamp = Date.now();
      saveProjectState(getCurrentProjectId());
      updateStyleDNAIndicator();
      showToast('Style DNA locked');
    }
    window.lockStyleDNA = lockStyleDNA;

    function unlockStyleDNA() {
      if (!confirm('Unlock Style DNA? You can then lock a new analysis.')) return;
      if (APP.writingPrefs) {
        APP.writingPrefs.styleDNALocked = false;
      }
      saveProjectState(getCurrentProjectId());
      updateStyleDNAIndicator();
      showToast('Style DNA unlocked');
    }
    window.unlockStyleDNA = unlockStyleDNA;

    function updateStyleDNAIndicator() {
      const indicator = document.getElementById('style_dna_indicator');
      if (!indicator) return;
      if (isStyleDNA()) {
        indicator.innerHTML = '<span style="color:#4a8">🔒 Style DNA</span>';
      } else {
        indicator.innerHTML = '<span style="color:#605840">Style DNA</span>';
      }
    }
    window.updateStyleDNAIndicator = updateStyleDNAIndicator;

    function exportStyleDNA() {
      if (!isStyleDNA()) {
        alert('No Style DNA to export');
        return;
      }
      const name = prompt('Enter name for export:', 'My Style DNA');
      if (!name) return;
      const data = {
        version: '1.0',
        name: name,
        styleDNA: getStyleDNA(),
        created: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'style-dna-' + name.toLowerCase().replace(/\s+/g, '-') + '-' + Date.now() + '.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast('Exported: ' + name);
    }
    window.exportStyleDNA = exportStyleDNA;

    function importStyleDNA(file) {
      if (!file) return;
      const r = new FileReader();
      r.onload = function (e) {
        try {
          const data = JSON.parse(e.target.result);
          if (!data.styleDNA) throw new Error('Invalid Style DNA file');
          if (!APP.writingPrefs) APP.writingPrefs = {};
          APP.writingPrefs.styleDNA = data.styleDNA;
          APP.writingPrefs.styleDNALocked = true;
          APP.writingPrefs.styleDNATimestamp = Date.now();
          saveProjectState(getCurrentProjectId());
          updateStyleDNAIndicator();
          renderAll();
          showToast('Imported: ' + (data.name || 'Style DNA'));
        } catch (err) { alert('Failed to import: ' + err.message); }
      };
      r.readAsText(file);
    }
    window.importStyleDNA = importStyleDNA;

    function editCharacter(idx) {
      const chars = APP.book?.chars || [];
      if (idx < 0 || idx >= chars.length) return;
      const char = chars[idx];
      const name = char.name || '';
      const text = char.text || '';
      const tags = (char.tags || []).join(', ');
      const incl = char.inclusion || 'full';

      const html = '<div id="char_edit_modal" class="char-edit-modal-overlay" style="display:flex;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:2000;align-items:center;justify-content:center">' +
        '<div class="char-edit-modal" style="background:#1a1512;border:1px solid #3a3020;width:90%;max-width:500px;border-radius:4px;padding:20px">' +
        '<h3 style="color:#c8a660;margin:0 0 15px 0">Edit Character</h3>' +
        '<div style="margin-bottom:12px"><label style="font-size:11px;color:#605840">Name</label><input type="text" id="char_edit_name" value="' + esc(name) + '" style="width:100%;padding:8px;background:#141209;border:1px solid #3a3020;color:#c8a660"></div>' +
        '<div style="margin-bottom:12px"><label style="font-size:11px;color:#605840">Description</label><textarea id="char_edit_text" rows="6" style="width:100%;padding:8px;background:#141209;border:1px solid #3a3020;color:#c8a660;resize:vertical">' + esc(text) + '</textarea></div>' +
        '<div style="margin-bottom:12px"><label style="font-size:11px;color:#605840">Tags (comma separated)</label><input type="text" id="char_edit_tags" value="' + esc(tags) + '" style="width:100%;padding:8px;background:#141209;border:1px solid #3a3020;color:#c8a660"></div>' +
        '<div style="margin-bottom:15px"><label style="font-size:11px;color:#605840">Inclusion</label><select id="char_edit_incl" style="width:100%;padding:8px;background:#141209;border:1px solid #3a3020;color:#c8a660"><option value="full"' + (incl === 'full' ? ' selected' : '') + '>Full</option><option value="brief"' + (incl === 'brief' ? ' selected' : '') + '>Brief</option><option value="off"' + (incl === 'off' ? ' selected' : '') + '>Off</option></select></div>' +
        '<div style="display:flex;gap:10px;justify-content:flex-end"><button onclick="document.getElementById(\'char_edit_modal\').remove()" style="padding:8px 16px;background:transparent;border:1px solid #3a3020;color:#a09080;cursor:pointer">Cancel</button><button onclick="saveCharEdit(' + idx + ')" style="padding:8px 16px;background:#c8a660;border:none;color:#090807;cursor:pointer">Save</button></div>' +
        '</div></div>';
      document.body.insertAdjacentHTML('beforeend', html);
    }
    window.editCharacter = editCharacter;

    function saveCharEdit(idx) {
      const chars = APP.book?.chars || [];
      if (idx < 0 || idx >= chars.length) return;
      chars[idx].name = document.getElementById('char_edit_name').value;
      chars[idx].text = document.getElementById('char_edit_text').value;
      chars[idx].tags = document.getElementById('char_edit_tags').value.split(',').map(t => t.trim()).filter(t => t);
      chars[idx].inclusion = document.getElementById('char_edit_incl').value;
      saveProjectState(getCurrentProjectId());
      document.getElementById('char_edit_modal').remove();
      renderStoryCharacters(document.getElementById('story-sub-content'));
    }
    window.saveCharEdit = saveCharEdit;

    function deleteCharacter(idx) {
      const chars = APP.book?.chars || [];
      if (idx < 0 || idx >= chars.length) return;
      if (confirm('Delete this character?')) {
        chars.splice(idx, 1);
        saveProjectState(getCurrentProjectId());
        const container = document.getElementById('story-sub-content');
        if (container) renderStoryCharacters(container);
      }
    }
    window.deleteCharacter = deleteCharacter;

    function renderStyleDNASection(container) {
      const dna = getStyleDNA();
      const locked = isStyleDNALocked();
      container.innerHTML = `
    <div class="list-hd">
      <span class="list-lbl">Style DNA ${locked ? '🔒' : ''}</span>
      ${locked ? '<button class="add-btn" onclick="unlockStyleDNA()">Unlock</button>' : ''}
      <button class="add-btn" onclick="exportStyleDNA()">Export</button>
      <button class="add-btn" onclick="document.getElementById(\'style_dna_import\').click()">Import</button>
      <input type="file" id="style_dna_import" accept=".json" style="display:none" onchange="importStyleDNA(this.files[0]);this.value=''">
    </div>
    ${dna ? '<div class="style-dna-content" style="background:#141209;padding:12px;border-radius:4px;margin-top:8px;font-size:12px;color:#a09080;max-height:200px;overflow-y:auto;white-space:pre-wrap">' + esc(dna.substring(0, 3000)) + '</div>' : '<p style="font-size:11px;color:#605840;margin-top:8px">No Style DNA. Run Style DNA analysis in Prompts tab, then click "Lock Style DNA".</p>'}
    <p style="font-size:10px;color:#d44;margin-top:8px">⚠️ Style DNA requires AI usage to analyze your writing and apply the voice.</p>
  `;
    }
    window.renderStyleDNASection = renderStyleDNASection;

    function renderSceneNavigator() {
      const content = document.getElementById('scene_nav_content');
      if (!content) return;

      const chapters = APP.chapter?.fullChapters || APP.chapter?.chapters || [];
      if (chapters.length === 0) {
        content.innerHTML = '<p style="font-size:11px;color:#605840">No chapters yet.</p>';
        return;
      }

      content.innerHTML = chapters.map((chap, idx) => {
        const scenes = chap.scenes || [];
        const title = chap.title || 'Chapter ' + (idx + 1);
        return '<div class="scene-nav-item" onclick="goToChapter(' + idx + ')"><div class="scene-nav-item-title">' + (idx + 1) + '. ' + esc(title) + '</div><div class="scene-nav-item-meta">' + scenes.length + ' scenes</div></div>';
      }).join('');
    }

    function goToChapter(idx) {
      APP.tab = 'chapter';
      showTab('chapter');
      // Highlight the chapter
      setTimeout(function () {
        const el = document.querySelector('.chapter-card[data-idx="' + idx + '"]');
        if (el) {
          el.scrollIntoView({ behavior: 'smooth', block: 'center' });
          el.style.boxShadow = '0 0 10px #c8a660';
          setTimeout(function () { el.style.boxShadow = ''; }, 2000);
        }
      }, 100);
    }
    window.goToChapter = goToChapter;

    function getGenreCompare(pid) {
      try { return JSON.parse(localStorage.getItem('na_genre_' + pid) || 'null'); }
      catch { return null; }
    }

    function saveGenreCompare(pid, data) {
      localStorage.setItem('na_genre_' + pid, JSON.stringify(data));
    }

    // Migration: convert old single-project data to new multi-project format
    function migrateToProjects() {
      const projects = getProjects();
      if (projects.length > 0) return;

      const oldState = localStorage.getItem('na_state');
      const oldGenre = localStorage.getItem('na_genre');

      const pid = 'project-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
      const name = generateProjectName();

      const newProjects = [{ id: pid, name: name }];
      saveProjects(newProjects);
      setCurrentProjectId(pid);

      if (oldState) {
        try {
          const data = JSON.parse(oldState);
          localStorage.setItem('na_state_' + pid, oldState);
          if (data.series) APP.series = { ...APP.series, ...data.series };
          if (data.book) APP.book = { ...APP.book, ...data.book };
          if (data.chapter) APP.chapter = { ...APP.chapter, ...data.chapter };
        } catch (e) { }
      }
      if (oldGenre) {
        saveGenreCompare(pid, JSON.parse(oldGenre));
      }
    }

    function switchProject(pid) {
      const currentPid = getCurrentProjectId();
      if (currentPid) saveProjectState(currentPid);

      setCurrentProjectId(pid);
      const state = getProjectState(pid);
      if (state) {
        if (state.series) APP.series = state.series;
        if (state.book) APP.book = state.book;
        if (state.chapter) APP.chapter = state.chapter;
      } else {
        APP.series = { name: '', subName: '', bible: mkSec() };
        APP.book = { title: '', bookNum: '', totalBooks: '', subNum: '', totalSub: '', bible: mkSec(), outline: mkSec(), chars: [{ id: mkId(), ...mkSec() }] };
        APP.chapter = { mode: 'chapter', chapterNum: '', sceneNum: '', useFullChapters: true, fullChapters: [], breakdown: mkSec(), settings: [{ id: mkId(), ...mkSec() }] };
      }

      const genre = getGenreCompare(pid);
      if (genre) APP.genreCompare = genre;
      else APP.genreCompare = { preset: 'fantasy', customText: '' };

      renderProjectSelector();
      renderSeries(); renderBook(); renderChapter();
      saveState();
    }

    function createNewProject() {
      const name = prompt('Enter project name:', 'New Project');
      if (!name) return;

      const projects = getProjects();
      const pid = 'project-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
      projects.push({ id: pid, name: name });
      saveProjects(projects);

      setCurrentProjectId(pid);
      APP.series = { name: '', subName: '', bible: mkSec() };
      APP.book = { title: '', bookNum: '', totalBooks: '', subNum: '', totalSub: '', bible: mkSec(), outline: mkSec(), chars: [{ id: mkId(), ...mkSec() }] };
      APP.chapter = { mode: 'chapter', chapterNum: '', sceneNum: '', useFullChapters: true, fullChapters: [], breakdown: mkSec(), settings: [{ id: mkId(), ...mkSec() }] };
      APP.genreCompare = { preset: 'fantasy', customText: '' };

      saveProjectState(pid);
      saveGenreCompare(pid, APP.genreCompare);
      renderProjectSelector();
      renderSeries(); renderBook(); renderChapter();
      saveState();
    }

    function renameProject() {
      const projects = getProjects();
      const currentPid = getCurrentProjectId();
      const current = projects.find(p => p.id === currentPid);
      if (!current) return;

      const newName = prompt('Enter new project name:', current.name);
      if (!newName || newName === current.name) return;

      current.name = newName;
      saveProjects(projects);
      renderProjectSelector();
    }

    function deleteProject() {
      const projects = getProjects();
      const currentPid = getCurrentProjectId();

      if (projects.length <= 1) {
        alert('Cannot delete the last project. Create a new project first.');
        return;
      }

      if (!confirm('Delete this project? This cannot be undone.')) return;

      const newProjects = projects.filter(p => p.id !== currentPid);
      saveProjects(newProjects);

      localStorage.removeItem('na_state_' + currentPid);
      localStorage.removeItem('na_genre_' + currentPid);

      switchProject(newProjects[0].id);
    }

    function renderProjectSelector() {
      const projects = getProjects();
      const currentPid = getCurrentProjectId();
      const current = projects.find(p => p.id === currentPid);

      document.getElementById('project_name_display').textContent = current ? current.name : 'Select Project';

      const listEl = document.getElementById('project_list');
      listEl.innerHTML = projects.map(p =>
        '<div class="project-item' + (p.id === currentPid ? ' active' : '') + '" data-pid="' + p.id + '">' +
        '<span>' + p.name + '</span>' +
        '</div>'
      ).join('');

      listEl.querySelectorAll('.project-item').forEach(item => {
        item.addEventListener('click', () => {
          const pid = item.dataset.pid;
          if (pid !== currentPid) switchProject(pid);
          document.getElementById('project_dropdown').classList.remove('open');
        });
      });
    }

    // ═══════════════════════════════════════════════════════════
    // WORD COUNT STATS
    // ═══════════════════════════════════════════════════════════

    function countWords(text) {
      if (!text || typeof text !== 'string' || !text.trim()) return 0;
      return text.trim().split(/\s+/).filter(w => w.length > 0).length;
    }

    function isActiveInclusion(item) {
      return item && item.inclusion && item.inclusion !== 'off';
    }

    function getStats() {
      const stats = {
        total: 0,
        series: { total: 0, active: 0 },
        book: { total: 0, active: 0 },
        chapter: { total: 0, active: 0 },
        writingPrefs: 0,
        counts: { chapters: 0, characters: 0, settings: 0 }
      };

      // Series Bible
      if (APP.series?.bible?.text) {
        const w = countWords(APP.series.bible.text);
        stats.series.total += w;
        if (APP.series.bible.inclusion !== 'off') stats.series.active += w;
      }

      // Book Bible
      if (APP.book?.bible?.text) {
        const w = countWords(APP.book.bible.text);
        stats.book.total += w;
        if (APP.book.bible.inclusion !== 'off') stats.book.active += w;
      }

      // Book Outline
      if (APP.book?.outline?.text) {
        const w = countWords(APP.book.outline.text);
        stats.book.total += w;
        if (APP.book.outline.inclusion !== 'off') stats.book.active += w;
      }

      // Characters
      if (APP.book?.chars?.length) {
        stats.counts.characters = APP.book.chars.length;
        APP.book.chars.forEach(c => {
          if (c.text) {
            const w = countWords(c.text);
            stats.book.total += w;
            if (isActiveInclusion(c)) stats.book.active += w;
          }
          if (c.appearance) stats.book.total += countWords(c.appearance);
          if (c.personality) stats.book.total += countWords(c.personality);
          if (c.background) stats.book.total += countWords(c.background);
        });
      }

      // Full Chapters/Scenes
      if (APP.chapter?.fullChapters?.length) {
        stats.counts.chapters = APP.chapter.fullChapters.length;
        APP.chapter.fullChapters.forEach(c => {
          if (c.text) {
            const w = countWords(c.text);
            stats.chapter.total += w;
            if (c.inclusion !== 'off') stats.chapter.active += w;
          }
        });
      }

      // Breakdowns (scene-level breakdown notes)
      if (APP.chapter?.breakdowns?.length) {
        APP.chapter.breakdowns.forEach(b => {
          if (b.text) {
            const w = countWords(b.text);
            stats.chapter.total += w;
            if (b.inclusion !== 'off') stats.chapter.active += w;
          }
        });
      }

      // Chapter Breakdown main text
      if (APP.chapter?.breakdown?.text) {
        const w = countWords(APP.chapter.breakdown.text);
        stats.chapter.total += w;
        if (APP.chapter.breakdown.inclusion !== 'off') stats.chapter.active += w;
      }

      // Chapter Settings
      if (APP.chapter?.settings?.length) {
        stats.counts.settings = APP.chapter.settings.length;
        APP.chapter.settings.forEach(s => {
          if (s.text) {
            const w = countWords(s.text);
            stats.chapter.total += w;
            if (isActiveInclusion(s)) stats.chapter.active += w;
          }
          if (s.setting) stats.chapter.total += countWords(s.setting);
          if (s.goal) stats.chapter.total += countWords(s.goal);
          if (s.conflict) stats.chapter.total += countWords(s.conflict);
          if (s.resolution) stats.chapter.total += countWords(s.resolution);
        });
      }

      // WritingPrefs AI Avoidance Rules
      if (APP.writingPrefs) {
        if (APP.writingPrefs.doNotUseWords) {
          stats.writingPrefs += countWords(APP.writingPrefs.doNotUseWords);
        }
        // Count all the boolean rule fields
        const rules = ['noEmDashes', 'noSemicolons', 'noColons', 'noTripletFraming',
          'noGoldenSunset', 'noInspirationalPivot', 'noAIBookending', 'varySentence',
          'avoidFilterWords', 'snappyDialogue', 'specificOverGeneric'];
        rules.forEach(r => {
          if (APP.writingPrefs[r]) stats.writingPrefs += 1;
        });
      }

      // Totals
      stats.total = stats.series.total + stats.book.total + stats.chapter.total + stats.writingPrefs;

      return stats;
    }

    function formatNumber(num) {
      return num.toLocaleString();
    }

    function updateStatsDisplay() {
      const stats = getStats();
      const badge = document.getElementById('stats_badge');
      const homeCard = document.getElementById('stats_card_content');

      if (badge) {
        badge.textContent = formatNumber(stats.total) + ' words';
      }

      if (homeCard) {
        homeCard.innerHTML =
          '<div class="stats-total">' +
          '<span class="stats-label">Total Words</span>' +
          '<span class="stats-value">' + formatNumber(stats.total) + '</span>' +
          '</div>' +
          '<div class="stats-breakdown">' +
          '<div class="stats-row"><span class="stats-sec">Series</span><span class="stats-num">' + formatNumber(stats.series.total) + '</span><span class="stats-active">(' + formatNumber(stats.series.active) + ' active)</span></div>' +
          '<div class="stats-row"><span class="stats-sec">Book</span><span class="stats-num">' + formatNumber(stats.book.total) + '</span><span class="stats-active">(' + formatNumber(stats.book.active) + ' active)</span></div>' +
          '<div class="stats-row"><span class="stats-sec">Chapter</span><span class="stats-num">' + formatNumber(stats.chapter.total) + '</span><span class="stats-active">(' + formatNumber(stats.chapter.active) + ' active)</span></div>' +
          '<div class="stats-row"><span class="stats-sec">Writing Prefs</span><span class="stats-num">' + formatNumber(stats.writingPrefs) + '</span></div>' +
          '</div>' +
          '<div class="stats-counts">' +
          '<span>' + stats.counts.chapters + ' Chapters</span>' +
          '<span>' + stats.counts.characters + ' Characters</span>' +
          '<span>' + stats.counts.settings + ' Settings</span>' +
          '</div>';
      }
    }

    migrateToProjects();
    renderProjectSelector();

    // Load saved state (per-project)
    const pid = getCurrentProjectId();
    const saved = getProjectState(pid);
    if (saved) {
      if (saved.series) APP.series = { ...APP.series, ...saved.series };
      if (saved.book) APP.book = { ...APP.book, ...saved.book };
      if (saved.chapter) APP.chapter = { ...APP.chapter, ...saved.chapter };
    }
    const genre = getGenreCompare(pid);
    if (genre) APP.genreCompare = genre;

    // Update stats after loading project data
    updateStatsDisplay();

    // Debounced save
    let saveTimer = null;
    function saveState() {
      clearTimeout(saveTimer);
      saveTimer = setTimeout(() => {
        const pid = getCurrentProjectId();
        saveProjectState(pid);
        saveGenreCompare(pid, APP.genreCompare);
        updateStatsDisplay();
      }, 400);
    }

    // ═══════════════════════════════════════════════════════════
    // WRITING PREFERENCES HELPERS
    // ═══════════════════════════════════════════════════════════

    function buildWritingPrefsInstructions() {
      const p = APP.writingPrefs;
      const rules = [];
      if (p.pov === 'first') rules.push('Write in first person perspective.');
      else if (p.pov === 'third') rules.push('Write in third person perspective.');
      else rules.push('Use a mix of first and third person as appropriate.');
      if (p.innerMonologue) rules.push('Assume text in italics represents inner monologue/thoughts.');
      if (p.punctuation) {
        if (p.avoidEmDashes) rules.push('DO NOT use em-dashes (—). Use commas, parentheses, or rewrite instead.');
        if (p.avoidSemicolons) rules.push('DO NOT use semicolons. Use periods or commas instead.');
        if (p.avoidColons) rules.push('DO NOT use colons except in dialogue or when grammatically required.');
      }
      if (p.avoidTriplet) rules.push('DO NOT use triplet framing (e.g., "Fast, cheap, and out of control").');
      if (p.avoidGoldenSunset) rules.push('AVOID the "Golden Sunset" Syndrome: Over-describing scenery to set a mood.');
      if (p.avoidInspirationalPivot) rules.push('DO NOT use "Inspirational Pivot" framing (e.g., "This isn\'t just about X, it\'s about humanity"). Avoid "It\'s less about X and more about Y" constructions.');
      if (p.avoidShowDontSummarize) rules.push('AVOID "AI bookending": Do not start with sweeping atmospheric descriptions or end with profound life lessons.');
      if (p.avoidFavoriteWords) rules.push('Avoid repetitive word choices. Vary vocabulary.');
      if (p.avoidFloweryProse) rules.push('AVOID flowery prose, purple prose, and clichéd metaphors.');
      if (p.avoidAdjectiveOverload) rules.push('AVOID adjective overload: Do not use three adjectives where one strong verb would do.');
      if (p.varySentenceStructure) rules.push('VARY sentence structure: Mix short punchy fragments with longer flowing thoughts.');
      if (p.filterWords) rules.push('Use the "Ugly" Rule: Avoid filter words (e.g., "She saw the bird fly" → "The bird flew").');
      if (p.snappyDialogue) rules.push('Keep dialogue SNAPPY and INDIRECT: Use subtext and interruptions.');
      if (p.specificOverGeneric) rules.push('PREFER SPECIFIC over GENERIC: Instead of "he felt sad," describe the specific physical sensation.');
      if (p.doNotUseWords && p.doNotUseWords.trim()) {
        const words = p.doNotUseWords.split(',').map(w => w.trim()).filter(w => w);
        if (words.length) rules.push(`DO NOT use these words: ${words.join(', ')}`);
      }
      if (rules.length === 0) return '';
      return '\n\n══════════════════════════════════════════════════════\nWRITING PREFERENCES (Strict Rules):\n' + rules.map(r => '• ' + r).join('\n') + '\n══════════════════════════════════════════════════════\n\n';
    }

    function buildGenreCompareInstructions() {
      const g = APP.genreCompare;
      if (g.preset === 'custom' && g.customText?.trim()) {
        return '\n\n══════════════════════════════════════════════════════\nREFERENCE STYLE (compare to this):\n' + g.customText + '\n══════════════════════════════════════════════════════\n\n';
      }
      if (g.preset !== 'custom' && GENRE_PRESETS[g.preset]) {
        return '\n\n══════════════════════════════════════════════════════\nGENRE CONTEXT: ' + g.preset.toUpperCase() + '\n' + GENRE_PRESETS[g.preset] + '\n══════════════════════════════════════════════════════\n\n';
      }
      return '';
    }

    function saveWritingPrefs() {
      localStorage.setItem('na_writing_prefs', JSON.stringify(APP.writingPrefs));
    }

    // ═══════════════════════════════════════════════════════════
    // CONTEXT BUILDER
    // ═══════════════════════════════════════════════════════════

    function buildContext() {
      const parts = [];
      const extract = (inc, text, maxW = 450, customWords = 500) => {
        if (inc === 'off' || !text?.trim()) return null;
        if (inc === 'brief') {
          const w = text.trim().split(/\s+/);
          return w.length > maxW ? w.slice(0, maxW).join(' ') + '\n\n*[— truncated: brief mode —]*' : text.trim();
        }
        if (inc === 'extended') {
          const w = text.trim().split(/\s+/);
          return w.length > 1000 ? w.slice(0, 1000).join(' ') + '\n\n*[— truncated: extended (1000 words) —]*' : text.trim();
        }
        if (inc === 'custom') {
          const w = text.trim().split(/\s+/);
          return w.length > customWords ? w.slice(0, customWords).join(' ') + `\n\n*[— truncated: custom (${customWords} words) —]*` : text.trim();
        }
        return text.trim();
      };
      // Series
      const sl = [];
      if (APP.series.name) sl.push(`**Series:** ${APP.series.name}`);
      if (APP.series.subName) sl.push(`**Sub-series:** ${APP.series.subName}`);
      const sb = extract(APP.series.bible.inclusion, APP.series.bible.text, 450, APP.series.bible.customWords || 500);
      if (sb) sl.push(`\n**Series Bible:**\n${sb}`);
      if (sl.length) parts.push(`## ◈ Series / Project\n\n${sl.join('\n')}`);
      // Book
      const bl = [];
      if (APP.book.title) {
        let pos = `"${APP.book.title}"`;
        if (APP.book.bookNum && APP.book.totalBooks) pos += ` — Book ${APP.book.bookNum} of ${APP.book.totalBooks}`;
        if (APP.book.subNum && APP.book.totalSub) pos += ` (${APP.book.subNum} of ${APP.book.totalSub} in sub-series)`;
        bl.push(`**Book:** ${pos}`);
      }
      const bb = extract(APP.book.bible.inclusion, APP.book.bible.text, 450, APP.book.bible.customWords || 500);
      if (bb) bl.push(`\n**Book Bible:**\n${bb}`);
      const bo = extract(APP.book.outline.inclusion, APP.book.outline.text, 450, APP.book.outline.customWords || 500);
      if (bo) bl.push(`\n**Book Outline:**\n${bo}`);
      if (bl.length) parts.push(`## ◉ Book\n\n${bl.join('\n')}`);
      // Characters
      const ac = APP.book.chars.filter(c => c.inclusion !== 'off' && c.text?.trim());
      if (ac.length) {
        const cb = ac.map(c => extract(c.inclusion, c.text, 300, c.customWords || 500)).filter(Boolean);
        if (cb.length) parts.push(`## ◑ Characters\n\n${cb.join('\n\n────────\n\n')}`);
      }
      // Full chapters
      const fc = APP.chapter.fullChapters.filter(c => c.text?.trim());
      const useFull = APP.chapter.useFullChapters && fc.length > 0;

      // Chapter
      const chl = [];
      if (APP.chapter.chapterNum) {
        const lbl = APP.chapter.mode === 'scene' && APP.chapter.sceneNum
          ? `Chapter ${APP.chapter.chapterNum}, Scene ${APP.chapter.sceneNum}`
          : `Chapter ${APP.chapter.chapterNum}`;
        chl.push(`**Current location in manuscript:** ${lbl}`);
      }

      if (useFull) {
        const isSceneLevel = APP.chapter.mode === 'scene';
        const chapterLabels = [];
        for (let i = 0; i < fc.length; i++) {
          const c = fc[i];
          let label = c.label || (isSceneLevel ? `Chapter ${c.number || i + 1} - Scene ${c.sceneNumber || ''}` : `Chapter ${c.number || i + 1}`);
          chapterLabels.push(`\n### ${label}\n\n${c.text.trim()}`);
        }
        if (chapterLabels.length) chl.push(`\n**Full ${isSceneLevel ? 'Scenes' : 'Chapters'}:**\n${chapterLabels.join('\n\n')}`);
      } else {
        const breakdowns = APP.chapter.breakdowns?.filter(b => b.text?.trim()) || [];
        if (breakdowns.length > 0) {
          const sorted = [...breakdowns].sort((a, b) => {
            const order = { prologue: 0, chapter: 1, epilogue: 2 };
            const orderA = order[a.type] ?? 1;
            const orderB = order[b.type] ?? 1;
            if (orderA !== orderB) return orderA - orderB;
            return (a.number || 0) - (b.number || 0);
          });
          const bdTexts = sorted.map(b => {
            const typeLabel = b.type === 'prologue' ? 'Prologue' : b.type === 'epilogue' ? 'Epilogue' : `Chapter ${b.number || ''}`;
            return `### ${typeLabel}\n\n${b.text.trim()}`;
          });
          chl.push(`\n**Chapter Breakdowns:**\n${bdTexts.join('\n\n────────\n\n')}`);
        }
      }
      const as_ = APP.chapter.settings.filter(s => s.inclusion !== 'off' && s.text?.trim());
      if (as_.length) {
        const sb2 = as_.map(s => extract(s.inclusion, s.text, 200, s.customWords || 500)).filter(Boolean);
        if (sb2.length) chl.push(`\n**Settings:**\n${sb2.join('\n\n────────\n\n')}`);
      }
      if (chl.length) parts.push(`## ❒ Chapter / Scene\n\n${chl.join('\n')}`);
      if (!parts.length) return '';
      return '# MANUSCRIPT CONTEXT\n\n_Use the following author-provided context to inform all editorial feedback. Preserve the established voice, world logic, character psychology, and narrative continuity._\n\n'
        + parts.join('\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n')
        + '\n\n══════════════════════════════════════════════════════\n\n';
    }

    function getContextPills() {
      const p = [];
      if (APP.series.bible.inclusion !== 'off' && APP.series.bible.text?.trim()) p.push({ label: 'Series Bible', mode: APP.series.bible.inclusion });
      if (APP.book.title) p.push({ label: `"${APP.book.title.slice(0, 20)}"`, mode: 'full' });
      if (APP.book.bible.inclusion !== 'off' && APP.book.bible.text?.trim()) p.push({ label: 'Book Bible', mode: APP.book.bible.inclusion });
      if (APP.book.outline.inclusion !== 'off' && APP.book.outline.text?.trim()) p.push({ label: 'Outline', mode: APP.book.outline.inclusion });
      const ac = APP.book.chars.filter(c => c.inclusion !== 'off' && c.text?.trim());
      if (ac.length) p.push({ label: `${ac.length} Char${ac.length > 1 ? 's' : ''}`, mode: ac[0].inclusion });

      if (APP.chapter.useFullChapters && APP.chapter.fullChapters.length > 0) {
        const fc = APP.chapter.fullChapters.filter(c => c.text?.trim());
        if (fc.length) p.push({ label: `${fc.length} Full ${APP.chapter.mode === 'scene' ? 'Scene' : 'Chapter'}${fc.length > 1 ? 's' : ''}`, mode: 'full' });
      } else {
        const breakdowns = APP.chapter.breakdowns?.filter(b => b.text?.trim()) || [];
        if (breakdowns.length > 0) {
          const sorted = [...breakdowns].sort((a, b) => {
            const order = { prologue: 0, chapter: 1, epilogue: 2 };
            const orderA = order[a.type] ?? 1;
            const orderB = order[b.type] ?? 1;
            if (orderA !== orderB) return orderA - orderB;
            return (a.number || 0) - (b.number || 0);
          });
          const first = sorted[0];
          const typeLabel = first.type === 'prologue' ? 'Prologue' : first.type === 'epilogue' ? 'Epilogue' : `Chapter ${first.number || ''}`;
          p.push({ label: `Ch. ${typeLabel}`, mode: 'brief' });
        }
      }

      const as_ = APP.chapter.settings.filter(s => s.inclusion !== 'off' && s.text?.trim());
      if (as_.length) p.push({ label: `${as_.length} Setting${as_.length > 1 ? 's' : ''}`, mode: as_[0].inclusion });
      return p;
    }

    // Helper to get full chapter text from Chapter tab
    function getFullChapterText() {
      const fc = APP.chapter.fullChapters?.filter(c => c.text?.trim()) || [];
      if (fc.length === 0) return null;

      const isSceneLevel = APP.chapter.mode === 'scene';

      const sorted = [...fc].sort((a, b) => {
        const order = { prologue: 0, chapter: 1, epilogue: 2 };
        const orderA = order[a.type] ?? 1;
        const orderB = order[b.type] ?? 1;
        if (orderA !== orderB) return orderA - orderB;
        if (a.number !== b.number) return (a.number || 0) - (b.number || 0);
        if (isSceneLevel) return (a.sceneNumber || 0) - (b.sceneNumber || 0);
        return 0;
      });

      return sorted.map(c => {
        const typeLabel = c.type === 'prologue' ? 'Prologue' : c.type === 'epilogue' ? 'Epilogue' : (isSceneLevel ? `Chapter ${c.number || ''} - Scene ${c.sceneNumber || ''}` : `Chapter ${c.number || ''}`);
        return `### ${typeLabel}\n\n${c.text.trim()}`;
      }).join('\n\n---\n\n');
    }

    // ═══════════════════════════════════════════════════════════
    // API
    // ═══════════════════════════════════════════════════════════

    async function callAPI(prompt, onChunk, onDone, onError, signal) {
      const provider = APP.provider;
      const apiKey = await getApiKeyForProvider(provider);

      if (!apiKey) { onError('No API key — add it in Settings.'); return; }

      const maxTokens = APP.maxTokens + (parseInt(document.getElementById('tok_boost')?.value) || 0);

      if (provider === 'anthropic') {
        // Anthropic API
        try {
          const res = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'x-api-key': apiKey,
              'anthropic-version': '2023-06-01',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              model: APP.model,
              messages: [{ role: 'user', content: prompt }],
              max_tokens: maxTokens,
              stream: true
            }),
            signal
          });
          if (!res.ok) {
            let msg = `HTTP ${res.status}`;
            try { const j = await res.json(); msg = j.error?.message || msg; } catch (e) { }
            onError(msg); const tb = document.getElementById('tok_boost'); if (tb) tb.value = 0; return;
          }
          const reader = res.body.getReader();
          const dec = new TextDecoder();
          let buf = '';
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            buf += dec.decode(value, { stream: true });
            const lines = buf.split('\n');
            buf = lines.pop();
            for (const line of lines) {
              if (line.startsWith('data: ')) {
                const d = line.slice(6).trim();
                if (d === '[DONE]') { const tb = document.getElementById('tok_boost'); if (tb) tb.value = 0; onDone(); return; }
                try {
                  const j = JSON.parse(d);
                  if (j.type === 'content_block_delta') {
                    const c = j.delta?.text;
                    if (c) onChunk(c);
                  }
                } catch (e) { }
              }
            }
          }
          onDone();
        } catch (e) {
          if (e.name === 'AbortError') return;
          onError(e.message);
        }
      } else if (provider === 'google') {
        // Google Gemini API
        try {
          const url = `https://generativelanguage.googleapis.com/v1beta/models/${APP.model}:streamGenerateContent`;
          const res = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-goog-api-key': apiKey
            },
            body: JSON.stringify({
              contents: [{ role: 'user', parts: [{ text: prompt }] }],
              generationConfig: {
                temperature: 0.9,
                maxOutputTokens: maxTokens,
                topP: 0.95,
                topK: 40
              }
            }),
            signal
          });
          if (!res.ok) {
            let msg = `HTTP ${res.status}`;
            try { const j = await res.json(); msg = j.error?.message || msg; } catch (e) { }
            onError(msg); const tb = document.getElementById('tok_boost'); if (tb) tb.value = 0; return;
          }
          const reader = res.body.getReader();
          const dec = new TextDecoder();
          let buf = '';
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            buf += dec.decode(value, { stream: true });
            const lines = buf.split('\n');
            buf = lines.pop();
            for (const line of lines) {
              if (line.startsWith('data: ')) {
                const d = line.slice(6).trim();
                if (d === '[DONE]') { const tb = document.getElementById('tok_boost'); if (tb) tb.value = 0; onDone(); return; }
                try {
                  const j = JSON.parse(d);
                  if (j.candidates && j.candidates[0]?.content?.parts) {
                    const c = j.candidates[0].content.parts[0]?.text;
                    if (c) onChunk(c);
                  }
                } catch (e) { }
              }
            }
          }
          onDone();
        } catch (e) {
          if (e.name === 'AbortError') return;
          onError(e.message);
        }
      } else if (provider === 'lmstudio') {
        // LM Studio (Local) - OpenAI compatible
        const baseUrl = APP.lmstudioUrl.replace(/\/$/, '');
        try {
          const headers = {
            'Content-Type': 'application/json'
          };
          if (apiKey) {
            headers['Authorization'] = `Bearer ${apiKey}`;
          }
          const res = await fetch(`${baseUrl}/v1/chat/completions`, {
            method: 'POST',
            headers,
            body: JSON.stringify({
              model: APP.model,
              messages: [{ role: 'user', content: prompt }],
              stream: true,
              max_tokens: maxTokens
            }),
            signal
          });
          if (!res.ok) {
            let msg = `HTTP ${res.status}`;
            try { const j = await res.json(); msg = j.error?.message || msg; } catch (e) { }
            onError(msg); const tb = document.getElementById('tok_boost'); if (tb) tb.value = 0; return;
          }
          const reader = res.body.getReader();
          const dec = new TextDecoder();
          let buf = '';
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            buf += dec.decode(value, { stream: true });
            const lines = buf.split('\n');
            buf = lines.pop();
            for (const line of lines) {
              if (line.startsWith('data: ')) {
                const d = line.slice(6).trim();
                if (d === '[DONE]') { const tb = document.getElementById('tok_boost'); if (tb) tb.value = 0; onDone(); return; }
                try {
                  const j = JSON.parse(d);
                  const c = j.choices?.[0]?.delta?.content;
                  if (c) onChunk(c);
                } catch (e) { }
              }
            }
          }
          onDone();
        } catch (e) {
          if (e.name === 'AbortError') return;
          onError(e.message);
        }
      } else {
        // OpenRouter or OpenAI Direct (both use OpenAI-compatible format)
        const isOpenAI = provider === 'openai';
        const url = isOpenAI
          ? 'https://api.openai.com/v1/chat/completions'
          : 'https://openrouter.ai/api/v1/chat/completions';

        const headers = {
          'Authorization': `Bearer ${apiKey}`,
          'Content-Type': 'application/json'
        };

        if (!isOpenAI) {
          headers['HTTP-Referer'] = location.href.startsWith('file://') ? 'https://novelists-atelier.local' : location.href;
          headers['X-Title'] = "The Novelist's Atelier";
        }

        try {
          const res = await fetch(url, {
            method: 'POST',
            headers,
            body: JSON.stringify({
              model: APP.model,
              messages: [{ role: 'user', content: prompt }],
              stream: true,
              max_tokens: maxTokens
            }),
            signal
          });
          if (!res.ok) {
            let msg = `HTTP ${res.status}`;
            try { const j = await res.json(); msg = j.error?.message || msg; } catch (e) { }
            onError(msg); const tb = document.getElementById('tok_boost'); if (tb) tb.value = 0; return;
          }
          const reader = res.body.getReader();
          const dec = new TextDecoder();
          let buf = '';
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            buf += dec.decode(value, { stream: true });
            const lines = buf.split('\n');
            buf = lines.pop();
            for (const line of lines) {
              if (line.startsWith('data: ')) {
                const d = line.slice(6).trim();
                if (d === '[DONE]') { const tb = document.getElementById('tok_boost'); if (tb) tb.value = 0; onDone(); return; }
                try {
                  const j = JSON.parse(d);
                  const c = j.choices?.[0]?.delta?.content;
                  if (c) onChunk(c);
                } catch (e) { }
              }
            }
          }
          onDone();
        } catch (e) {
          if (e.name === 'AbortError') return;
          onError(e.message);
        }
      }
    }

    // ═══════════════════════════════════════════════════════════
    // FILE UTILS
    // ═══════════════════════════════════════════════════════════

    async function readFile(file) {
      if (!file) return '';
      if (file.name.endsWith('.docx')) {
        try {
          const buf = await file.arrayBuffer();
          if (typeof mammoth !== 'undefined') {
            const r = await mammoth.extractRawText({ arrayBuffer: buf });
            return r.value;
          }
          return '[mammoth.js not loaded — try .txt or .md]';
        } catch (e) { return '[Could not parse .docx]'; }
      }
      return new Promise(res => {
        const r = new FileReader();
        r.onload = e => res(e.target.result);
        r.readAsText(file);
      });
    }

    function dlMd(text, fname) {
      const b = new Blob([text], { type: 'text/markdown;charset=utf-8' });
      const u = URL.createObjectURL(b);
      const a = document.createElement('a');
      a.href = u; a.download = fname;
      document.body.appendChild(a); a.click();
      document.body.removeChild(a); URL.revokeObjectURL(u);
    }

    function esc(s) { return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;') }

    function addHelp(parent, text) {
      const icon = document.createElement('span');
      icon.className = 'help-icon';
      icon.textContent = '?';
      icon.style.cursor = 'pointer';
      icon.style.marginLeft = '4px';
      const tooltip = document.createElement('div');
      tooltip.className = 'tooltip';
      tooltip.style.display = 'none';
      tooltip.innerHTML = text + '<button class="tooltip-close">×</button>';
      document.body.appendChild(tooltip);
      icon.addEventListener('click', (e) => {
        e.stopPropagation();
        document.querySelectorAll('.tooltip').forEach(t => t.style.display = 'none');
        if (tooltip.style.display === 'none') {
          const rect = icon.getBoundingClientRect();
          tooltip.style.top = (rect.top - 10) + 'px';
          tooltip.style.left = (rect.left - 10) + 'px';
          tooltip.style.display = 'block';
        } else {
          tooltip.style.display = 'none';
        }
      });
      tooltip.querySelector('.tooltip-close').addEventListener('click', (e) => {
        e.stopPropagation();
        tooltip.style.display = 'none';
      });
      document.addEventListener('click', () => {
        tooltip.style.display = 'none';
      });
      parent.appendChild(icon);
    }

    // ═══════════════════════════════════════════════════════════
    // SECTION BLOCK RENDERER (used in series/book/chapter tabs)
    // ═══════════════════════════════════════════════════════════

    function renderSB(containerId, stateRef, key, opts = {}) {
      const { title = '', desc = '', rows = 5, exportFn = null, uploadId = mkId() } = opts;
      const val = stateRef[key];
      const customWords = val.customWords || 500;
      const el = document.getElementById(containerId);
      if (!el) return;
      el.innerHTML = `
    <div class="sb" id="sb_${containerId}">
      <div class="sb-head">
        <div class="sb-info">
          <span class="sb-title">${esc(title)}</span>
          ${desc ? `<span class="sb-desc">${esc(desc)}</span>` : ''}
        </div>
        <div class="sb-ctrls">
          <div class="itog">
            <button class="ibtn i-full${val.inclusion === 'full' ? ' on' : ''}" data-mode="full">Full</button>
            <button class="ibtn i-brief${val.inclusion === 'brief' ? ' on' : ''}" data-mode="brief">Brief</button>
            <button class="ibtn i-extended${val.inclusion === 'extended' ? ' on' : ''}" data-mode="extended">Extended</button>
            <button class="ibtn i-custom${val.inclusion === 'custom' ? ' on' : ''}" data-mode="custom">Custom</button>
            <button class="ibtn i-off${val.inclusion === 'off' ? ' on' : ''}" data-mode="off">Off</button>
          </div>
          <span id="help_inclusion_${containerId}"></span>
          <input type="file" id="fu_${uploadId}" accept=".md,.txt,.docx" style="display:none">
          <button class="smbtn" id="upbtn_${uploadId}">↑ Upload</button>
          <button class="smbtn" id="expbtn_${containerId}" ${val.text?.trim() ? '' : 'disabled'}>↓ .md</button>
        </div>
      </div>
      <div id="custom_words_row_${containerId}" style="display:${val.inclusion === 'custom' ? 'flex' : 'none'};padding:4px 8px;background:#0f0d09;border-bottom:1px solid #181510;gap:8px;align-items:center">
        <span style="font-family:'JetBrains Mono',monospace;font-size:8px;color:#60584a">Words:</span>
        <input type="number" id="custom_words_${containerId}" value="${customWords}" min="100" max="5000" step="100" style="width:70px;background:#0a0907;border:1px solid #1e1a12;border-radius:2px;color:#a89868;font-size:12px;padding:2px 5px">
      </div>
      <textarea class="sb-ta" style="min-height:${rows * 22}px" placeholder="Paste or upload ${title.toLowerCase()} here…">${esc(val.text)}</textarea>
    </div>`;

      const sbEl = el.querySelector('.sb');
      // Inclusion toggle
      el.querySelectorAll('.ibtn').forEach(btn => {
        btn.addEventListener('click', () => {
          stateRef[key] = { ...val, inclusion: btn.dataset.mode };
          el.querySelectorAll('.ibtn').forEach(b => b.classList.remove('on'));
          btn.classList.add('on');
          const sbOff = btn.dataset.mode === 'off';
          sbEl.classList.toggle('sb-off', sbOff);
          document.getElementById(`custom_words_row_${containerId}`).style.display = btn.dataset.mode === 'custom' ? 'flex' : 'none';
          saveState();
        });
      });

      // Custom words input
      const cwInput = document.getElementById(`custom_words_${containerId}`);
      if (cwInput) {
        cwInput.addEventListener('input', e => {
          stateRef[key] = { ...stateRef[key], customWords: parseInt(e.target.value) || 500 };
          saveState();
        });
      }
      // Upload
      const fu = el.querySelector(`#fu_${uploadId}`);
      el.querySelector(`#upbtn_${uploadId}`).addEventListener('click', () => fu.click());
      fu.addEventListener('change', async e => {
        const f = e.target.files[0]; if (!f) return;
        const text = await readFile(f);
        stateRef[key] = { ...stateRef[key], text };
        el.querySelector('.sb-ta').value = text;
        e.target.value = '';
        saveState();
        el.querySelector(`#expbtn_${containerId}`).disabled = !text.trim();
      });
      // Export
      el.querySelector(`#expbtn_${containerId}`).addEventListener('click', () => {
        if (!val.text?.trim()) return;
        const fname = exportFn ? exportFn() : `${title.toLowerCase().replace(/[^a-z0-9]+/g, '-')}.md`;
        dlMd(`# ${title}\n\n${stateRef[key].text}`, fname);
      });
      // Textarea
      el.querySelector('.sb-ta').addEventListener('input', e => {
        stateRef[key] = { ...stateRef[key], text: e.target.value };
        el.querySelector(`#expbtn_${containerId}`).disabled = !e.target.value.trim();
        saveState();
      });

      // Add help tooltip for inclusion modes
      const helpEl = el.querySelector(`#help_inclusion_${containerId}`);
      if (helpEl) {
        addHelp(helpEl, '<b>Full:</b> Include all text in prompts<br><b>Brief:</b> Include first ~450 words<br><b>Extended:</b> Include first ~1000 words<br><b>Custom:</b> Include your word count<br><b>Off:</b> Exclude from prompts');
      }
    }

    // ═══════════════════════════════════════════════════════════
    // PANEL: HOME
    // ═══════════════════════════════════════════════════════════

    function renderHome() {
      updateStatsDisplay();
      const p = document.getElementById('panel-home');
      p.innerHTML = `
    <div class="ctx-scroll" style="max-width:700px">
      <div class="ctx-head">
        <h2>Welcome to The Novelist's Atelier</h2>
        <p>Your AI-powered writing assistant for editing and world-building.</p>
      </div>

      <div class="scard" style="margin-bottom:20px">
        <div class="scard-hd" style="display:flex;justify-content:space-between;align-items:center">
          <span>📊 Project Stats</span>
        </div>
        <div class="scard-body" id="stats_card_content">
          <div style="color:#605840;font-size:12px">Loading stats...</div>
        </div>
      </div>

      <div class="home-section">
        <h3>Contributions</h3>
        <p style="color:#a89868;font-size:14px;margin-bottom:12px">
          Contributions like yours help me fix bugs, smooth out the syntax, and ensure The Novelist's Atelier is the best tool it can be for authors.<br><br>
          Here's to better drafts and fewer red pens!
        </p>
        <a href="https://ko-fi.com/f5alcon" target="_blank" class="kofi-btn">☕ Contribute on Ko-fi</a>
      </div>

      <div class="home-section">
        <h3>Getting Started</h3>
        <ol style="margin:0;padding-left:20px;color:#a89868;font-size:14px;line-height:1.8">
          <li>Go to <b>Settings</b> to configure your API key (or use LM Studio for local models)</li>
          <li>Add your series details in <b>Series</b> (optional but recommended)</li>
          <li>Add your book details in <b>Book</b> (optional)</li>
          <li>Add your current chapter/scene in <b>Chapter</b></li>
          <li>Use <b>Prompts</b> to generate character profiles, edit scenes, and more!</li>
        </ol>
      </div>

      <div class="home-section">
        <h3>How It Works</h3>
        <div class="home-grid">
          <div class="home-card" onclick="showTab('series')" style="cursor:pointer">
            <span class="home-icon">◈</span>
            <h4>Series</h4>
            <p>Global context for your entire series. Genre, tone, world-building, and narrative summary.</p>
          </div>
          <div class="home-card" onclick="showTab('book')" style="cursor:pointer">
            <span class="home-icon">◉</span>
            <h4>Book</h4>
            <p>Individual book details. Plot outline and book-specific bible. (Characters & Timeline in Story tab)</p>
          </div>
          <div class="home-card" onclick="showTab('chapter')" style="cursor:pointer">
            <span class="home-icon">❒</span>
            <h4>Chapter</h4>
            <p>Current chapter/scene text. Settings and context for the scene you're working on.</p>
          </div>
          <div class="home-card" onclick="showTab('story')" style="cursor:pointer">
            <span class="home-icon">📖</span>
            <h4>Story</h4>
            <p>Characters, relationships, and timeline. Build your story elements at the series level.</p>
          </div>
          <div class="home-card" onclick="showTab('prompts')" style="cursor:pointer">
            <span class="home-icon">◆</span>
            <h4>Prompts</h4>
            <p>AI-powered editing tools. Character creation, copy editing, line editing, and more.</p>
          </div>
          <div class="home-card" onclick="showTab('pipeline')" style="cursor:pointer">
            <span class="home-icon">⟹</span>
            <h4>Pipeline</h4>
            <p>Chain multiple prompts together. Each step builds on the last for complex workflows.</p>
          </div>
          <div class="home-card" onclick="showTab('settings')" style="cursor:pointer">
            <span class="home-icon">⚙</span>
            <h4>Settings</h4>
            <p>Configure API keys, choose models, adjust generation settings, and customize themes.</p>
          </div>
          <div class="home-card" onclick="showTab('help')" style="cursor:pointer">
            <span class="home-icon">?</span>
            <h4>Help</h4>
            <p>Documentation, keyboard shortcuts, tab guides, and activity log.</p>
          </div>
        </div>
      </div>

      <div class="home-section">
        <h3>Tips</h3>
        <ul style="margin:0;padding-left:20px;color:#a89868;font-size:13px;line-height:1.7">
          <li>The more context you provide (Series → Book → Chapter), the better the AI can assist you</li>
          <li>Use "Full" for sections you want fully included in prompts</li>
          <li>Use "Brief" for long sections where you want a summary included</li>
          <li>Use Pipeline to chain multiple edits on the same text</li>
          <li>Local models via LM Studio work offline and keep your data private</li>
          <li>Use the Story tab for characters, relationships, and timeline - saved at series level for multi-book projects</li>
        </ul>
      </div>

      <div class="home-section">
        <h3>Inclusion Modes</h3>
        <p style="color:#a89868;font-size:13px;margin-bottom:10px">In Series, Book, and Chapter tabs, each section has toggle buttons:</p>
        <div class="home-modes">
          <span class="mode-badge full">Full</span> Include all text
        </div>
        <div class="home-modes">
          <span class="mode-badge brief">Brief</span> First ~450 words (summary)
        </div>
        <div class="home-modes">
          <span class="mode-badge extended">Extended</span> First ~1000 words
        </div>
        <div class="home-modes">
          <span class="mode-badge custom">Custom</span> Your word count
        </div>
        <div class="home-modes">
          <span class="mode-badge off">Off</span> Exclude from prompts
        </div>
        <p style="color:#60584a;font-size:12px;margin-top:10px">Toggle sections On/Off in the Chapter tab to control what context gets sent to the AI.</p>
      </div>

      <div class="home-section">
        <h3>AI Usage</h3>
        <p style="color:#a89868;font-size:13px;margin-bottom:10px">
          <b>The Novelist's Atelier</b> was built using AI assistance, specifically <b>Claude Sonnet 4.6</b>, <b>MiniMax M2.5</b>, and <b>OpenCode Big Pickle</b>.
        </p>
        <p style="color:#a89868;font-size:13px;margin-bottom:10px">
          For authors concerned about AI usage in their workflow, see the <b>Authors Guild</b> resources on AI best practices:
        </p>
        <ul style="margin:0;padding-left:20px;color:#a89868;font-size:13px;line-height:1.7">
          <li><a href="https://authorsguild.org/resource/ai-best-practices-for-authors/" target="_blank" style="color:#c8a660">AI Best Practices for Authors</a></li>
          <li><a href="https://authorsguild.org/advocacy/artificial-intelligence/faq/" target="_blank" style="color:#c8a660">Authors Guild AI FAQ</a></li>
        </ul>
        <p style="color:#60584a;font-size:12px;margin-top:10px">
          This tool is designed to assist authors, not replace their creative voice. All generated content should be reviewed and refined by you.
        </p>
      </div>
    </div>`;
    }

    // ═══════════════════════════════════════════════════════════
    // PANEL: SERIES
    // ═══════════════════════════════════════════════════════════

    function renderSeries() {
      const p = document.getElementById('panel-series');
      p.innerHTML = `
    <div class="ctx-scroll">
      <div class="ctx-head">
        <h2>Series & Project</h2>
        <p>Global context for your entire series. These details will be available in all editing prompts.</p>
      </div>
      <div class="meta-row">
        <div class="meta-field">
          <label class="mlabel">Series Name</label>
          <input class="minput" id="s_name" value="${esc(APP.series.name)}" placeholder="e.g. The Shattered Realm">
        </div>
        <div class="meta-field">
          <label class="mlabel">Sub-series / Trilogy Name</label>
          <input class="minput" id="s_sub" value="${esc(APP.series.subName)}" placeholder="e.g. The War of Embers (trilogy)">
        </div>
      </div>
      <div style="margin-bottom:14px">
        <button class="add-btn" id="gen_series_bible" style="background:#0f180d;border-color:#263422;color:#7aac74">⚡ Generate Series Bible from Book</button>
      </div>
      <div id="sb_series_bible"></div>
    </div>`;
      p.querySelector('#s_name').addEventListener('input', e => { APP.series.name = e.target.value; saveState(); updateTabDot(); });
      p.querySelector('#s_sub').addEventListener('input', e => { APP.series.subName = e.target.value; saveState(); });
      p.querySelector('#gen_series_bible')?.addEventListener('click', () => generateSeriesBibleFromBook());
      renderSB('sb_series_bible', APP.series, 'bible', { title: 'Series Bible', desc: 'Genre, tone, POV, narrative summary, world-building, factions, style guide', rows: 14, exportFn: () => 'series-bible.md' });

      // Add help icons
      addHelp(p.querySelector('#s_name').parentElement, 'The overall series name (e.g., "The Shattered Realm")');
      addHelp(p.querySelector('#s_sub').parentElement, 'Sub-series or trilogy name within the larger series');
    }

    // ═══════════════════════════════════════════════════════════
    // PANEL: BOOK
    // ═══════════════════════════════════════════════════════════

    function renderBook() {
      const p = document.getElementById('panel-book');
      p.innerHTML = `
    <div class="ctx-scroll">
      <div class="ctx-head">
        <h2>Book</h2>
        <p>Book-level details, bible, and outline. Characters and relationships are in the Story tab.</p>
      </div>
      <div class="meta-row">
        <div class="meta-field" style="flex:2">
          <label class="mlabel">Book Title</label>
          <input class="minput" id="b_title" value="${esc(APP.book.title)}" placeholder="e.g. Ashes of the First Tower">
        </div>
        <div class="meta-field narrow"><label class="mlabel">Book #</label><input class="minput" id="b_num" value="${esc(APP.book.bookNum)}" placeholder="2"></div>
        <div class="meta-field narrow"><label class="mlabel">Of Total</label><input class="minput" id="b_tot" value="${esc(APP.book.totalBooks)}" placeholder="10"></div>
        <div class="meta-field narrow"><label class="mlabel">Sub #</label><input class="minput" id="b_snum" value="${esc(APP.book.subNum)}" placeholder="2"></div>
        <div class="meta-field narrow"><label class="mlabel">Of Total</label><input class="minput" id="b_stot" value="${esc(APP.book.totalSub)}" placeholder="3"></div>
      </div>
      <div style="margin-bottom:14px">
        <button class="add-btn" id="gen_book_bible" style="background:#0f180d;border-color:#263422;color:#7aac74">⚡ Generate Book Bible from Chapters</button>
      </div>
      <div id="sb_book_bible"></div>
      <div id="sb_book_outline"></div>
    </div>`;

      ['b_title', 'b_num', 'b_tot', 'b_snum', 'b_stot'].forEach(id => {
        const map = { b_title: 'title', b_num: 'bookNum', b_tot: 'totalBooks', b_snum: 'subNum', b_stot: 'totalSub' };
        p.querySelector(`#${id}`).addEventListener('input', e => { APP.book[map[id]] = e.target.value; saveState(); updateTabDot(); });
      });

      const bibleKey = `book_bible_${APP.book.title || 'x'}`;
      renderSB('sb_book_bible', APP.book, 'bible', { title: 'Book Bible', desc: 'Characters, current plot state, active subplots, unresolved threads, world-building', rows: 10, exportFn: () => `book-bible.md` });
      renderSB('sb_book_outline', APP.book, 'outline', { title: 'Book Outline', desc: 'Chapter-by-chapter outline with POV, function, and plot beats', rows: 8, exportFn: () => 'book-outline.md' });

      p.querySelector('#gen_book_bible').addEventListener('click', () => {
        generateBookBibleFromChapters();
      });

      addHelp(p.querySelector('#b_title').parentElement, 'The title of this specific book');
      addHelp(p.querySelector('#b_num').parentElement, 'This book\'s number in the series (e.g., Book 2)');
      addHelp(p.querySelector('#b_tot').parentElement, 'Total number of books in the series');
      addHelp(p.querySelector('#b_snum').parentElement, 'Sub-series or trilogy number (e.g., Book 3 of 3 in a trilogy)');
      addHelp(p.querySelector('#b_stot').parentElement, 'Total books in the sub-series/trilogy');
    }

    function renderCharsList() {
      const list = document.getElementById('chars_list');
      if (!list) return;
      const cnt = document.getElementById('char_cnt');
      if (cnt) cnt.textContent = APP.book.chars.length;
      list.innerHTML = '';
      APP.book.chars.forEach((char, i) => {
        const wrap = document.createElement('div');
        wrap.className = 'list-item';
        wrap.id = `char_wrap_${char.id}`;
        if (APP.book.chars.length > 1) {
          const rm = document.createElement('button');
          rm.className = 'rm-btn'; rm.title = 'Remove';
          rm.innerHTML = '×';
          rm.addEventListener('click', () => {
            APP.book.chars = APP.book.chars.filter(c => c.id !== char.id);
            saveState(); renderCharsList();
          });
          wrap.appendChild(rm);
        }
        const holder = document.createElement('div');
        holder.id = `sb_char_${char.id}`;
        wrap.appendChild(holder);
        list.appendChild(wrap);
        const charRef = { data: char };
        const proxy = new Proxy({}, {
          get: (_, k) => k === 'data' ? char : undefined,
          set: (_, k, v) => { if (k === 'data') { const idx = APP.book.chars.findIndex(c => c.id === char.id); if (idx >= 0) APP.book.chars[idx] = { ...APP.book.chars[idx], ...v }; } return true; }
        });
        // Use a small wrapper to hook into renderSB
        const idx = i;
        const sbId = `sb_char_${char.id}`;
        // render into it
        const tmpState = { val: char };
        renderSBDirect(sbId, APP.book.chars, idx, { title: `Character Profile${APP.book.chars.length > 1 ? ' ' + (i + 1) : ''}`, desc: 'Name, role, goal, appearance, psychology, arc, speech style', rows: 7, exportFn: () => `characters-${i + 1}.md` });
      });
    }

    // ═══════════════════════════════════════════════════════════
    // RELATIONSHIP MAP UI
    // ═══════════════════════════════════════════════════════════

    function renderRelsList() {
      const list = document.getElementById('rels_list');
      if (!list) return;
      const cnt = document.getElementById('rel_cnt');
      const rels = getBookRelationships();
      if (cnt) cnt.textContent = rels.length;
      if (rels.length === 0) {
        list.innerHTML = '<div class="empty-msg">No relationships defined. Add at least 2 characters, then click to the Book tab "+ Add Relationship" above to connect them. Use "View Map" to see a visual diagram.</div>';
        return;
      }
      list.innerHTML = rels.map(r => {
        const c1 = getCharacterById(r.char1Id);
        const c2 = getCharacterById(r.char2Id);
        const typeInfo = getRelationshipTypes().find(t => t.id === r.type);
        return '<div class="rel-item" style="border-left:3px solid ' + (typeInfo?.color || '#c8a660') + '">' +
          '<div class="rel-names">' + (c1?.data?.text?.split('\n')[0] || 'Unknown') + ' <span class="rel-arrow">' + (r.bidirectional ? '↔' : '→') + '</span> ' + (c2?.data?.text?.split('\n')[0] || 'Unknown') + '</div>' +
          '<div class="rel-type">' + (typeInfo?.label || r.type) + '</div>' +
          (r.description ? '<div class="rel-desc">' + esc(r.description) + '</div>' : '') +
          '<div class="rel-actions">' +
          '<button class="rel-edit" data-id="' + r.id + '">Edit</button>' +
          '<button class="rel-delete" data-id="' + r.id + '">Delete</button>' +
          '</div>' +
          '</div>';
      }).join('');
      list.querySelectorAll('.rel-edit').forEach(btn => { btn.addEventListener('click', () => { openRelationshipModal(btn.dataset.id); }); });
      list.querySelectorAll('.rel-delete').forEach(btn => { btn.addEventListener('click', () => { if (confirm('Delete this relationship?')) { deleteRelationship(btn.dataset.id); renderRelsList(); } }); });
    }

    window.openRelationshipModal = function (editId) {
      const rels = getBookRelationships();
      const existing = editId ? rels.find(r => r.id === editId) : null;
      const chars = APP.book?.chars || [];
      const types = getRelationshipTypes();
      const isOpen = document.getElementById('rel_modal');
      if (isOpen) { isOpen.remove(); }
      const html = '<div class="rel-modal-overlay" id="rel_modal">' +
        '<div class="rel-modal">' +
        '<div class="rel-modal-hd"><h3>' + (existing ? 'Edit Relationship' : 'Add Relationship') + '</h3><button class="rel-modal-close" onclick="closeRelationshipModal()">×</button></div>' +
        '<div class="rel-modal-body">' +
        '<div class="rel-field"><label>Character 1</label><select id="rel_char1">' + (chars.map(c => '<option value="' + c.id + '" ' + (existing?.char1Id === c.id ? 'selected' : '') + '>' + esc(c.text?.split('\n')[0] || 'Unnamed') + '</option>').join('')) + '</select></div>' +
        '<div class="rel-field"><label>Character 2</label><select id="rel_char2">' + (chars.map(c => '<option value="' + c.id + '" ' + (existing?.char2Id === c.id ? 'selected' : '') + '>' + esc(c.text?.split('\n')[0] || 'Unnamed') + '</option>').join('')) + '</select></div>' +
        '<div class="rel-field"><label>Relationship Type</label><select id="rel_type">' + (types.map(t => '<option value="' + t.id + '" ' + (existing?.type === t.id ? 'selected' : '') + '>' + t.label + '</option>').join('')) + '</select></div>' +
        '<div class="rel-field"><label>Description</label><textarea id="rel_desc" placeholder="Describe the relationship...">' + (existing?.description || '') + '</textarea></div>' +
        '<div class="rel-field"><label><input type="checkbox" id="rel_bi" ' + (existing?.bidirectional ? 'checked' : '') + '> Bidirectional (mutual)</label></div>' +
        '<div class="rel-actions-row"><button class="rel-btn-cancel" onclick="closeRelationshipModal()">Cancel</button><button class="rel-btn-save" onclick="saveRelationshipFromModal(\'' + (editId || '') + '\')">' + (existing ? 'Update' : 'Add') + '</button></div>' +
        '</div>' +
        '</div>' +
        '</div>';
      document.body.insertAdjacentHTML('beforeend', html);
      document.getElementById('rel_modal').classList.add('open');
      document.getElementById('rel_modal').addEventListener('click', (e) => { if (e.target.id === 'rel_modal') closeRelationshipModal(); });
    };

    window.closeRelationshipModal = function () { const m = document.getElementById('rel_modal'); if (m) m.remove(); };

    window.saveRelationshipFromModal = function (editId) {
      const char1Id = document.getElementById('rel_char1').value;
      const char2Id = document.getElementById('rel_char2').value;
      if (!char1Id || !char2Id || char1Id === char2Id) { alert('Please select two different characters'); return; }
      const type = document.getElementById('rel_type').value;
      const description = document.getElementById('rel_desc').value;
      const bidirectional = document.getElementById('rel_bi').checked;
      if (editId) { updateRelationship(editId, { char1Id, char2Id, type, description, bidirectional }); }
      else { addRelationship(char1Id, char2Id, type, description, bidirectional); }
      closeRelationshipModal();
      renderRelsList();
    };

    window.openRelationshipMapModal = function () {
      const chars = APP.book?.chars || [];
      const rels = getBookRelationships();
      if (chars.length < 2) { alert('Add at least 2 characters to view the relationship map.'); return; }
      const isOpen = document.getElementById('rel_map_modal');
      if (isOpen) { isOpen.remove(); }
      const html = '<div class="rel-map-overlay" id="rel_map_modal">' +
        '<div class="rel-map-modal">' +
        '<div class="rel-map-hd"><h3>Character Relationship Map</h3><button class="rel-map-close" onclick="closeRelationshipMapModal()">×</button></div>' +
        '<div class="rel-map-body"><canvas id="rel_map_canvas"></canvas></div>' +
        '</div>' +
        '</div>';
      document.body.insertAdjacentHTML('beforeend', html);
      document.getElementById('rel_map_modal').classList.add('open');
      setTimeout(initRelationshipMap, 100);
      document.getElementById('rel_map_modal').addEventListener('click', (e) => { if (e.target.id === 'rel_map_modal') closeRelationshipMapModal(); });
    };

    window.closeRelationshipMapModal = function () { const m = document.getElementById('rel_map_modal'); if (m) m.remove(); };

    window.initRelationshipMap = function () {
      const canvas = document.getElementById('rel_map_canvas');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const chars = APP.book?.chars || [];
      const rels = getBookRelationships();
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.scale(dpr, dpr);
      ctx.fillStyle = '#090807';
      ctx.fillRect(0, 0, rect.width, rect.height);
      const nodeRadius = 30;
      const nodes = chars.map((c, i) => {
        const angle = (2 * Math.PI * i) / chars.length - Math.PI / 2;
        const cx = rect.width / 2 + (Math.min(rect.width, rect.height) / 2 - 60) * Math.cos(angle);
        const cy = rect.height / 2 + (Math.min(rect.width, rect.height) / 2 - 60) * Math.sin(angle);
        return { cx, cy, id: c.id, name: c.text?.split('\n')[0] || 'Unnamed', x: cx, y: cy };
      });
      rels.forEach(r => {
        const n1 = nodes.find(n => n.id === r.char1Id);
        const n2 = nodes.find(n => n.id === r.char2Id);
        if (n1 && n2) {
          ctx.beginPath();
          ctx.moveTo(n1.x, n1.y);
          ctx.lineTo(n2.x, n2.y);
          ctx.strokeStyle = getRelationshipTypeColor(r.type);
          ctx.lineWidth = 2;
          ctx.stroke();
          if (!r.bidirectional) {
            const mx = (n1.x + n2.x) / 2, my = (n1.y + n2.y) / 2;
            const ang = Math.atan2(n2.y - n1.y, n2.x - n1.x);
            ctx.beginPath();
            ctx.moveTo(mx, my);
            ctx.lineTo(mx - 8 * Math.cos(ang - 0.4), my - 8 * Math.sin(ang - 0.4));
            ctx.lineTo(mx - 8 * Math.cos(ang + 0.4), my - 8 * Math.sin(ang + 0.4));
            ctx.closePath();
            ctx.fillStyle = getRelationshipTypeColor(r.type);
            ctx.fill();
          }
        }
      });
      nodes.forEach(n => {
        ctx.beginPath();
        ctx.arc(n.x, n.y, nodeRadius, 0, 2 * Math.PI);
        ctx.fillStyle = '#1a1512';
        ctx.fill();
        ctx.strokeStyle = '#c8a660';
        ctx.lineWidth = 2;
        ctx.stroke();
        ctx.fillStyle = '#c8a660';
        ctx.font = '11px JetBrains Mono';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        const initials = n.name.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
        ctx.fillText(initials, n.x, n.y);
        ctx.fillStyle = '#a09080';
        ctx.font = '10px JetBrains Mono';
        const labelY = n.y + nodeRadius + 12;
        ctx.fillText(n.name.substring(0, 12), n.x, labelY);
      });
    }

    // renderSBDirect for list items (operates on array by index)
    function renderSBDirect(containerId, arr, idx, opts = {}) {
      const { title, desc, rows = 5, exportFn = null, uploadId = mkId(), allowGenerate = false, generateTitle = '' } = opts;
      const val = arr[idx];
      const el = document.getElementById(containerId);
      if (!el) return;
      el.innerHTML = `
    <div class="sb">
      <div class="sb-head">
        <div class="sb-info">
          <span class="sb-title">${esc(title)}</span>
          ${desc ? `<span class="sb-desc">${esc(desc)}</span>` : ''}
        </div>
        <div class="sb-ctrls">
          ${allowGenerate ? `<button class="smbtn" id="genbtn_${containerId}" style="margin-right:8px;color:#7aac74;border-color:#263422;background:#0f180d">✦ Generate ${generateTitle}</button>` : ''}
          <div class="itog">
            <button class="ibtn i-full${val.inclusion === 'full' ? ' on' : ''}" data-mode="full">On</button>
            <button class="ibtn i-off${val.inclusion === 'off' ? ' on' : ''}" data-mode="off">Off</button>
          </div>
          <input type="file" id="fu_${uploadId}" accept=".md,.txt,.docx" style="display:none">
          <button class="smbtn" id="upbtn_${uploadId}">↑ Upload</button>
          <button class="smbtn" id="expbtn_${containerId}" ${val.text?.trim() ? '' : 'disabled'}>↓ .md</button>
        </div>
      </div>
      <textarea class="sb-ta" style="min-height:${rows * 22}px" placeholder="Paste or upload ${title.toLowerCase()} here…">${esc(val.text)}</textarea>
    </div>`;
      el.querySelectorAll('.ibtn').forEach(btn => {
        btn.addEventListener('click', () => {
          arr[idx] = { ...arr[idx], inclusion: btn.dataset.mode };
          el.querySelectorAll('.ibtn').forEach(b => b.classList.remove('on'));
          btn.classList.add('on');
          saveState();
        });
      });
      const fu = el.querySelector(`#fu_${uploadId}`);
      el.querySelector(`#upbtn_${uploadId}`).addEventListener('click', () => fu.click());
      fu.addEventListener('change', async e => {
        const f = e.target.files[0]; if (!f) return;
        const text = await readFile(f);
        arr[idx] = { ...arr[idx], text };
        el.querySelector('.sb-ta').value = text;
        e.target.value = ''; saveState();
        el.querySelector(`#expbtn_${containerId}`).disabled = !text.trim();
      });
      el.querySelector(`#expbtn_${containerId}`).addEventListener('click', () => {
        if (!arr[idx].text?.trim()) return;
        const fname = exportFn ? exportFn() : `${title.toLowerCase().replace(/[^a-z0-9]+/g, '-')}.md`;
        dlMd(`# ${title}\n\n${arr[idx].text}`, fname);
      });
      el.querySelector('.sb-ta').addEventListener('input', e => {
        arr[idx] = { ...arr[idx], text: e.target.value };
        el.querySelector(`#expbtn_${containerId}`).disabled = !e.target.value.trim();
        saveState();
      });
      if (allowGenerate) {
        el.querySelector(`#genbtn_${containerId}`)?.addEventListener('click', () => opts.onGenerate(idx));
      }
    }

    // ═══════════════════════════════════════════════════════════
    // PANEL: CHAPTER
    // ═══════════════════════════════════════════════════════════

    function renderChapter() {
      const p = document.getElementById('panel-chapter');
      const isScene = APP.chapter.mode === 'scene';
      const isChapter = APP.chapter.mode === 'chapter';

      p.innerHTML = `
    <div class="ctx-scroll">
      <div class="ctx-head">
        <h2>Chapter / Scene</h2>
        <p>The current chapter or scene you're working on. This granular context is injected into editing prompts.</p>
        <div style="margin-top:8px">
          <button class="add-btn" onclick="autoToggleContext()" style="background:#1a1512;border-color:#c8a660;color:#c8a660;margin-right:8px">🧠 Smart Context</button>
          <button class="add-btn" onclick="analyzeLocalText()" style="background:#1a1512;border-color:#7aac74;color:#7aac74">📊 Local Analysis</button>
        </div>
      </div>
      <div class="mtog">
        <button class="mbtn${isChapter ? ' mon' : ''}" id="ch_mode_chapter">◈ Chapter Level</button>
        <button class="mbtn${isScene ? ' mon' : ''}" id="ch_mode_scene">◎ Scene Level</button>
      </div>
      <div class="meta-row">
        <div class="meta-field narrow"><label class="mlabel">Chapter #</label><input class="minput" id="ch_num" value="${esc(APP.chapter.chapterNum)}" placeholder="7"></div>
        <div class="meta-field narrow" id="scene_num_wrap" style="display:${isScene ? 'flex' : 'none'}">
          <label class="mlabel">Scene #</label><input class="minput" id="ch_snum" value="${esc(APP.chapter.sceneNum)}" placeholder="2">
        </div>
      </div>
      
      ${isChapter ? `
      <div class="fc-toggle" id="fc_toggle">
        <button class="fc-btn${!APP.chapter.useFullChapters ? ' fcon' : ''}" id="fc_mode_breakdown">◈ Breakdown Mode</button>
        <button class="fc-btn${APP.chapter.useFullChapters ? ' fcon' : ''}" id="fc_mode_full">◉ Full Chapters</button>
        <button class="fc-btn" id="find_replace_btn" onclick="openFindReplacePanel()">Find/Replace</button>
      </div>
      
      <div id="ch_breakdown_section" style="display:${APP.chapter.useFullChapters ? 'none' : 'block'}">
        <div style="margin-bottom:14px">
          <button class="add-btn" id="add_breakdown" style="background:#0f180d;border-color:#263422;color:#7aac74">+ Add Breakdown</button>
        </div>
        <div id="breakdowns_container"></div>
      </div>
      ` : ''}
      
      <div id="ch_fullchapters_section" style="display:${isScene || APP.chapter.useFullChapters ? 'block' : 'none'}">
        <div style="margin-bottom:14px">
          <button class="add-btn" id="add_full_chapter" style="background:#0f180d;border-color:#263422;color:#7aac74">${isScene ? '+ Add Scene' : '+ Add Chapter'}</button>
        </div>
        <div id="fc_chapters_container"></div>
      </div>
      
      <hr class="divider">
      <div class="list-hd">
        <span class="list-lbl">Settings (<span id="set_cnt">${APP.chapter.settings.length}</span>)</span>
        <button class="add-btn" id="add_setting">+ Add Setting</button>
      </div>
      <div id="settings_list"></div>
      <div class="export-bar">
        <button class="add-btn" onclick="autoToggleContext()" style="background:#1a1512;border-color:#c8a660;color:#c8a660;margin-right:8px">🧠 Smart Context</button>
        <button class="add-btn" onclick="analyzeLocalText()" style="background:#1a1512;border-color:#7aac74;color:#7aac74;margin-right:8px">📊 Local Analysis</button>
        <span class="export-lbl">Export complete chapter package as a single .md file</span>
        <button class="export-btn" id="ch_export">↓ Export Chapter .md</button>
      </div>
    </div>`;

      // Level toggle (Chapter/Scene)
      ['chapter', 'scene'].forEach(m => {
        const btn = p.querySelector(`#ch_mode_${m}`);
        if (btn) {
          btn.addEventListener('click', () => {
            APP.chapter.mode = m;
            APP.chapter.useFullChapters = true;
            p.querySelector('#ch_mode_chapter').classList.toggle('mon', m === 'chapter');
            p.querySelector('#ch_mode_scene').classList.toggle('mon', m === 'scene');
            const sn = p.querySelector('#scene_num_wrap');
            if (sn) sn.style.display = m === 'scene' ? 'flex' : 'none';
            saveState();
            renderChapter();
          });
        }
      });

      // Breakdown/Full Chapters toggle (Chapter level only)
      const bdBtn = p.querySelector('#fc_mode_breakdown');
      if (bdBtn) {
        bdBtn.addEventListener('click', () => {
          APP.chapter.useFullChapters = false;
          p.querySelector('#fc_mode_breakdown').classList.add('fcon');
          p.querySelector('#fc_mode_full').classList.remove('fcon');
          const bd = p.querySelector('#ch_breakdown_section');
          if (bd) bd.style.display = 'block';
          const fc = p.querySelector('#ch_fullchapters_section');
          if (fc) fc.style.display = 'none';
          saveState();
          renderBreakdowns();
        });
      }

      const fcBtn = p.querySelector('#fc_mode_full');
      if (fcBtn) {
        fcBtn.addEventListener('click', () => {
          APP.chapter.useFullChapters = true;
          p.querySelector('#fc_mode_full').classList.add('fcon');
          p.querySelector('#fc_mode_breakdown').classList.remove('fcon');
          const bd = p.querySelector('#ch_breakdown_section');
          if (bd) bd.style.display = 'none';
          const fc = p.querySelector('#ch_fullchapters_section');
          if (fc) fc.style.display = 'block';
          saveState();
          renderFullChapters();
        });
      }

      p.querySelector('#ch_num')?.addEventListener('input', e => { APP.chapter.chapterNum = e.target.value; saveState(); });
      p.querySelector('#ch_snum')?.addEventListener('input', e => { APP.chapter.sceneNum = e.target.value; saveState(); });

      const addFullBtn = p.querySelector('#add_full_chapter');
      if (addFullBtn) {
        addFullBtn.addEventListener('click', () => {
          const isNowScene = APP.chapter.mode === 'scene';
          APP.chapter.fullChapters.push({
            type: 'chapter',
            number: APP.chapter.fullChapters.length + 1,
            sceneNumber: isNowScene ? 1 : 0,
            label: '',
            text: ''
          });
          saveState();
          renderFullChapters();
        });
      }

      const addBdBtn = p.querySelector('#add_breakdown');
      if (addBdBtn) {
        addBdBtn.addEventListener('click', () => {
          APP.chapter.breakdowns = APP.chapter.breakdowns || [];
          APP.chapter.breakdowns.push({ type: 'chapter', number: APP.chapter.breakdowns.length + 1, text: '' });
          saveState();
          renderBreakdowns();
        });
      }

      const addSetBtn = p.querySelector('#add_setting');
      if (addSetBtn) {
        addSetBtn.addEventListener('click', () => {
          APP.chapter.settings.push({ id: mkId(), ...mkSec() });
          saveState();
          renderSettingsList();
        });
      }

      const chExport = p.querySelector('#ch_export');
      if (chExport) {
        chExport.addEventListener('click', exportChapter);
      }

      if (isScene || APP.chapter.useFullChapters) {
        renderFullChapters();
      } else {
        renderBreakdowns();
      }
      renderSettingsList();

      // Add help icons
      addHelp(p.querySelector('#ch_mode_chapter'), 'Edit at chapter level - use for full chapters or breakdowns');
      addHelp(p.querySelector('#ch_mode_scene'), 'Edit at scene level - use for individual scenes within a chapter');
      addHelp(p.querySelector('#ch_num').parentElement, 'Current chapter number you\'re working on');
      const sceneNumWrap = p.querySelector('#scene_num_wrap');
      if (sceneNumWrap) addHelp(sceneNumWrap, 'Scene number within the chapter');
      const fcToggle = p.querySelector('#fc_toggle');
      if (fcToggle) addHelp(fcToggle, 'Breakdown = brief summary mode | Full = paste complete text');
    }

    function renderFullChapters() {
      const container = document.getElementById('fc_chapters_container');
      if (!container) return;

      const isSceneLevel = APP.chapter.mode === 'scene';

      const sortedChapters = [...APP.chapter.fullChapters].sort((a, b) => {
        const order = { prologue: 0, chapter: 1, epilogue: 2 };
        const orderA = order[a.type] ?? 1;
        const orderB = order[b.type] ?? 1;
        if (orderA !== orderB) return orderA - orderB;
        if (a.number !== b.number) return (a.number || 0) - (b.number || 0);
        if (isSceneLevel) return (a.sceneNumber || 0) - (b.sceneNumber || 0);
        return 0;
      });

      container.innerHTML = '';

      sortedChapters.forEach((chap, idx) => {
        renderFullChapter(container, chap, idx);
      });

      if (APP.chapter.fullChapters.length === 0) {
        container.innerHTML = '<div style="padding:20px;text-align:center;color:#50483a;font-style:italic">No chapters added yet. Click "+ Add Chapter" to begin.</div>';
      }
    }

    function renderFullChapter(container, val, idx) {
      const div = document.createElement('div');
      div.className = 'fc-chap';
      div.dataset.idx = idx;

      const isSceneLevel = APP.chapter.mode === 'scene';
      const typeLabel = val.type === 'prologue' ? 'Prologue' : val.type === 'epilogue' ? 'Epilogue' : (isSceneLevel ? 'Scene' : 'Chapter');
      const displayLabel = val.type !== 'chapter' ? typeLabel : (isSceneLevel ? `Scene ${val.number || ''}.${val.sceneNumber || ''}` : `Chapter ${val.number || ''}`);

      const sceneNumField = isSceneLevel ? `<input type="number" class="fc-scene-num" data-field="sceneNumber" value="${val.sceneNumber || ''}" placeholder="Sc#" style="width:50px;background:#0d0b08;border:1px solid #252015;color:#a89868;font-family:'JetBrains Mono',monospace;font-size:11px;padding:3px 5px;border-radius:2px">` : '';

      div.innerHTML = `
    <div class="fc-chap-hd" style="display:flex;justify-content:space-between;align-items:center">
      <span class="fc-chap-lbl">${esc(displayLabel)}</span>
      <button class="rm-chap-btn" data-idx="${idx}" style="background:transparent;border:none;color:#c06050;cursor:pointer;font-size:14px">×</button>
    </div>
    <div style="display:flex;gap:8px;padding:8px;background:#0a0807;border-bottom:1px solid #181510">
      <select class="fc-type-select" data-field="type" style="background:#0d0b08;border:1px solid #252015;color:#a89868;font-family:'JetBrains Mono',monospace;font-size:10px;padding:3px 5px;border-radius:2px">
        <option value="prologue" ${val.type === 'prologue' ? 'selected' : ''}>Prologue</option>
        <option value="chapter" ${val.type === 'chapter' ? 'selected' : ''}>${isSceneLevel ? 'Chapter/Scene' : 'Chapter'}</option>
        <option value="epilogue" ${val.type === 'epilogue' ? 'selected' : ''}>Epilogue</option>
      </select>
      <input type="number" class="fc-chap-num" data-field="number" value="${val.number || ''}" placeholder="${isSceneLevel ? 'Ch#' : '#'}" style="width:50px;background:#0d0b08;border:1px solid #252015;color:#a89868;font-family:'JetBrains Mono',monospace;font-size:11px;padding:3px 5px;border-radius:2px">
      ${sceneNumField}
    </div>
    <textarea placeholder="${isSceneLevel ? 'Paste scene text here...' : 'Paste chapter text here...'}">${esc(val.text)}</textarea>
  `;
      container.appendChild(div);

      div.querySelector('.rm-chap-btn')?.addEventListener('click', () => {
        APP.chapter.fullChapters = APP.chapter.fullChapters.filter((_, i) => i !== idx);
        saveState();
        renderFullChapters();
      });

      div.querySelector('.fc-type-select')?.addEventListener('change', e => {
        APP.chapter.fullChapters[idx].type = e.target.value;
        saveState();
        renderFullChapters();
      });

      div.querySelector('.fc-chap-num').addEventListener('input', e => {
        APP.chapter.fullChapters[idx].number = parseInt(e.target.value) || 0;
        saveState();
        renderFullChapters();
      });

      div.querySelector('.fc-scene-num')?.addEventListener('input', e => {
        APP.chapter.fullChapters[idx].sceneNumber = parseInt(e.target.value) || 0;
        saveState();
        renderFullChapters();
      });

      div.querySelector('textarea').addEventListener('input', e => {
        APP.chapter.fullChapters[idx].text = e.target.value;
        saveState();
      });
    }

    function renderBreakdowns() {
      const container = document.getElementById('breakdowns_container');
      if (!container) return;

      const breakdowns = APP.chapter.breakdowns || [];
      const sorted = [...breakdowns].sort((a, b) => {
        const order = { prologue: 0, chapter: 1, epilogue: 2 };
        const orderA = order[a.type] ?? 1;
        const orderB = order[b.type] ?? 1;
        if (orderA !== orderB) return orderA - orderB;
        return (a.number || 0) - (b.number || 0);
      });

      container.innerHTML = '';

      sorted.forEach((val, idx) => {
        const div = document.createElement('div');
        div.className = 'sb';
        div.style.marginBottom = '14px';

        const typeLabel = val.type === 'prologue' ? 'Prologue' : val.type === 'epilogue' ? 'Epilogue' : 'Chapter';
        const displayLabel = val.type !== 'chapter' ? typeLabel : `${typeLabel} ${val.number || ''}`;

        div.innerHTML = `
      <div class="sb-head" style="display:flex;justify-content:space-between;align-items:center">
        <span class="sb-title">${esc(displayLabel)}</span>
        <button class="rm-chap-btn" data-idx="${idx}" style="background:transparent;border:none;color:#c06050;cursor:pointer;font-size:14px">×</button>
      </div>
      <div style="display:flex;gap:8px;padding:8px;background:#0a0807;border-bottom:1px solid #181510">
        <select class="breakdown-type-select" data-field="type" style="background:#0d0b08;border:1px solid #252015;color:#a89868;font-family:'JetBrains Mono',monospace;font-size:10px;padding:3px 5px;border-radius:2px">
          <option value="prologue" ${val.type === 'prologue' ? 'selected' : ''}>Prologue</option>
          <option value="chapter" ${val.type === 'chapter' ? 'selected' : ''}>Chapter</option>
          <option value="epilogue" ${val.type === 'epilogue' ? 'selected' : ''}>Epilogue</option>
        </select>
        <input type="number" class="breakdown-num" data-field="number" value="${val.number || ''}" placeholder="#" style="width:50px;background:#0d0b08;border:1px solid #252015;color:#a89868;font-family:'JetBrains Mono',monospace;font-size:11px;padding:3px 5px;border-radius:2px">
      </div>
      <textarea class="sb-ta" placeholder="POV, synopsis, theme, hook, conflict, resolution, reader questions, plot points, alternative versions...">${esc(val.text)}</textarea>
    `;
        container.appendChild(div);

        div.querySelector('.rm-chap-btn').addEventListener('click', () => {
          APP.chapter.breakdowns = APP.chapter.breakdowns.filter((_, i) => i !== idx);
          saveState();
          renderBreakdowns();
        });

        div.querySelector('.breakdown-type-select').addEventListener('change', e => {
          APP.chapter.breakdowns[idx].type = e.target.value;
          saveState();
          renderBreakdowns();
        });

        div.querySelector('.breakdown-num').addEventListener('input', e => {
          APP.chapter.breakdowns[idx].number = parseInt(e.target.value) || 0;
          saveState();
          renderBreakdowns();
        });

        div.querySelector('.sb-ta').addEventListener('input', e => {
          APP.chapter.breakdowns[idx].text = e.target.value;
          saveState();
        });
      });

      if (breakdowns.length === 0) {
        container.innerHTML = '<div style="padding:20px;text-align:center;color:#50483a;font-style:italic">No breakdowns added yet. Click "+ Add Breakdown" to begin.</div>';
      }
    }

    function renderSettingsList() {
      const list = document.getElementById('settings_list');
      if (!list) return;
      const cnt = document.getElementById('set_cnt');
      if (cnt) cnt.textContent = APP.chapter.settings.length;
      list.innerHTML = '';
      APP.chapter.settings.forEach((s, i) => {
        const wrap = document.createElement('div');
        wrap.className = 'list-item';
        if (APP.chapter.settings.length > 1) {
          const rm = document.createElement('button');
          rm.className = 'rm-btn'; rm.innerHTML = '×';
          rm.addEventListener('click', () => {
            APP.chapter.settings = APP.chapter.settings.filter(x => x.id !== s.id);
            saveState(); renderSettingsList();
          });
          wrap.appendChild(rm);
        }
        const holder = document.createElement('div');
        holder.id = `sb_setting_${s.id}`;
        wrap.appendChild(holder);
        list.appendChild(wrap);
        renderSBDirect(`sb_setting_${s.id}`, APP.chapter.settings, i, {
          title: `Setting${APP.chapter.settings.length > 1 ? ' ' + (i + 1) : ''}`,
          desc: 'Name, location, role, season, unique features, sights, sounds, smells, notes',
          rows: 7, exportFn: () => `setting-${i + 1}.md`,
          allowGenerate: true,
          generateTitle: 'from Chapter/Scene',
          onGenerate: (index) => generateSettingFromChapter(index)
        });
      });
    }

    function exportChapter() {
      const lbl = APP.chapter.mode === 'scene' && APP.chapter.sceneNum
        ? `Chapter ${APP.chapter.chapterNum} Scene ${APP.chapter.sceneNum}`
        : `Chapter ${APP.chapter.chapterNum || 'X'}`;
      let md = `# ${lbl}\n\n`;
      if (APP.chapter.breakdown.text?.trim()) md += `## Chapter Breakdown\n\n${APP.chapter.breakdown.text}\n\n`;
      APP.chapter.settings.forEach((s, i) => {
        if (s.text?.trim()) md += `## Setting ${i + 1}\n\n${s.text}\n\n`;
      });
      const prefix = APP.book.title ? APP.book.title.replace(/\s+/g, '-').toLowerCase() + '-' : '';
      dlMd(md, `${prefix}${lbl.replace(/\s+/g, '-').toLowerCase()}.md`);
    }

    function generateSettingFromChapter(settingIdx) {
      let sourceText = "";

      // Extract text from Full Chapters/Scenes
      const fullChapters = APP.chapter.fullChapters?.filter(c => c.text?.trim()) || [];
      const fullText = fullChapters.map(c => c.text.trim()).join('\n\n');

      // Extract text from Breakdowns
      const breakdowns = APP.chapter.breakdowns?.filter(b => b.text?.trim()) || [];
      const breakdownText = breakdowns.map(b => b.text.trim()).join('\n\n');

      // Favor full chapters/scenes over breakdowns if both exist
      if (fullText) {
        sourceText = fullText;
      } else if (breakdownText) {
        sourceText = breakdownText;
      }

      if (!sourceText) {
        alert("Please add text to your Chapter or Scene first to generate a setting.");
        return;
      }

      const promptText = `Analyze the following chapter or scene text and extract all relevant details to create a detailed setting description.

Return the setting details formatted as follows:
- **Name:** [Name of the setting]
- **Location:** [Geographical or relative location]
- **Role:** [Purpose or role of the setting in the story]
- **Season/Time:** [Time of day, season, etc.]
- **Unique Features:** [Distinguishing marks or features]
- **Sights:** [Visual details]
- **Sounds:** [Auditory details]
- **Smells:** [Olfactory details]
- **Notes:** [Any other relevant notes or atmosphere]

Text to analyze:
${sourceText}`;

      const output = showProgress('⚡', 'Generating Setting from text...');

      let accumulatedText = "";

      callAPI(promptText,
        chunk => {
          if (chunk) {
            accumulatedText += chunk;
            output.update(chunk);
            // We also update the textarea in real-time
            APP.chapter.settings[settingIdx].text = accumulatedText;
            const containerId = `sb_setting_${APP.chapter.settings[settingIdx].id}`;
            const ta = document.getElementById(containerId)?.querySelector('.sb-ta');
            if (ta) ta.value = accumulatedText;
          }
        },
        () => {
          output.complete('Setting generated successfully!');
          saveState();
          renderSettingsList(); // re-render to ensure state is clean
        },
        err => {
          output.error('Error generating setting: ' + err);
        },
        null
      );
    }

    // ═══════════════════════════════════════════════════════════
    // PANEL: PROMPTS
    // ═══════════════════════════════════════════════════════════
    // STORY TAB (Characters + Relationships + Timeline)
    // ═══════════════════════════════════════════════════════════

    let storySubTab = localStorage.getItem('na_story_subtab') || 'characters';

    function renderStory() {
      const p = document.getElementById('panel-story');
      if (!p) return;

      p.innerHTML = `
    <div class="ctx-scroll" style="max-width:900px">
      <div class="ctx-head">
        <h2>Story Elements</h2>
        <p>Characters, relationships, and timeline for your story.</p>
      </div>
      
      <div class="story-subtabs">
        <button class="story-subtab ${storySubTab === 'characters' ? 'active' : ''}" data-subtab="characters">Characters</button>
        <button class="story-subtab ${storySubTab === 'relationships' ? 'active' : ''}" data-subtab="relationships">Relationships</button>
        <button class="story-subtab ${storySubTab === 'timeline' ? 'active' : ''}" data-subtab="timeline">Timeline</button>
        <button class="story-subtab ${storySubTab === 'styledna' ? 'active' : ''}" data-subtab="styledna">Style DNA</button>
      </div>
      
      <div id="story-content"></div>
    </div>
  `;

      p.querySelectorAll('.story-subtab').forEach(btn => {
        btn.addEventListener('click', () => {
          storySubTab = btn.dataset.subtab;
          localStorage.setItem('na_story_subtab', storySubTab);
          renderStory();
        });
      });

      renderStoryContent();
    }

    function renderStoryContent() {
      const container = document.getElementById('story-content');
      if (!container) return;

      if (storySubTab === 'characters') {
        renderStoryCharacters(container);
      } else if (storySubTab === 'relationships') {
        renderStoryRelationships(container);
      } else if (storySubTab === 'timeline') {
        renderStoryTimeline(container);
      } else if (storySubTab === 'styledna') {
        renderStyleDNASection(container);
      }
    }

    function renderStoryCharacters(container) {
      if (!APP.book) APP.book = { title: '', bookNum: '', totalBooks: '', subNum: '', totalSub: '', bible: mkSec(), outline: mkSec(), chars: [{ id: mkId(), ...mkSec() }] };
      const chars = APP.book.chars || [];

      container.innerHTML = `
    <div class="list-hd">
      <span class="list-lbl">Characters (${chars.length})</span>
      <button class="add-btn" onclick="addCharacter()">+ Add Character</button>
    </div>
    <div id="story-chars-list"></div>
  `;

      renderStoryCharsList();
    }

    function renderStoryCharsList() {
      const list = document.getElementById('story-chars-list');
      if (!list) return;
      const chars = APP.book?.chars || [];

      if (chars.length === 0) {
        list.innerHTML = '<div class="empty-msg">No characters yet. Click "+ Add Character" to create one.</div>';
        return;
      }

      list.innerHTML = chars.map((c, i) => `
    <div class="ch-item" data-idx="${i}">
      <div class="ch-item-hd">
        <span class="ch-num">${i + 1}</span>
        <span class="ch-title">${esc(c.data?.text?.split('\n')[0] || 'Unnamed')}</span>
      </div>
      <div class="ch-item-bd">${esc(c.data?.text || '').substring(0, 100)}${c.data?.text?.length > 100 ? '...' : ''}</div>
      <div class="ch-item-ft">
        <button class="ch-edit" data-idx="${i}" onclick="editCharacter(${i})">Edit</button>
        <button class="ch-delete" data-idx="${i}" onclick="deleteCharacter(${i})">Delete</button>
      </div>
    </div>
  `).join('');

      list.querySelectorAll('.ch-edit').forEach(btn => {
        btn.addEventListener('click', () => { editCharacter(parseInt(btn.dataset.idx)); });
      });
      list.querySelectorAll('.ch-delete').forEach(btn => {
        btn.addEventListener('click', () => { if (confirm('Delete this character?')) { deleteCharacter(parseInt(btn.dataset.idx)); renderStoryCharsList(); } });
      });
    }

    function renderStoryRelationships(container) {
      const rels = getBookRelationships();
      const chars = APP.book?.chars || [];

      container.innerHTML = `
    <div class="list-hd">
      <span class="list-lbl">Relationships (${rels.length})</span>
      <button class="add-btn" onclick="openRelationshipModal()">+ Add Relationship</button>
      <button class="add-btn" onclick="openRelationshipMapModal()" style="margin-left:8px;background:#1a1512;border-color:#3a3020;color:#c8a660">View Map</button>
    </div>
    <div id="story-rels-list"></div>
  `;

      renderRelsList();
    }

    function renderStoryTimeline(container) {
      const timeline = getSeriesTimeline();
      const books = [APP.book].filter(b => b && b.title);
      const chapters = APP.chapter?.fullChapters || [];

      container.innerHTML = `
    <div class="list-hd">
      <span class="list-lbl">Timeline Events (${timeline.length})</span>
      <button class="add-btn" onclick="openTimelineEventModal()">+ Add Event</button>
      <button class="add-btn" onclick="openTimelineVisualModal()" style="margin-left:8px;background:#1a1512;border-color:#3a3020;color:#c8a660">View Timeline</button>
    </div>
    <div id="story-timeline-list"></div>
  `;

      renderTimelineList();
    }

    function renderTimelineList() {
      const list = document.getElementById('story-timeline-list');
      if (!list) return;
      const timeline = getSeriesTimeline();

      if (timeline.length === 0) {
        list.innerHTML = '<div class="empty-msg">No timeline events yet. Click "+ Add Event" to create one. Events are saved at the series level and can span multiple books.</div>';
        return;
      }

      list.innerHTML = timeline.map(e => {
        const type = getEventTypes().find(t => t.id === e.eventType);
        return `<div class="timeline-item" style="border-left:3px solid ${type?.color || '#c8a660'}">
      <div class="timeline-title">${esc(e.title)}</div>
      <div class="timeline-type" style="color:${type?.color || '#c8a660'}">${type?.label || e.eventType}</div>
      ${e.description ? '<div class="timeline-desc">' + esc(e.description) + '</div>' : ''}
      <div class="timeline-meta">
        ${e.date ? '<span>📅 ' + esc(e.date) + '</span>' : ''}
      </div>
      <div class="timeline-actions">
        <button class="timeline-edit" data-id="${e.id}">Edit</button>
        <button class="timeline-delete" data-id="${e.id}">Delete</button>
      </div>
    </div>`;
      }).join('');

      list.querySelectorAll('.timeline-edit').forEach(btn => {
        btn.addEventListener('click', () => { openTimelineEventModal(btn.dataset.id); });
      });
      list.querySelectorAll('.timeline-delete').forEach(btn => {
        btn.addEventListener('click', () => { if (confirm('Delete this event?')) { deleteTimelineEvent(btn.dataset.id); renderTimelineList(); } });
      });
    }

    // Timeline Modal Functions
    window.openTimelineEventModal = function (editId) {
      const timeline = getSeriesTimeline();
      const existing = editId ? timeline.find(e => e.id === editId) : null;
      const books = [APP.book].filter(b => b && b.title);
      const chapters = APP.chapter?.fullChapters || [];
      const types = getEventTypes();

      const isOpen = document.getElementById('timeline_modal');
      if (isOpen) { isOpen.remove(); }

      const html = `<div class="timeline-modal-overlay" id="timeline_modal">
    <div class="timeline-modal">
      <div class="timeline-modal-hd">
        <h3>${existing ? 'Edit Event' : 'Add Timeline Event'}</h3>
        <button class="timeline-modal-close" onclick="closeTimelineEventModal()">×</button>
      </div>
      <div class="timeline-modal-body">
        <div class="timeline-field"><label>Title *</label><input type="text" id="timeline_title" value="${existing ? esc(existing.title) : ''}" placeholder="Event title"></div>
        <div class="timeline-field"><label>Event Type</label><select id="timeline_type">${types.map(t => `<option value="${t.id}" ${existing?.eventType === t.id ? 'selected' : ''}>${t.label}</option>`).join('')}</select></div>
        <div class="timeline-field"><label>Description</label><textarea id="timeline_desc" placeholder="What happens...">${existing ? esc(existing.description) : ''}</textarea></div>
        <div class="timeline-field"><label>Book (optional)</label><select id="timeline_book"><option value="">-- None --</option>${books.map(b => `<option value="book" ${existing?.bookId === 'book' ? 'selected' : ''}>${esc(b.title)}</option>`).join('')}</select></div>
        <div class="timeline-field"><label>Chapter (optional)</label><select id="timeline_chapter"><option value="">-- None --</option>${chapters.map((c, i) => `<option value="${c.id}" ${existing?.chapterId === c.id ? 'selected' : ''}>Chapter ${i + 1}: ${esc(c.title || c.text?.substring(0, 20) || 'Untitled')}</option>`).join('')}</select></div>
        <div class="timeline-field"><label>Date/Order</label><input type="text" id="timeline_date" value="${existing ? esc(existing.date) : ''}" placeholder="e.g., Year 1, Day 45, etc."></div>
        <div class="timeline-actions-row"><button class="timeline-btn-cancel" onclick="closeTimelineEventModal()">Cancel</button><button class="timeline-btn-save" onclick="saveTimelineEvent('${editId || ''}')">${existing ? 'Update' : 'Add'}</button></div>
      </div>
    </div>
  </div>`;

      document.body.insertAdjacentHTML('beforeend', html);
      document.getElementById('timeline_modal').classList.add('open');
      document.getElementById('timeline_modal').addEventListener('click', (e) => { if (e.target.id === 'timeline_modal') closeTimelineEventModal(); });
    };

    window.closeTimelineEventModal = function () {
      const m = document.getElementById('timeline_modal');
      if (m) m.remove();
    };

    window.saveTimelineEvent = function (editId) {
      const title = document.getElementById('timeline_title').value.trim();
      if (!title) { alert('Title is required'); return; }
      const description = document.getElementById('timeline_desc').value;
      const eventType = document.getElementById('timeline_type').value;
      const bookId = document.getElementById('timeline_book').value;
      const chapterId = document.getElementById('timeline_chapter').value;
      const date = document.getElementById('timeline_date').value;

      if (editId) {
        updateTimelineEvent(editId, { title, description, eventType, bookId, chapterId, date });
      } else {
        addTimelineEvent(title, description, eventType, bookId, chapterId, date);
      }
      closeTimelineEventModal();
      renderTimelineList();
    };

    window.openTimelineVisualModal = function () {
      const timeline = getSeriesTimeline();
      if (timeline.length === 0) { alert('Add some events first!'); return; }

      const isOpen = document.getElementById('timeline_visual_modal');
      if (isOpen) { isOpen.remove(); }

      const html = `<div class="timeline-visual-overlay" id="timeline_visual_modal">
    <div class="timeline-visual-modal">
      <div class="timeline-visual-hd">
        <h3>Story Timeline</h3>
        <button class="timeline-visual-close" onclick="closeTimelineVisualModal()">×</button>
      </div>
      <div class="timeline-visual-body"><div id="timeline_visual_container"></div></div>
    </div>
  </div>`;

      document.body.insertAdjacentHTML('beforeend', html);
      document.getElementById('timeline_visual_modal').classList.add('open');
      document.getElementById('timeline_visual_modal').addEventListener('click', (e) => { if (e.target.id === 'timeline_visual_modal') closeTimelineVisualModal(); });
      setTimeout(renderTimelineVisual, 100);
    };

    window.closeTimelineVisualModal = function () {
      const m = document.getElementById('timeline_visual_modal');
      if (m) m.remove();
    };

    function renderTimelineVisual() {
      const container = document.getElementById('timeline_visual_container');
      if (!container) return;
      const timeline = getSeriesTimeline();
      const types = getEventTypes();

      container.innerHTML = `<div class="timeline-visual-scroll">
    <div class="timeline-visual-line"></div>
    ${timeline.map((e, i) => {
        const type = types.find(t => t.id === e.eventType);
        return `<div class="timeline-visual-event" style="--color:${type?.color || '#c8a660'}">
        <div class="timeline-visual-dot"></div>
        <div class="timeline-visual-card">
          <div class="timeline-visual-title">${esc(e.title)}</div>
          <div class="timeline-visual-type">${type?.label || e.eventType}</div>
          ${e.description ? '<div class="timeline-visual-desc">' + esc(e.description) + '</div>' : ''}
          ${e.date ? '<div class="timeline-visual-date">' + esc(e.date) + '</div>' : ''}
        </div>
      </div>`;
      }).join('')}
  </div>`;
    }

    // Timeline Import/Export
    window.exportTimeline = function () {
      const data = JSON.stringify(getSeriesTimeline(), null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'novelist-atelier-timeline-' + Date.now() + '.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    };

    window.importTimeline = function () {
      const input = document.getElementById('timeline_import_file');
      input.click();
    };

    window.addEventListener('DOMContentLoaded', function () {
      document.getElementById('timeline_import_file').addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (event) {
          try {
            const data = JSON.parse(event.target.result);
            if (!Array.isArray(data)) throw new Error('Invalid format');
            const merge = confirm('Merge with existing timeline? OK to merge, Cancel to replace all.');
            if (merge) {
              const existing = getSeriesTimeline();
              data.forEach(ev => { if (!existing.find(e => e.id === ev.id)) existing.push(ev); });
              saveSeriesTimeline(existing);
            } else {
              saveSeriesTimeline(data);
            }
            renderTimelineList();
            alert('Timeline imported successfully!');
          } catch (err) {
            alert('Error importing: ' + err.message);
          }
        };
        reader.readAsText(file);
        this.value = '';
      });
    });

    // ═══════════════════════════════════════════════════════════

    function renderPrompts() {
      const p = document.getElementById('panel-prompts');
      if (!p) return;
      const catIds = CATEGORIES.map(c => c.id);
      p.innerHTML = `
    <nav class="p-sidebar">
      <div class="p-sidebar-lbl">Editing Modes</div>
      ${CATEGORY_SECTIONS.map(s => `
        <div class="p-sidebar-sec">${s.label}</div>
        ${s.cats.map(catId => {
        const c = CATEGORIES.find(cat => cat.id === catId);
        if (!c) return '';
        return `<button class="pcatbtn${APP.prompts.cat === c.id ? ' pca' : ''}" data-cat="${c.id}" style="--cc:${c.color}">
            <span class="pci">${c.icon}</span>${c.label}
          </button>`;
      }).join('')}
      `).join('')}
    </nav>
    <div class="p-list" id="p_list"></div>
    <div class="p-editor" id="p_editor"></div>`;

      p.querySelectorAll('.pcatbtn').forEach(btn => {
        btn.addEventListener('click', () => {
          APP.prompts.cat = btn.dataset.cat;
          localStorage.setItem('na_prompts_cat', APP.prompts.cat);
          APP.prompts.promptId = null;
          APP.prompts.fields = {};
          p.querySelectorAll('.pcatbtn').forEach(b => b.classList.toggle('pca', b.dataset.cat === APP.prompts.cat));
          renderPromptList();
          renderPromptEditor();
        });
      });
      renderPromptList();
      renderPromptEditor();
    }

    function renderPromptList() {
      const list = document.getElementById('p_list'); if (!list) return;
      const cat = CATEGORIES.find(c => c.id === APP.prompts.cat);
      const catPrompts = PROMPTS[APP.prompts.cat] || [];
      const customPrompts = getCustomTemplatesForCategory(APP.prompts.cat) || [];
      const allPrompts = [...catPrompts, ...customPrompts];
      const showExtract = ['character', 'world', 'location'].includes(APP.prompts.cat);
      const extractBtn = APP.prompts.cat === 'character' ? '<button class="extract-btn" id="extract_chars">Extract Characters</button>' :
        APP.prompts.cat === 'world' ? '<button class="extract-btn" id="extract_world">Extract World Building</button>' :
          '<button class="extract-btn" id="extract_locs">Extract Locations</button>';
      list.innerHTML = `
    <div class="p-list-hd">
      <div class="p-list-bar" style="--cc:${cat.color}"></div>
      <div class="p-list-name" style="--cc:${cat.color}"><span style="color:${cat.color}">${cat.icon}</span>${cat.label}</div>
      <div class="p-list-cnt">${allPrompts.length} prompt${allPrompts.length !== 1 ? 's' : ''}</div>
    </div>
    <div style="padding:8px 10px;border-bottom:1px solid #181510">
      <button class="create-template-btn" onclick="openTemplateModal('${APP.prompts.cat}', null)">+ Create Template</button>
    </div>
    ${showExtract ? `
    <div class="extract-section" style="padding:10px;border-bottom:1px solid #181510;margin-bottom:8px">
      <div class="mlabel" style="margin-bottom:6px">Extract from Chapters</div>
      <textarea class="extract-text" id="extract_text" placeholder="Paste chapter text to extract from..." style="width:100%;min-height:60px;background:#0b0908;border:1px solid #1c1912;border-radius:2px;color:#a89868;font-family:'Crimson Pro',serif;font-size:12px;padding:8px;resize:vertical;margin-bottom:8px"></textarea>
      <div class="extract-row">
        ${extractBtn}
      </div>
      <div class="extract-result" id="extract_result" style="display:none">
        <textarea id="extract_output" readonly></textarea>
      </div>
    </div>` : ''}
    ${catPrompts.map(pr => `
      <button class="pcrd${APP.prompts.promptId === pr.id ? ' pcra' : ''}" data-pid="${pr.id}" style="--cc:${cat.color}">
        <div class="pcrd-t">${esc(pr.title)}</div>
        <div class="pcrd-d">${esc(pr.desc)}</div>
      </button>`).join('')}
    ${customPrompts.length > 0 ? '<div class="p-custom-header">Custom Templates</div>' : ''}
    ${customPrompts.map(pr => `
      <button class="pcrd custom-prompt${APP.prompts.promptId === pr.id ? ' pcra' : ''}" data-pid="${pr.id}" data-custom="true" style="--cc:${cat.color}">
        <div class="pcrd-t">${esc(pr.title)} <span class="custom-badge">Custom</span></div>
        <div class="pcrd-d">${esc(pr.desc)}</div>
        <div class="pcrd-actions">
          <span class="pcrd-edit" onclick="event.stopPropagation();openTemplateModal('${APP.prompts.cat}', '${pr.id}')">Edit</span>
          <span class="pcrd-delete" onclick="event.stopPropagation();deleteTemplate('${APP.prompts.cat}', '${pr.id}')">Delete</span>
        </div>
      </button>`).join('')}`;

      list.querySelectorAll('.pcrd').forEach(btn => {
        btn.addEventListener('click', () => {
          const same = APP.prompts.promptId === btn.dataset.pid;
          APP.prompts.promptId = same ? null : btn.dataset.pid;
          APP.prompts.fields = {};
          APP.prompts.output = '';
          list.querySelectorAll('.pcrd').forEach(b => b.classList.toggle('pcra', b.dataset.pid === APP.prompts.promptId));
          renderPromptEditor();
        });
      });

      if (showExtract) {
        setupExtractButtons();
      }
    }

    function renderPromptEditor() {
      const editor = document.getElementById('p_editor'); if (!editor) return;
      // First check built-in prompts
      let pr = APP.prompts.promptId ? (PROMPTS[APP.prompts.cat] || []).find(p => p.id === APP.prompts.promptId) : null;
      // Then check custom templates
      if (!pr && APP.prompts.promptId && APP.prompts.promptId.startsWith('custom-')) {
        const customList = getCustomTemplatesForCategory(APP.prompts.cat) || [];
        const customTpl = customList.find(t => t.id === APP.prompts.promptId);
        if (customTpl) {
          // Convert string template to function using a safer method
          pr = {
            id: customTpl.id,
            title: customTpl.title,
            desc: customTpl.desc,
            fields: customTpl.fields,
            tpl: function (f) {
              let result = customTpl.tpl;
              if (customTpl.fields) {
                customTpl.fields.forEach(field => {
                  const regex = new RegExp('\\$\\{f\\.' + field.key + '\\}', 'g');
                  result = result.replace(regex, f[field.key] || '');
                });
              }
              return result;
            }
          };
        }
      }
      if (!pr) {
        const pills = getContextPills();
        editor.innerHTML = `<div class="p-empty">
      <h3>Select a prompt to begin</h3>
      <p>${pills.length ? pills.length + ' context section' + (pills.length > 1 ? 's' : '') + ' active' : 'Add context in Series / Book / Chapter tabs'}</p>
    </div>`;
        return;
      }

      const pills = getContextPills();
      editor.innerHTML = `
    <div class="p-ehd">
      <div class="p-etit">${esc(pr.title)}</div>
      <div class="p-edesc">${esc(pr.desc)}</div>
    </div>
    <div class="p-ebody" id="p_fields">
      ${pr.fields.map(f => `
        <div class="pfl">
          <label>${esc(f.label)}</label>
          ${f.type === 'textarea'
          ? `<textarea placeholder="Enter ${esc(f.label.toLowerCase())}…" data-key="${f.key}" rows="5"></textarea>`
          : `<input type="text" placeholder="Enter ${esc(f.label.toLowerCase())}…" data-key="${f.key}">`
        }
        </div>`).join('')}
    </div>
    <div class="ctx-bar">
      <span class="ctx-bar-lbl">Context:</span>
      <div class="ctx-pills">
        ${pills.length === 0 ? '<span class="ctx-none">none</span>' : pills.map(pi => `<span class="cpill c${pi.mode}">${esc(pi.label)}</span>`).join('')}
      </div>
    </div>
    <div class="out-area">
      <div class="out-toolbar">
        <div class="out-status" id="out_status"><span>Ready</span></div>
        <div class="out-btns">
          <button class="sec-btn" id="copy_prompt_btn">Copy Prompt</button>
          <button class="sec-btn" id="copy_out_btn" disabled>Copy Output</button>
          <button class="sec-btn" id="dl_out_btn" disabled>↓ .md</button>
          <button class="sec-btn" onclick="showTokenBreakdown(APP.prompts.tpl, APP.prompts.fields)" style="margin-left:8px">📊 Breakdown</button>
          <button class="stop-btn" id="stop_btn" style="display:none">■ Stop</button>
          <button class="run-btn" id="run_btn" ${APP.apiKey ? '' : 'title="Add API key in Settings"'}>▶ Run</button>
        </div>
      </div>
      <div class="out-text" id="out_text"><span class="out-placeholder">Output will appear here…</span></div>
    </div>`;

      // Restore field values
      pr.fields.forEach(f => {
        const el = editor.querySelector(`[data-key="${f.key}"]`);
        if (el && APP.prompts.fields[f.key]) el.value = APP.prompts.fields[f.key];
        if (el) el.addEventListener('input', e => { APP.prompts.fields[f.key] = e.target.value; });
      });

      // Restore output
      if (APP.prompts.output) {
        document.getElementById('out_text').textContent = APP.prompts.output;
        document.getElementById('copy_out_btn').disabled = false;
        document.getElementById('dl_out_btn').disabled = false;
      }

      // Copy prompt
      document.getElementById('copy_prompt_btn').addEventListener('click', () => {
        const ctx = buildContext();
        const prefs = buildWritingPrefsInstructions();
        const genre = buildGenreCompareInstructions();
        const full = genre + prefs + ctx + pr.tpl(APP.prompts.fields);
        navigator.clipboard.writeText(full).then(() => {
          const btn = document.getElementById('copy_prompt_btn');
          btn.textContent = '✓ Copied'; btn.classList.add('ok');
          setTimeout(() => { btn.textContent = 'Copy Prompt'; btn.classList.remove('ok'); }, 2000);
        });
      });

      // Copy output
      document.getElementById('copy_out_btn').addEventListener('click', () => {
        if (!APP.prompts.output) return;
        navigator.clipboard.writeText(APP.prompts.output).then(() => {
          const btn = document.getElementById('copy_out_btn');
          btn.textContent = '✓ Copied'; btn.classList.add('ok');
          setTimeout(() => { btn.textContent = 'Copy Output'; btn.classList.remove('ok'); }, 2000);
        });
      });

      // Download output
      document.getElementById('dl_out_btn').addEventListener('click', () => {
        if (!APP.prompts.output) return;
        dlMd(APP.prompts.output, `${pr.id}-output.md`);
      });

      // Stop
      document.getElementById('stop_btn').addEventListener('click', () => {
        if (APP.prompts.abortCtrl) APP.prompts.abortCtrl.abort();
        APP.prompts.running = false;
        setRunState(false);
      });

      // Token warning function
      function updateTokenWarning() {
        const ctx = buildContext();
        const prefs = buildWritingPrefsInstructions();
        const genre = buildGenreCompareInstructions();
        const full = genre + prefs + ctx + pr.tpl(APP.prompts.fields);
        const estTokens = Math.round(full.length / 4);
        const limit = APP.maxTokens + (parseInt(document.getElementById('tok_boost')?.value) || 0);
        const pct = (estTokens / limit) * 100;
        const warningEl = document.getElementById('token_warning');
        if (!warningEl) return;
        if (pct > 100) {
          warningEl.className = 'token-warning err';
          warningEl.textContent = `~${(estTokens / 1000).toFixed(1)}k / ${(limit / 1000).toFixed(0)}k (OVER)`;
        } else if (pct > 80) {
          warningEl.className = 'token-warning warn';
          warningEl.textContent = `~${(estTokens / 1000).toFixed(1)}k / ${(limit / 1000).toFixed(0)}k`;
        } else {
          warningEl.className = 'token-warning ok';
          warningEl.textContent = `~${(estTokens / 1000).toFixed(1)}k tokens`;
        }
      }

      // Add token warning element
      const statusEl = document.getElementById('out_status');
      if (statusEl) {
        const tw = document.createElement('span');
        tw.id = 'token_warning';
        tw.className = 'token-warning ok';
        tw.style.marginLeft = '8px';
        statusEl.appendChild(tw);
        updateTokenWarning();
      }

      // Add input listeners to update token warning
      pr.fields.forEach(f => {
        const el = editor.querySelector(`[data-key="${f.key}"]`);
        if (el) el.addEventListener('input', updateTokenWarning);
      });

      // Run
      document.getElementById('run_btn').addEventListener('click', () => {
        if (APP.prompts.running) return;
        const ctx = buildContext();
        const prefs = buildWritingPrefsInstructions();
        const genre = buildGenreCompareInstructions();
        const prompt = genre + prefs + ctx + pr.tpl(APP.prompts.fields);
        APP.prompts.running = true;
        APP.prompts.output = '';
        APP.prompts.abortCtrl = new AbortController();

        const outText = document.getElementById('out_text');
        outText.textContent = '';
        const cursor = document.createElement('span');
        cursor.className = 'cursor-blink';
        outText.appendChild(cursor);

        setRunState(true);
        const t0 = Date.now();

        callAPI(prompt,
          chunk => {
            APP.prompts.output += chunk;
            outText.textContent = APP.prompts.output;
            outText.appendChild(cursor);
            outText.scrollTop = outText.scrollHeight;
          },
          () => {
            APP.prompts.running = false;
            outText.textContent = APP.prompts.output;
            setRunState(false, `Done · ${((Date.now() - t0) / 1000).toFixed(1)}s`);
            document.getElementById('copy_out_btn').disabled = false;
            document.getElementById('dl_out_btn').disabled = false;
            // Log to activity
            const pr = APP.prompts;
            const cat = CATEGORIES.find(c => c.id === pr.cat);
            addActivityLogEntry(`Generated: ${pr.promptId} (${cat?.label || pr.cat})`);
          },
          err => {
            APP.prompts.running = false;
            outText.textContent = 'Error: ' + err;
            setRunState(false, 'Error');
          },
          APP.prompts.abortCtrl.signal
        );
      });

      // Add help icon to Prompts editor
      const editorHd = editor.querySelector('.p-ehd');
      if (editorHd) {
        editorHd.style.position = 'relative';
        addHelp(editorHd, '<b>Context:</b> Shows what context sections (Series, Book, Chapter, Settings) are being included in the prompt.<br><br><b>Run:</b> Sends your prompt + context to the AI using your configured API.<br><br><b>Copy Prompt:</b> Copies the full prompt text (without running) to clipboard.<br><br><b>On/Off:</b> Toggle settings in Chapter tab to include or exclude them from context.');
      }
    }

    function setRunState(running, statusText = null) {
      const runBtn = document.getElementById('run_btn');
      const stopBtn = document.getElementById('stop_btn');
      const status = document.getElementById('out_status');
      if (!runBtn) return;
      if (running) {
        runBtn.textContent = 'Running…'; runBtn.classList.add('running'); runBtn.disabled = true;
        stopBtn.style.display = 'inline-block';
        status.innerHTML = '<span class="spin"></span><span>Generating…</span>';
      } else {
        runBtn.textContent = '▶ Run'; runBtn.classList.remove('running'); runBtn.disabled = false;
        stopBtn.style.display = 'none';
        status.innerHTML = `<span>${statusText || 'Ready'}</span>`;
      }
    }

    // ═══════════════════════════════════════════════════════════
    // PANEL: PIPELINE
    // ═══════════════════════════════════════════════════════════

    function getFirstTextareaKey(promptId, catId) {
      const pr = (PROMPTS[catId] || []).find(p => p.id === promptId);
      if (!pr) return null;
      const f = pr.fields.find(f => f.type === 'textarea');
      return f ? f.key : null;
    }

    function renderPipeline() {
      const p = document.getElementById('panel-pipeline');
      p.innerHTML = `
    <div class="pipe-layout">
      <div class="pipe-builder">
        <div class="pipe-hd">
          <h2>Pipeline</h2>
          <p>Chain multiple prompts in sequence. Each step builds on the last.</p>
        </div>
        <div class="pipe-mode">
          <button class="pm-btn${APP.pipeline.mode === 'refine' ? ' pmon' : ''}" id="pm_refine" data-mode="refine">
            ⟹ Refine<span>Each output feeds the next step</span>
          </button>
          <button class="pm-btn${APP.pipeline.mode === 'parallel' ? ' pmon' : ''}" id="pm_parallel" data-mode="parallel">
            ⊞ Multi-Lens<span>All steps analyze the same text</span>
          </button>
        </div>
        <div class="pipeline-style-opt">
          <input type="checkbox" id="use_writing_style" ${APP.pipeline.useWritingStyle ? 'checked' : ''}>
          <label for="use_writing_style">Use captured writing style for rewrites (in addition to new output)</label>
        </div>
        <div class="pipe-controls">
          <button class="pipe-run-btn" id="pipe_run">▶ Run All Steps</button>
          <button class="pipe-clear-btn" id="pipe_add">+ Step</button>
          <button class="pipe-clear-btn" id="pipe_clear">Clear All</button>
          <button class="pipe-save-btn" id="pipe_save" disabled>↓ Save Results</button>
        </div>
        <div id="pipeline_steps"></div>
      </div>
      <div class="pipe-results">
        <div class="res-hd">
          <span class="res-title">Results</span>
          <div class="res-actions">
            <button class="sec-btn" id="pipe_copy_all" disabled>Copy All</button>
            <button class="sec-btn" id="pipe_save_all" disabled>↓ Save All</button>
          </div>
        </div>
        <div id="res_summary" style="font-family:'JetBrains Mono',monospace;font-size:8px;color:#40382a;letter-spacing:.06em;margin-bottom:8px"></div>
        <div id="res_content"><div class="res-empty">Add steps and run to see results here</div></div>
      </div>
    </div>`;

      p.querySelectorAll('.pm-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          APP.pipeline.mode = btn.dataset.mode;
          p.querySelectorAll('.pm-btn').forEach(b => b.classList.toggle('pmon', b.dataset.mode === APP.pipeline.mode));
        });
      });

      // Writing style toggle
      p.querySelector('#use_writing_style').addEventListener('change', e => {
        APP.pipeline.useWritingStyle = e.target.checked;
      });

      p.querySelector('#pipe_add').addEventListener('click', addPipelineStep);
      p.querySelector('#pipe_clear').addEventListener('click', () => {
        APP.pipeline.steps = [];
        APP.pipeline.results = [];
        renderPipelineSteps();
        renderPipelineResults();
      });
      p.querySelector('#pipe_run').addEventListener('click', runPipeline);
      p.querySelector('#pipe_save').addEventListener('click', savePipelineResults);
      p.querySelector('#pipe_copy_all').addEventListener('click', copyAllPipelineResults);
      p.querySelector('#pipe_save_all').addEventListener('click', saveAllPipelineResults);

      renderPipelineSteps();
      renderPipelineResults();
    }

    function addPipelineStep() {
      const defCat = 'punch';
      const defPrompt = PROMPTS[defCat][0];
      APP.pipeline.steps.push({
        id: mkId(), cat: defCat, promptId: defPrompt.id,
        fields: {}, usePrev: APP.pipeline.steps.length > 0
      });
      renderPipelineSteps();
    }

    function renderPipelineSteps() {
      const container = document.getElementById('pipeline_steps'); if (!container) return;
      if (APP.pipeline.steps.length === 0) {
        container.innerHTML = `<div style="padding:16px;font-family:'Crimson Pro',serif;font-size:13px;color:#40382a;font-style:italic;text-align:center">No steps yet — click "+ Step" to begin</div>`;
        return;
      }
      container.innerHTML = '';
      APP.pipeline.steps.forEach((step, i) => {
        if (i > 0) {
          const conn = document.createElement('div');
          conn.className = 'connector';
          conn.textContent = APP.pipeline.mode === 'refine' ? '↓ output feeds next' : '↓';
          container.appendChild(conn);
        }
        const div = document.createElement('div');
        div.className = 'pipe-step';
        div.id = `step_${step.id}`;

        const cat = CATEGORIES.find(c => c.id === step.cat) || CATEGORIES[0];
        const stepPrompts = PROMPTS[step.cat] || [];
        const pr = stepPrompts.find(p => p.id === step.promptId) || stepPrompts[0];

        div.innerHTML = `
      <div class="pipe-step-hd">
        <div class="step-num">${i + 1}</div>
        <div class="step-selects">
          <select class="step-sel" id="step_cat_${step.id}">
            ${CATEGORIES.map(c => `<option value="${c.id}"${c.id === step.cat ? ' selected' : ''}>${c.label}</option>`).join('')}
          </select>
          <select class="step-sel" id="step_pr_${step.id}">
            ${stepPrompts.map(sp => `<option value="${sp.id}"${sp.id === step.promptId ? ' selected' : ''}>${esc(sp.title)}</option>`).join('')}
          </select>
        </div>
        <button class="step-rm" data-id="${step.id}">×</button>
      </div>
      <div class="step-body" id="step_body_${step.id}"></div>`;

        container.appendChild(div);

        // Remove
        div.querySelector('.step-rm').addEventListener('click', () => {
          APP.pipeline.steps = APP.pipeline.steps.filter(s => s.id !== step.id);
          renderPipelineSteps();
        });

        // Category change
        div.querySelector(`#step_cat_${step.id}`).addEventListener('change', e => {
          const s = APP.pipeline.steps.find(x => x.id === step.id);
          s.cat = e.target.value;
          const newPrompts = PROMPTS[s.cat] || [];
          s.promptId = newPrompts[0]?.id || '';
          s.fields = {};
          renderPipelineSteps();
        });

        // Prompt change
        div.querySelector(`#step_pr_${step.id}`).addEventListener('change', e => {
          const s = APP.pipeline.steps.find(x => x.id === step.id);
          s.promptId = e.target.value;
          s.fields = {};
          renderPipelineSteps();
        });

        // Step body
        renderStepBody(step, i, pr);
      });
    }

    function renderStepBody(step, i, pr) {
      const body = document.getElementById(`step_body_${step.id}`); if (!body || !pr) return;
      const firstTA = pr.fields.find(f => f.type === 'textarea');
      const canPipe = i > 0 && APP.pipeline.mode === 'refine' && firstTA;

      body.innerHTML = `
    ${canPipe ? `
      <div class="pipe-tog">
        <input type="checkbox" id="useprev_${step.id}" ${step.usePrev ? 'checked' : ''}>
        <label for="useprev_${step.id}">Use output from previous step as "${esc(firstTA.label)}"</label>
      </div>`: ''}
    <div class="pipe-tog">
      <input type="checkbox" id="style_dna_${step.id}" ${step.applyStyleDNA ? 'checked' : ''}>
      <label for="style_dna_${step.id}">🎨 Apply Style DNA <span style="color:#d44;font-size:10px">(requires AI)</span></label>
    </div>
    ${pr.fields.map(f => {
        const isPiped = canPipe && step.usePrev && f === firstTA;
        return `
        <div class="step-field">
          <label>${esc(f.label)}</label>
          ${isPiped
            ? `<div class="step-piped">← Will receive output from Step ${i}</div>`
            : f.type === 'textarea'
              ? `<textarea data-key="${f.key}" placeholder="${esc(f.label)}…" rows="3">${esc(step.fields[f.key] || '')}</textarea>`
              : `<input type="text" data-key="${f.key}" placeholder="${esc(f.label)}…" value="${esc(step.fields[f.key] || '')}">`
          }
        </div>`
      }).join('')}`;

      if (canPipe) {
        body.querySelector(`#useprev_${step.id}`).addEventListener('change', e => {
          step.usePrev = e.target.checked;
          renderStepBody(step, i, pr);
        });
      }
      const styleDnaCheck = body.querySelector(`#style_dna_${step.id}`);
      if (styleDnaCheck) {
        styleDnaCheck.addEventListener('change', e => {
          step.applyStyleDNA = e.target.checked;
        });
      }
      body.querySelectorAll('[data-key]').forEach(el => {
        el.addEventListener('input', e => { step.fields[e.target.dataset.key] = e.target.value; });
      });
    }

    async function runPipeline() {
      if (APP.pipeline.steps.length === 0) return;
      const runBtn = document.getElementById('pipe_run'); if (!runBtn) return;
      if (APP.pipeline.running) return;

      APP.pipeline.running = true;
      APP.pipeline.results = APP.pipeline.steps.map(s => ({ id: s.id, name: (PROMPTS[s.cat] || []).find(p => p.id === s.promptId)?.title || 'Step', status: 'waiting', text: '' }));
      runBtn.textContent = 'Running…'; runBtn.classList.add('running'); runBtn.disabled = true;
      document.getElementById('pipe_save').disabled = true;
      renderPipelineResults();

      const ctx = buildContext();
      let prevOutput = '';

      for (let i = 0; i < APP.pipeline.steps.length; i++) {
        const step = APP.pipeline.steps[i];
        const pr = (PROMPTS[step.cat] || []).find(p => p.id === step.promptId);
        if (!pr) continue;

        // Build fields for this step
        const fields = { ...step.fields };
        if (i > 0 && APP.pipeline.mode === 'refine' && step.usePrev) {
          const firstTA = pr.fields.find(f => f.type === 'textarea');
          if (firstTA) fields[firstTA.key] = prevOutput;
        } else if (i > 0 && APP.pipeline.mode === 'parallel' && !fields[pr.fields.find(f => f.type === 'textarea')?.key]) {
          // parallel: keep original text from step 0's output if available
        }

        const prompt = ctx + pr.tpl(fields);

        // Update result status
        APP.pipeline.results[i].status = 'running';
        APP.pipeline.results[i].text = '';
        renderPipelineResults();

        await new Promise((resolve) => {
          APP.pipeline.abortCtrl = new AbortController();
          callAPI(prompt,
            chunk => {
              APP.pipeline.results[i].text += chunk;
              const el = document.getElementById(`res_text_${step.id}`);
              if (el) { el.textContent = APP.pipeline.results[i].text; }
            },
            () => {
              APP.pipeline.results[i].status = 'done';
              prevOutput = APP.pipeline.results[i].text;
              updateResultStatus(step.id, 'done');
              resolve();
            },
            err => {
              APP.pipeline.results[i].status = 'err';
              APP.pipeline.results[i].text = 'Error: ' + err;
              updateResultStatus(step.id, 'err');
              resolve();
            },
            APP.pipeline.abortCtrl.signal
          );
        });
        // Small pause between steps
        if (i < APP.pipeline.steps.length - 1) await new Promise(r => setTimeout(r, 300));
      }

      APP.pipeline.running = false;
      runBtn.textContent = '▶ Run All Steps'; runBtn.classList.remove('running'); runBtn.disabled = false;
      const allDone = APP.pipeline.results.every(r => r.status === 'done');
      document.getElementById('pipe_save').disabled = !allDone;
      document.getElementById('pipe_copy_all').disabled = !allDone;
      document.getElementById('pipe_save_all').disabled = !allDone;
      document.getElementById('res_summary').textContent = `${APP.pipeline.results.filter(r => r.status === 'done').length}/${APP.pipeline.steps.length} completed`;
    }

    function updateResultStatus(stepId, status) {
      const el = document.getElementById(`res_status_${stepId}`);
      if (el) { el.className = `res-step-status ${status}`; el.textContent = status === 'done' ? 'Done' : status === 'running' ? 'Running…' : 'Error'; }
    }

    function renderPipelineResults() {
      const content = document.getElementById('res_content'); if (!content) return;
      if (APP.pipeline.results.length === 0) {
        content.innerHTML = '<div class="res-empty">Add steps and run to see results here</div>';
        return;
      }
      content.innerHTML = '';
      APP.pipeline.results.forEach((r, i) => {
        const div = document.createElement('div');
        div.className = 'res-step';
        const statusLabel = r.status === 'done' ? 'Done' : r.status === 'running' ? 'Running…' : r.status === 'err' ? 'Error' : 'Waiting';
        div.innerHTML = `
      <div class="res-step-hd">
        <div class="res-step-num">${i + 1}</div>
        <div class="res-step-name">${esc(r.name)}</div>
        <div class="res-step-status ${r.status}" id="res_status_${r.id}">${statusLabel}</div>
      </div>
      <div class="res-step-text" id="res_text_${r.id}">${esc(r.text) || '<span style="color:#281e14;font-style:italic">Waiting…</span>'}</div>`;
        content.appendChild(div);
      });
    }

    function savePipelineResults() {
      if (!APP.pipeline.results.length) return;
      let md = `# Pipeline Results\n\nGenerated by The Novelist's Atelier — ${new Date().toLocaleString()}\n\nMode: ${APP.pipeline.mode === 'refine' ? 'Refine (Sequential)' : 'Multi-Lens (Parallel)'}\n\n`;
      APP.pipeline.results.forEach((r, i) => {
        md += `## Step ${i + 1}: ${r.name}\n\n${r.text}\n\n---\n\n`;
      });
      dlMd(md, `pipeline-results-${Date.now()}.md`);
    }

    function copyAllPipelineResults() {
      if (!APP.pipeline.results.length) return;
      let text = `# Pipeline Results\n\nGenerated by The Novelist's Atelier — ${new Date().toLocaleString()}\n\n`;
      APP.pipeline.results.forEach((r, i) => {
        text += `\n=== Step ${i + 1}: ${r.name} ===\n\n${r.text}\n\n`;
      });
      navigator.clipboard.writeText(text).then(() => {
        const btn = document.getElementById('pipe_copy_all');
        if (btn) { btn.textContent = '✓ Copied'; btn.classList.add('ok'); }
        setTimeout(() => { if (btn) { btn.textContent = 'Copy All'; btn.classList.remove('ok'); } }, 2000);
      });
    }

    function saveAllPipelineResults() {
      if (!APP.pipeline.results.length) return;
      let md = `# Pipeline Results\n\nGenerated by The Novelist's Atelier — ${new Date().toLocaleString()}\n\nMode: ${APP.pipeline.mode === 'refine' ? 'Refine (Sequential)' : 'Multi-Lens (Parallel)'}\n\n`;
      APP.pipeline.results.forEach((r, i) => {
        md += `## Step ${i + 1}: ${r.name}\n\n${r.text}\n\n---\n\n`;
      });
      dlMd(md, `pipeline-results-${Date.now()}.md`);
    }

    // ═══════════════════════════════════════════════════════════
    // PANEL: SETTINGS
    // ═══════════════════════════════════════════════════════════

    function renderSettings() {
      const p = document.getElementById('panel-settings');
      // Filter models by current provider
      const filteredModels = MODELS.filter(m => m.provider === APP.provider);
      const grouped = {};
      filteredModels.forEach(m => { if (!grouped[m.provider]) grouped[m.provider] = []; grouped[m.provider].push(m); });

      p.innerHTML = `
    <div class="settings-scroll">
      <div class="settings-section">
        <div class="scard" style="background:#1a1512;border-color:#c8a660">
          <div class="scard-hd" style="color:#c8a660">🔒 Security Notice</div>
          <div class="scard-body">
            <p style="color:#a89070;font-size:13px;line-height:1.5">Your API keys can be stored in different ways. Choose the option that best fits your security needs:</p>
            
            <div style="margin-top:12px;padding:10px;background:#0b0908;border-radius:3px">
              <div style="color:#c8a660;font-size:12px;margin-bottom:4px">🔐 Password-Encrypted (Recommended)</div>
              <p style="color:#a89070;font-size:11px;margin:0">Keys encrypted with AES-256 before storing. You'll be prompted for your password when needed. Most secure option. <strong>Default mode.</strong></p>
            </div>
            
            <div style="margin-top:8px;padding:10px;background:#0b0908;border-radius:3px">
              <div style="color:#c8a660;font-size:12px;margin-bottom:4px">📄 Plaintext</div>
              <p style="color:#a89070;font-size:11px;margin:0">Keys stored directly in browser localStorage. Convenient but readable by browser extensions.</p>
            </div>
            
            <div style="margin-top:8px;padding:10px;background:#0b0908;border-radius:3px">
              <div style="color:#c8a660;font-size:12px;margin-bottom:4px">⌨️ Prompt Each Session</div>
              <p style="color:#a89070;font-size:11px;margin:0">Keys never stored. You'll be prompted to enter them when you first use the AI. Highest security - nothing stored.</p>
            </div>
            
            <div style="margin-top:8px;padding:10px;background:#0b0908;border-radius:3px">
              <div style="color:#c8a660;font-size:12px;margin-bottom:4px">⏱️ Session Only</div>
              <p style="color:#a89070;font-size:11px;margin:0">Keys stored in sessionStorage. Cleared automatically when you close the browser tab.</p>
            </div>
            
            <div style="margin-top:15px;padding-top:15px;border-top:1px solid #252015">
              <label class="mlabel" style="color:#c8a660">API Key Storage Mode</label>
              <select id="storage_mode_select" style="background:#0b0908;border:1px solid #252015;color:#c8a660;font-family:'JetBrains Mono',monospace;font-size:12px;padding:6px 10px;border-radius:2px;width:100%;margin-top:5px">
                <option value="plaintext" ${getStorageMode() === 'plaintext' ? 'selected' : ''}>Plaintext</option>
                <option value="encrypted" ${getStorageMode() === 'encrypted' ? 'selected' : ''}>Password-Encrypted (Recommended)</option>
                <option value="prompt" ${getStorageMode() === 'prompt' ? 'selected' : ''}>Prompt Each Session</option>
                <option value="session" ${getStorageMode() === 'session' ? 'selected' : ''}>Session Only (sessionStorage)</option>
              </select>
              <div id="storage_mode_actions" style="margin-top:10px"></div>
              <div id="storage_mode_status" style="color:#7aac74;font-size:12px;margin-top:8px"></div>
            </div>
          </div>
        </div>

        <div class="settings-hd">
          <h2>Settings</h2>
          <p>Configure your API access and model preferences.</p>
        </div>

        <div class="scard">
          <div class="scard-hd">API Provider</div>
          <div class="scard-body">
            <div class="meta-field">
              <label class="mlabel">Select Provider</label>
              <select id="provider_select" style="background:#0b0908;border:1px solid #252015;color:#c8a660;font-family:'JetBrains Mono',monospace;font-size:12px;padding:6px 10px;border-radius:2px;width:100%">
                <option value="openrouter" ${APP.provider === 'openrouter' ? 'selected' : ''}>OpenRouter (Default)</option>
                <option value="anthropic" ${APP.provider === 'anthropic' ? 'selected' : ''}>Anthropic Direct (Claude)</option>
                <option value="openai" ${APP.provider === 'openai' ? 'selected' : ''}>OpenAI Direct</option>
                <option value="google" ${APP.provider === 'google' ? 'selected' : ''}>Google Direct (Gemini)</option>
                <option value="lmstudio" ${APP.provider === 'lmstudio' ? 'selected' : ''}>LM Studio (Local)</option>
              </select>
            </div>
          </div>
        </div>

        <div class="scard" id="openrouter_card" style="display:${APP.provider === 'openrouter' ? 'block' : 'none'}">
          <div class="scard-hd">OpenRouter API Key</div>
          <div class="scard-body">
            <div class="api-row">
              <div class="meta-field">
                <label class="mlabel">API Key</label>
                <div class="api-key-wrap">
                  <input class="minput" type="password" id="api_key_inp" value="${esc(APP.apiKeys.openrouter)}" placeholder="sk-or-v1-…" autocomplete="off">
                  <button class="api-show" id="api_show">Show</button>
                </div>
              </div>
              <button class="test-btn" id="test_btn">Test</button>
            </div>
            <div class="api-status" id="api_status"></div>
            <p class="api-note">Get your key at <a href="https://openrouter.ai/keys" target="_blank">openrouter.ai/keys</a>.</p>
          </div>
        </div>

        <div class="scard" id="anthropic_card" style="display:${APP.provider === 'anthropic' ? 'block' : 'none'}">
          <div class="scard-hd">Anthropic API Key</div>
          <div class="scard-body">
            <div class="api-row">
              <div class="meta-field">
                <label class="mlabel">API Key</label>
                <div class="api-key-wrap">
                  <input class="minput" type="password" id="api_key_anthropic" value="${esc(APP.apiKeys.anthropic)}" placeholder="sk-ant-…" autocomplete="off">
                  <button class="api-show" id="api_show_ant">Show</button>
                </div>
              </div>
              <button class="test-btn" id="test_btn_ant">Test</button>
            </div>
            <div class="api-status" id="api_status_ant"></div>
            <p class="api-note">Get your key at <a href="https://console.anthropic.com/settings/keys" target="_blank">console.anthropic.com</a>.</p>
          </div>
        </div>

        <div class="scard" id="openai_card" style="display:${APP.provider === 'openai' ? 'block' : 'none'}">
          <div class="scard-hd">OpenAI API Key</div>
          <div class="scard-body">
            <div class="api-row">
              <div class="meta-field">
                <label class="mlabel">API Key</label>
                <div class="api-key-wrap">
                  <input class="minput" type="password" id="api_key_openai" value="${esc(APP.apiKeys.openai)}" placeholder="sk-…" autocomplete="off">
                  <button class="api-show" id="api_show_openai">Show</button>
                </div>
              </div>
              <button class="test-btn" id="test_btn_openai">Test</button>
            </div>
            <div class="api-status" id="api_status_openai"></div>
            <p class="api-note">Get your key at <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a>.</p>
          </div>
        </div>

        <div class="scard" id="google_card" style="display:${APP.provider === 'google' ? 'block' : 'none'}">
          <div class="scard-hd">Google API Key</div>
          <div class="scard-body">
            <div class="api-row">
              <div class="meta-field">
                <label class="mlabel">API Key</label>
                <div class="api-key-wrap">
                  <input class="minput" type="password" id="api_key_google" value="${esc(APP.apiKeys.google)}" placeholder="AIza…" autocomplete="off">
                  <button class="api-show" id="api_show_google">Show</button>
                </div>
              </div>
              <button class="test-btn" id="test_btn_google">Test</button>
            </div>
            <div class="api-status" id="api_status_google"></div>
            <p class="api-note">Get your key at <a href="https://aistudio.google.com/app/apikey" target="_blank">aistudio.google.com</a>. Requires billing enabled.</p>
          </div>
        </div>

        <div class="scard" id="lmstudio_card" style="display:${APP.provider === 'lmstudio' ? 'block' : 'none'}">
          <div class="scard-hd"><span id="lmstudio_help_hd"></span>LM Studio (Local)</div>
          <div class="scard-body">
            <div class="api-row">
              <div class="meta-field" style="flex:2">
                <label class="mlabel">Base URL</label>
                <input class="minput" type="text" id="lmstudio_url" value="${esc(APP.lmstudioUrl)}" placeholder="http://localhost:1234">
              </div>
            </div>
            <div class="api-row" style="margin-top:10px">
              <div class="meta-field">
                <label class="mlabel">API Key (optional)</label>
                <div class="api-key-wrap">
                  <input class="minput" type="password" id="api_key_lmstudio" value="${esc(APP.apiKeys.lmstudio)}" placeholder="Optional" autocomplete="off">
                  <button class="api-show" id="api_show_lmstudio">Show</button>
                </div>
              </div>
              <button class="test-btn" id="test_btn_lmstudio">Test</button>
            </div>
            <div class="api-status" id="api_status_lmstudio"></div>
            <div class="api-row" style="margin-top:10px">
              <div class="meta-field" style="flex:2">
                <label class="mlabel">Model Name (if not fetched)</label>
                <input class="minput" type="text" id="lmstudio_model" value="" placeholder="e.g. qwen/qwen3-vl-8b">
              </div>
            </div>
            <p class="api-note">Start LM Studio, load a model, enable Server in Developer tab. If models don't fetch, enter name manually above.</p>
          </div>
        </div>

        <div class="scard">
          <div class="scard-hd">Model</div>
          <div class="scard-body">
            <div class="model-collapse-hd" id="model_collapse_hd">
              <span>Select model</span>
              <span class="model-collapse-icon">▼</span>
            </div>
            <div class="model-grid" id="model_grid">
              ${Object.entries(grouped).map(([provider, models]) => `
                <div class="model-section-lbl">${provider}</div>
                ${models.map(m => `
                  <div class="model-row${APP.model === m.id ? ' msel' : ''}" data-mid="${m.id}" style="--mc:${m.color}">
                    <div class="model-radio"><div class="model-radio-dot"></div></div>
                    <div class="model-info">
                      <div class="model-name">${esc(m.name)}</div>
                      <div class="model-meta">${esc(m.id)} · ${m.ctx} ctx</div>
                    </div>
                    <span class="model-provider" style="color:${m.color};border-color:${m.color}22">${esc(provider)}</span>
                  </div>`).join('')}
              `).join('')}
            </div>
            <p class="api-note" style="margin-top:10px">${APP.provider === 'openrouter' ? 'Model IDs are OpenRouter paths. Check <a href="https://openrouter.ai/models" target="_blank">openrouter.ai/models</a> for availability.' : APP.provider === 'anthropic' ? 'Select a Claude model. Check <a href="https://docs.anthropic.com/en/docs/models-overview" target="_blank">docs.anthropic.com</a> for models.' : APP.provider === 'google' ? 'Select a Gemini model. Check <a href="https://ai.google.dev/docs" target="_blank">ai.google.dev/docs</a> for models.' : 'Select a GPT model. Check <a href="https://platform.openai.com/docs/models" target="_blank">platform.openai.com</a> for models.'}</p>
          </div>
        </div>

        <div class="scard">
          <div class="scard-hd">Display Settings</div>
          <div class="scard-body">
            <div class="scale-row">
              <label class="mlabel" style="flex:1">Theme</label>
              <select id="theme_select" style="background:#0b0908;border:1px solid #252015;color:#c8a660;font-family:'JetBrains Mono',monospace;font-size:11px;padding:4px 8px;border-radius:2px">
                <option value="default" ${APP.theme === 'default' ? 'selected' : ''}>Default Dark</option>
                <option value="soft-beach" ${APP.theme === 'soft-beach' ? 'selected' : ''}>Soft Beach</option>
                <option value="pink-sand" ${APP.theme === 'pink-sand' ? 'selected' : ''}>Pink Sand</option>
                <option value="dark-sand" ${APP.theme === 'dark-sand' ? 'selected' : ''}>Dark Sand</option>
                <option value="ice-cold" ${APP.theme === 'ice-cold' ? 'selected' : ''}>Ice Cold</option>
                <option value="freeze-purple" ${APP.theme === 'freeze-purple' ? 'selected' : ''}>Freeze Purple</option>
                <option value="medium-purple" ${APP.theme === 'medium-purple' ? 'selected' : ''}>Medium Purple</option>
                <option value="purple-pain" ${APP.theme === 'purple-pain' ? 'selected' : ''}>Purple Pain</option>
                <option value="heavy-purple" ${APP.theme === 'heavy-purple' ? 'selected' : ''}>Heavy Purple</option>
                <option value="yass-queen" ${APP.theme === 'yass-queen' ? 'selected' : ''}>Yass Queen</option>
                <option value="sister-sister" ${APP.theme === 'sister-sister' ? 'selected' : ''}>Sister Sister</option>
                <option value="crown-yellow" ${APP.theme === 'crown-yellow' ? 'selected' : ''}>Crown Yellow</option>
                <option value="blue-light" ${APP.theme === 'blue-light' ? 'selected' : ''}>Blue Light</option>
                <option value="brutal-blue" ${APP.theme === 'brutal-blue' ? 'selected' : ''}>Brutal Blue</option>
              </select>
            </div>
            <div class="scale-row" style="margin-top:12px">
              <label class="mlabel" style="flex:1">Main UI Scale</label>
              <div style="display:flex;align-items:center;gap:8px">
                <button class="smbtn" id="scale_down">−</button>
                <span class="scale-val" id="scale_val" style="min-width:40px;text-align:center">${APP.uiScale}x</span>
                <button class="smbtn" id="scale_up">+</button>
              </div>
            </div>
            <div class="scale-row" style="margin-top:12px">
              <label class="mlabel" style="flex:1">Header Scale</label>
              <div style="display:flex;align-items:center;gap:8px">
                <button class="smbtn" id="hscale_down">−</button>
                <span class="scale-val" id="hscale_val" style="min-width:40px;text-align:center">${APP.headerScale || 1}x</span>
                <button class="smbtn" id="hscale_up">+</button>
              </div>
            </div>
          </div>
        </div>

        <div class="scard">
          <div class="scard-hd">Generation Settings</div>
          <div class="scard-body">
            <div class="max-tok-row">
              <div class="meta-field" style="max-width:120px">
                <label class="mlabel">Max Tokens</label>
                <input class="minput" type="number" id="max_tok" value="${APP.maxTokens}" min="256" max="16000" step="256">
              </div>
              <div class="meta-field" style="max-width:100px">
                <label class="mlabel">Boost (1 run)</label>
                <input class="minput" type="number" id="tok_boost" value="0" min="0" max="16000" step="256" placeholder="+tokens">
              </div>
              <span class="tok-note">Higher = longer responses but may cost more. 4000 is a good default for editing tasks.</span>
            </div>
          </div>
        </div>

        <div class="scard">
          <div class="scard-hd">Writing Preferences</div>
          <div class="scard-body">
            <div class="pref-section">
              <div class="pref-section-lbl">Point of View</div>
              <div class="pref-radio">
                <label><input type="radio" name="pov" value="first" ${APP.writingPrefs.pov === 'first' ? 'checked' : ''}> 1st Person</label>
                <label><input type="radio" name="pov" value="third" ${APP.writingPrefs.pov === 'third' ? 'checked' : ''}> 3rd Person</label>
                <label><input type="radio" name="pov" value="mixed" ${APP.writingPrefs.pov === 'mixed' ? 'checked' : ''}> Mixed</label>
              </div>
            </div>
            <div class="pref-section">
              <div class="pref-row">
                <label>Italics = inner monologue</label>
                <input type="checkbox" id="inner_monologue" ${APP.writingPrefs.innerMonologue ? 'checked' : ''}>
              </div>
            </div>
            <div class="pref-section">
              <div class="pref-section-lbl">AI Avoidance Rules (all ON by default)</div>
              <div class="pref-group">
                <div class="pref-group-lbl">
                  <input type="checkbox" id="punctuation_grp" ${APP.writingPrefs.punctuation ? 'checked' : ''} style="accent-color:#c8a660">
                  Punctuation Group
                </div>
                <div class="pref-sub" style="display:${APP.writingPrefs.punctuation ? 'block' : 'none'}" id="punctuation_sub">
                  <div class="pref-row"><label>No em-dashes (—)</label><input type="checkbox" id="avoid_emdashes" ${APP.writingPrefs.avoidEmDashes ? 'checked' : ''}></div>
                  <div class="pref-row"><label>No semicolons</label><input type="checkbox" id="avoid_semicolons" ${APP.writingPrefs.avoidSemicolons ? 'checked' : ''}></div>
                  <div class="pref-row"><label>No colons</label><input type="checkbox" id="avoid_colons" ${APP.writingPrefs.avoidColons ? 'checked' : ''}></div>
                </div>
              </div>
              <div class="pref-group">
                <div class="pref-group-lbl">
                  <input type="checkbox" id="avoid_triplet" ${APP.writingPrefs.avoidTriplet ? 'checked' : ''} style="accent-color:#c8a660">
                  No Triplet Framing
                </div>
              </div>
              <div class="pref-group">
                <div class="pref-group-lbl">
                  <input type="checkbox" id="avoid_golden_sunset" ${APP.writingPrefs.avoidGoldenSunset ? 'checked' : ''} style="accent-color:#c8a660">
                  No Golden Sunset (over-description)
                </div>
              </div>
              <div class="pref-group">
                <div class="pref-group-lbl">
                  <input type="checkbox" id="avoid_inspirational" ${APP.writingPrefs.avoidInspirationalPivot ? 'checked' : ''} style="accent-color:#c8a660">
                  No Inspirational Pivot
                </div>
              </div>
              <div class="pref-group">
                <div class="pref-group-lbl">
                  <input type="checkbox" id="avoid_show_summarize" ${APP.writingPrefs.avoidShowDontSummarize ? 'checked' : ''} style="accent-color:#c8a660">
                  No AI Bookending
                </div>
              </div>
              <div class="pref-row"><label>Vary sentence structure</label><input type="checkbox" id="vary_sentence" ${APP.writingPrefs.varySentenceStructure ? 'checked' : ''}></div>
              <div class="pref-row"><label>Avoid filter words</label><input type="checkbox" id="filter_words" ${APP.writingPrefs.filterWords ? 'checked' : ''}></div>
              <div class="pref-row"><label>Snappy dialogue</label><input type="checkbox" id="snappy_dialogue" ${APP.writingPrefs.snappyDialogue ? 'checked' : ''}></div>
              <div class="pref-row"><label>Specific over generic</label><input type="checkbox" id="specific_generic" ${APP.writingPrefs.specificOverGeneric ? 'checked' : ''}></div>
            </div>
            <div class="pref-section">
              <div class="pref-section-lbl">Do Not Use Words (comma-separated)</div>
              <textarea class="dnu-text" id="do_not_use" placeholder="e.g., very, really, actually, basically">${esc(APP.writingPrefs.doNotUseWords || '')}</textarea>
            </div>
          </div>
        </div>

        <div class="scard">
          <div class="scard-hd">Data Management</div>
          <div class="scard-body">
            <p class="api-note" style="margin-bottom:10px">All project data (Series, Book, Chapter) is automatically saved to your browser's local storage.</p>
            <div class="export-import-row">
              <button class="export-btn" id="export_btn">Export Project</button>
              <button class="import-btn" id="import_btn">Import Project</button>
              <input type="file" id="import_file" accept=".json" style="display:none">
            </div>

            <div class="import-status" id="import_status" style="margin-top:8px;font-size:12px;color:#c8a660"></div>
            <div style="margin-top:12px;padding-top:12px;border-top:1px solid #252015">
              <p class="api-note" style="margin-bottom:10px">Backup History (last 24 hours)</p>
              <div class="backup-list" id="backup_list"></div>
            </div>
            <div style="margin-top:12px;padding-top:12px;border-top:1px solid #252015">
              <p class="api-note" style="margin-bottom:10px">Custom Prompt Templates (global across all projects)</p>
              <div class="export-import-row">
                <button class="export-btn" onclick="exportTemplates()">Export Templates</button>
                <button class="import-btn" onclick="importTemplates()">Import Templates</button>
              </div>
            </div>
            <div style="margin-top:15px;padding-top:15px;border-top:1px solid #252015">
              <p class="api-note" style="margin-bottom:10px">Timeline Events (series-level, multi-book)</p>
              <div class="export-import-row">
                <button class="export-btn" onclick="exportTimeline()">Export Timeline</button>
                <button class="import-btn" onclick="importTimeline()">Import Timeline</button>
              </div>
            </div>
            <hr style="border:0;border-top:1px solid #252015;margin:15px 0">
            <button class="clear-all-btn" id="clear_data_btn">Clear All Saved Data</button>
          </div>
        </div>
      </div>
    </div>`;

      // Provider selector
      p.querySelector('#provider_select').addEventListener('change', e => {
        APP.provider = e.target.value;
        localStorage.setItem('na_provider', APP.provider);
        // Show/hide relevant cards
        p.querySelector('#openrouter_card').style.display = APP.provider === 'openrouter' ? 'block' : 'none';
        p.querySelector('#anthropic_card').style.display = APP.provider === 'anthropic' ? 'block' : 'none';
        p.querySelector('#openai_card').style.display = APP.provider === 'openai' ? 'block' : 'none';
        p.querySelector('#google_card').style.display = APP.provider === 'google' ? 'block' : 'none';
        p.querySelector('#lmstudio_card').style.display = APP.provider === 'lmstudio' ? 'block' : 'none';
        // Auto-select first available model for provider
        const availableModels = MODELS.filter(m => m.provider === APP.provider);
        if (availableModels.length > 0 && !availableModels.find(m => m.id === APP.model)) {
          APP.model = availableModels[0].id;
          localStorage.setItem('na_model', APP.model);
        }
        renderSettings(); // Re-render to update model list
        updateTabDot();
      });

      // Storage mode selector
      const storageSelect = p.querySelector('#storage_mode_select');
      const storageActions = p.querySelector('#storage_mode_actions');
      const storageStatus = p.querySelector('#storage_mode_status');

      function updateStorageModeUI() {
        const mode = getStorageMode();
        if (mode === 'encrypted') {
          storageActions.innerHTML = `
        <button id="set_password_btn" class="add-btn" style="background:#1a1512;border-color:#c8a660;color:#c8a660;margin-top:5px">${localStorage.getItem('na_encrypted_keys') ? 'Change Password' : 'Set Password'}</button>
        ${APP_KEY_PASSWORD ? '<span style="color:#7aac74;font-size:12px;margin-left:10px">✓ Keys Unlocked</span>' : ''}
      `;
          storageStatus.textContent = APP_KEY_PASSWORD ? 'Keys are unlocked for this session' : 'Keys are locked - password required on next use';
        } else if (mode === 'prompt') {
          storageActions.innerHTML = '<span style="color:#c8a660;font-size:12px">You will be prompted for API keys when needed</span>';
          storageStatus.textContent = '';
        } else if (mode === 'session') {
          storageActions.innerHTML = '<span style="color:#c8a660;font-size:12px">Keys cleared when browser closes</span>';
          storageStatus.textContent = '';
        } else {
          storageActions.innerHTML = '';
          storageStatus.textContent = '';
        }
      }

      storageSelect.addEventListener('change', async function () {
        const newMode = this.value;
        if (newMode === 'encrypted') {
          const password = prompt('Set a password for encrypting your API keys:');
          if (!password) {
            this.value = getStorageMode();
            return;
          }
          const confirm = prompt('Confirm password:');
          if (confirm !== password) {
            alert('Passwords do not match');
            this.value = getStorageMode();
            return;
          }
          setStorageMode('encrypted');
          await saveKeysSecurely(password);
          updateStorageModeUI();
          renderSettings();
        } else if (newMode === 'prompt') {
          if (confirm('This will clear all stored API keys. You will be prompted for keys when needed. Continue?')) {
            localStorage.removeItem('na_key');
            localStorage.removeItem('na_anthropic_key');
            localStorage.removeItem('na_openai_key');
            localStorage.removeItem('na_google_key');
            localStorage.removeItem('na_lmstudio_key');
            sessionStorage.clear();
            setStorageMode('prompt');
            APP.apiKeys = { openrouter: '', anthropic: '', openai: '', google: '', lmstudio: '' };
            updateStorageModeUI();
            renderSettings();
          } else {
            this.value = getStorageMode();
          }
        } else if (newMode === 'session') {
          if (confirm('This will move keys to session storage. Keys will be cleared when you close the browser. Continue?')) {
            localStorage.removeItem('na_key');
            localStorage.removeItem('na_anthropic_key');
            localStorage.removeItem('na_openai_key');
            localStorage.removeItem('na_google_key');
            localStorage.removeItem('na_lmstudio_key');
            localStorage.removeItem('na_encrypted_keys');
            localStorage.removeItem('na_key_salt');
            setStorageMode('session');
            await saveKeysSecurely('');
            updateStorageModeUI();
            renderSettings();
          } else {
            this.value = getStorageMode();
          }
        } else {
          if (confirm('Switch back to plaintext storage? Your keys will be stored without encryption.')) {
            localStorage.removeItem('na_encrypted_keys');
            localStorage.removeItem('na_key_salt');
            setStorageMode('plaintext');
            await saveKeysSecurely('');
            updateStorageModeUI();
            renderSettings();
          } else {
            this.value = getStorageMode();
          }
        }
      });

      p.addEventListener('click', async function (e) {
        if (e.target.id === 'set_password_btn') {
          const password = prompt('Enter new password for encrypting API keys:');
          if (!password) return;
          const confirm = prompt('Confirm password:');
          if (confirm !== password) {
            alert('Passwords do not match');
            return;
          }
          await saveKeysSecurely(password);
          updateStorageModeUI();
          storageStatus.textContent = 'Password updated!';
        }
      });

      updateStorageModeUI();

      // OpenRouter key
      const keyInp = p.querySelector('#api_key_inp');
      p.querySelector('#api_show').addEventListener('click', function () {
        const show = keyInp.type === 'password';
        keyInp.type = show ? 'text' : 'password';
        this.textContent = show ? 'Hide' : 'Show';
      });
      keyInp.addEventListener('input', e => {
        APP.apiKeys.openrouter = e.target.value.trim();
        saveKeysSecurely(APP_KEY_PASSWORD);
        updateTabDot();
      });

      // Anthropic key
      const keyAnt = p.querySelector('#api_key_anthropic');
      p.querySelector('#api_show_ant').addEventListener('click', function () {
        const show = keyAnt.type === 'password';
        keyAnt.type = show ? 'text' : 'password';
        this.textContent = show ? 'Hide' : 'Show';
      });
      keyAnt.addEventListener('input', e => {
        APP.apiKeys.anthropic = e.target.value.trim();
        saveKeysSecurely(APP_KEY_PASSWORD);
        updateTabDot();
      });

      // OpenAI key
      const keyOai = p.querySelector('#api_key_openai');
      p.querySelector('#api_show_openai').addEventListener('click', function () {
        const show = keyOai.type === 'password';
        keyOai.type = show ? 'text' : 'password';
        this.textContent = show ? 'Hide' : 'Show';
      });
      keyOai.addEventListener('input', e => {
        APP.apiKeys.openai = e.target.value.trim();
        saveKeysSecurely(APP_KEY_PASSWORD);
        updateTabDot();
      });

      // Test OpenRouter
      p.querySelector('#test_btn').addEventListener('click', async () => {
        const status = p.querySelector('#api_status');
        status.className = 'api-status checking'; status.textContent = 'Testing…';
        try {
          const res = await fetch('https://openrouter.ai/api/v1/auth/key', {
            headers: { 'Authorization': `Bearer ${APP.apiKeys.openrouter}` }
          });
          if (res.ok) {
            const j = await res.json();
            status.className = 'api-status ok';
            status.textContent = `✓ Connected${j.data?.label ? ' — ' + j.data.label : ''}`;
          } else {
            const j = await res.json().catch(() => ({ error: { message: 'Unknown error' } }));
            status.className = 'api-status err';
            status.textContent = '✗ ' + ((j.error?.message) || `HTTP ${res.status}`);
          }
        } catch (e) {
          status.className = 'api-status err';
          status.textContent = '✗ ' + e.message;
        }
      });

      // Test Anthropic
      p.querySelector('#test_btn_ant').addEventListener('click', async () => {
        const status = p.querySelector('#api_status_ant');
        status.className = 'api-status checking'; status.textContent = 'Testing…';
        try {
          const res = await fetch('https://api.anthropic.com/v1/auth_checks', {
            method: 'POST',
            headers: {
              'x-api-key': APP.apiKeys.anthropic,
              'anthropic-version': '2023-06-01',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
          });
          if (res.ok) {
            status.className = 'api-status ok';
            status.textContent = '✓ Connected';
          } else {
            const j = await res.json().catch(() => ({ error: { message: 'Unknown error' } }));
            status.className = 'api-status err';
            status.textContent = '✗ ' + ((j.error?.message) || `HTTP ${res.status}`);
          }
        } catch (e) {
          status.className = 'api-status err';
          status.textContent = '✗ ' + e.message;
        }
      });

      // Test OpenAI
      p.querySelector('#test_btn_openai').addEventListener('click', async () => {
        const status = p.querySelector('#api_status_openai');
        status.className = 'api-status checking'; status.textContent = 'Testing…';
        try {
          const res = await fetch('https://api.openai.com/v1/models', {
            headers: { 'Authorization': `Bearer ${APP.apiKeys.openai}` }
          });
          if (res.ok) {
            status.className = 'api-status ok';
            status.textContent = '✓ Connected';
          } else {
            const j = await res.json().catch(() => ({ error: { message: 'Unknown error' } }));
            status.className = 'api-status err';
            status.textContent = '✗ ' + ((j.error?.message) || `HTTP ${res.status}`);
          }
        } catch (e) {
          status.className = 'api-status err';
          status.textContent = '✗ ' + e.message;
        }
      });

      // Google key
      const keyGoogle = p.querySelector('#api_key_google');
      p.querySelector('#api_show_google').addEventListener('click', function () {
        const show = keyGoogle.type === 'password';
        keyGoogle.type = show ? 'text' : 'password';
        this.textContent = show ? 'Hide' : 'Show';
      });
      keyGoogle.addEventListener('input', e => {
        APP.apiKeys.google = e.target.value.trim();
        saveKeysSecurely(APP_KEY_PASSWORD);
        updateTabDot();
      });

      // Test Google
      p.querySelector('#test_btn_google').addEventListener('click', async () => {
        const status = p.querySelector('#api_status_google');
        status.className = 'api-status checking'; status.textContent = 'Testing…';
        try {
          const res = await fetch('https://generativelanguage.googleapis.com/v1beta/models', {
            headers: { 'x-goog-api-key': APP.apiKeys.google }
          });
          if (res.ok) {
            status.className = 'api-status ok';
            status.textContent = '✓ Connected';
          } else {
            const j = await res.json().catch(() => ({ error: { message: 'Unknown error' } }));
            status.className = 'api-status err';
            status.textContent = '✗ ' + ((j.error?.message) || `HTTP ${res.status}`);
          }
        } catch (e) {
          status.className = 'api-status err';
          status.textContent = '✗ ' + e.message;
        }
      });

      // LM Studio URL
      const lmstudioUrlInp = p.querySelector('#lmstudio_url');
      lmstudioUrlInp.addEventListener('input', e => {
        APP.lmstudioUrl = e.target.value.trim();
        localStorage.setItem('na_lmstudio_url', APP.lmstudioUrl);
      });

      // LM Studio key
      const keyLmstudio = p.querySelector('#api_key_lmstudio');
      p.querySelector('#api_show_lmstudio').addEventListener('click', function () {
        const show = keyLmstudio.type === 'password';
        keyLmstudio.type = show ? 'text' : 'password';
        this.textContent = show ? 'Hide' : 'Show';
      });
      keyLmstudio.addEventListener('input', e => {
        APP.apiKeys.lmstudio = e.target.value.trim();
        saveKeysSecurely(APP_KEY_PASSWORD);
        updateTabDot();
      });

      // Test LM Studio & Fetch Models
      p.querySelector('#test_btn_lmstudio').addEventListener('click', async () => {
        const status = p.querySelector('#api_status_lmstudio');
        const baseUrl = (p.querySelector('#lmstudio_url').value || 'http://localhost:1234').replace(/\/$/, '');
        status.className = 'api-status checking'; status.textContent = 'Testing…';
        try {
          // Try LM Studio's native API endpoint first
          let models = [];
          let foundModels = false;
          let errorMsg = '';

          // Try the LM Studio native models endpoint
          try {
            const res = await fetch(`${baseUrl}/api/v0/models`);
            if (res.ok) {
              const j = await res.json();
              models = j.models || [];
              foundModels = true;
            } else {
              errorMsg = `HTTP ${res.status}`;
            }
          } catch (e) { errorMsg = e.message; }

          // If not found, try OpenAI compatible endpoint
          if (!foundModels || models.length === 0) {
            try {
              const res = await fetch(`${baseUrl}/v1/models`, {
                method: 'GET',
                mode: 'cors',
                headers: { 'Content-Type': 'application/json' }
              });
              if (res.ok) {
                const j = await res.json();
                models = j.data || [];
                foundModels = true;
              } else {
                errorMsg = `HTTP ${res.status}`;
              }
            } catch (e) { errorMsg = e.message; }
          }

          status.className = 'api-status ok';
          if (models.length > 0) {
            status.textContent = `✓ Connected (${models.length} models found)`;
            // Add models to MODELS array dynamically
            models.forEach(m => {
              const modelId = m.id || m;
              const existing = MODELS.find(ex => ex.id === modelId && ex.provider === 'lmstudio');
              if (!existing) {
                MODELS.push({
                  id: modelId,
                  name: modelId,
                  provider: 'lmstudio',
                  ctx: 'varies',
                  color: '#888888'
                });
              }
            });
            // Switch to LM Studio provider and update model list
            APP.provider = 'lmstudio';
            localStorage.setItem('na_provider', 'lmstudio');
            renderSettings();
          } else if (errorMsg) {
            status.textContent = `✓ Connected (enter model name manually below)`;
            // Still switch to LM Studio so user can manually enter model
            APP.provider = 'lmstudio';
            localStorage.setItem('na_provider', 'lmstudio');
            renderSettings();
          } else if (!foundModels) {
            status.textContent = `✓ Connected (enter model name manually below)`;
            APP.provider = 'lmstudio';
            localStorage.setItem('na_provider', 'lmstudio');
            renderSettings();
          } else {
            status.textContent = '✓ Connected (no models loaded - load a model in LM Studio first)';
          }
        } catch (e) {
          status.className = 'api-status err';
          let msg = e.message;
          if (msg.includes('Failed to fetch') || msg.includes('NetworkError')) {
            msg = 'Could not connect. Is LM Studio running with Server enabled?';
          }
          status.textContent = '✗ ' + msg;
        }
      });

      // Model selection
      p.querySelectorAll('.model-row').forEach(row => {
        row.addEventListener('click', () => {
          APP.model = row.dataset.mid;
          localStorage.setItem('na_model', APP.model);
          p.querySelectorAll('.model-row').forEach(r => r.classList.toggle('msel', r.dataset.mid === APP.model));
        });
      });

      // Model collapse toggle
      const mch = document.getElementById('model_collapse_hd');
      const mg = document.getElementById('model_grid');
      mch.addEventListener('click', () => {
        mch.classList.toggle('collapsed');
        mg.classList.toggle('collapsed');
      });

      // Max tokens
      p.querySelector('#max_tok').addEventListener('input', e => {
        APP.maxTokens = parseInt(e.target.value) || 4000;
        localStorage.setItem('na_maxtok', APP.maxTokens);
      });

      // Clear data (per-project)
      p.querySelector('#clear_data_btn').addEventListener('click', () => {
        if (confirm('Clear all saved project data (Series, Book, Chapter)? This cannot be undone.')) {
          const pid = getCurrentProjectId();
          localStorage.removeItem('na_state_' + pid);
          APP.series = { name: '', subName: '', bible: mkSec() };
          APP.book = { title: '', bookNum: '', totalBooks: '', subNum: '', totalSub: '', bible: mkSec(), outline: mkSec(), chars: [{ id: mkId(), ...mkSec() }] };
          APP.chapter = { mode: 'chapter', chapterNum: '', sceneNum: '', useFullChapters: false, sceneLevel: false, fullChapters: [], breakdowns: [], breakdown: mkSec(), settings: [{ id: mkId(), ...mkSec() }] };
          // Re-render context tabs
          renderSeries(); renderBook(); renderChapter();
          saveState();
        }
      });

      // Export Project
      const projects = getProjects();
      const currentPid = getCurrentProjectId();
      const currentProject = projects.find(p => p.id === currentPid);
      p.querySelector('#export_btn').addEventListener('click', () => {
        const exportData = {
          version: '1.0-beta',
          exportedAt: new Date().toISOString(),
          projectName: currentProject ? currentProject.name : 'Unnamed Project',
          series: APP.series,
          book: APP.book,
          chapter: APP.chapter,
          genreCompare: APP.genreCompare
        };
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const safeName = (currentProject ? currentProject.name : 'project').replace(/[^a-z0-9]/gi, '-').toLowerCase();
        a.download = 'novelist-atelier-' + safeName + '-' + Date.now() + '.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });

      // Import Project
      const importFileInput = p.querySelector('#import_file');
      const importOptions = p.querySelector('#import_options');
      const importStatus = p.querySelector('#import_status');

      p.querySelector('#import_btn').addEventListener('click', () => {
        importFileInput.click();
      });

      importFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (event) {
          try {
            const data = JSON.parse(event.target.result);
            // Validate required fields
            if (!data.series || !data.book || !data.chapter) {
              throw new Error('Invalid project file: missing required data');
            }

            const importAsNew = confirm('Import as a NEW project? Click OK for new project, Cancel to merge with current project.');

            if (importAsNew) {
              // Create new project from import
              const projName = data.projectName || prompt('Enter project name:', 'Imported Project') || 'Imported Project';
              const pid = 'project-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
              const projects = getProjects();
              projects.push({ id: pid, name: projName });
              saveProjects(projects);

              APP.series = data.series || { name: '', subName: '', bible: mkSec() };
              APP.book = data.book || { title: '', bookNum: '', totalBooks: '', subNum: '', totalSub: '', bible: mkSec(), outline: mkSec(), chars: [{ id: mkId(), ...mkSec() }] };
              APP.chapter = data.chapter || { mode: 'chapter', chapterNum: '', sceneNum: '', useFullChapters: false, sceneLevel: false, fullChapters: [], breakdowns: [], breakdown: mkSec(), settings: [{ id: mkId(), ...mkSec() }] };
              APP.genreCompare = data.genreCompare || { preset: 'fantasy', customText: '' };

              setCurrentProjectId(pid);
              saveProjectState(pid);
              saveGenreCompare(pid, APP.genreCompare);
              renderProjectSelector();
            } else {
              const wipeFirst = p.querySelector('#import_wipe').checked;
              if (wipeFirst) {
                const pid = getCurrentProjectId();
                APP.series = data.series || { name: '', subName: '', bible: mkSec() };
                APP.book = data.book || { title: '', bookNum: '', totalBooks: '', subNum: '', totalSub: '', bible: mkSec(), outline: mkSec(), chars: [{ id: mkId(), ...mkSec() }] };
                APP.chapter = data.chapter || { mode: 'chapter', chapterNum: '', sceneNum: '', useFullChapters: false, sceneLevel: false, fullChapters: [], breakdowns: [], breakdown: mkSec(), settings: [{ id: mkId(), ...mkSec() }] };
                if (data.genreCompare) {
                  APP.genreCompare = { ...data.genreCompare };
                  saveGenreCompare(pid, APP.genreCompare);
                }
              } else {
                // Merge mode - combine data
                if (data.series) {
                  if (data.series.name) APP.series.name = data.series.name;
                  if (data.series.subName) APP.series.subName = data.series.subName;
                  if (data.series.bible?.text) APP.series.bible.text = (APP.series.bible.text || '') + '\n\n' + data.series.bible.text;
                }
                if (data.book) {
                  if (data.book.title) APP.book.title = data.book.title;
                  if (data.book.bookNum) APP.book.bookNum = data.book.bookNum;
                  if (data.book.totalBooks) APP.book.totalBooks = data.book.totalBooks;
                  if (data.book.subNum) APP.book.subNum = data.book.subNum;
                  if (data.book.totalSub) APP.book.totalSub = data.book.totalSub;
                  if (data.book.bible?.text) APP.book.bible.text = (APP.book.bible.text || '') + '\n\n' + data.book.bible.text;
                  if (data.book.outline?.text) APP.book.outline.text = (APP.book.outline.text || '') + '\n\n' + data.book.outline.text;
                  if (data.book.chars?.length) {
                    data.book.chars.forEach(c => {
                      if (!APP.book.chars.find(existing => existing.id === c.id)) {
                        APP.book.chars.push(c);
                      }
                    });
                  }
                }
                if (data.chapter) {
                  if (data.chapter.mode) APP.chapter.mode = data.chapter.mode;
                  if (data.chapter.chapterNum) APP.chapter.chapterNum = data.chapter.chapterNum;
                  if (data.chapter.sceneNum) APP.chapter.sceneNum = data.chapter.sceneNum;
                  if (data.chapter.useFullChapters !== undefined) APP.chapter.useFullChapters = data.chapter.useFullChapters;
                  if (data.chapter.fullChapters?.length) {
                    data.chapter.fullChapters.forEach(c => {
                      if (!APP.chapter.fullChapters.find(existing => existing.id === c.id)) {
                        APP.chapter.fullChapters.push(c);
                      }
                    });
                  }
                  if (data.chapter.breakdown?.text) APP.chapter.breakdown.text = (APP.chapter.breakdown.text || '') + '\n\n' + data.chapter.breakdown.text;
                  if (data.chapter.settings?.length) {
                    data.chapter.settings.forEach(s => {
                      if (!APP.chapter.settings.find(existing => existing.id === s.id)) {
                        APP.chapter.settings.push(s);
                      }
                    });
                  }
                }
                if (data.genreCompare) {
                  const pid = getCurrentProjectId();
                  APP.genreCompare = { ...APP.genreCompare, ...data.genreCompare };
                  saveGenreCompare(pid, APP.genreCompare);
                }
              }
            }
            saveState();
            renderSeries(); renderBook(); renderChapter();
            importStatus.textContent = importAsNew ? 'Imported as new project!' : 'Import successful!';
            importStatus.style.color = '#50a060';
            setTimeout(() => { importStatus.textContent = ''; }, 3000);
          } catch (err) {
            importStatus.textContent = 'Error: ' + err.message;
            importStatus.style.color = '#b05040';
          }
        };
        reader.readAsText(file);
        importFileInput.value = '';
      });

      // Show import options on hover/click hint
      p.querySelector('#import_btn').addEventListener('mouseenter', () => {
        importOptions.style.display = 'block';
      });

      // Theme
      document.getElementById('theme_select').addEventListener('change', (e) => {
        APP.theme = e.target.value;
        localStorage.setItem('na_theme', APP.theme);
        document.body.className = APP.theme === 'default' ? '' : 'theme-' + APP.theme;
      });

      // UI Scale
      document.getElementById('scale_up').addEventListener('click', () => {
        APP.uiScale = Math.min(2, APP.uiScale + 0.1);
        document.getElementById('scale_val').textContent = APP.uiScale.toFixed(1) + 'x';
        document.documentElement.style.setProperty('--ui-scale', APP.uiScale);
        localStorage.setItem('na_uiscale', APP.uiScale);
      });
      document.getElementById('scale_down').addEventListener('click', () => {
        APP.uiScale = Math.max(0.5, APP.uiScale - 0.1);
        document.getElementById('scale_val').textContent = APP.uiScale.toFixed(1) + 'x';
        document.documentElement.style.setProperty('--ui-scale', APP.uiScale);
        localStorage.setItem('na_uiscale', APP.uiScale);
      });

      // Header Scale
      document.getElementById('hscale_up').addEventListener('click', () => {
        APP.headerScale = Math.min(2, (APP.headerScale || 1) + 0.1);
        document.getElementById('hscale_val').textContent = APP.headerScale.toFixed(1) + 'x';
        const h = document.getElementById('app-header');
        h.style.fontSize = (17 * APP.headerScale) + 'px';
        h.style.height = (50 * APP.headerScale) + 'px';
        h.style.padding = '0 ' + (20 * APP.headerScale) + 'px';
        h.style.gap = (10 * APP.headerScale) + 'px';
        localStorage.setItem('na_hscale', APP.headerScale);
      });
      document.getElementById('hscale_down').addEventListener('click', () => {
        APP.headerScale = Math.max(0.5, (APP.headerScale || 1) - 0.1);
        document.getElementById('hscale_val').textContent = APP.headerScale.toFixed(1) + 'x';
        const h = document.getElementById('app-header');
        h.style.fontSize = (17 * APP.headerScale) + 'px';
        h.style.height = (50 * APP.headerScale) + 'px';
        h.style.padding = '0 ' + (20 * APP.headerScale) + 'px';
        h.style.gap = (10 * APP.headerScale) + 'px';
        localStorage.setItem('na_hscale', APP.headerScale);
      });

      // Writing Preferences
      const wpPrefs = ['inner_monologue', 'avoid_emdashes', 'avoid_semicolons', 'avoid_colons', 'avoid_triplet', 'avoid_golden_sunset', 'avoid_inspirational', 'avoid_show_summarize', 'vary_sentence', 'filter_words', 'snappy_dialogue', 'specific_generic'];
      wpPrefs.forEach(id => {
        const el = p.querySelector('#' + id);
        if (el) el.addEventListener('change', e => {
          const key = id.replace(/_([a-z])/g, (m, c) => c.toUpperCase());
          APP.writingPrefs[key] = e.target.checked;
          saveWritingPrefs();
        });
      });

      // Punctuation group toggle
      p.querySelector('#punctuation_grp').addEventListener('change', e => {
        APP.writingPrefs.punctuation = e.target.checked;
        document.getElementById('punctuation_sub').style.display = e.target.checked ? 'block' : 'none';
        saveWritingPrefs();
      });

      // POV
      p.querySelectorAll('input[name="pov"]').forEach(el => {
        el.addEventListener('change', e => {
          APP.writingPrefs.pov = e.target.value;
          saveWritingPrefs();
        });
      });

      // Do Not Use Words
      const doNotUseEl = p.querySelector('#do_not_use');
      if (doNotUseEl) {
        doNotUseEl.addEventListener('input', e => {
          APP.writingPrefs.doNotUseWords = e.target.value;
          saveWritingPrefs();
        });
      }

      // Add help icons for Settings
      const providerSel = p.querySelector('#provider_select');
      if (providerSel) addHelp(providerSel.parentElement, 'Choose which AI service to use. OpenRouter routes to multiple providers.');
      const openrouterCard = p.querySelector('#openrouter_card');
      if (openrouterCard) addHelp(openrouterCard.querySelector('.scard-hd'), 'Get your key at openrouter.ai/keys');
      const anthropicCard = p.querySelector('#anthropic_card');
      if (anthropicCard) addHelp(anthropicCard.querySelector('.scard-hd'), 'Get your key at console.anthropic.com');
      const openaiCard = p.querySelector('#openai_card');
      if (openaiCard) addHelp(openaiCard.querySelector('.scard-hd'), 'Get your key at platform.openai.com');
      const googleCard = p.querySelector('#google_card');
      if (googleCard) addHelp(googleCard.querySelector('.scard-hd'), 'Get your key at aistudio.google.com. Requires billing.');
      const lmstudioCard = p.querySelector('#lmstudio_card');
      if (lmstudioCard) {
        addHelp(lmstudioCard.querySelector('#lmstudio_help_hd'), '1. Download LM Studio<br>2. Load a model<br>3. Go to Developer tab, enable "Start Server"<br>4. Go to Settings → App Settings → Enable "Allow CORS"<br>5. Click Test to fetch models');
        const lmUrl = lmstudioCard.querySelector('#lmstudio_url');
        if (lmUrl) addHelp(lmUrl.parentElement, 'Server address for local models (default: http://localhost:1234)');
        const lmKey = lmstudioCard.querySelector('#api_key_lmstudio');
        if (lmKey) addHelp(lmKey.parentElement, 'Optional API key for network access to LM Studio');
      }
      const maxTokEl = p.querySelector('#max_tok');
      if (maxTokEl) addHelp(maxTokEl.parentElement, 'Maximum words in AI response. Higher = longer output.');
      const tokBoostEl = p.querySelector('#tok_boost');
      if (tokBoostEl) addHelp(tokBoostEl.parentElement, 'Add extra tokens for this single run (doesn\'t change default).');

      // Render backup list
      renderBackupList();
    }

    // ═══════════════════════════════════════════════════════════
    // HELP TAB
    // ═══════════════════════════════════════════════════════════

    let helpSubTab = localStorage.getItem('na_help_subtab') || 'welcome';

    function renderHelp() {
      const p = document.getElementById('panel-help');
      if (!p) return;

      p.innerHTML = `
    <div class="ctx-scroll" style="max-width:900px">
      <div class="ctx-head">
        <h2>Help & Documentation</h2>
        <p>Everything you need to know about The Novelist's Atelier.</p>
      </div>
      
      <div class="help-subtabs">
        <button class="help-subtab ${helpSubTab === 'welcome' ? 'active' : ''}" data-subtab="welcome">Welcome</button>
        <button class="help-subtab ${helpSubTab === 'shortcuts' ? 'active' : ''}" data-subtab="shortcuts">Keyboard Shortcuts</button>
        <button class="help-subtab ${helpSubTab === 'guides' ? 'active' : ''}" data-subtab="guides">Tab Guides</button>
        <button class="help-subtab ${helpSubTab === 'log' ? 'active' : ''}" data-subtab="log">Activity Log</button>
      </div>
      
      <div id="help-content"></div>
    </div>
  `;

      p.querySelectorAll('.help-subtab').forEach(btn => {
        btn.addEventListener('click', () => {
          helpSubTab = btn.dataset.subtab;
          localStorage.setItem('na_help_subtab', helpSubTab);
          renderHelp();
        });
      });

      renderHelpContent();
    }

    function renderHelpContent() {
      const container = document.getElementById('help-content');
      if (!container) return;

      if (helpSubTab === 'welcome') {
        renderHelpWelcome(container);
      } else if (helpSubTab === 'shortcuts') {
        renderHelpShortcuts(container);
      } else if (helpSubTab === 'guides') {
        renderHelpGuides(container);
      } else if (helpSubTab === 'log') {
        renderHelpLog(container);
      }
    }

    function renderHelpWelcome(container) {
      container.innerHTML = `
    <div class="help-section">
      <h3>Welcome to The Novelist's Atelier</h3>
      <p>Your AI-powered writing assistant for editing and world-building across multi-book projects.</p>
      
      <h4>Quick Start</h4>
      <ol style="color:#a89868;line-height:1.8">
        <li>Start in <b>Series</b> to set up your world-building and genre</li>
        <li>Add your first <b>Book</b> with title and outline</li>
        <li>Use <b>Story</b> tab to create characters and plan your timeline</li>
        <li>Work on <b>Chapter</b> level with scene settings and text</li>
        <li>Use <b>Prompts</b> for AI-powered editing and generation</li>
        <li>Chain prompts in <b>Pipeline</b> for complex workflows</li>
      </ol>
      
      <h4>Key Concepts</h4>
      <ul style="color:#a89868;line-height:1.8">
        <li><b>Inclusion Modes</b> - Control what gets included in AI prompts (Full, Brief, Extended, Custom, Off)</li>
        <li><b>Projects</b> - Organize separate stories in different projects</li>
        <li><b>Series Level</b> - Timeline and some elements span multiple books</li>
        <li><b>Custom Templates</b> - Create your own prompt templates in Prompts tab</li>
      </ul>
    </div>
  `;
    }

    function renderHelpShortcuts(container) {
      container.innerHTML = `
    <div class="help-section">
      <h3>Keyboard Shortcuts</h3>
      <p style="color:#a89868;margin-bottom:16px">Use these shortcuts to work faster. Works with Ctrl (Windows/Linux) or Cmd (Mac).</p>
      
      <div class="help-shortcut-group">
        <h4>Navigation</h4>
        <div class="help-shortcut"><span class="help-key">Ctrl/Cmd + 1-8</span><span class="help-desc">Switch to tab (1=Home, 2=Series, 3=Book, etc.)</span></div>
      </div>
      
      <div class="help-shortcut-group">
        <h4>Actions</h4>
        <div class="help-shortcut"><span class="help-key">Ctrl/Cmd + S</span><span class="help-desc">Force save immediately</span></div>
        <div class="help-shortcut"><span class="help-key">Ctrl/Cmd + N</span><span class="help-desc">Create new item (character in Story, chapter in Chapter, etc.)</span></div>
        <div class="help-shortcut"><span class="help-key">Ctrl/Cmd + Enter</span><span class="help-desc">Run prompt (in Prompts tab)</span></div>
        <div class="help-shortcut"><span class="help-key">Ctrl/Cmd + F</span><span class="help-desc">Open Global Search</span></div>
        <div class="help-shortcut"><span class="help-key">Ctrl/Cmd + J</span><span class="help-desc">Open Scene Navigator</span></div>
      </div>
      
      <div class="help-shortcut-group">
        <h4>Other</h4>
        <div class="help-shortcut"><span class="help-key">Escape</span><span class="help-desc">Close any open modal</span></div>
        <div class="help-shortcut"><span class="help-key">F1</span><span class="help-desc">Open Help tab</span></div>
      </div>
    </div>
  `;
    }

    function renderHelpGuides(container) {
      container.innerHTML = `
    <div class="help-section">
      <h3>Tab Guides</h3>
      
      <div class="help-guide">
        <h4>📖 Series Tab</h4>
        <p>Global context for your entire series. Set up genre, tone, world-building bible, and series overview. Timeline and some settings here apply to all books.</p>
      </div>
      
      <div class="help-guide">
        <h4>📖 Book Tab</h4>
        <p>Individual book details. Title, book number, outline, and book-specific bible. Characters and timeline are managed in the Story tab.</p>
      </div>
      
      <div class="help-guide">
        <h4>📖 Chapter Tab</h4>
        <p>Current chapter or scene. Work on your text, set up scene context (setting, goal, conflict, resolution), and manage multiple scenes.</p>
      </div>
      
      <div class="help-guide">
        <h4>📖 Story Tab</h4>
        <p>Central hub for story elements: Characters, Relationships (visual map), and Timeline. Saved at series level for multi-book projects. Genre Compare settings are also here.</p>
      </div>
      
      <div class="help-guide">
        <h4>📖 Prompts Tab</h4>
        <p>AI-powered editing tools. Choose from categories like Character Creation, Copy Editing, Line Editing. Use built-in prompts or create custom templates.</p>
      </div>
      
      <div class="help-guide">
        <h4>📖 Pipeline Tab</h4>
        <p>Chain multiple prompts together. Each step's output feeds into the next, enabling complex editing workflows.</p>
      </div>
      
      <div class="help-guide">
        <h4>📖 Settings Tab</h4>
        <p>Configure API keys, choose AI models, adjust generation settings, manage projects, and export/import data.</p>
      </div>
      
      <div class="help-guide">
        <h4>🔍 Global Search</h4>
        <p>Click the 🔍 button in the header or press Ctrl/Cmd+F to search across all your project data. Searches chapters, characters, settings, bibles, timeline, and relationships. Results are limited to 100 with an indicator.</p>
      </div>
      
      <div class="help-guide">
        <h4>🔍 Find & Replace</h4>
        <p>In the Chapter tab, click "Find/Replace" to open the search panel. Use Find Next to locate occurrences, Replace to change one at a time, or Replace All to change all. Supports regex patterns and case-sensitive matching.</p>
      </div>
      
      <div class="help-guide">
        <h4>🔍 Find All</h4>
        <p>In the search modal's "Find All" tab, see all occurrences of your search term across all chapters. Click any result to jump to that location. Limited to 100 results.</p>
      </div>
      
      <div class="help-guide">
        <h4>🧠 Smart Context</h4>
        <p>Click the 🧠 Smart Context button in the Chapter tab to automatically optimize context sections. The AI analyzes your prompt and toggles context inclusions on/off to maximize relevance while saving tokens.</p>
      </div>
      
      <div class="help-guide">
        <h4>📊 Local Analysis</h4>
        <p>Click the 📊 Local Analysis button in the Chapter tab to analyze your chapter text. Shows word count, sentence stats, readability score, sentiment, and common words.</p>
      </div>
      
      <div class="help-guide">
        <h4>📊 Token Breakdown</h4>
        <p>Click the 📊 Breakdown button in the Prompts tab to see how tokens are distributed across all context sections. Helps optimize your prompts to stay within limits.</p>
      </div>
      
      <div class="help-guide">
        <h4>🎨 Style DNA</h4>
        <p>In the Story tab's Style DNA tab, define your unique writing style with sample text. Export/Import presets, or use the built-in styles. Enable "Apply Style DNA" in Pipeline steps to have AI match your voice.</p>
      </div>
      
      <div class="help-guide">
        <h4>🔐 Secure API Key Storage</h4>
        <p>In Settings, choose how to store your API keys: <strong>Password-Encrypted</strong> (recommended, AES-256), <strong>Prompt Each Session</strong> (enter when needed), or <strong>Session Only</strong> (cleared on browser close). The default is Password-Encrypted for security.</p>
      </div>
    </div>
  `;
    }

    function renderHelpLog(container) {
      const log = getActivityLog();
      container.innerHTML = `
    <div class="help-section">
      <h3>Activity Log</h3>
      <p style="color:#a89868;margin-bottom:16px">Recent AI generations (last ${log.length} of 50). Newest entries appear at bottom.</p>
      
      <div class="activity-log">
        ${log.length === 0 ? '<div class="empty-msg">No AI generations yet. Use the Prompts tab to generate content.</div>' :
          log.map(entry => `
            <div class="activity-entry">
              <div class="activity-time">${entry.time}</div>
              <div class="activity-desc">${entry.desc}</div>
            </div>
          `).join('')
        }
      </div>
    </div>
  `;
    }

    // Activity Log Functions
    function getActivityLog() {
      try {
        return JSON.parse(localStorage.getItem('na_activity_log')) || [];
      } catch { return []; }
    }

    function addActivityLogEntry(desc) {
      const log = getActivityLog();
      const entry = {
        time: new Date().toLocaleString(),
        desc: desc
      };
      log.push(entry);
      if (log.length > 50) {
        log.shift(); // Remove oldest
      }
      localStorage.setItem('na_activity_log', JSON.stringify(log));
    }

    // ═══════════════════════════════════════════════════════════
    // KEYBOARD SHORTCUTS
    // ═══════════════════════════════════════════════════════════

    document.addEventListener('keydown', function (e) {
      const isMod = e.ctrlKey || e.metaKey;
      const key = e.key.toLowerCase();

      // Escape - close modals
      if (key === 'escape') {
        const modals = document.querySelectorAll('[class$="modal-overlay"], [class$="modal-overlay open"]');
        modals.forEach(m => {
          if (m.classList.contains('open')) {
            m.classList.remove('open');
            if (m.id) window['close' + m.id.charAt(0).toUpperCase() + m.id.slice(1).replace('_', '').replace('modal', 'Modal') + 'Modal']?.();
          }
        });
        return;
      }

      // F1 - Open Help
      if (key === 'f1') {
        e.preventDefault();
        showTab('help');
        return;
      }

      if (!isMod) return;

      // Ctrl/Cmd + Number - Switch tabs
      if (key >= '1' && key <= '8') {
        e.preventDefault();
        const tabIndex = parseInt(key) - 1;
        const tabs = TABS[tabIndex];
        if (tabs) {
          showTab(tabs.id);
        }
        return;
      }

      // Ctrl/Cmd + S - Force save
      if (key === 's') {
        e.preventDefault();
        clearTimeout(saveTimer);
        const pid = getCurrentProjectId();
        saveProjectState(pid);
        saveGenreCompare(pid, APP.genreCompare);
        updateStatsDisplay();
        showToast('Saved!');
        return;
      }

      // Ctrl/Cmd + J - Scene Navigator
      if (key === 'j') {
        e.preventDefault();
        toggleSceneNavigator();
        return;
      }

      // Ctrl/Cmd + F - Search
      if (key === 'f') {
        e.preventDefault();
        openSearchModal();
        return;
      }

      // Ctrl/Cmd + N - New item
      if (key === 'n') {
        e.preventDefault();
        if (APP.tab === 'story') {
          window.addCharacter?.();
        } else if (APP.tab === 'chapter') {
          if (APP.chapter.useFullChapters) {
            APP.chapter.fullChapters.push({ id: mkId(), title: '', text: '' });
          } else {
            APP.chapter.breakdowns.push({ id: mkId(), text: '' });
          }
          saveState();
          renderChapter();
        } else if (APP.tab === 'series') {
          // Add new series section if needed
        }
        showToast('New item added');
        return;
      }

      // Ctrl/Cmd + Enter - Run prompt
      if (key === 'enter') {
        e.preventDefault();
        const runBtn = document.querySelector('#prompt-editor-run');
        if (runBtn) runBtn.click();
        return;
      }
    });

    function showToast(msg) {
      const existing = document.getElementById('toast-notification');
      if (existing) existing.remove();
      const toast = document.createElement('div');
      toast.id = 'toast-notification';
      toast.textContent = msg;
      toast.style.cssText = 'position:fixed;bottom:20px;right:20px;background:#1a1512;border:1px solid #c8a660;color:#c8a660;padding:10px 20px;border-radius:4px;font-size:12px;z-index:9999;animation:fadeIn 0.2s';
      document.body.appendChild(toast);
      setTimeout(() => { toast.remove(); }, 2000);
    }

    // ═══════════════════════════════════════════════════════════
    // TAB NAVIGATION
    // ═══════════════════════════════════════════════════════════

    const RENDER_FNS = { home: renderHome, series: renderSeries, book: renderBook, chapter: renderChapter, story: renderStory, prompts: renderPrompts, pipeline: renderPipeline, settings: renderSettings, help: renderHelp };
    const rendered = {};

    function showTab(id) {
      APP.tab = id;
      localStorage.setItem('na_tab', id);
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === id));
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.getElementById(`panel-${id}`)?.classList.add('active');
      if (!rendered[id]) { RENDER_FNS[id]?.(); rendered[id] = true; }
    }

    function updateTabDot() {
      const hasCtx = getContextPills().length > 0;
      const hasKey = !!APP.apiKey;
      const prBtn = document.querySelector('[data-tab="prompts"]');
      const setBtn = document.querySelector('[data-tab="settings"]');
      if (prBtn) {
        const dot = prBtn.querySelector('.tab-dot');
        if (hasCtx && !dot) {
          const d = document.createElement('span'); d.className = 'tab-dot';
          prBtn.appendChild(d);
        } else if (!hasCtx && dot) dot.remove();
      }
    }

    // Extract from Chapters function
    function runExtract(type) {
      const text = document.getElementById('extract_text').value;
      if (!text.trim()) { alert('Please paste chapter text first.'); return; }

      let prompt = '';
      if (type === 'character') {
        prompt = `Extract all distinct characters from the following text. For each character, provide: Name, Role, Key Traits, Physical Description (if mentioned), Speech Style, and any character development moments.\n\nTEXT:\n${text}`;
      } else if (type === 'world') {
        prompt = `Extract all world-building elements from the following text. Include: Magic/Technology systems, Factions/Groups, Historical events mentioned, Social structures, Geography/Setting details, Rules or laws, and any unique terminology.\n\nTEXT:\n${text}`;
      } else if (type === 'location') {
        prompt = `Extract all locations from the following text. For each location provide: Name, Description, Atmosphere/Mood, Key features, and any significance to the plot.\n\nTEXT:\n${text}`;
      }

      const outputEl = document.getElementById('extract_output');
      const resultEl = document.getElementById('extract_result');
      resultEl.style.display = 'block';
      outputEl.value = 'Processing...';

      callAPI(prompt,
        chunk => { outputEl.value += chunk; },
        () => { outputEl.value += '\n\n[Done]'; },
        err => { outputEl.value = 'Error: ' + err; },
        null
      );
    }

    function setupExtractButtons() {
      document.getElementById('extract_chars')?.addEventListener('click', () => runExtract('character'));
      document.getElementById('extract_world')?.addEventListener('click', () => runExtract('world'));
      document.getElementById('extract_locs')?.addEventListener('click', () => runExtract('location'));
    }

    function generateBookBibleFromChapters() {
      const chapters = APP.chapter.fullChapters?.filter(c => c.text?.trim()) || [];
      if (chapters.length === 0) {
        alert('No chapters found. Add chapters in the Chapter tab first.');
        return;
      }

      const allText = chapters.map(c => `### ${c.label || 'Chapter'}\n\n${c.text.trim()}`).join('\n\n---\n\n');

      const promptText = `You are a Senior Continuity Architect and Narrative Analyst. Process the following manuscript chapters and extract information to build a comprehensive Book Bible.

Process sequentially, chapter by chapter. Do NOT summarize—EXTRACT and ENCODE specific data. Generalizations are forbidden.

---

## 1. GENRE & BASIC INFO

* **Genre:** [Extract from text]
* **Tone:** [Extract tone, mood, atmosphere]
* **Point of View:** [Note POV style - first person, third limited, etc.]
* **Current Status:** End of [last chapter name/number]

## 2. NARRATIVE SUMMARY (The "So Far")

* **Logline:** One sentence summary of the core conflict.
* **Main Plot Progression:** Bulleted list of major events across all chapters.
* **Active Subplots:** List of side plots currently in motion.
* **Unresolved Threads:** List of clues, mysteries, or items not yet resolved.

## 3. CHARACTER PROFILES

For each character that appears:

**[Character Name]**
* **Role:** Protagonist/Antagonist/Sidekick/Minor
* **Current Goal:** What do they want right now?
* **Internal Conflict:** What is stopping them?
* **Physical Appearance:** Brief description
* **Speech Style:** Note any speech patterns
* **Character Arc:** How they have changed since Chapter 1

## 4. WORLD-BUILDING & LORE

* **Setting/Location:** Primary locations where story takes place
* **Rules of Magic/Tech:** Hard limits and costs if applicable
* **Factions/Politics:** Current power dynamics
* **Glossary of Terms:** Unique slang, names of cities, made-up currencies

## 5. STYLE GUIDE & EXAMPLES

* **Writing Style Notes:** Show vs tell ratio, sentence variation, key stylistic choices
* **Example Dialogue:** [Extract 1-2 lines of dialogue that exemplify the voice]
* **Example Action:** [Extract a brief action scene passage]
* **Example Description:** [Extract a descriptive passage]

---

MANUSCRIPT:
---
${allText}
---`;

      const output = showProgress('Generating Book Bible...', `Generating Book Bible from ${chapters.length} chapter(s)...`);

      let accumulatedText = '';

      callAPI(promptText,
        chunk => { if (chunk) { accumulatedText += chunk; output.update(chunk); } },
        () => {
          output.complete('Book Bible generated!');
          if (accumulatedText && accumulatedText.trim()) {
            showGeneratedOutput(accumulatedText, 'Book Bible');
          } else {
            alert('Generation completed but result was empty. Check console for details.');
          }
        },
        err => {
          console.error('API Error:', err);
          output.error(err || 'Unknown error');
        }
      );
    }

    function generateSeriesBibleFromBook() {
      const bookBible = APP.book.bible?.text?.trim();
      const bookTitle = APP.book.title || 'Untitled Book';
      const bookNum = APP.book.bookNum || '?';
      const totalBooks = APP.book.totalBooks || '?';
      const subNum = APP.book.subNum || '?';
      const totalSub = APP.book.totalSub || '?';

      if (!bookBible) {
        alert('No Book Bible found. Generate a Book Bible from chapters in the Book tab first.');
        return;
      }

      const promptText = `You are a Senior Continuity Architect. Expand the following Book Bible into a comprehensive Series Bible that could apply to multiple books in a series.

Include:
- How this book fits into the larger series arc
- Series-level world-building that extends beyond this book
- Potential future character development arcs
- Series-wide themes and motifs
- How the setting/rules might evolve across books

BOOK BIBLE (Book ${bookNum} of ${totalBooks}${subNum && totalSub ? `, Subseries ${subNum} of ${totalSub}` : ''}):
---
${bookBible}
---

SERIES BIBLE:
---`;

      const output = showProgress('Generating Series Bible...', `
Generating Series Bible from Book "${bookTitle}"...

This will expand the book-level bible into a series-level reference.`);

      let accumulatedText = '';

      callAPI(promptText,
        chunk => { if (chunk) { accumulatedText += chunk; output.update(chunk); } },
        () => {
          output.complete('Series Bible generated!');
          if (accumulatedText && accumulatedText.trim()) {
            showGeneratedOutput(accumulatedText, 'Series Bible');
          } else {
            alert('Generation completed but result was empty. Please try again.');
          }
        },
        err => {
          console.error('API Error:', err);
          output.error(err || 'Unknown error');
        }
      );
    }

    function showProgress(initial, message) {
      const div = document.createElement('div');
      div.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#111009;border:1px solid #c8a660;padding:20px 30px;border-radius:4px;z-index:9999;color:#e0d3bc;font-family:Crimson Pro,serif;font-size:14px;box-shadow:0 4px 20px rgba(0,0,0,0.5)';
      div.innerHTML = `<div style="text-align:center"><div style="margin-bottom:10px">⚡</div>${message}</div><pre id="prompt_output" style="margin-top:15px;max-height:200px;overflow:auto;background:#0b0908;padding:10px;border-radius:2px;font-size:11px;color:#a89868;white-space:pre-wrap;text-align:left"></pre>`;
      document.body.appendChild(div);
      let text = '';
      return {
        update: (chunk) => {
          try {
            if (chunk) {
              text += chunk;
              const pre = document.getElementById('prompt_output');
              if (pre) pre.textContent = text;
            }
          } catch (e) { console.error('Update error:', e); }
        },
        complete: (msg) => {
          try {
            if (div && div.parentNode) {
              div.innerHTML = `<div style="color:#7aac74">✓ ${msg}</div>`;
              setTimeout(() => { if (div.parentNode) div.remove(); }, 1500);
            }
          } catch (e) { console.error('Complete error:', e); }
          return text || '';
        },
        error: (msg) => {
          try {
            if (div && div.parentNode) {
              div.innerHTML = `<div style="color:#c06050">✗ ${msg}</div>`;
              setTimeout(() => { if (div.parentNode) div.remove(); }, 3000);
            }
          } catch (e) { console.error('Error display error:', e); }
        }
      };
    }

    function showGeneratedOutput(text, title) {
      const div = document.createElement('div');
      div.style.cssText = 'position:fixed;top:5%;left:5%;width:90%;height:90%;background:#111009;border:1px solid #c8a660;padding:20px;border-radius:4px;z-index:9999;color:#e0d3bc;font-family:Crimson Pro,serif;font-size:14px;box-shadow:0 4px 30px rgba(0,0,0,0.7)';
      div.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;border-bottom:1px solid #252015;padding-bottom:10px">
      <h3 style="margin:0;color:#c8a660">${title}</h3>
      <button id="gen_output_close" style="background:transparent;border:none;color:#80786a;font-size:20px;cursor:pointer">✕</button>
    </div>
    <textarea id="gen_output_text" style="width:100%;height:calc(100% - 60px);background:#0b0908;border:1px solid #252015;color:#a89868;font-family:Crimson Pro,serif;font-size:13px;padding:10px;resize:none">${esc(text)}</textarea>
    <div style="margin-top:10px;display:flex;gap:10px;justify-content:flex-end">
      <button id="gen_copy_btn" style="padding:8px 16px;background:#141209;border:1px solid #3a3020;border-radius:2px;color:#c8a660;font-family:'JetBrains Mono',monospace;font-size:11px;cursor:pointer">Copy to Clipboard</button>
      <button id="gen_save_btn" style="padding:8px 16px;background:#0f180d;border:1px solid #263422;border-radius:2px;color:#7aac74;font-family:'JetBrains Mono',monospace;font-size:11px;cursor:pointer">Save as .md</button>
    </div>
  `;
      document.body.appendChild(div);

      div.querySelector('#gen_output_close').addEventListener('click', () => div.remove());
      div.querySelector('#gen_copy_btn').addEventListener('click', () => {
        const ta = div.querySelector('#gen_output_text');
        ta.select();
        document.execCommand('copy');
        div.querySelector('#gen_copy_btn').textContent = 'Copied!';
        setTimeout(() => div.querySelector('#gen_copy_btn').textContent = 'Copy to Clipboard', 2000);
      });
      div.querySelector('#gen_save_btn').addEventListener('click', () => {
        const text = div.querySelector('#gen_output_text').value;
        const blob = new Blob([text], { type: 'text/markdown' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = title.toLowerCase().replace(/\s+/g, '-') + '.md';
        a.click();
        URL.revokeObjectURL(a.href);
      });
    }

    // ═══════════════════════════════════════════════════════════
    // SMART FEATURES
    // ═══════════════════════════════════════════════════════════

    function getFullChapterText() {
      let text = '';
      if (APP.chapter.useFullChapters && APP.chapter.fullChapters) {
        APP.chapter.fullChapters.forEach(ch => {
          if (ch.text) text += ch.text + ' ';
          if (ch.scenes) {
            ch.scenes.forEach(s => {
              if (s.content) text += s.content + ' ';
            });
          }
        });
      } else if (APP.chapter.breakdowns) {
        APP.chapter.breakdowns.forEach(b => {
          if (b.text) text += b.text + ' ';
        });
      }
      return text;
    }

    function autoToggleContext() {
      const chapterText = getFullChapterText();
      if (!chapterText) {
        alert('Please add some chapter text first to analyze context.');
        return;
      }

      const textLower = chapterText.toLowerCase();
      let toggledCount = 0;

      if (APP.book && APP.book.chars) {
        APP.book.chars.forEach(char => {
          const nameLine = char.text ? char.text.split('\n')[0].toLowerCase().trim() : '';
          if (nameLine && textLower.includes(nameLine)) {
            char.inclusion = 'full';
            toggledCount++;
          } else {
            char.inclusion = 'off';
          }
        });
      }

      if (APP.chapter && APP.chapter.settings) {
        APP.chapter.settings.forEach(setting => {
          const nameLine = setting.text ? setting.text.split('\n')[0].toLowerCase().trim() : '';
          if (nameLine && textLower.includes(nameLine)) {
            setting.inclusion = 'full';
            toggledCount++;
          } else {
            setting.inclusion = 'off';
          }
        });
      }

      saveProjectState(getCurrentProjectId());
      renderChapter();
      showToast('Smart Context: toggled ' + toggledCount + ' items');
    }

    function analyzeLocalText() {
      const chapterText = getFullChapterText();
      if (!chapterText) {
        alert('Please add some chapter text first to analyze.');
        return;
      }

      const adverbs = (chapterText.match(/\b\w+ly\b/gi) || []).length;
      const passive = (chapterText.match(/\b(was|were|is|are|been|being|be)\s+\w+ed\b/gi) || []).length;
      const filterWords = (chapterText.match(/\b(saw|felt|heard|noticed|realized|watched|looked|seemed)\b/gi) || []).length;

      let crutchCount = 0;
      if (APP.writingPrefs && APP.writingPrefs.doNotUseWords) {
        const crutchWords = APP.writingPrefs.doNotUseWords.split(',').map(w => w.trim()).filter(w => w);
        if (crutchWords.length > 0) {
          const regex = new RegExp('\\b(' + crutchWords.join('|') + ')\\b', 'gi');
          crutchCount = (chapterText.match(regex) || []).length;
        }
      }

      const wordCount = chapterText.split(/\s+/).filter(w => w.length > 0).length;

      const report = '📊 Local Text Analysis Report\n' +
        '-----------------------------------\n' +
        'Word Count: ' + wordCount + '\n\n' +
        '🏃 Adverbs (-ly): ' + adverbs + ' (' + ((adverbs / wordCount) * 100).toFixed(1) + '%)\n' +
        '🥱 Passive Voice: ' + passive + ' instances\n' +
        '👁️ Filter Words: ' + filterWords + ' instances\n' +
        '🚫 Crutch Words: ' + crutchCount + ' instances\n\n' +
        'Tip: Try to keep adverbs under 1.5% and minimize filter words to strengthen your prose!';

      alert(report);
    }

    function getGranularTokenBreakdown(promptTemplate, fields) {
      const ctxParts = { series: 0, book: 0, characters: 0, chapter: 0, settings: 0, prompt: 0 };
      const est = (text) => text ? Math.round(text.length / 4) : 0;

      if (APP.series && APP.series.bible && APP.series.bible.inclusion !== 'off' && APP.series.bible.text) {
        ctxParts.series += est(APP.series.bible.text);
      }

      if (APP.book) {
        if (APP.book.bible && APP.book.bible.inclusion !== 'off' && APP.book.bible.text) {
          ctxParts.book += est(APP.book.bible.text);
        }
        if (APP.book.outline && APP.book.outline.inclusion !== 'off' && APP.book.outline.text) {
          ctxParts.book += est(APP.book.outline.text);
        }
        if (APP.book.chars) {
          APP.book.chars.forEach(c => {
            if (c.inclusion !== 'off' && c.text) ctxParts.characters += est(c.text);
          });
        }
      }

      if (APP.chapter) {
        if (APP.chapter.useFullChapters && APP.chapter.fullChapters) {
          APP.chapter.fullChapters.forEach(c => {
            if (c.text) ctxParts.chapter += est(c.text);
            if (c.scenes) c.scenes.forEach(s => { if (s.content) ctxParts.chapter += est(s.content); });
          });
        } else if (APP.chapter.breakdowns) {
          APP.chapter.breakdowns.forEach(b => { if (b.text) ctxParts.chapter += est(b.text); });
        }

        if (APP.chapter.settings) {
          APP.chapter.settings.forEach(s => { if (s.inclusion !== 'off' && s.text) ctxParts.settings += est(s.text); });
        }
      }

      const prefs = buildWritingPrefsInstructions ? buildWritingPrefsInstructions() : '';
      const genre = buildGenreCompareInstructions ? buildGenreCompareInstructions() : '';
      const basePrompt = genre + prefs + (promptTemplate ? promptTemplate(fields || {}) : '');
      ctxParts.prompt = est(basePrompt);

      const total = Object.values(ctxParts).reduce((a, b) => a + b, 0);
      return { parts: ctxParts, total };
    }

    function showTokenBreakdown(promptTemplate, fields) {
      const breakdown = getGranularTokenBreakdown(promptTemplate, fields);
      const limit = APP.maxTokens + (parseInt(document.getElementById('tok_boost')?.value) || 0);
      const pct = (val) => ((val / breakdown.total) * 100).toFixed(1);

      const msg = '🧮 Token Usage Breakdown\n' +
        '-----------------------------------\n' +
        'Total Estimated Tokens: ~' + breakdown.total + ' / ' + limit + '\n\n' +
        '📖 Series Bible: ~' + breakdown.parts.series + ' (' + pct(breakdown.parts.series) + '%)\n' +
        '📘 Book Context: ~' + breakdown.parts.book + ' (' + pct(breakdown.parts.book) + '%)\n' +
        '👥 Characters: ~' + breakdown.parts.characters + ' (' + pct(breakdown.parts.characters) + '%)\n' +
        '📝 Chapter Text: ~' + breakdown.parts.chapter + ' (' + pct(breakdown.parts.chapter) + '%)\n' +
        '🗺️ Settings: ~' + breakdown.parts.settings + ' (' + pct(breakdown.parts.settings) + '%)\n' +
        '🤖 Prompt & Rules: ~' + breakdown.parts.prompt + ' (' + pct(breakdown.parts.prompt) + '%)';

      alert(msg);
    }

    // Build nav
    function initNav() {
      const nav = document.getElementById('tab-nav');
      nav.innerHTML = TABS.map(t => `
    <button class="tab-btn${t.id === APP.tab ? ' active' : ''}" data-tab="${t.id}">
      <span class="tab-icon">${t.icon}</span>${t.label}
    </button>`).join('');
      nav.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => showTab(btn.dataset.tab));
      });
    }

    // ═══════════════════════════════════════════════════════════
    // INIT
    // ═══════════════════════════════════════════════════════════

    window.onerror = function (msg, url, line, col, error) {
      document.getElementById('app-main').innerHTML = '<div style="padding:20px;color:#c06060;font-size:14px"><b>JavaScript Error:</b><br>' + msg + '<br>Line: ' + line + '</div>';
      return true;
    };

    try {
      initNav();

      // Project dropdown - available from any tab
      const projectDropdown = document.querySelector('#project_dropdown');
      if (projectDropdown) {
        document.querySelector('#project_current_btn').addEventListener('click', (e) => {
          e.stopPropagation();
          projectDropdown.classList.toggle('open');
        });
        document.addEventListener('click', () => {
          projectDropdown.classList.remove('open');
        });
        projectDropdown.addEventListener('click', (e) => {
          e.stopPropagation();
        });

        // Project actions
        document.querySelector('#project_new').addEventListener('click', () => {
          projectDropdown.classList.remove('open');
          createNewProject();
        });
        document.querySelector('#project_load').addEventListener('click', () => {
          projectDropdown.classList.remove('open');
          document.getElementById('import_file').click();
        });
        document.querySelector('#project_save').addEventListener('click', () => {
          projectDropdown.classList.remove('open');
          saveProjectState(getCurrentProjectId());
          alert('Project saved!');
        });
        document.querySelector('#project_import').addEventListener('click', () => {
          projectDropdown.classList.remove('open');
          document.getElementById('import_file').click();
        });
        document.querySelector('#project_export').addEventListener('click', () => {
          try {
            projectDropdown.classList.remove('open');
            const pid = getCurrentProjectId();
            const projects = getProjects();
            const currentProject = projects.find(p => p.id === pid);
            const exportData = {
              version: '1.0-beta',
              exportedAt: new Date().toISOString(),
              projectName: currentProject ? currentProject.name : 'Unnamed Project',
              series: APP.series,
              book: APP.book,
              chapter: APP.chapter,
              genreCompare: APP.genreCompare
            };
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const safeName = (currentProject ? currentProject.name : 'project').replace(/[^a-z0-9]/gi, '-').toLowerCase();
            a.download = 'novelist-atelier-' + safeName + '-' + Date.now() + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          } catch (e) {
            console.error('Export error:', e);
            alert('Export failed: ' + e.message);
          }
        });

        // Global import handler for project dropdown
        document.getElementById('import_file').addEventListener('change', function (e) {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function (event) {
            try {
              const data = JSON.parse(event.target.result);
              if (!data.series || !data.book || !data.chapter) {
                throw new Error('Invalid project file: missing required data');
              }

              const importAsNew = confirm('Import as a NEW project? Click OK for new project, Cancel to merge with current project.');

              if (importAsNew) {
                const projName = data.projectName || prompt('Enter project name:', 'Imported Project') || 'Imported Project';
                const pid = 'project-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                const projects = getProjects();
                projects.push({ id: pid, name: projName });
                saveProjects(projects);

                APP.series = data.series || { name: '', subName: '', bible: mkSec() };
                APP.book = data.book || { title: '', bookNum: '', totalBooks: '', subNum: '', totalSub: '', bible: mkSec(), outline: mkSec(), chars: [{ id: mkId(), ...mkSec() }] };
                APP.chapter = data.chapter || { mode: 'chapter', chapterNum: '', sceneNum: '', useFullChapters: false, sceneLevel: false, fullChapters: [], breakdowns: [], breakdown: mkSec(), settings: [{ id: mkId(), ...mkSec() }] };
                APP.genreCompare = data.genreCompare || { preset: 'fantasy', customText: '' };

                setCurrentProjectId(pid);
                saveProjectState(pid);
                saveGenreCompare(pid, APP.genreCompare);
                renderProjectSelector();
              } else {
                const pid = getCurrentProjectId();
                APP.series = data.series || { name: '', subName: '', bible: mkSec() };
                APP.book = data.book || { title: '', bookNum: '', totalBooks: '', subNum: '', totalSub: '', bible: mkSec(), outline: mkSec(), chars: [{ id: mkId(), ...mkSec() }] };
                APP.chapter = data.chapter || { mode: 'chapter', chapterNum: '', sceneNum: '', useFullChapters: false, sceneLevel: false, fullChapters: [], breakdowns: [], breakdown: mkSec(), settings: [{ id: mkId(), ...mkSec() }] };
                if (data.genreCompare) {
                  APP.genreCompare = { ...data.genreCompare };
                  saveGenreCompare(pid, APP.genreCompare);
                }
                saveProjectState(pid);
                renderProjectSelector();
              }

              showTab(APP.tab);
              alert('Project imported successfully!');
            } catch (err) {
              alert('Error importing project: ' + err.message);
            }
          };
          reader.readAsText(file);
          e.target.value = '';
        });

        document.querySelector('#project_rename').addEventListener('click', () => {
          projectDropdown.classList.remove('open');
          renameProject();
        });
        document.querySelector('#project_delete').addEventListener('click', () => {
          projectDropdown.classList.remove('open');
          deleteProject();
        });
      }

      showTab(APP.tab);
      updateTabDot();

      // Auto-save every 30 seconds
      setInterval(function () { var pid = getCurrentProjectId(); if (pid) autoSaveLoop(); }, 30000);

      // Hourly backup
      setInterval(function () { var pid = getCurrentProjectId(); if (pid) createHourlyBackup(pid); }, 3600000);

      // Update save time display every minute
      setInterval(function () { var pid = getCurrentProjectId(); if (pid) updateLastSavedTime(pid); }, 60000);
    } catch (e) {
      document.getElementById('app-main').innerHTML = '<div style="padding:20px;color:#c06060">Error: ' + esc(e.message) + '<br><pre style="font-size:10px">' + esc(e.stack) + '</pre></div>';
    }

    // ═══════════════════════════════════════════════════════════
    // CUSTOM TEMPLATE MODAL
    // ═══════════════════════════════════════════════════════════
    let editingTemplateId = null;
    let editingTemplateCat = null;

    function openTemplateModal(catId, templateId) {
      const modal = document.getElementById('template_modal');
      const titleInput = document.getElementById('template_title');
      const descInput = document.getElementById('template_desc');
      const catSelect = document.getElementById('template_cat');
      const fieldsContainer = document.getElementById('template_fields');
      const tplInput = document.getElementById('template_tpl');
      const previewDiv = document.getElementById('template_preview');

      catSelect.value = catId;
      editingTemplateCat = catId;

      if (templateId) {
        editingTemplateId = templateId;
        const custom = getCustomTemplatesForCategory(catId);
        const tpl = custom.find(t => t.id === templateId);
        if (tpl) {
          titleInput.value = tpl.title || '';
          descInput.value = tpl.desc || '';
          tplInput.value = tpl.tpl || '';
          renderTemplateFields(tpl.fields || []);
        }
      } else {
        editingTemplateId = null;
        titleInput.value = '';
        descInput.value = '';
        tplInput.value = '';
        renderTemplateFields([{ key: '', label: '', type: 'text' }]);
      }

      previewDiv.textContent = '';
      modal.classList.add('open');
    }

    function closeTemplateModal() {
      document.getElementById('template_modal').classList.remove('open');
      editingTemplateId = null;
      editingTemplateCat = null;
    }

    function renderTemplateFields(fields) {
      const container = document.getElementById('template_fields');
      container.innerHTML = fields.map((f, i) =>
        '<div class="template-field-row">' +
        '<input type="text" placeholder="key" value="' + (f.key || '') + '" class="field-key">' +
        '<input type="text" placeholder="label" value="' + (f.label || '') + '" class="field-label">' +
        '<select class="field-type">' +
        '<option value="text"' + (f.type === 'text' ? ' selected' : '') + '>Text</option>' +
        '<option value="textarea"' + (f.type === 'textarea' ? ' selected' : '') + '>Textarea</option>' +
        '</select>' +
        '<span class="template-field-remove" onclick="removeTemplateField(' + i + ')">×</span>' +
        '</div>'
      ).join('');
    }

    function addTemplateField() {
      const container = document.getElementById('template_fields');
      const div = document.createElement('div');
      div.className = 'template-field-row';
      div.innerHTML =
        '<input type="text" placeholder="key" class="field-key">' +
        '<input type="text" placeholder="label" class="field-label">' +
        '<select class="field-type">' +
        '<option value="text">Text</option>' +
        '<option value="textarea">Textarea</option>' +
        '</select>' +
        '<span class="template-field-remove" onclick="this.parentElement.remove()">×</span>';
      container.appendChild(div);
    }

    function removeTemplateField(idx) {
      const container = document.getElementById('template_fields');
      if (container.children[idx]) {
        container.children[idx].remove();
      }
    }

    // ═══════════════════════════════════════════════════════════
    // CUSTOM TEMPLATE MODAL HTML
    // ═══════════════════════════════════════════════════════════
    document.write(`
<div class="template-modal-overlay" id="template_modal">
  <div class="template-modal">
    <div class="template-modal-hd">
      <h3 id="template_modal_title">Create Custom Template</h3>
      <button class="template-modal-close" onclick="closeTemplateModal()">×</button>
    </div>
    <div class="template-modal-body">
      <div class="template-field">
        <label style="display:block;font-size:11px;color:#605840;margin-bottom:6px">Category</label>
        <select id="template_cat" style="width:100%;padding:8px;background:#1a1512;border:1px solid #3a3020;color:#c8a660;font-size:12px">
          <option value="character">Character</option>
          <option value="world">World Building</option>
          <option value="location">Locations</option>
          <option value="developmental">Developmental</option>
          <option value="copy">Copy Editor</option>
          <option value="line">Line Editor</option>
          <option value="punch">Impact & Punch</option>
          <option value="paragraph">Paragraph</option>
          <option value="custom">Custom</option>
        </select>
      </div>
      <div class="template-field">
        <label style="display:block;font-size:11px;color:#605840;margin-bottom:6px">Title</label>
        <input type="text" id="template_title" placeholder="My Custom Prompt" style="width:100%;padding:8px;background:#1a1512;border:1px solid #3a3020;color:#c8a660;font-size:12px">
      </div>
      <div class="template-field">
        <label style="display:block;font-size:11px;color:#605840;margin-bottom:6px">Description</label>
        <input type="text" id="template_desc" placeholder="What this prompt does..." style="width:100%;padding:8px;background:#1a1512;border:1px solid #3a3020;color:#c8a660;font-size:12px">
      </div>
      <div class="template-field">
        <label style="display:block;font-size:11px;color:#605840;margin-bottom:6px">Fields</label>
        <div id="template_fields"></div>
        <button class="template-add-field" onclick="addTemplateField()">+ Add Field</button>
      </div>
      <div class="template-field">
        <label class="template-tpl-label">Template (use \${f.fieldname} for variables)</label>
        <textarea id="template_tpl" placeholder="Write your prompt here...&#10;Example: Analyze this \${f.text} for \${f.focus}"></textarea>
      </div>
      <div id="template_preview" class="template-preview"></div>
      <div class="template-actions">
        <button class="template-btn template-btn-secondary" onclick="previewTemplate()">Preview</button>
        <button class="template-btn template-btn-primary" onclick="saveTemplate()">Save Template</button>
      </div>
    </div>
  </div>
</div>
<input type="file" id="template_import_file" accept=".json" style="display:none">
<input type="file" id="timeline_import_file" accept=".json" style="display:none">
`);

    function getTemplateFieldsFromUI() {
      const rows = document.querySelectorAll('#template_fields .template-field-row');
      const fields = [];
      rows.forEach(row => {
        const key = row.querySelector('.field-key').value.trim();
        const label = row.querySelector('.field-label').value.trim();
        const type = row.querySelector('.field-type').value;
        if (key && label) {
          fields.push({ key, label, type });
        }
      });
      return fields;
    }

    function previewTemplate() {
      const title = document.getElementById('template_title').value;
      const fields = getTemplateFieldsFromUI();
      let tpl = document.getElementById('template_tpl').value;

      // Replace ${f.fieldname} with [fieldname] for preview
      fields.forEach(f => {
        const regex = new RegExp('\\$\\{f\\.' + f.key + '\\}', 'g');
        tpl = tpl.replace(regex, '[' + f.label + ']');
      });

      document.getElementById('template_preview').textContent = tpl || '(No template content)';
    }

    function saveTemplate() {
      const title = document.getElementById('template_title').value.trim();
      const desc = document.getElementById('template_desc').value.trim();
      const catId = document.getElementById('template_cat').value;
      const fields = getTemplateFieldsFromUI();
      const tpl = document.getElementById('template_tpl').value;

      if (!title) {
        alert('Title is required');
        return;
      }
      if (fields.length === 0) {
        alert('At least one field is required');
        return;
      }
      if (!tpl.trim()) {
        alert('Template content is required');
        return;
      }

      // Check all fields are used in template
      const usedKeys = [];
      fields.forEach(f => {
        if (tpl.includes('${f.' + f.key + '}')) {
          usedKeys.push(f.key);
        }
      });
      if (usedKeys.length < fields.length) {
        const unused = fields.filter(f => !usedKeys.includes(f.key)).map(f => f.key).join(', ');
        alert('Warning: These fields are not used in template: ' + unused);
      }

      const template = { title, desc, fields, tpl };

      if (editingTemplateId) {
        updateCustomTemplate(editingTemplateCat, editingTemplateId, template);
      } else {
        addCustomTemplate(catId, template);
      }

      closeTemplateModal();
      // Refresh prompts panel
      if (APP.currentTab === 'prompts') {
        renderPrompts();
      }
    }

    function deleteTemplate(catId, templateId) {
      if (!confirm('Delete this custom template? This cannot be undone.')) return;
      deleteCustomTemplate(catId, templateId);
      if (APP.prompts.promptId === templateId) {
        APP.prompts.promptId = null;
        APP.prompts.fields = {};
        APP.prompts.output = '';
      }
      if (APP.currentTab === 'prompts') {
        renderPromptList();
        renderPromptEditor();
      }
    }

    // Template Export/Import
    function exportTemplates() {
      const data = exportCustomTemplates();
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'novelist-atelier-templates-' + Date.now() + '.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function importTemplates() {
      const input = document.getElementById('template_import_file');
      input.click();
    }

    document.getElementById('template_import_file').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (event) {
        try {
          JSON.parse(event.target.result); // Validate JSON
          const merge = confirm('Merge with existing templates? Click OK to merge, Cancel to replace all.');
          importCustomTemplates(event.target.result, merge);
          if (APP.currentTab === 'prompts') renderPrompts();
          alert('Templates imported successfully!');
        } catch (err) {
          alert('Error importing templates: ' + err.message);
        }
      };
      reader.readAsText(file);
      this.value = '';
    });

  </script>
  <div id="search_modal" class="search-modal-overlay">
    <div class="search-modal">
      <div class="search-modal-hd">
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <button class="search-tab-btn active" id="search_tab_btn" onclick="showSearchTab('search')">🔍 Search</button>
          <button class="search-tab-btn" id="find_tab_btn" onclick="showSearchTab('find')">Find/Replace</button>
          <button class="search-tab-btn" id="findall_tab_btn" onclick="showSearchTab('findall')">Find All</button>
        </div>
      </div>

      <!-- Search Tab -->
      <div id="search_tab_content">
        <div class="search-modal-hd">
          <input type="text" id="search_input" class="search-input"
            placeholder="Search chapters, characters, settings..." autofocus>
        </div>
        <div class="search-options">
          <label><input type="checkbox" id="search_regex"> Regex</label>
          <label><input type="checkbox" id="search_case"> Case sensitive</label>
        </div>
        <div class="search-results" id="search_results"></div>
        <div class="search-results-count" id="search_results_count"></div>
      </div>

      <!-- Find/Replace Tab -->
      <div id="find_tab_content" style="display:none">
        <div style="padding:12px">
          <div style="margin-bottom:10px">
            <label style="font-size:11px;color:#605840;display:block;margin-bottom:4px">Find:</label>
            <input type="text" id="find_input" class="search-input" placeholder="Find text...">
          </div>
          <div style="margin-bottom:10px">
            <label style="font-size:11px;color:#605840;display:block;margin-bottom:4px">Replace:</label>
            <input type="text" id="replace_input" class="search-input" placeholder="Replace with...">
          </div>
          <div class="search-options" style="padding:8px 0">
            <label><input type="checkbox" id="find_regex"> Regex</label>
            <label><input type="checkbox" id="find_case"> Case sensitive</label>
            <label><input type="checkbox" id="find_all_chapters" checked> All chapters</label>
          </div>
          <div style="display:flex;gap:8px">
            <button class="search-btn" onclick="findNext()">Find Next</button>
            <button class="search-btn" onclick="replaceOne()">Replace</button>
            <button class="search-btn" onclick="replaceAll()">Replace All</button>
          </div>
        </div>
      </div>

      <!-- Find All Tab -->
      <div id="findall_tab_content" style="display:none">
        <div style="padding:12px">
          <div style="margin-bottom:10px">
            <label style="font-size:11px;color:#605840;display:block;margin-bottom:4px">Find:</label>
            <input type="text" id="findall_input" class="search-input" placeholder="Find all occurrences...">
          </div>
          <div class="search-options" style="padding:8px 0">
            <label><input type="checkbox" id="findall_regex"> Regex</label>
            <label><input type="checkbox" id="findall_case"> Case sensitive</label>
          </div>
          <button class="search-btn search-btn-primary" style="width:100%;margin-bottom:12px"
            onclick="findAllOccurrences()">Find All</button>
          <div class="search-results" id="findall_results" style="max-height:300px"></div>
          <div class="search-results-count" id="findall_count"></div>
        </div>
      </div>

      <div class="search-modal-ft">
        <button class="search-btn" onclick="closeSearchModal()">Close</button>
      </div>
    </div>
  </div>

</body>

</html>