<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Novelist's Atelier — 1.0 Beta</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&family=JetBrains+Mono:wght@300;400&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root { 
  --ui-scale: 1;
  /* Theme: Default Dark */
  --bg:#090807; --bg2:#0b0908; --bg3:#0e0c09; --bg4:#111009; --bg5:#141209;
  --border:#181510; --border2:#1c1912; --border3:#1e1a12; --border4:#252015;
  --text:#e0d3bc; --text2:#c8a660; --text3:#a89868; --text4:#80786a; --text5:#50483a;
  --accent:#c8a660; --accent2:#7aac74; --accent3:#c06050;
}

/* Theme: Soft Beach */
body.theme-soft-beach{
  --bg:#1a2328; --bg2:#1e2a30; --bg3:#223238; --bg4:#263040; --bg5:#2a3840;
  --border:#2f4048; --border2:#384854; --border3:#405060; --border4:#485868;
  --text:#d0e8f0; --text2:#51e2f5; --text3:#9df9ef; --text4:#7ac8d8; --text5:#5088a0;
  --accent:#51e2f5; --accent2:#9df9ef; --accent3:#edf756;
}
/* Theme: Pink Sand */
body.theme-pink-sand{
  --bg:#2a1f24; --bg2:#302429; --bg3:#36292e; --bg4:#3c2e34; --bg5:#42343a;
  --border:#4a3a40; --border2:#504046; --border3:#56464c; --border4:#5c4c52;
  --text:#f0d8e0; --text2:#ffa8b6; --text3:#ffc8d0; --text4:#d8a0b0; --text5:#a87888;
  --accent:#ffa8b6; --accent2:#ffb6c8; --accent3:#a28089;
}
/* Theme: Dark Sand */
body.theme-dark-sand{
  --bg:#1a1819; --bg2:#1e1c1d; --bg3:#222021; --bg4:#262425; --bg5:#2a2829;
  --border:#302c2d; --border2:#363233; --border3:#3c3839; --border4:#423e3f;
  --text:#d8d0c8; --text2:#a28089; --text3:#b8a098; --text4:#908078; --text5:#686058;
  --accent:#a28089; --accent2:#b8a098; --accent3:#c8a080;
}
/* Theme: Ice Cold */
body.theme-ice-cold{
  --bg:#1a2028; --bg2:#1e2832; --bg3:#22303c; --bg4:#263844; --bg5:#2a4050;
  --border:#2f4858; --border2:#385068; --border3:#415878; --border4:#486088;
  --text:#d0e8f8; --text2:#a0d2eb; --text3:#b8e0f0; --text4:#90c0d8; --text5:#70a0c0;
  --accent:#a0d2eb; --accent2:#b8e0f0; --accent3:#e5eaf5;
}
/* Theme: Freeze Purple */
body.theme-freeze-purple{
  --bg:#1a1a24; --bg2:#202028; --bg3:#26262c; --bg4:#2c2c34; --bg5:#32323c;
  --border:#3a3a44; --border2:#42424c; --border3:#4a4a54; --border4:#52525c;
  --text:#e0e0f0; --text2:#e5eaf5; --text3:#f0f0ff; --text4:#c0c0d8; --text5:#a0a0b8;
  --accent:#e5eaf5; --accent2:#d0bdf4; --accent3:#c0b0e8;
}
/* Theme: Medium Purple */
body.theme-medium-purple{
  --bg:#1a1824; --bg2:#201c2c; --bg3:#262034; --bg4:#2c243c; --bg5:#322844;
  --border:#3a2c4c; --border2:#443458; --border3:#4e3c64; --border4:#584470;
  --text:#e0d8f0; --text2:#d0bdf4; --text3:#e0c8ff; --text4:#b8a8d8; --text5:#9888b8;
  --accent:#d0bdf4; --accent2:#e0c8ff; --accent3:#8458b3;
}
/* Theme: Purple Pain */
body.theme-purple-pain{
  --bg:#181420; --bg2:#1c1828; --bg3:#201c30; --bg4:#242038; --bg5:#282440;
  --border:#2c2848; --border2:#342c50; --border3:#3c3058; --border4:#443460;
  --text:#d8d0e8; --text2:#8458b3; --text3:#a068c8; --text4:#9048a0; --text5:#683878;
  --accent:#8458b3; --accent2:#a068c8; --accent3:#c060a0;
}
/* Theme: Heavy Purple */
body.theme-heavy-purple{
  --bg:#201820; --bg2:#281c28; --bg3:#302030; --bg4:#382438; --bg5:#402840;
  --border:#483048; --border2:#503858; --border3:#584068; --border4:#604878;
  --text:#e8d8e0; --text2:#a28089; --text3:#b898a0; --text4:#887878; --text5:#685858;
  --accent:#a28089; --accent2:#b898a0; --accent3:#ff1d58;
}
/* Theme: Yass Queen */
body.theme-yass-queen{
  --bg:#1a0a14; --bg2:#200c1a; --bg3:#280e20; --bg4:#301026; --bg5:#38122c;
  --border:#401432; --border2:#481838; --border3:#501c3e; --border4:#582044;
  --text:#f8d0e0; --text2:#ff1d58; --text3:#ff4080; --text4:#d81848; --text5:#a01038;
  --accent:#ff1d58; --accent2:#ff4080; --accent3:#fff685;
}
/* Theme: Sister Sister */
body.theme-sister-sister{
  --bg:#1a1420; --bg2:#201828; --bg3:#281c30; --bg4:#302038; --bg5:#382440;
  --border:#402848; --border2:#482c50; --border3:#503058; --border4:#583460;
  --text:#f0d8f0; --text2:#f75990; --text3:#ff78a8; --text4:#d84878; --text5:#a83860;
  --accent:#f75990; --accent2:#ff78a8; --accent3:#fff685;
}
/* Theme: Crown Yellow */
body.theme-crown-yellow{
  --bg:#1a1a10; --bg2:#202018; --bg3:#282820; --bg4:#303028; --bg5:#383830;
  --border:#404038; --border2:#484840; --border3:#505048; --border4:#585850;
  --text:#e8e8d0; --text2:#fff685; --text3:#ffffa0; --text4:#d8d870; --text5:#b0b058;
  --accent:#fff685; --accent2:#ffffa0; --accent3:#00ddff;
}
/* Theme: Blue Light */
body.theme-blue-light{
  --bg:#081820; --bg2:#0a2028; --bg3:#0c2830; --bg4:#0e3038; --bg5:#103840;
  --border:#124048; --border2:#144850; --border3:#165058; --border4:#185860;
  --text:#d0f0f8; --text2:#00ddff; --text3:#40e0ff; --text4:#00b8d8; --text5:#0090b0;
  --accent:#00ddff; --accent2:#40e0ff; --accent3:#0049b7;
}
/* Theme: Brutal Blue */
body.theme-brutal-blue{
  --bg:#080c18; --bg2:#0a1020; --bg3:#0c1428; --bg4:#0e1830; --bg5:#101c38;
  --border:#122040; --border2:#142448; --border3:#162850; --border4:#182c58;
  --text:#d0d8f0; --text2:#0049b7; --text3:#2060d8; --text4:#003898; --text5:#002870;
  --accent:#0049b7; --accent2:#2060d8; --accent3:#51e2f5;
}
html,body{height:100%;overflow:auto}
body{background:var(--bg);font-family:'Crimson Pro',Georgia,serif;color:var(--text)}

/* Main content scaled */
#app-main {
  zoom: var(--ui-scale, 1);
}

/* Mobile Layout */
@media (max-width: 768px) {
  body.mobile-enabled { overflow-x: auto; }
  body.mobile-enabled #app { min-width: 120vw; flex-direction: row; }
  body.mobile-enabled .ctx-scroll { min-width: 100vw; }
  body.mobile-enabled .p-sidebar { width: 120px; flex-shrink: 0; }
  body.mobile-enabled .p-list { width: 160px; flex-shrink: 0; }
  body.mobile-enabled .panel { min-width: 100vw; }
  body.mobile-enabled #panel-prompts { flex-direction: row !important; min-width: calc(120px + 160px + 300px); }
}

.mobile-toggle {
  display: flex; align-items: center; gap: 6px; margin-left: 10px;
}
.mobile-toggle label { font-size: 8px; color: #50483a; }
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:#2a2118;border-radius:2px}

/* ─── LAYOUT ─────────────────────────────────────── */
#app{height:100vh;display:flex;flex-direction:column;overflow:auto;background:var(--bg)}

#app-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:0 20px;height:50px;
  border-bottom:1px solid var(--border);
  background:#0b0a08;flex-shrink:0;
  font-size:17px;
  position: relative;
}
.brand{display:flex;align-items:baseline;gap:10px}
.brand-logo{height:24px;vertical-align:middle;border-radius:3px}
.brand-title{font-family:'Playfair Display',serif;font-size:17px;font-weight:700;color:#e0d3bc;letter-spacing:.02em}
.brand-ver{font-family:'JetBrains Mono',monospace;font-size:9px;color:#3a3020;letter-spacing:.1em}

.tab-nav{display:flex;gap:2px}
.tab-btn{
  padding:5px 14px;background:transparent;border:1px solid transparent;
  color:#50483a;font-family:'JetBrains Mono',monospace;font-size:9px;
  letter-spacing:.08em;text-transform:uppercase;cursor:pointer;
  border-radius:2px;transition:all .12s;display:flex;align-items:center;gap:5px;
}
.tab-btn:hover{color:#a09070;border-color:#2a2118}
.tab-btn.active{color:#c8a660;border-color:#3a3020;background:#141109}
.tab-dot{width:5px;height:5px;border-radius:50%;background:#c8a660;opacity:.7}

#app-main{flex:1;overflow:hidden;position:relative;background:var(--bg2)}
.panel{position:absolute;inset:0;overflow:hidden;display:none;background:var(--bg)}
.panel.active{display:flex;flex-direction:column}
#panel-settings{overflow-y:auto}

/* ─── CONTEXT TABS (series/book/chapter) ─────────── */
.ctx-scroll{flex:1;overflow-y:auto;padding:20px 24px}
.ctx-head{margin-bottom:20px;padding-bottom:14px;border-bottom:1px solid #181510}
.ctx-head h2{font-family:'Playfair Display',serif;font-size:22px;font-style:italic;color:#e0d3bc;margin-bottom:3px}
.ctx-head p{font-size:13px;color:#50483a;font-style:italic}
.home-section{margin-bottom:28px}
.home-section h3{font-family:'Playfair Display',serif;font-size:16px;color:#c8a660;margin-bottom:12px;border-bottom:1px solid #252015;padding-bottom:6px}
.home-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
.home-card{background:#0f0d0a;border:1px solid #1e1a12;border-radius:4px;padding:14px;transition:border-color .15s,background .15s}
.home-card:hover{background:#12100a;border-color:#3a3020}
.home-card h4{font-family:'JetBrains Mono',monospace;font-size:11px;color:#e0d3bc;margin:8px 0 6px;text-transform:uppercase;letter-spacing:.05em}
.home-card p{font-size:12px;color:#706858;line-height:1.5;margin:0}
.home-icon{font-size:20px;color:#c8a660}
.home-modes{font-size:12px;color:#a89868;margin-bottom:6px;display:flex;align-items:center;gap:8px}
.mode-badge{padding:2px 8px;border-radius:3px;font-family:'JetBrains Mono',monospace;font-size:9px;text-transform:uppercase;margin-right:4px}
.mode-badge.full{background:#121a10;color:#80b07a;border:1px solid #263422}
.mode-badge.brief{background:#101520;color:#7a9ec0;border:1px solid #222636}
.mode-badge.extended{background:#201510;color:#c8a060;border:1px solid #3d2a1a}
.mode-badge.custom{background:#1a1520;color:#a080c0;border:1px solid #352a3d}
.mode-badge.off{background:#150f0f;color:#705858;border:1px solid #2a1f1f}
/* Ko-fi widget positioning */
@keyframes kofifix{from{left:auto;right:20px} to{left:auto;right:20px}}
.ko-fi-widget-container,.kf-bottom-left,.floating-chat,.kofiwidgetOverlay{right:20px !important;left:auto !important;animation:kofifix 1s}
.kofi-btn{display:inline-block;padding:10px 20px;background:#c8a660;color:#1a1510;font-family:'JetBrains Mono',monospace;font-size:12px;text-decoration:none;border-radius:4px;transition:background .2s}
.kofi-btn:hover{background:#d4b574}

/* meta row */
.meta-row{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap}
.meta-field{display:flex;flex-direction:column;gap:4px;flex:1;min-width:140px}
.meta-field.narrow{max-width:80px;flex:0 0 auto}
.mlabel{font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:.12em;text-transform:uppercase;color:#40382a}
.help-icon{display:inline-block;width:14px;height:14px;border-radius:50%;background:#1a1510;border:1px solid #40382a;color:#6a5a4a;font-size:9px;font-family:'JetBrains Mono',monospace;text-align:center;line-height:12px;cursor:help;margin-left:4px;vertical-align:middle}
.help-icon:hover{background:#252015;color:#c8a660}
.tooltip{position:fixed;background:#1a1510;border:1px solid #c8a660;color:#e0d3bc;padding:8px 12px;border-radius:4px;font-size:11px;max-width:250px;z-index:10000;box-shadow:0 4px 12px rgba(0,0,0,0.5);font-family:'Crimson Pro',serif;line-height:1.4}
.tooltip-close{position:absolute;top:4px;right:6px;background:none;border:none;color:#6a5a4a;cursor:pointer;font-size:12px}
input.minput,select.minput{
  background:#0d0b08;border:1px solid #1e1a12;border-radius:2px;
  color:#b8a878;font-family:'Crimson Pro',serif;font-size:14px;
  padding:5px 9px;outline:none;transition:border-color .12s;width:100%;
}
input.minput:focus,select.minput:focus{border-color:#4a4028;background:#0f0d0a}
input.minput::placeholder{color:#252015}
select.minput option{background:#0d0b08;color:#b8a878}

/* section block */
.sb{margin-bottom:14px;border:1px solid var(--border);border-radius:3px;overflow:hidden;transition:border-color .15s}
.sb:focus-within{border-color:#252015}
.sb-head{
  display:flex;align-items:center;justify-content:space-between;
  padding:7px 11px;background:#0e0b09;border-bottom:1px solid #181510;
  flex-wrap:wrap;gap:7px;
}
.sb-info{display:flex;flex-direction:column;gap:2px;min-width:0}
.sb-title{font-family:'Crimson Pro',serif;font-size:13px;font-weight:600;color:#b8a878}
.sb-desc{font-size:11px;color:#40382a;font-style:italic}
.sb-ctrls{display:flex;align-items:center;gap:5px;flex-shrink:0}

/* inclusion toggle */
.itog{display:flex;border:1px solid #1e1a12;border-radius:2px;overflow:hidden}
.ibtn{
  padding:2px 7px;background:transparent;border:none;border-right:1px solid #1e1a12;
  color:#3a3020;font-family:'JetBrains Mono',monospace;font-size:8px;
  letter-spacing:.05em;cursor:pointer;transition:all .12s;
}
.ibtn:last-child{border-right:none}
.ibtn:hover{color:#7a6848;background:#141109}
.ibtn.i-full.on{background:#121a10;color:#80b07a}
.ibtn.i-brief.on{background:#101520;color:#7a9ec0}
.ibtn.i-extended.on{background:#201510;color:#c8a060}
.ibtn.i-custom.on{background:#102030;color:#60a0c8}
.ibtn.i-off.on{background:#1a1010;color:#b06060}

.smbtn{
  padding:2px 8px;background:#111009;border:1px solid #252015;border-radius:2px;
  color:#60584a;font-family:'JetBrains Mono',monospace;font-size:8px;
  letter-spacing:.05em;cursor:pointer;transition:all .12s;white-space:nowrap;
}
.smbtn:hover{color:#c8a660;border-color:#4a3a18}
.smbtn:disabled{opacity:.3;cursor:not-allowed}

.sb-ta{
  width:100%;background:#0b0908;border:none;color:#a89868;
  font-family:'Crimson Pro',serif;font-size:14px;line-height:1.7;
  padding:9px 11px;resize:vertical;outline:none;min-height:90px;
}
.sb-ta::placeholder{color:#201c10}
.sb-ta:focus{background:#0d0b08}

/* list management */
.list-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.list-lbl{font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:.12em;text-transform:uppercase;color:#3a3020}
.add-btn{
  padding:2px 9px;background:transparent;border:1px dashed #252015;border-radius:2px;
  color:#4a4030;font-family:'JetBrains Mono',monospace;font-size:8px;
  cursor:pointer;transition:all .12s;letter-spacing:.06em;
}
.add-btn:hover{border-color:#c8a660;color:#c8a660}
.list-item{position:relative;margin-bottom:8px}
.rm-btn{
  position:absolute;top:7px;right:7px;width:17px;height:17px;
  background:#180f0f;border:1px solid #2a1818;border-radius:2px;
  color:#604040;font-size:10px;cursor:pointer;display:flex;
  align-items:center;justify-content:center;z-index:1;transition:all .12s;
}
.rm-btn:hover{background:#241414;color:#d06060}

/* chapter mode toggle */
.mtog{display:flex;border:1px solid #1e1a12;border-radius:2px;overflow:hidden;margin-bottom:14px}
.mbtn{
  flex:1;padding:6px 12px;background:transparent;border:none;border-right:1px solid #1e1a12;
  color:#3a3020;font-family:'JetBrains Mono',monospace;font-size:9px;
  letter-spacing:.08em;text-transform:uppercase;cursor:pointer;transition:all .12s;
}
.mbtn:last-child{border-right:none}
.mbtn.mon{background:#141109;color:#c8a660}

/* export bar */
.export-bar{
  margin-top:8px;padding:9px 13px;background:#0b0908;border:1px solid #181510;
  border-radius:3px;display:flex;align-items:center;justify-content:space-between;gap:10px;
}
.export-lbl{font-family:'JetBrains Mono',monospace;font-size:9px;color:#4a4030;letter-spacing:.06em}
.export-btn{
  padding:4px 13px;background:#181610;border:1px solid #3a3018;border-radius:2px;
  color:#c8a660;font-family:'JetBrains Mono',monospace;font-size:9px;
  cursor:pointer;transition:all .12s;letter-spacing:.05em;
}
.export-btn:hover{background:#201e12;border-color:#c8a660}
.divider{border:none;border-top:1px solid #181510;margin:16px 0}

/* ─── PROMPTS PANEL ───────────────────────────────── */
#panel-prompts{flex-direction:row !important}

.p-sidebar{width:180px;flex-shrink:0;border-right:1px solid var(--border);overflow-y:auto;padding:10px 0;background:var(--bg2)}
.p-sidebar-lbl{font-family:'JetBrains Mono',monospace;font-size:7px;letter-spacing:.14em;text-transform:uppercase;color:#302818;padding:4px 13px 7px}
.p-sidebar-sec{font-family:'JetBrains Mono',monospace;font-size:6px;letter-spacing:.16em;text-transform:uppercase;color:#4a3a20;padding:12px 13px 4px;border-top:1px solid #181510;margin-top:4px}
.pcatbtn{
  width:100%;padding:6px 13px;background:transparent;border:none;
  border-left:2px solid transparent;cursor:pointer;display:flex;align-items:center;
  gap:7px;font-family:'Crimson Pro',serif;font-size:13px;color:#60584a;
  text-align:left;transition:all .12s;
}
.pcatbtn:hover{color:#a89868;background:#0f0d09}
.pcatbtn.pca{color:#e0d3bc;background:#0f0d09;border-left-color:var(--cc)}
.pci{font-size:12px;color:var(--cc);opacity:.7;flex-shrink:0}
.pcatbtn.pca .pci{opacity:1}

.p-list{width:230px;flex-shrink:0;border-right:1px solid var(--border);overflow-y:auto;padding:10px 0;background:var(--bg2)}
.p-list-hd{padding:4px 11px 11px;border-bottom:1px solid #181510;margin-bottom:5px}
.p-list-bar{height:1px;background:var(--cc);opacity:.45;margin-bottom:7px}
.p-list-name{font-family:'Playfair Display',serif;font-size:14px;color:#e0d3bc;display:flex;align-items:center;gap:6px}
.p-list-cnt{font-family:'JetBrains Mono',monospace;font-size:8px;color:#302818;margin-top:2px;letter-spacing:.06em}
.pcrd{
  margin:3px 7px;padding:7px 9px;background:transparent;border:1px solid transparent;
  border-radius:3px;cursor:pointer;text-align:left;transition:all .12s;width:calc(100% - 14px);
}
.pcrd:hover{background:#0f0d09;border-color:#1e1910}
.pcrd.pcra{background:#120f08;border-color:var(--cc)}
.pcrd-t{font-family:'Crimson Pro',serif;font-size:13px;font-weight:600;color:#a89868;margin-bottom:2px}
.pcra .pcrd-t{color:#e0d3bc}
.pcrd-d{font-size:11px;color:#40382a;font-style:italic;line-height:1.4}

/* prompt editor */
.p-editor{flex:1;display:flex;flex-direction:column;overflow:hidden}
.p-empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;color:#281e14}
.p-empty h3{font-family:'Playfair Display',serif;font-size:17px;font-style:italic}
.p-empty p{font-size:12px;color:#201810}

.p-ehd{padding:13px 18px 11px;border-bottom:1px solid #181510;flex-shrink:0}
.p-etit{font-family:'Playfair Display',serif;font-size:17px;color:#e0d3bc;margin-bottom:3px}
.p-edesc{font-size:12px;color:#50483a;font-style:italic}

.p-ebody{flex:1;overflow-y:auto;padding:14px 18px;display:flex;flex-direction:column;gap:11px;min-height:0}
.pfl{display:flex;flex-direction:column;gap:4px}
.pfl label{font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:.1em;text-transform:uppercase;color:#50483a}
.pfl input,.pfl textarea{
  background:#0a0907;border:1px solid #1a1810;border-radius:2px;
  color:#a89868;font-family:'Crimson Pro',serif;font-size:14px;
  padding:6px 9px;outline:none;transition:border-color .12s;resize:vertical;width:100%;
}
.pfl input:focus,.pfl textarea:focus{border-color:#3a3018;background:#0c0a08}
.pfl input::placeholder,.pfl textarea::placeholder{color:#201c10}
.pfl textarea{min-height:85px;line-height:1.65}

/* context bar */
.ctx-bar{
  flex-shrink:0;padding:5px 18px;background:#0c0a08;border-top:1px solid #181510;
  display:flex;align-items:center;gap:7px;flex-wrap:wrap;
}
.ctx-bar-lbl{font-family:'JetBrains Mono',monospace;font-size:8px;color:#3a3020;letter-spacing:.08em;text-transform:uppercase;flex-shrink:0}
.ctx-pills{display:flex;gap:3px;flex-wrap:wrap;align-items:center}
.cpill{
  padding:1px 6px;border-radius:9px;font-family:'JetBrains Mono',monospace;
  font-size:7px;letter-spacing:.06em;border:1px solid;
}
.cpill.cfull{border-color:#263422;color:#7aac74;background:#0f180d}
.ctx-none{font-family:'JetBrains Mono',monospace;font-size:8px;color:#281e14;font-style:italic}

/* output area */
.out-area{
  flex-shrink:0;border-top:1px solid #181510;background:#070605;
  display:flex;flex-direction:column;max-height:45vh;min-height:120px;
}
.out-toolbar{
  display:flex;align-items:center;justify-content:space-between;
  padding:6px 18px;border-bottom:1px solid #141209;flex-shrink:0;
  gap:8px;flex-wrap:wrap;
}
.out-status{
  font-family:'JetBrains Mono',monospace;font-size:8px;color:#3a3020;
  letter-spacing:.08em;text-transform:uppercase;display:flex;align-items:center;gap:6px;
}
.spin{
  display:inline-block;width:8px;height:8px;border:1px solid #3a3020;
  border-top-color:#c8a660;border-radius:50%;animation:spin .6s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
.out-btns{display:flex;gap:5px}
.run-btn{
  padding:4px 14px;background:#c8a660;color:#090807;border:none;border-radius:2px;
  font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:500;
  cursor:pointer;letter-spacing:.05em;transition:all .12s;
}
.run-btn:hover{background:#dbb870}
.run-btn:disabled{background:#2a2418;color:#504830;cursor:not-allowed}
.run-btn.running{background:#8a6a30;color:#e0d3bc}
.stop-btn{
  padding:4px 10px;background:#2a1010;border:1px solid #4a2020;border-radius:2px;
  color:#c06050;font-family:'JetBrains Mono',monospace;font-size:9px;
  cursor:pointer;transition:all .12s;letter-spacing:.05em;
}
.stop-btn:hover{background:#381818;border-color:#c06050}
.sec-btn{
  padding:4px 10px;background:#141209;border:1px solid #252015;border-radius:2px;
  color:#60584a;font-family:'JetBrains Mono',monospace;font-size:9px;
  cursor:pointer;transition:all .12s;letter-spacing:.05em;
}
.sec-btn:hover{color:#c8a660;border-color:#4a3a18}
.sec-btn.ok{border-color:#263422;color:#7aac74;background:#0f180d}

.out-text{
  flex:1;overflow-y:auto;padding:10px 18px;
  font-family:'Crimson Pro',serif;font-size:14px;color:#80786a;
  line-height:1.75;white-space:pre-wrap;word-break:break-word;
}
.out-placeholder{font-style:italic;color:#281e14;font-size:13px}
.cursor-blink{display:inline-block;width:2px;height:1em;background:#c8a660;animation:blink .8s ease-in-out infinite;vertical-align:text-bottom;margin-left:1px}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}

/* ─── PIPELINE PANEL ──────────────────────────────── */
#panel-pipeline{flex-direction:column !important}

.pipe-layout{flex:1;display:flex;overflow:hidden;gap:0}
.pipe-builder{width:420px;flex-shrink:0;border-right:1px solid var(--border);overflow-y:auto;padding:16px;background:var(--bg2)}
.pipe-results{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:0;background:var(--bg)}

.pipe-hd{margin-bottom:14px}
.pipe-hd h2{font-family:'Playfair Display',serif;font-size:18px;font-style:italic;color:#e0d3bc;margin-bottom:3px}
.pipe-hd p{font-size:12px;color:#50483a;font-style:italic}

/* pipeline mode toggle */
.pipe-mode{display:flex;border:1px solid #1e1a12;border-radius:2px;overflow:hidden;margin-bottom:14px}
.pm-btn{
  flex:1;padding:6px;background:transparent;border:none;border-right:1px solid #1e1a12;
  color:#3a3020;font-family:'JetBrains Mono',monospace;font-size:8px;
  letter-spacing:.07em;text-transform:uppercase;cursor:pointer;transition:all .12s;
  display:flex;flex-direction:column;align-items:center;gap:2px;
}
.pm-btn:last-child{border-right:none}
.pm-btn.pmon{background:#141109;color:#c8a660}
.pm-btn span:last-child{font-size:7px;opacity:.6;font-style:italic;letter-spacing:.04em}

/* pipeline step */
.pipe-step{
  margin-bottom:10px;border:1px solid #1e1a12;border-radius:3px;
  overflow:hidden;background:#0b0908;
}
.pipe-step-hd{
  display:flex;align-items:center;padding:7px 10px;background:#0f0d09;
  border-bottom:1px solid #1a1710;gap:8px;
}
.step-num{
  width:22px;height:22px;border-radius:50%;border:1px solid #3a3020;
  background:#181410;color:#c8a660;font-family:'JetBrains Mono',monospace;
  font-size:9px;display:flex;align-items:center;justify-content:center;flex-shrink:0;
}
.step-selects{display:flex;gap:6px;flex:1;min-width:0}
.step-sel{
  background:#0a0907;border:1px solid #1a1810;border-radius:2px;
  color:#a89868;font-family:'Crimson Pro',serif;font-size:12px;
  padding:3px 6px;outline:none;flex:1;min-width:0;
  transition:border-color .12s;
}
.step-sel:focus{border-color:#3a3018}
.step-sel option{background:#0a0907;color:#a89868}
.step-rm{
  width:20px;height:20px;background:#180f0f;border:1px solid #2a1818;border-radius:2px;
  color:#604040;font-size:11px;cursor:pointer;display:flex;align-items:center;
  justify-content:center;flex-shrink:0;transition:all .12s;
}
.step-rm:hover{background:#241414;color:#d06060}

.step-body{padding:9px 10px;display:flex;flex-direction:column;gap:7px}
.pipe-tog{
  display:flex;align-items:center;gap:6px;padding:5px 8px;
  background:#111009;border:1px solid #1a1710;border-radius:2px;
}
.pipe-tog label{font-family:'JetBrains Mono',monospace;font-size:8px;color:#60584a;letter-spacing:.06em;cursor:pointer;flex:1}
.pipe-tog input[type=checkbox]{accent-color:#c8a660;cursor:pointer}
.step-field{display:flex;flex-direction:column;gap:3px}
.step-field label{font-family:'JetBrains Mono',monospace;font-size:8px;color:#40382a;letter-spacing:.08em;text-transform:uppercase}
.step-field input,.step-field textarea{
  background:#090806;border:1px solid #181510;border-radius:2px;
  color:#a89868;font-family:'Crimson Pro',serif;font-size:13px;
  padding:5px 8px;outline:none;resize:vertical;width:100%;
  transition:border-color .12s;
}
.step-field input:focus,.step-field textarea:focus{border-color:#3a3018}
.step-field input::placeholder,.step-field textarea::placeholder{color:#1c1810}
.step-field textarea{min-height:70px;line-height:1.6}
.step-piped{
  padding:5px 8px;background:#0e1208;border:1px solid #1e2618;border-radius:2px;
  font-family:'JetBrains Mono',monospace;font-size:8px;color:#7aac74;
  letter-spacing:.05em;font-style:italic;
}
.connector{
  display:flex;align-items:center;justify-content:center;padding:3px 0;
  color:#3a3020;font-size:12px;
}

/* pipe controls */
.pipe-controls{
  display:flex;gap:7px;flex-wrap:wrap;margin-bottom:14px;
  padding:10px;background:#0b0908;border:1px solid #181510;border-radius:3px;
}
.pipe-run-btn{
  flex:1;padding:7px 16px;background:#c8a660;color:#090807;border:none;border-radius:2px;
  font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:500;
  cursor:pointer;letter-spacing:.06em;transition:all .12s;min-width:120px;
}
.pipe-run-btn:hover{background:#dbb870}
.pipe-run-btn:disabled{background:#2a2418;color:#504830;cursor:not-allowed}
.pipe-run-btn.running{background:#8a6a30;color:#e0d3bc}
.pipe-clear-btn{
  padding:7px 13px;background:#141209;border:1px solid #252015;border-radius:2px;
  color:#60584a;font-family:'JetBrains Mono',monospace;font-size:9px;
  cursor:pointer;transition:all .12s;letter-spacing:.05em;
}
.pipe-clear-btn:hover{color:#c8a660;border-color:#4a3a18}
.pipe-save-btn{
  padding:7px 13px;background:#0f180d;border:1px solid #263422;border-radius:2px;
  color:#7aac74;font-family:'JetBrains Mono',monospace;font-size:9px;
  cursor:pointer;transition:all .12s;letter-spacing:.05em;
}
.pipe-save-btn:hover{border-color:#7aac74}
.pipe-save-btn:disabled{opacity:.3;cursor:not-allowed}

/* results */
.res-hd{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid #181510;
}
.res-title{font-family:'Playfair Display',serif;font-size:16px;font-style:italic;color:#e0d3bc}
.res-empty{
  flex:1;display:flex;align-items:center;justify-content:center;
  color:#281e14;font-family:'Playfair Display',serif;font-style:italic;font-size:15px;
}
.res-step{margin-bottom:16px}
.res-step-hd{
  display:flex;align-items:center;gap:8px;margin-bottom:7px;
  padding:5px 9px;background:#0b0908;border:1px solid #181510;border-radius:2px;
}
.res-step-num{
  width:18px;height:18px;border-radius:50%;border:1px solid #3a3020;
  background:#181410;color:#c8a660;font-family:'JetBrains Mono',monospace;
  font-size:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0;
}
.res-step-name{font-family:'Crimson Pro',serif;font-size:13px;font-weight:600;color:#b8a878;flex:1}
.res-step-status{
  font-family:'JetBrains Mono',monospace;font-size:8px;color:#50483a;letter-spacing:.06em;
}
.res-step-status.running{color:#c8a660}
.res-step-status.done{color:#7aac74}
.res-step-status.err{color:#c06050}
.res-step-text{
  background:#080706;border:1px solid #141209;border-radius:2px;
  padding:10px 13px;font-family:'Crimson Pro',serif;font-size:13px;color:#80786a;
  line-height:1.75;white-space:pre-wrap;word-break:break-word;
  min-height:60px;
}

/* ─── SETTINGS PANEL ──────────────────────────────── */
.settings-scroll{flex:1;overflow-y:auto;padding:24px}
.settings-section{max-width:580px}
.settings-hd{margin-bottom:20px;padding-bottom:14px;border-bottom:1px solid #181510}
.settings-hd h2{font-family:'Playfair Display',serif;font-size:22px;font-style:italic;color:#e0d3bc;margin-bottom:3px}
.settings-hd p{font-size:13px;color:#50483a;font-style:italic}

.scard{margin-bottom:18px;border:1px solid var(--border);border-radius:3px;overflow:hidden}
.scard-hd{
  padding:9px 13px;background:var(--bg3);border-bottom:1px solid var(--border);
  font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:.1em;
  text-transform:uppercase;color:var(--text5);
}
.scard-hd #lmstudio_help_hd{display:inline;margin-right:4px}
.scard-body{padding:13px}

.api-row{display:flex;gap:7px;align-items:flex-end}
.api-row .meta-field{flex:1}
.api-key-wrap{position:relative}
.api-key-wrap input{padding-right:60px;font-family:'JetBrains Mono',monospace;font-size:12px;letter-spacing:.06em}
.api-show{
  position:absolute;right:6px;top:50%;transform:translateY(-50%);
  padding:2px 7px;background:#141209;border:1px solid #252015;border-radius:2px;
  color:#60584a;font-family:'JetBrains Mono',monospace;font-size:8px;cursor:pointer;
  transition:all .12s;letter-spacing:.05em;
}
.api-show:hover{color:#c8a660;border-color:#4a3a18}
.test-btn{
  padding:6px 14px;background:#141209;border:1px solid #3a3020;border-radius:2px;
  color:#c8a660;font-family:'JetBrains Mono',monospace;font-size:9px;
  cursor:pointer;transition:all .12s;letter-spacing:.05em;white-space:nowrap;flex-shrink:0;
  margin-bottom:1px;
}
.test-btn:hover{background:#1c1a10;border-color:#c8a660}
.api-status{
  margin-top:6px;font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:.06em;
  min-height:16px;
}
.api-status.ok{color:#7aac74}
.api-status.err{color:#c06050}
.api-status.checking{color:#c8a660}
.api-note{margin-top:7px;font-size:12px;color:#40382a;line-height:1.5;font-style:italic}
.api-note a{color:#c8a660;text-decoration:none}
.api-note a:hover{text-decoration:underline}

/* model selector */
.model-grid{display:flex;flex-direction:column;gap:5px}
.model-row{
  display:flex;align-items:center;gap:8px;padding:7px 9px;
  border:1px solid #1c1912;border-radius:2px;cursor:pointer;
  transition:all .12s;background:transparent;
}
.model-row:hover{background:#0d0b08;border-color:#252015}
.model-row.msel{background:#120f08;border-color:var(--mc)}
.model-radio{
  width:12px;height:12px;border-radius:50%;border:1px solid #3a3020;
  background:#111009;flex-shrink:0;display:flex;align-items:center;justify-content:center;
  transition:all .12s;
}
.model-row.msel .model-radio{border-color:var(--mc);background:var(--mc)}
.model-radio-dot{width:5px;height:5px;border-radius:50%;background:#090807;display:none}
.model-row.msel .model-radio-dot{display:block}
.model-info{flex:1;min-width:0}
.model-name{font-family:'Crimson Pro',serif;font-size:14px;font-weight:600;color:#a89868}
.model-row.msel .model-name{color:#e0d3bc}
.model-meta{font-family:'JetBrains Mono',monospace;font-size:8px;color:#3a3020;letter-spacing:.04em;margin-top:1px}
.model-provider{
  font-family:'JetBrains Mono',monospace;font-size:8px;padding:1px 6px;
  border-radius:9px;border:1px solid;flex-shrink:0;
}

.model-section-lbl{
  font-family:'JetBrains Mono',monospace;font-size:7px;letter-spacing:.12em;
  text-transform:uppercase;color:#302818;padding:6px 0 4px;margin-top:4px;
}
.model-collapse-hd{
  display:flex;align-items:center;justify-content:space-between;cursor:pointer;
  padding:4px 0;margin-bottom:4px;
}
.model-collapse-hd:hover{color:#c8a660}
.model-collapse-icon{transition:transform .2s}
.model-collapse-hd.collapsed .model-collapse-icon{transform:rotate(-90deg)}
#model_grid.collapsed{display:none}

.clear-all-btn{
  padding:6px 14px;background:#1a1010;border:1px solid #3a2020;border-radius:2px;
  color:#b05040;font-family:'JetBrains Mono',monospace;font-size:9px;
  cursor:pointer;transition:all .12s;letter-spacing:.05em;
}
.clear-all-btn:hover{background:#221414;border-color:#b05040}

.max-tok-row{display:flex;align-items:center;gap:10px}
.tok-note{font-size:12px;color:#40382a;font-style:italic}

/* Mobile Layout */
@media (max-width: 768px) {
  body.mobile-enabled { overflow-x: auto; }
  body.mobile-enabled #app { min-width: 150vw; flex-direction: row; }
  body.mobile-enabled .ctx-scroll { min-width: 100vw; }
  body.mobile-enabled .p-sidebar { width: 100px; flex-shrink: 0; }
  body.mobile-enabled .p-list { width: 140px; flex-shrink: 0; }
  body.mobile-enabled .panel { min-width: 100vw; }
  body.mobile-enabled #panel-prompts { flex-direction: row !important; min-width: calc(100px + 140px + 300px); }
  body.mobile-enabled #panel-pipeline { min-width: 100vw; flex-direction: column; }
  body.mobile-enabled .pipe-layout { flex-direction: column; }
  body.mobile-enabled .pipe-builder { width: 100%; border-right: none; border-bottom: 1px solid #181510; }
}

.mobile-toggle { display:flex;align-items:center;gap:6px;margin-left:10px }
.mobile-toggle input[type=checkbox]{width:14px;height:14px;accent-color:#c8a660}
.mobile-toggle label{font-family:'JetBrains Mono',monospace;font-size:8px;color:#50483a;letter-spacing:.05em}

/* Writing Prefs */
.pref-section{margin-bottom:16px}
.pref-section-lbl{font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:.1em;text-transform:uppercase;color:#50483a;margin-bottom:6px}
.pref-row{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.pref-row label{flex:1;font-size:13px;color:#a89868}
.pref-row input[type=checkbox]{width:16px;height:16px;accent-color:#c8a660}
.pref-toggle{position:relative;width:36px;height:20px}
.pref-toggle input{opacity:0;width:0;height:0}
.pref-toggle-slider{position:absolute;cursor:pointer;inset:0;background:#1a1810;border:1px solid #2a2520;border-radius:10px;transition:.12s}
.pref-toggle-slider:before{content:'';position:absolute;height:14px;width:14px;left:2px;bottom:2px;background:#60584a;border-radius:50%;transition:.12s}
.pref-toggle input:checked+.pref-toggle-slider{background:#1a2810;border-color:#3a5030}
.pref-toggle input:checked+.pref-toggle-slider:before{transform:translateX(16px);background:#7aac74}
.pref-radio{display:flex;gap:8px;flex-wrap:wrap}
.pref-radio label{font-size:12px;color:#a89868;display:flex;align-items:center;gap:4px;cursor:pointer}
.pref-radio input{accent-color:#c8a660}
.pref-group{border:1px solid #1e1a12;border-radius:2px;padding:8px;margin-bottom:8px}
.pref-group-lbl{font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:.08em;color:#c8a660;margin-bottom:6px;display:flex;align-items:center;gap:6px}
.pref-sub{margin-left:16px;margin-top:4px}
.pref-sub .pref-row{margin-bottom:4px}
.pref-sub label{font-size:11px;color:#80786a}
.dnu-text{width:100%;min-height:60px;font-family:'Crimson Pro',serif;font-size:13px;background:#0a0907;border:1px solid #1a1810;border-radius:2px;color:#a89868;padding:6px;resize:vertical}

/* Genre Compare */
.genre-compare-row{display:flex;gap:8px;align-items:flex-end;margin-bottom:10px}
.genre-compare-row .meta-field{flex:1}
.gc-select{background:#0d0b08;border:1px solid #1e1a12;border-radius:2px;color:#a89868;font-family:'Crimson Pro',serif;font-size:13px;padding:5px 9px;outline:none;width:100%}
.gc-ref-text{min-height:80px;width:100%;background:#0a0907;border:1px solid #1a1810;border-radius:2px;color:#a89868;font-family:'Crimson Pro',serif;font-size:13px;padding:8px;resize:vertical}

/* Extract Section */
.extract-row{display:flex;gap:8px;flex-wrap:wrap}
.extract-btn{padding:6px 12px;background:#141209;border:1px solid #252015;border-radius:2px;color:#a89868;font-family:'JetBrains Mono',monospace;font-size:9px;cursor:pointer;transition:all .12s}
.extract-btn:hover{background:#1c1a10;border-color:#c8a660}
.extract-result{margin-top:10px;padding:10px;background:#0b0908;border:1px solid #181510;border-radius:2px;max-height:200px;overflow-y:auto}
.extract-result textarea{width:100%;min-height:100px;background:transparent;border:none;color:#a89868;font-family:'Crimson Pro',serif;font-size:12px;resize:vertical}

/* Full Chapters */
.fc-toggle{display:flex;border:1px solid #1e1a12;border-radius:2px;overflow:hidden;margin-bottom:14px}
.fc-btn{flex:1;padding:6px;background:transparent;border:none;border-right:1px solid #1e1a12;color:#3a3020;font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:.07em;text-transform:uppercase;cursor:pointer;transition:all .12s}
.fc-btn:last-child{border-right:none}
.fc-btn.fcon{background:#141109;color:#c8a660}
.fc-chapters{display:flex;flex-direction:column;gap:10px;margin-bottom:14px}
.fc-chap{flex:1;border:1px solid #181510;border-radius:3px;overflow:hidden}
.fc-chap-hd{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;background:#0e0b09;border-bottom:1px solid #181510}
.fc-chap-lbl{font-family:'JetBrains Mono',monospace;font-size:9px;color:#c8a660;letter-spacing:.06em}
.fc-chap textarea{width:100%;min-height:120px;background:#0b0908;border:none;color:#a89868;font-family:'Crimson Pro',serif;font-size:13px;padding:8px;resize:vertical}
.fc-chap textarea::placeholder{color:#252015}
.fc-warning{padding:8px 12px;background:#1a1410;border:1px solid #4a3020;border-radius:2px;color:#c8a660;font-family:'JetBrains Mono',monospace;font-size:9px;margin-bottom:14px;display:flex;align-items:center;gap:6px}
.fc-warning.hidden{display:none}

/* Pipeline Copy All */
.res-actions{display:flex;gap:5px}
.token-warning{font-family:'JetBrains Mono',monospace;font-size:8px;padding:2px 6px;border-radius:2px;margin-left:8px}
.token-warning.ok{color:#7aac74;background:#0f180d}
.token-warning.warn{color:#c8a660;background:#1a1810}
.token-warning.err{color:#c06050;background:#1a1010}

/* Bible Creation */
.bible-creation-row{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}
.bible-opt{display:flex;align-items:center;gap:6px;padding:6px 10px;background:#0d0b08;border:1px solid #1e1a12;border-radius:2px}
.bible-opt input[type=checkbox]{accent-color:#c8a660}
.bible-opt label{font-size:12px;color:#a89868;cursor:pointer}

/* Character Match */
.char-match-row{display:flex;gap:8px;align-items:center;margin-bottom:10px;padding:8px;background:#1a1410;border:1px solid #3a3020;border-radius:2px}
.char-match-row label{font-size:12px;color:#c8a660;flex:1}
.char-match-toggle{font-size:11px;color:#7aac74;cursor:pointer}

/* Pipeline Style Option */
.pipeline-style-opt{display:flex;align-items:center;gap:8px;padding:8px;background:#0d0b08;border:1px solid #1e1a12;border-radius:2px;margin-bottom:10px}
.pipeline-style-opt input[type=checkbox]{accent-color:#c8a660}
.pipeline-style-opt label{font-size:12px;color:#a89868;flex:1}
</style>
</head>
<body>
<div id="app">
  <header id="app-header">
    <div class="brand">
      <a href="NALogo.png" target="_blank"><img src="NALogo.png" class="brand-logo" alt="Logo"></a>
      <span class="brand-title">The Novelist's Atelier</span>
      <span class="brand-ver">1.0 Beta</span>

    </div>
    <nav class="tab-nav" id="tab-nav"></nav>
  </header>
  <main id="app-main">
    <div id="panel-home" class="panel"></div>
    <div id="panel-series" class="panel"></div>
    <div id="panel-book" class="panel"></div>
    <div id="panel-chapter" class="panel"></div>
    <div id="panel-prompts" class="panel"></div>
    <div id="panel-pipeline" class="panel"></div>
    <div id="panel-settings" class="panel"></div>
  </main>
</div>

<script>
'use strict';

// ═══════════════════════════════════════════════════════════
// CONSTANTS
// ═══════════════════════════════════════════════════════════

const TABS = [
  { id:'home', icon:'⌂', label:'Home' },
  { id:'series', icon:'◈', label:'Series' },
  { id:'book',   icon:'◉', label:'Book' },
  { id:'chapter',icon:'❒', label:'Chapter' },
  { id:'prompts',icon:'◆', label:'Prompts' },
  { id:'pipeline',icon:'⟹', label:'Pipeline' },
  { id:'settings',icon:'⚙', label:'Settings' },
];

const MODELS = [
  // OpenRouter (Default)
  { id:'anthropic/claude-opus-4', name:'Claude Opus 4', provider:'openrouter', ctx:'200k', color:'#c87a50' },
  { id:'anthropic/claude-sonnet-4-5', name:'Claude Sonnet 4.5', provider:'openrouter', ctx:'200k', color:'#c87a50' },
  { id:'anthropic/claude-haiku-4-5', name:'Claude Haiku 4.5', provider:'openrouter', ctx:'200k', color:'#c87a50' },
  { id:'openai/gpt-4o', name:'GPT-4o', provider:'openrouter', ctx:'128k', color:'#50a878' },
  { id:'openai/gpt-4.5-preview', name:'GPT-4.5 Preview', provider:'openrouter', ctx:'128k', color:'#50a878' },
  { id:'openai/o3-mini', name:'o3-mini', provider:'openrouter', ctx:'200k', color:'#50a878' },
  { id:'google/gemini-2.5-pro-preview', name:'Gemini 2.5 Pro', provider:'openrouter', ctx:'1M', color:'#5080c8' },
  { id:'google/gemini-2.0-flash-001', name:'Gemini 2.0 Flash', provider:'openrouter', ctx:'1M', color:'#5080c8' },
  { id:'meta-llama/llama-3.3-70b-instruct', name:'Llama 3.3 70B', provider:'openrouter', ctx:'128k', color:'#8050c8' },
  { id:'mistralai/mistral-large', name:'Mistral Large', provider:'openrouter', ctx:'128k', color:'#c85078' },
  { id:'deepseek/deepseek-r1', name:'DeepSeek R1', provider:'openrouter', ctx:'128k', color:'#50b8c8' },
  { id:'deepseek/deepseek-v3', name:'DeepSeek V3', provider:'openrouter', ctx:'128k', color:'#50b8c8' },
  { id:'x-ai/grok-2-1212', name:'Grok 2', provider:'openrouter', ctx:'32k', color:'#a0a0a0' },
  // Anthropic Direct
  { id:'claude-opus-4-20250514', name:'Claude Opus 4', provider:'anthropic', ctx:'200k', color:'#d4a574' },
  { id:'claude-sonnet-4-20250514', name:'Claude Sonnet 4', provider:'anthropic', ctx:'200k', color:'#d4a574' },
  { id:'claude-haiku-3-5-20250520', name:'Claude Haiku 3.5', provider:'anthropic', ctx:'200k', color:'#d4a574' },
  // OpenAI Direct
  { id:'gpt-4o', name:'GPT-4o', provider:'openai', ctx:'128k', color:'#10a37f' },
  { id:'gpt-4o-mini', name:'GPT-4o Mini', provider:'openai', ctx:'128k', color:'#10a37f' },
  { id:'gpt-4.5', name:'GPT-4.5', provider:'openai', ctx:'128k', color:'#10a37f' },
  // Google Direct
  { id:'gemini-2.5-pro-preview-06-05', name:'Gemini 2.5 Pro', provider:'google', ctx:'1M', color:'#4285f4' },
  { id:'gemini-2.0-flash-001', name:'Gemini 2.0 Flash', provider:'google', ctx:'1M', color:'#4285f4' },
  { id:'gemini-1.5-flash-8b', name:'Gemini 1.5 Flash 8B', provider:'google', ctx:'1M', color:'#4285f4' },
  { id:'gemini-1.5-flash', name:'Gemini 1.5 Flash', provider:'google', ctx:'1M', color:'#4285f4' },
  { id:'gemini-1.5-pro', name:'Gemini 1.5 Pro', provider:'google', ctx:'2M', color:'#4285f4' },
  // LM Studio (Local)
  { id:'local', name:'Load model in LM Studio, then click Test', provider:'lmstudio', ctx:'varies', color:'#888888' },
];

const CATEGORIES = [
  { id:'character',   label:'Character',        icon:'◑', color:'#e07070' },
  { id:'world',       label:'World Building',  icon:'◒', color:'#70b0e0' },
  { id:'location',    label:'Locations',        icon:'◓', color:'#70c0a0' },
  { id:'developmental',label:'Developmental',    icon:'◉', color:'#8fbc8b' },
  { id:'copy',        label:'Copy Editor',      icon:'◎', color:'#87afc7' },
  { id:'line',        label:'Line Editor',      icon:'◐', color:'#c987c7' },
  { id:'punch',       label:'Impact & Punch',   icon:'◆', color:'#e0b870' },
  { id:'paragraph',   label:'Paragraph',        icon:'¶', color:'#d8a098' },
  { id:'sentence',    label:'Sentence',         icon:'—', color:'#98c8d8' },
  { id:'chapter',     label:'Chapter Review',   icon:'❒', color:'#a098d8' },
  { id:'style',       label:'Style Analysis',   icon:'◈', color:'#c9a96e' },
];

const CATEGORY_SECTIONS = [
  { id:'create', label:'Create', cats:['character','world','location'] },
  { id:'editors', label:'Editors', cats:['developmental','copy','line'] },
  { id:'improve', label:'Improve', cats:['punch','paragraph','sentence'] },
  { id:'polish', label:'Polish', cats:['chapter','style'] },
];

const GENRE_PRESETS = {
  'fantasy': 'High fantasy with magic systems, world-building focus, epic scope',
  'sci-fi': 'Science fiction with technology focus, futuristic settings',
  'thriller': 'Fast-paced, high stakes, tension-driven narrative',
  'romance': 'Relationship-focused, emotional stakes, character-driven',
  'horror': 'Atmospheric, fear, psychological tension',
  'literary': 'Literary fiction with prose style, thematic depth',
  'mystery': 'Puzzle-driven, clues and red herrings, detective POV',
  'adventure': 'Action-driven, external stakes, fast plot',
  'custom': 'Custom reference text'
};

const WRITING_PREFS_DEFAULT = {
  pov: 'mixed',
  innerMonologue: false,
  punctuation: true,
  avoidEmDashes: true,
  avoidSemicolons: true,
  avoidColons: true,
  avoidTriplet: true,
  avoidGoldenSunset: true,
  avoidInspirationalPivot: true,
  avoidShowDontSummarize: true,
  avoidFavoriteWords: true,
  avoidFloweryProse: true,
  avoidAdjectiveOverload: true,
  varySentenceStructure: true,
  filterWords: true,
  snappyDialogue: true,
  specificOverGeneric: true,
  doNotUseWords: ''
};

// ═══════════════════════════════════════════════════════════
// PROMPT DATA
// ═══════════════════════════════════════════════════════════
// Each prompt: { id, title, desc, fields:[{key,label,type}], tpl(fields)=>string }
// type: 'text' | 'textarea'
// The first 'textarea' field is the "primary" field used for pipeline piping

const PROMPTS = {
style:[
{id:'s1',title:'Capture My Writing DNA',desc:'Deep analysis of your unique voice and style fingerprint',
 fields:[{key:'sample',label:'Paste 3–5 pages of your best writing',type:'textarea'}],
 tpl:(f)=>`You are a literary analyst specializing in author voice. Analyze the following writing sample and produce a comprehensive "Style DNA" document.

Cover:
- Sentence structure patterns (average length, variation, rhythm)
- Vocabulary tier and register (literary, colloquial, technical mix)
- Dialogue style (how characters speak, tags, beats)
- POV handling and narrative distance
- Pacing signature (scene vs. summary ratio)
- Emotional tone and how you convey interiority
- Recurring stylistic tics (good and ones to watch)
- 3–5 "rules" that seem to govern the prose instinctively

End with a one-paragraph "author voice statement" to use as a north star.

WRITING SAMPLE:
---
${f.sample||'[PASTE YOUR WRITING SAMPLE HERE]'}
---`},
{id:'s2',title:'Consistency Check Against My Style',desc:'Flag passages that drift from your established voice',
 fields:[{key:'style_doc',label:'Your Style DNA document',type:'textarea'},{key:'new_text',label:'New text to check',type:'textarea'}],
 tpl:(f)=>`You are a line editor protecting an author's voice. Using the Style DNA below, analyze the new text and flag any passages that drift from the established voice.

For each flag:
- Quote the offending phrase/sentence
- Explain what rule or pattern it breaks
- Suggest a corrected version in the author's voice

STYLE DNA:
---
${f.style_doc||'[PASTE STYLE DNA]'}
---
NEW TEXT:
---
${f.new_text||'[PASTE NEW TEXT]'}
---`},
],
developmental:[
{id:'d1',title:'Chapter Structure Audit',desc:'Big-picture analysis of a chapter\'s structural integrity',
 fields:[{key:'synopsis',label:'Story context / where we are in the novel',type:'text'},{key:'chapter',label:'Paste the chapter (or leave empty to use Chapter tab)',type:'textarea'}],
 tpl:(f)=>{
   const chapterText = f.chapter?.trim() || getFullChapterText() || '[PASTE CHAPTER]';
   return `You are a world-class developmental editor. Read this chapter and provide a structural audit.

Analyze:
1. **Scene Goals** — Does every scene have a clear goal, conflict, and outcome?
2. **Pacing** — Where does momentum stall? Where does it rush?
3. **Stakes** — Are the stakes clear and felt? Do they escalate?
4. **Character Agency** — Are characters driving the plot or being dragged?
5. **Promise & Payoff** — What does this chapter promise? Does it deliver?
6. **Structural Issues** — Plot holes, logic gaps, continuity problems?
7. **Chapter Arc** — Does the chapter have its own satisfying micro-arc?

End with: Top 3 Priority Fixes ranked by impact.

STORY CONTEXT: ${f.synopsis||'[CONTEXT]'}
CHAPTER:
---
${chapterText}
---`;}},
{id:'d2',title:'Pacing Analysis',desc:'Scene-by-scene pacing map with recommendations',
 fields:[{key:'text',label:'Paste the text (or leave empty to use Chapter tab)',type:'textarea'}],
 tpl:(f)=>{
   const text = f.text?.trim() || getFullChapterText() || '[PASTE TEXT]';
   return `You are a developmental editor specializing in narrative pacing. Create a pacing map of this text.

For each distinct scene or section:
- Label it (Scene 1, Scene 2, etc.)
- Assign a pace rating: Crawl / Walk / Jog / Run / Sprint
- One sentence on what drives or kills momentum here
- Flag any pace whiplash (jarring transitions between speeds)

Then provide:
- Overall pacing assessment
- The 2–3 most critical pacing interventions
- Specific suggestions for slow sections
- Specific suggestions for rushed sections

TEXT:
---
${text}
---`;}},
{id:'d3',title:'Character Arc Tracker',desc:'Track emotional and behavioral change across a section',
 fields:[{key:'character',label:'Character name',type:'text'},{key:'arc_goal',label:'Intended arc in this section (optional)',type:'text'},{key:'text',label:'Paste the text (or leave empty to use Chapter tab)',type:'textarea'}],
 tpl:(f)=>{
   const text = f.text?.trim() || getFullChapterText() || '[PASTE TEXT]';
   return `You are a developmental editor analyzing character arc. Track ${f.character||'[CHARACTER]'}'s internal journey through this text.

Map:
- Their emotional state at the START
- Key moments where their internal world shifts (quote the line, explain the shift)
- Their emotional state at the END
- Whether their external actions align with their internal state
- Any moments where they act inconsistently without earned reason

Intended arc: ${f.arc_goal||'Not specified — infer from context'}

Assess: Is the arc visible and felt, or merely stated? What's the single biggest gap?

TEXT:
---
${text}
---`;}},
],
copy:[
{id:'c1',title:'Full Copy Edit Pass',desc:'Grammar, consistency, fact-checking, and correctness',
 fields:[{key:'text',label:'Paste the text (or leave empty to use Chapter tab)',type:'textarea'}],
 tpl:(f)=>{
   const text = f.text?.trim() || getFullChapterText() || '[PASTE TEXT]';
   return `You are a meticulous copy editor. Perform a full copy edit pass.

Flag and correct:
1. Grammar & Syntax — errors, unintentional fragments, run-ons
2. Punctuation — commas, em-dashes, ellipses, dialogue punctuation
3. Spelling — typos, homophones, name consistency
4. Continuity — character names, physical descriptions, timeline logic
5. Word Repetition — same word used too close together
6. Tense Consistency — any unintended tense shifts
7. POV Consistency — head-hopping or POV violations

Format: numbered list. For each: Quote original → corrected version → one-line explanation.
Preserve intentional style choices (fragments for effect, unconventional punctuation for voice).

TEXT:
---
${text}
---`;}},
{id:'c2',title:'Dialogue Mechanics Check',desc:'Audit all dialogue tags, beats, and punctuation',
 fields:[{key:'text',label:'Paste the text (or leave empty to use Chapter tab)',type:'textarea'}],
 tpl:(f)=>{
   const text = f.text?.trim() || getFullChapterText() || '[PASTE TEXT]';
   return `You are a copy editor specializing in dialogue. Audit all dialogue in this text.

Check for:
- Incorrect dialogue punctuation (comma vs. period before/after tags)
- Overuse of "said" replacements — flag where "said" would be stronger
- Missing or unnecessary dialogue tags
- Action beats that could replace tags for better effect
- Characters speaking in ways inconsistent with their established voice
- Dialogue that sounds unnatural or on-the-nose

Present as: original → corrected format.

TEXT:
---
${text}
---`;}},
],
line:[
{id:'l1',title:'Line Edit for Clarity & Flow',desc:'Sharpen prose without changing the author\'s voice',
 fields:[{key:'text',label:'Paste the text (or leave empty to use Chapter tab)',type:'textarea'}],
 tpl:(f)=>{
   const text = f.text?.trim() || getFullChapterText() || '[PASTE TEXT]';
   return `You are a line editor. Cardinal rule: never sacrifice the author's voice for clarity.

Target:
- Sentences that are tangled or require re-reading
- Abrupt or muddy transitions
- Passive constructions that drain energy (flag — don't blindly fix)
- Vague, abstract language where concrete detail would land harder
- Filler phrases: "it was," "there were," "began to"
- Overwritten moments that undercut their own emotional impact

Present as: Original → Suggested Revision + one-line note on why. Always note if original is a valid style choice.

TEXT:
---
${text}
---`;}},
{id:'l2',title:'Show vs. Tell Audit',desc:'Find telling that should be showing, and vice versa',
 fields:[{key:'text',label:'Paste the text (or leave empty to use Chapter tab)',type:'textarea'}],
 tpl:(f)=>{
   const text = f.text?.trim() || getFullChapterText() || '[PASTE TEXT]';
   return `You are a line editor. Audit this text for show vs. tell balance.

TELLING TO FLAG Abstract emotional statements, (needs showing): character trait announcements, summarized reactions that could be dramatized.

SHOWING TO FLAG (could be told): Scenes over-dramatized when a quick summary would serve better. Not all telling is bad — flag only where it actively weakens impact.

For each flag: Quote → label (NEEDS SHOWING or OVER-SHOWN) → rewritten example.

End with: The ratio feels [too much telling / balanced / too much showing] because ___

TEXT:
---
${text}
---`;}},
{id:'l3',title:'Sensory Depth Pass',desc:'Identify where sensory detail is missing or underdeveloped',
 fields:[{key:'text',label:'Paste the text (or leave empty to use Chapter tab)',type:'textarea'}],
 tpl:(f)=>{
   const text = f.text?.trim() || getFullChapterText() || '[PASTE TEXT]';
   return `You are a line editor. Do a sensory depth pass on this text.

Map which senses are active in each scene: sight, sound, smell, touch, taste, proprioception, temperature.

For each scene or section:
- List which senses are present
- Flag which are absent or underused where they'd deepen immersion
- Identify passages that feel visually over-loaded
- Suggest 2–3 specific sensory additions (concrete, not generic) that would most elevate the scene

TEXT:
---
${text}
---`;}},
],
character:[
{id:'ch1',title:'New Character Creation',desc:'Build a fully realized character from concept',
 fields:[{key:'concept',label:'Character concept / role in story',type:'text'},{key:'genre',label:'Genre and tone',type:'text'},{key:'context',label:'Relevant story context',type:'text'}],
 tpl:(f)=>`You are a creative collaborator and character development expert.

Concept: ${f.concept||'[CHARACTER CONCEPT]'}
Genre/tone: ${f.genre||'[GENRE]'}
Context: ${f.context||'[CONTEXT]'}

Develop:
1. Core Identity — Name options, age, background, appearance (distinctive, not generic)
2. Psychology — Core wound, deepest fear, greatest desire, fatal flaw
3. Voice — How they speak (rhythm, vocabulary, verbal tics, what they never say)
4. Contradiction — The internal tension that makes them human
5. Relationships — How they relate to power, love, strangers
6. Arc Potential — What they need to learn, what they'll resist
7. Scene Presence — How they enter a room, how they behave under pressure
8. Three Revealing Details — Small, specific details that instantly characterize them

End with: One sentence capturing their essence — their through-line.`},
{id:'ch2',title:'Character Voice Workshop',desc:'Develop and test a character\'s distinct dialogue voice',
 fields:[{key:'character_desc',label:'Character description and background',type:'textarea'},{key:'scene',label:'Scene context for the dialogue',type:'text'}],
 tpl:(f)=>`You are a dialogue coach and character voice specialist.

CHARACTER:
${f.character_desc||'[CHARACTER DESCRIPTION]'}

SCENE CONTEXT: ${f.scene||'[SCENE]'}

First, define this character's Voice Rules:
- Sentence length tendency (clipped? flowing? interrupted?)
- Vocabulary level and register
- What they use instead of saying things directly
- What topics they deflect from and how
- Their emotional tell (how does stress/joy/anger show in speech?)
- 3 phrases they'd use; 3 phrases they'd NEVER use

Then write 8–10 lines of sample dialogue across different emotional registers: neutral, defensive, excited, lying, grieving.

Finally: write the same scene beat twice — once in their voice, once "generic" — to show the contrast.`},
{id:'ch3',title:'Character Consistency Audit',desc:'Check if a character\'s behavior is consistent and motivated',
 fields:[{key:'character',label:'Character name',type:'text'},{key:'profile',label:'Brief character profile / known traits',type:'textarea'},{key:'text',label:'Text to audit',type:'textarea'}],
 tpl:(f)=>`You are a developmental editor checking character consistency.

CHARACTER: ${f.character||'[CHARACTER]'}
PROFILE: ${f.profile||'[PROFILE]'}

Flag:
- Any action, decision, or reaction inconsistent with established character
- Dialogue that sounds like a different character or authorial voice
- Moments where the character is too conveniently helpful/obstructive
- Emotional reactions that aren't earned or set up
- Inconsistency in stated beliefs vs. behavior

For each flag: quote it, explain the inconsistency, suggest a fix.

TEXT:
---
${f.text||'[PASTE TEXT]'}
---`},
],
world:[
{id:'w1',title:'World Building Bible Entry',desc:'Create a structured reference entry for any world element',
 fields:[{key:'element',label:'Element to document (magic system, government, etc.)',type:'text'},{key:'what_i_know',label:'What you already know about it',type:'textarea'},{key:'genre',label:'Genre / tone',type:'text'}],
 tpl:(f)=>`You are a world-building consultant.

ELEMENT: ${f.element||'[ELEMENT]'}
GENRE/TONE: ${f.genre||'[GENRE]'}
WHAT I KNOW SO FAR:
${f.what_i_know||'[YOUR NOTES]'}

Develop into a full World Bible entry:
1. Core Concept — One clear sentence definition
2. Rules & Logic — Internal laws (consistent, exploitable, with costs)
3. History & Origin — How it came to be, key turning points
4. Current State — How it exists in the world now
5. Factions & Perspectives — How different groups relate to this element
6. Sensory Reality — What it looks, sounds, smells, feels like
7. Story Potential — 5 conflict seeds this element could generate
8. Consistency Traps — Questions to answer to avoid plot holes

Flag any logical contradictions in what I've provided.`},
{id:'w2',title:'World Consistency Check',desc:'Audit a passage for world-building errors',
 fields:[{key:'world_rules',label:'Relevant world rules / bible notes',type:'textarea'},{key:'text',label:'Passage to check',type:'textarea'}],
 tpl:(f)=>`You are a continuity editor specializing in world-building. Check this passage against the established world rules.

WORLD RULES:
---
${f.world_rules||'[PASTE WORLD RULES]'}
---

Check for:
- Violations of established world rules
- Technology, magic, or social structures used inconsistently
- Anachronistic language or concepts for this world
- Details that contradict earlier established facts
- Missed opportunities to reinforce world-building organically

Present as: Issue → Quote → Explanation → Suggested Fix

TEXT:
---
${f.text||'[PASTE TEXT]'}
---`},
],
location:[
{id:'loc1',title:'Location Deep Build',desc:'Develop a location into a vivid, story-ready setting',
 fields:[{key:'location',label:'Location name and basic concept',type:'text'},{key:'role',label:'Its narrative role',type:'text'},{key:'genre',label:'Genre / tone',type:'text'}],
 tpl:(f)=>`You are a setting development specialist.

LOCATION: ${f.location||'[LOCATION]'}
NARRATIVE ROLE: ${f.role||'[ROLE]'}
GENRE/TONE: ${f.genre||'[GENRE]'}

Develop:
1. Establishing Shot — One paragraph introduction as a reader would first encounter it
2. Sensory Atlas — Dominant impressions across all senses, time-of-day variations
3. History Embedded in Space — What does this place carry from its past?
4. Living Ecosystem — What lives here? What rhythms govern it?
5. Emotional Register — What mood does it impose on characters?
6. Scene Potential — 4 different scene types this location enables
7. Symbolic Resonance — What could this place mean thematically?
8. 3 Unique Details — Specific, unusual details no other location would have

End with: A single image that captures the essence of this place.`},
{id:'loc2',title:'Location Scene Enhancement',desc:'Deepen an existing location scene for atmosphere and immersion',
 fields:[{key:'text',label:'Paste the location scene',type:'textarea'}],
 tpl:(f)=>`You are a line editor specializing in setting and atmosphere.

Assess:
1. Is the setting earning its place on the page, or is it wallpaper?
2. What sensory channels are underused?
3. Does the setting reflect or contrast the POV character's emotional state?
4. Are there missed opportunities for the setting to do story work?
5. Is there any over-description slowing the scene?

Then: Provide a rewritten version of the most underdeveloped descriptive passage, showing how to deepen it without adding length.

TEXT:
---
${f.text||'[PASTE TEXT]'}
---`},
],
punch:[
{id:'p1',title:'Impact Rewrite — Multiple Options',desc:'Get 4 punchy rewrites of any passage',
 fields:[{key:'text',label:'Paste the passage to punch up',type:'textarea'},{key:'goal',label:'What should this passage DO emotionally? (optional)',type:'text'}],
 tpl:(f)=>`You are a master prose stylist. Rewrite this passage 4 times, each time using a different technique to maximize impact.

ORIGINAL:
---
${f.text||'[PASTE PASSAGE]'}
---
Emotional goal: ${f.goal||'Infer from context'}

REWRITE 1 — Compression: Strip it to its most essential form. Every word earns its place.
REWRITE 2 — Rhythm: Deliberate sentence-length variation for emotional punch. Short sentences land blows.
REWRITE 3 — Concrete Detail: Replace abstractions with specific, physical, visceral detail.
REWRITE 4 — Subtext: Pull back. Let the emotion live beneath the surface. Trust the reader.

After each rewrite: one sentence on what you sacrificed and what you gained.
Then: Which approach best serves this moment and why?`},
{id:'p2',title:'Opening Line Workshop',desc:'Generate and critique multiple opening line options',
 fields:[{key:'chapter_summary',label:'What this chapter/scene is about',type:'text'},{key:'current_opening',label:'Your current opening line (optional)',type:'text'},{key:'tone',label:'Desired tone',type:'text'}],
 tpl:(f)=>`You are a master of first lines.

WHAT THIS CHAPTER IS ABOUT: ${f.chapter_summary||'[SUMMARY]'}
DESIRED TONE: ${f.tone||'[TONE]'}
CURRENT OPENING: ${f.current_opening||'None yet'}

Generate 8 different opening lines, each using a different technique:
1. In medias res — action already happening
2. Disorientation — reader doesn't yet know where they are
3. Voice-first — pure character voice
4. Sensory ambush — lead with a striking sense impression
5. Paradox or contradiction — something that doesn't add up
6. The ordinary made strange
7. The last line of the previous scene as echo
8. Pure momentum — the first domino that starts everything falling

For each: one sentence on what it promises the reader.
Then: If forced to pick one, it would be ___ because ___.`},
{id:'p3',title:'Closing Line Workshop',desc:'Craft a chapter-ending line with maximum resonance',
 fields:[{key:'chapter_summary',label:'What happened in this chapter',type:'text'},{key:'what_comes_next',label:'What\'s coming next (briefly)',type:'text'},{key:'current_closing',label:'Your current closing line (optional)',type:'text'}],
 tpl:(f)=>`You are a prose stylist specializing in chapter endings.

WHAT HAPPENED: ${f.chapter_summary||'[SUMMARY]'}
WHAT\'S COMING: ${f.what_comes_next||'[NEXT]'}
CURRENT CLOSING: ${f.current_closing||'None yet'}

Generate 6 closing line options:
1. The gut-punch — an image or fact that lands like a blow
2. The quiet devastation — understated, the weight arrives after
3. The question — leaves the reader unable to stop thinking
4. The reframe — changes how the reader sees everything before it
5. The echo — callbacks a word or image from the chapter's opening
6. The door — ends mid-motion, pure momentum into the next chapter

For each: what emotion it leaves behind.
Then: My recommendation for this chapter's emotional needs is ___ because ___.`},
],
chapter:[
{id:'cr0',title:'Overused Phrases & Words',desc:'Find repetitive or clichéd language and suggest alternatives',
 fields:[{key:'context',label:'Novel context / character names / setting notes',type:'text'},{key:'chapter',label:'Paste the chapter (or leave empty to use Chapter tab)',type:'textarea'}],
 tpl:(f)=>{
   const chapterText = f.chapter?.trim() || getFullChapterText() || '[PASTE CHAPTER]';
   return `You are a prose editor specializing in eliminating overused, repetitive, and clichéd language.

NOVEL CONTEXT: ${f.context||'[CONTEXT]'}

Scan the following chapter for:
1. **Repeated words** — Words used too frequently (especially adjectives, adverbs, verbs)
2. **Clichés** — Overused phrases and expressions
3. **Filter words** — "He saw", "She heard", "He felt", "She noticed" etc.
4. **Weak constructions** — "There was", "It was", "He was", "She had"
5. **Redundancies** — Words or phrases that say the same thing twice
6. **Said-isms** — Overuse of "said" or weak dialogue tags
7. ** Telling instead of Showing** — Instances where showing would be stronger

For each issue found, provide:
- The problematic phrase (quoted exactly)
- The line number or location
- Why it's problematic
- A suggested replacement (or "cut" if it can be removed)

Finally, provide a revised version of the first 500 words with your corrections applied.

CHAPTER:
---
${chapterText}
---`;}},
{id:'cr1a',title:'Pronoun Usage Analysis',desc:'Check pronoun density and sentence-start pronouns',
 fields:[{key:'context',label:'Main POV character name(s)',type:'text'},{key:'chapter',label:'Paste the chapter (or leave empty to use Chapter tab)',type:'textarea'}],
 tpl:(f)=>{
   const chapterText = f.chapter?.trim() || getFullChapterText() || '[PASTE CHAPTER]';
   return `You are a prose editor specializing in varied, strong sentence construction.

Analyze the following chapter for pronoun usage patterns. The goal is to keep total pronoun usage under 15% and sentences starting with pronouns under 30%.

TARGETS:
- Total pronoun usage: under 15% of all words
- Sentence-start pronouns: under 30% of all sentences

Calculate and report:
1. **Total word count** and **total pronoun count**
2. **Pronoun density percentage** (pronouns ÷ total words × 100)
3. **Total sentences** and **sentences starting with pronouns**
4. **Initial pronoun percentage** (sentence-start pronouns ÷ total sentences × 100)

For each category, note if it passes or fails the target.

If OVER the targets, identify the specific problem sentences and provide revised versions with:
- Stronger sentence openers (action verbs, sensory details, setting, subject presence)
- Name substitutions where appropriate
- Varied sentence structures

Also identify any sentences that could be combined or restructured for better flow.

CHAPTER:
---
${chapterText}
---`;}},
{id:'cr1',title:'Full Chapter Review',desc:'Comprehensive editorial read covering all dimensions',
 fields:[{key:'context',label:'Where are we in the novel? Stakes, what just happened',type:'text'},{key:'chapter',label:'Paste the chapter (or leave empty to use Chapter tab)',type:'textarea'}],
 tpl:(f)=>{
   const chapterText = f.chapter?.trim() || getFullChapterText() || '[PASTE CHAPTER]';
   return `You are a senior editor at a major literary publishing house. Full editorial read.

NOVEL CONTEXT: ${f.context||'[CONTEXT]'}

**THE CHAPTER IN ONE SENTENCE** — What actually happens here (not what was intended, what's on the page).

**WHAT'S WORKING** — Specific. Quote the lines or moments that are genuinely excellent.

**THE CORE ISSUE** — If there's one structural or thematic problem, name it clearly.

**SCENE BY SCENE** — Walk through each scene: Goal / Conflict / Outcome. Flag scenes that don't change anything.

**CHARACTER** — Is everyone acting like themselves? Any character doing something for plot convenience?

**PACING** — Where does it breathe well? Where does it stall or rush?

**PROSE** — Flag the 3 weakest prose moments and the 3 strongest. Be specific.

**READER EXPERIENCE** — What will the reader feel at the end? Is that what the novel needs?

**3 PRIORITY ACTIONS** — If you could only change three things, in order of impact?

CHAPTER:
---
${chapterText}
---`;}},
],
paragraph:[
{id:'par1',title:'Paragraph Dissection',desc:'Sentence-level analysis and improvement of a single paragraph',
 fields:[{key:'para',label:'Paste the paragraph',type:'textarea'}],
 tpl:(f)=>`You are a line editor. Dissect this paragraph at the sentence level.

For each sentence:
- Assess its function (advance action, reveal character, set mood, provide information?)
- Rate effectiveness: Strong / Adequate / Weak
- If Weak: explain why and provide a rewrite

Assess the paragraph as a whole:
- Does it have a clear through-line?
- Is the rhythm varied and intentional?
- Does it earn its length?
- What is the single most impactful change?

Finally: Provide a polished rewrite incorporating your best suggestions (keep the author's voice).

PARAGRAPH:
---
${f.para||'[PASTE PARAGRAPH]'}
---`},
{id:'par2',title:'Transition Repair',desc:'Fix a jarring or unclear transition between paragraphs or scenes',
 fields:[{key:'before',label:'Paragraph/section BEFORE the transition',type:'textarea'},{key:'after',label:'Paragraph/section AFTER the transition',type:'textarea'}],
 tpl:(f)=>`You are a line editor specializing in flow and transitions. The transition between these sections isn't working. Diagnose and offer solutions.

Diagnose:
- What is the logical/emotional gap between these sections?
- Is this a tonal shift, a time jump, a POV distance change, a pace change?
- What's currently bridging them (if anything)?
- Why isn't it working?

Then provide 3 different transition options:
1. A bridging sentence or short paragraph
2. A structural fix (scene break, section break, different ending)
3. A rewrite of one or both endings/openings to create natural flow

BEFORE:
---
${f.before||'[PASTE FIRST SECTION]'}
---
AFTER:
---
${f.after||'[PASTE SECOND SECTION]'}
---`},
],
sentence:[
{id:'sen1',title:'Sentence Surgery — 5 Options',desc:'Get five distinct rewrites of any sentence',
 fields:[{key:'sentence',label:'The sentence to rewrite',type:'textarea'},{key:'context',label:'Surrounding context (1–2 sentences before/after)',type:'textarea'},{key:'issue',label:'What\'s wrong with it? (optional)',type:'text'}],
 tpl:(f)=>`You are a prose stylist. Rewrite this sentence 5 times, each version solving a different problem or pursuing a different strength.

ORIGINAL: ${f.sentence||'[PASTE SENTENCE]'}
CONTEXT: ${f.context||'[SURROUNDING CONTEXT]'}
KNOWN ISSUE: ${f.issue||'Diagnose yourself'}

VERSION 1 — Tighter: Cut every unnecessary word. Minimum viable sentence.
VERSION 2 — Punchier rhythm: Reorder for a stronger landing. End on the word with most weight.
VERSION 3 — More concrete: Replace abstractions or vague verbs with specific, physical language.
VERSION 4 — More voice: Push the character or narrator's voice harder. Make it more "theirs."
VERSION 5 — Syntactic experiment: Try a completely different sentence structure (fragment, inversion, list, etc.)

For each: one phrase explaining what changed and why it works.`},
{id:'sen2',title:'Verb Audit',desc:'Replace weak or passive verbs with muscular, specific alternatives',
 fields:[{key:'text',label:'Paste the text',type:'textarea'}],
 tpl:(f)=>`You are a line editor. Do a verb audit on this text.

Flag every instance of:
- "To be" constructions that could be cut or made active
- Vague motion verbs: went, came, moved, got — replace with specific action
- "Began to" / "started to" constructions — usually just cut them
- Passive voice (flag it, don't automatically fix — sometimes it's right)
- Verbs propped up by adverbs — find one strong verb instead

For each flag: Original → Suggested Verb(s) → one-word reason.
Then: A rewritten version of the 3 weakest sentences with upgraded verbs.

TEXT:
---
${f.text||'[PASTE TEXT]'}
---`},
],
};

// ═══════════════════════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════════════════════

function mkSec(text='',inclusion='full'){return{text,inclusion}}
function mkId(){return Date.now().toString(36)+Math.random().toString(36).slice(2)}

const APP = {
  tab: localStorage.getItem('na_tab') || 'series',
  theme: localStorage.getItem('na_theme') || 'default',
  uiScale: parseFloat(localStorage.getItem('na_uiscale')) || 1.5,
  headerScale: parseFloat(localStorage.getItem('na_hscale')) || 1,
  provider: localStorage.getItem('na_provider') || 'openrouter',
  apiKeys: {
    openrouter: localStorage.getItem('na_key') || '',
    anthropic: localStorage.getItem('na_anthropic_key') || '',
    openai: localStorage.getItem('na_openai_key') || '',
    google: localStorage.getItem('na_google_key') || '',
    lmstudio: localStorage.getItem('na_lmstudio_key') || ''
  },
  lmstudioUrl: localStorage.getItem('na_lmstudio_url') || 'http://localhost:1234',
  get apiKey() { return this.apiKeys[this.provider] || ''; },
  model: localStorage.getItem('na_model') || 'anthropic/claude-sonnet-4-5',
  maxTokens: parseInt(localStorage.getItem('na_maxtok')||'4000'),
  writingPrefs: JSON.parse(localStorage.getItem('na_writing_prefs')||'null') || {...WRITING_PREFS_DEFAULT},
  genreCompare: JSON.parse(localStorage.getItem('na_genre')||'null') || { preset: 'fantasy', customText: '' },
  series: { name:'', subName:'', bible: mkSec() },
  book: { title:'', bookNum:'', totalBooks:'', subNum:'', totalSub:'', bible:mkSec(), outline:mkSec(), chars:[{id:mkId(),...mkSec()}] },
  chapter: { mode:'chapter', chapterNum:'', sceneNum:'', useFullChapters:true, fullChapters:[], breakdown:mkSec(), settings:[{id:mkId(),...mkSec()}] },
  prompts: { cat: localStorage.getItem('na_prompts_cat') || 'character', promptId:null, fields:{}, output:'', running:false, abortCtrl:null },
  pipeline: { mode:'refine', steps:[], running:false, results:[], abortCtrl:null, useWritingStyle: false },
};

// Apply UI scale and mobile
document.documentElement.style.setProperty('--ui-scale', APP.uiScale);
if(APP.headerScale && APP.headerScale !== 1){
  const h = document.getElementById('app-header');
  h.style.transform = 'scale(' + APP.headerScale + ')';
  h.style.transformOrigin = 'left center';
  h.style.height = (50 * APP.headerScale) + 'px';
  h.style.whiteSpace = 'nowrap';
}
if(APP.theme && APP.theme !== 'default') document.body.classList.add('theme-' + APP.theme);

// Load saved state
try {
  const saved = JSON.parse(localStorage.getItem('na_state')||'null');
  if(saved){
    if(saved.series) APP.series = {...APP.series,...saved.series};
    if(saved.book) APP.book = {...APP.book,...saved.book};
    if(saved.chapter) APP.chapter = {...APP.chapter,...saved.chapter};
  }
} catch(e){}

// Debounced save
let saveTimer = null;
function saveState(){
  clearTimeout(saveTimer);
  saveTimer = setTimeout(()=>{
    localStorage.setItem('na_state', JSON.stringify({series:APP.series,book:APP.book,chapter:APP.chapter}));
  },400);
}

// ═══════════════════════════════════════════════════════════
// WRITING PREFERENCES HELPERS
// ═══════════════════════════════════════════════════════════

function buildWritingPrefsInstructions(){
  const p = APP.writingPrefs;
  const rules = [];
  if(p.pov === 'first') rules.push('Write in first person perspective.');
  else if(p.pov === 'third') rules.push('Write in third person perspective.');
  else rules.push('Use a mix of first and third person as appropriate.');
  if(p.innerMonologue) rules.push('Assume text in italics represents inner monologue/thoughts.');
  if(p.punctuation){
    if(p.avoidEmDashes) rules.push('DO NOT use em-dashes (—). Use commas, parentheses, or rewrite instead.');
    if(p.avoidSemicolons) rules.push('DO NOT use semicolons. Use periods or commas instead.');
    if(p.avoidColons) rules.push('DO NOT use colons except in dialogue or when grammatically required.');
  }
  if(p.avoidTriplet) rules.push('DO NOT use triplet framing (e.g., "Fast, cheap, and out of control").');
  if(p.avoidGoldenSunset) rules.push('AVOID the "Golden Sunset" Syndrome: Over-describing scenery to set a mood.');
  if(p.avoidInspirationalPivot) rules.push('DO NOT use "Inspirational Pivot" framing (e.g., "This isn\'t just about X, it\'s about humanity"). Avoid "It\'s less about X and more about Y" constructions.');
  if(p.avoidShowDontSummarize) rules.push('AVOID "AI bookending": Do not start with sweeping atmospheric descriptions or end with profound life lessons.');
  if(p.avoidFavoriteWords) rules.push('Avoid repetitive word choices. Vary vocabulary.');
  if(p.avoidFloweryProse) rules.push('AVOID flowery prose, purple prose, and clichéd metaphors.');
  if(p.avoidAdjectiveOverload) rules.push('AVOID adjective overload: Do not use three adjectives where one strong verb would do.');
  if(p.varySentenceStructure) rules.push('VARY sentence structure: Mix short punchy fragments with longer flowing thoughts.');
  if(p.filterWords) rules.push('Use the "Ugly" Rule: Avoid filter words (e.g., "She saw the bird fly" → "The bird flew").');
  if(p.snappyDialogue) rules.push('Keep dialogue SNAPPY and INDIRECT: Use subtext and interruptions.');
  if(p.specificOverGeneric) rules.push('PREFER SPECIFIC over GENERIC: Instead of "he felt sad," describe the specific physical sensation.');
  if(p.doNotUseWords && p.doNotUseWords.trim()){
    const words = p.doNotUseWords.split(',').map(w => w.trim()).filter(w => w);
    if(words.length) rules.push(`DO NOT use these words: ${words.join(', ')}`);
  }
  if(rules.length === 0) return '';
  return '\n\n══════════════════════════════════════════════════════\nWRITING PREFERENCES (Strict Rules):\n' + rules.map(r => '• ' + r).join('\n') + '\n══════════════════════════════════════════════════════\n\n';
}

function buildGenreCompareInstructions(){
  const g = APP.genreCompare;
  if(g.preset === 'custom' && g.customText?.trim()){
    return '\n\n══════════════════════════════════════════════════════\nREFERENCE STYLE (compare to this):\n' + g.customText + '\n══════════════════════════════════════════════════════\n\n';
  }
  if(g.preset !== 'custom' && GENRE_PRESETS[g.preset]){
    return '\n\n══════════════════════════════════════════════════════\nGENRE CONTEXT: ' + g.preset.toUpperCase() + '\n' + GENRE_PRESETS[g.preset] + '\n══════════════════════════════════════════════════════\n\n';
  }
  return '';
}

function saveWritingPrefs(){
  localStorage.setItem('na_writing_prefs', JSON.stringify(APP.writingPrefs));
}

// ═══════════════════════════════════════════════════════════
// CONTEXT BUILDER
// ═══════════════════════════════════════════════════════════

function buildContext(){
  const parts=[];
  const extract=(inc,text,maxW=450, customWords=500)=>{
    if(inc==='off'||!text?.trim()) return null;
    if(inc==='brief'){
      const w=text.trim().split(/\s+/);
      return w.length>maxW?w.slice(0,maxW).join(' ')+'\n\n*[— truncated: brief mode —]*':text.trim();
    }
    if(inc==='extended'){
      const w=text.trim().split(/\s+/);
      return w.length>1000?w.slice(0,1000).join(' ')+'\n\n*[— truncated: extended (1000 words) —]*':text.trim();
    }
    if(inc==='custom'){
      const w=text.trim().split(/\s+/);
      return w.length>customWords?w.slice(0,customWords).join(' ')+`\n\n*[— truncated: custom (${customWords} words) —]*`:text.trim();
    }
    return text.trim();
  };
  // Series
  const sl=[];
  if(APP.series.name) sl.push(`**Series:** ${APP.series.name}`);
  if(APP.series.subName) sl.push(`**Sub-series:** ${APP.series.subName}`);
  const sb=extract(APP.series.bible.inclusion,APP.series.bible.text,450,APP.series.bible.customWords||500);
  if(sb) sl.push(`\n**Series Bible:**\n${sb}`);
  if(sl.length) parts.push(`## ◈ Series / Project\n\n${sl.join('\n')}`);
  // Book
  const bl=[];
  if(APP.book.title){
    let pos=`"${APP.book.title}"`;
    if(APP.book.bookNum&&APP.book.totalBooks) pos+=` — Book ${APP.book.bookNum} of ${APP.book.totalBooks}`;
    if(APP.book.subNum&&APP.book.totalSub) pos+=` (${APP.book.subNum} of ${APP.book.totalSub} in sub-series)`;
    bl.push(`**Book:** ${pos}`);
  }
  const bb=extract(APP.book.bible.inclusion,APP.book.bible.text,450,APP.book.bible.customWords||500);
  if(bb) bl.push(`\n**Book Bible:**\n${bb}`);
  const bo=extract(APP.book.outline.inclusion,APP.book.outline.text,450,APP.book.outline.customWords||500);
  if(bo) bl.push(`\n**Book Outline:**\n${bo}`);
  if(bl.length) parts.push(`## ◉ Book\n\n${bl.join('\n')}`);
  // Characters
  const ac=APP.book.chars.filter(c=>c.inclusion!=='off'&&c.text?.trim());
  if(ac.length){
    const cb=ac.map(c=>extract(c.inclusion,c.text,300,c.customWords||500)).filter(Boolean);
    if(cb.length) parts.push(`## ◑ Characters\n\n${cb.join('\n\n────────\n\n')}`);
  }
  // Full chapters
  const fc = APP.chapter.fullChapters.filter(c => c.text?.trim());
  const useFull = APP.chapter.useFullChapters && fc.length > 0;
  
  // Chapter
  const chl=[];
  if(APP.chapter.chapterNum){
    const lbl=APP.chapter.mode==='scene'&&APP.chapter.sceneNum
      ?`Chapter ${APP.chapter.chapterNum}, Scene ${APP.chapter.sceneNum}`
      :`Chapter ${APP.chapter.chapterNum}`;
    chl.push(`**Current location in manuscript:** ${lbl}`);
  }
  
  if(useFull){
    const isSceneLevel = APP.chapter.mode === 'scene';
    const chapterLabels = [];
    for(let i = 0; i < fc.length; i++){
      const c = fc[i];
      let label = c.label || (isSceneLevel ? `Chapter ${c.number || i+1} - Scene ${c.sceneNumber || ''}` : `Chapter ${c.number || i+1}`);
      chapterLabels.push(`\n### ${label}\n\n${c.text.trim()}`);
    }
    if(chapterLabels.length) chl.push(`\n**Full ${isSceneLevel ? 'Scenes' : 'Chapters'}:**\n${chapterLabels.join('\n\n')}`);
  } else {
    const breakdowns = APP.chapter.breakdowns?.filter(b => b.text?.trim()) || [];
    if(breakdowns.length > 0){
      const sorted = [...breakdowns].sort((a, b) => {
        const order = {prologue: 0, chapter: 1, epilogue: 2};
        const orderA = order[a.type] ?? 1;
        const orderB = order[b.type] ?? 1;
        if(orderA !== orderB) return orderA - orderB;
        return (a.number || 0) - (b.number || 0);
      });
      const bdTexts = sorted.map(b => {
        const typeLabel = b.type === 'prologue' ? 'Prologue' : b.type === 'epilogue' ? 'Epilogue' : `Chapter ${b.number || ''}`;
        return `### ${typeLabel}\n\n${b.text.trim()}`;
      });
      chl.push(`\n**Chapter Breakdowns:**\n${bdTexts.join('\n\n────────\n\n')}`);
    }
  }
  const as_=APP.chapter.settings.filter(s=>s.inclusion!=='off'&&s.text?.trim());
  if(as_.length){
    const sb2=as_.map(s=>extract(s.inclusion,s.text,200,s.customWords||500)).filter(Boolean);
    if(sb2.length) chl.push(`\n**Settings:**\n${sb2.join('\n\n────────\n\n')}`);
  }
  if(chl.length) parts.push(`## ❒ Chapter / Scene\n\n${chl.join('\n')}`);
  if(!parts.length) return '';
  return '# MANUSCRIPT CONTEXT\n\n_Use the following author-provided context to inform all editorial feedback. Preserve the established voice, world logic, character psychology, and narrative continuity._\n\n'
    +parts.join('\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n')
    +'\n\n══════════════════════════════════════════════════════\n\n';
}

function getContextPills(){
  const p=[];
  if(APP.series.bible.inclusion!=='off'&&APP.series.bible.text?.trim()) p.push({label:'Series Bible',mode:APP.series.bible.inclusion});
  if(APP.book.title) p.push({label:`"${APP.book.title.slice(0,20)}"`,mode:'full'});
  if(APP.book.bible.inclusion!=='off'&&APP.book.bible.text?.trim()) p.push({label:'Book Bible',mode:APP.book.bible.inclusion});
  if(APP.book.outline.inclusion!=='off'&&APP.book.outline.text?.trim()) p.push({label:'Outline',mode:APP.book.outline.inclusion});
  const ac=APP.book.chars.filter(c=>c.inclusion!=='off'&&c.text?.trim());
  if(ac.length) p.push({label:`${ac.length} Char${ac.length>1?'s':''}`,mode:ac[0].inclusion});
  
  if(APP.chapter.useFullChapters && APP.chapter.fullChapters.length > 0){
    const fc = APP.chapter.fullChapters.filter(c => c.text?.trim());
    if(fc.length) p.push({label:`${fc.length} Full ${APP.chapter.mode === 'scene' ? 'Scene' : 'Chapter'}${fc.length>1?'s':''}`,mode:'full'});
  } else {
    const breakdowns = APP.chapter.breakdowns?.filter(b => b.text?.trim()) || [];
    if(breakdowns.length > 0){
      const sorted = [...breakdowns].sort((a, b) => {
        const order = {prologue: 0, chapter: 1, epilogue: 2};
        const orderA = order[a.type] ?? 1;
        const orderB = order[b.type] ?? 1;
        if(orderA !== orderB) return orderA - orderB;
        return (a.number || 0) - (b.number || 0);
      });
      const first = sorted[0];
      const typeLabel = first.type === 'prologue' ? 'Prologue' : first.type === 'epilogue' ? 'Epilogue' : `Chapter ${first.number || ''}`;
      p.push({label:`Ch. ${typeLabel}`,mode:'brief'});
    }
  }
  
  const as_=APP.chapter.settings.filter(s=>s.inclusion!=='off'&&s.text?.trim());
  if(as_.length) p.push({label:`${as_.length} Setting${as_.length>1?'s':''}`,mode:as_[0].inclusion});
  return p;
}

// Helper to get full chapter text from Chapter tab
function getFullChapterText(){
  const fc = APP.chapter.fullChapters?.filter(c => c.text?.trim()) || [];
  if(fc.length === 0) return null;
  
  const isSceneLevel = APP.chapter.mode === 'scene';
  
  const sorted = [...fc].sort((a, b) => {
    const order = {prologue: 0, chapter: 1, epilogue: 2};
    const orderA = order[a.type] ?? 1;
    const orderB = order[b.type] ?? 1;
    if(orderA !== orderB) return orderA - orderB;
    if(a.number !== b.number) return (a.number || 0) - (b.number || 0);
    if(isSceneLevel) return (a.sceneNumber || 0) - (b.sceneNumber || 0);
    return 0;
  });
  
  return sorted.map(c => {
    const typeLabel = c.type === 'prologue' ? 'Prologue' : c.type === 'epilogue' ? 'Epilogue' : (isSceneLevel ? `Chapter ${c.number || ''} - Scene ${c.sceneNumber || ''}` : `Chapter ${c.number || ''}`);
    return `### ${typeLabel}\n\n${c.text.trim()}`;
  }).join('\n\n---\n\n');
}

// ═══════════════════════════════════════════════════════════
// API
// ═══════════════════════════════════════════════════════════

async function callAPI(prompt, onChunk, onDone, onError, signal){
  const provider = APP.provider;
  const apiKey = APP.apiKey;
  
  if(!apiKey){onError('No API key — add it in Settings.'); return;}
  
  const maxTokens = APP.maxTokens + (parseInt(document.getElementById('tok_boost')?.value)||0);
  
  if(provider === 'anthropic'){
    // Anthropic API
    try{
      const res = await fetch('https://api.anthropic.com/v1/messages',{
        method:'POST',
        headers:{
          'x-api-key': apiKey,
          'anthropic-version': '2023-06-01',
          'Content-Type':'application/json'
        },
        body: JSON.stringify({
          model: APP.model,
          messages:[{role:'user',content:prompt}],
          max_tokens: maxTokens,
          stream: true
        }),
        signal
      });
      if(!res.ok){
        let msg = `HTTP ${res.status}`;
        try{const j=await res.json(); msg=j.error?.message||msg;}catch(e){}
        onError(msg); const tb=document.getElementById('tok_boost'); if(tb) tb.value=0; return;
      }
      const reader=res.body.getReader();
      const dec=new TextDecoder();
      let buf='';
      while(true){
        const{done,value}=await reader.read();
        if(done) break;
        buf+=dec.decode(value,{stream:true});
        const lines=buf.split('\n');
        buf=lines.pop();
        for(const line of lines){
          if(line.startsWith('data: ')){
            const d=line.slice(6).trim();
            if(d==='[DONE]'){const tb=document.getElementById('tok_boost'); if(tb) tb.value=0;onDone();return;}
            try{
              const j=JSON.parse(d);
              if(j.type === 'content_block_delta'){
                const c = j.delta?.text;
                if(c) onChunk(c);
              }
            }catch(e){}
          }
        }
      }
      onDone();
    }catch(e){
      if(e.name==='AbortError') return;
      onError(e.message);
    }
  } else if(provider === 'google'){
    // Google Gemini API
    try{
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${APP.model}:streamGenerateContent?key=${apiKey}`;
      const res = await fetch(url,{
        method:'POST',
        headers:{
          'Content-Type':'application/json'
        },
        body: JSON.stringify({
          contents: [{ role: 'user', parts: [{ text: prompt }] }],
          generationConfig: {
            temperature: 0.9,
            maxOutputTokens: maxTokens,
            topP: 0.95,
            topK: 40
          }
        }),
        signal
      });
      if(!res.ok){
        let msg = `HTTP ${res.status}`;
        try{const j=await res.json(); msg=j.error?.message||msg;}catch(e){}
        onError(msg); const tb=document.getElementById('tok_boost'); if(tb) tb.value=0; return;
      }
      const reader=res.body.getReader();
      const dec=new TextDecoder();
      let buf='';
      while(true){
        const{done,value}=await reader.read();
        if(done) break;
        buf+=dec.decode(value,{stream:true});
        const lines=buf.split('\n');
        buf=lines.pop();
        for(const line of lines){
          if(line.startsWith('data: ')){
            const d=line.slice(6).trim();
            if(d==='[DONE]'){const tb=document.getElementById('tok_boost'); if(tb) tb.value=0;onDone();return;}
            try{
              const j=JSON.parse(d);
              if(j.candidates && j.candidates[0]?.content?.parts){
                const c = j.candidates[0].content.parts[0]?.text;
                if(c) onChunk(c);
              }
            }catch(e){}
          }
        }
      }
      onDone();
    }catch(e){
      if(e.name==='AbortError') return;
      onError(e.message);
    }
  } else if(provider === 'lmstudio'){
    // LM Studio (Local) - OpenAI compatible
    const baseUrl = APP.lmstudioUrl.replace(/\/$/, '');
    try{
      const headers = {
        'Content-Type': 'application/json'
      };
      if(apiKey){
        headers['Authorization'] = `Bearer ${apiKey}`;
      }
      const res = await fetch(`${baseUrl}/v1/chat/completions`,{
        method:'POST',
        headers,
        body: JSON.stringify({
          model: APP.model,
          messages:[{role:'user',content:prompt}],
          stream: true,
          max_tokens: maxTokens
        }),
        signal
      });
      if(!res.ok){
        let msg=`HTTP ${res.status}`;
        try{const j=await res.json(); msg=j.error?.message||msg;}catch(e){}
        onError(msg); const tb=document.getElementById('tok_boost'); if(tb) tb.value=0; return;
      }
      const reader=res.body.getReader();
      const dec=new TextDecoder();
      let buf='';
      while(true){
        const{done,value}=await reader.read();
        if(done) break;
        buf+=dec.decode(value,{stream:true});
        const lines=buf.split('\n');
        buf=lines.pop();
        for(const line of lines){
          if(line.startsWith('data: ')){
            const d=line.slice(6).trim();
            if(d==='[DONE]'){const tb=document.getElementById('tok_boost'); if(tb) tb.value=0;onDone();return;}
            try{
              const j=JSON.parse(d);
              const c=j.choices?.[0]?.delta?.content;
              if(c) onChunk(c);
            }catch(e){}
          }
        }
      }
      onDone();
    }catch(e){
      if(e.name==='AbortError') return;
      onError(e.message);
    }
  } else {
    // OpenRouter or OpenAI Direct (both use OpenAI-compatible format)
    const isOpenAI = provider === 'openai';
    const url = isOpenAI 
      ? 'https://api.openai.com/v1/chat/completions'
      : 'https://openrouter.ai/api/v1/chat/completions';
    
    const headers = {
      'Authorization': `Bearer ${apiKey}`,
      'Content-Type': 'application/json'
    };
    
    if(!isOpenAI){
      headers['HTTP-Referer'] = location.href.startsWith('file://') ? 'https://novelists-atelier.local' : location.href;
      headers['X-Title'] = "The Novelist's Atelier";
    }
    
    try{
      const res = await fetch(url,{
        method:'POST',
        headers,
        body: JSON.stringify({
          model: APP.model,
          messages:[{role:'user',content:prompt}],
          stream: true,
          max_tokens: maxTokens
        }),
        signal
      });
      if(!res.ok){
        let msg=`HTTP ${res.status}`;
        try{const j=await res.json(); msg=j.error?.message||msg;}catch(e){}
        onError(msg); const tb=document.getElementById('tok_boost'); if(tb) tb.value=0; return;
      }
      const reader=res.body.getReader();
      const dec=new TextDecoder();
      let buf='';
      while(true){
        const{done,value}=await reader.read();
        if(done) break;
        buf+=dec.decode(value,{stream:true});
        const lines=buf.split('\n');
        buf=lines.pop();
        for(const line of lines){
          if(line.startsWith('data: ')){
            const d=line.slice(6).trim();
            if(d==='[DONE]'){const tb=document.getElementById('tok_boost'); if(tb) tb.value=0;onDone();return;}
            try{
              const j=JSON.parse(d);
              const c=j.choices?.[0]?.delta?.content;
              if(c) onChunk(c);
            }catch(e){}
          }
        }
      }
      onDone();
    }catch(e){
      if(e.name==='AbortError') return;
      onError(e.message);
    }
  }
}

// ═══════════════════════════════════════════════════════════
// FILE UTILS
// ═══════════════════════════════════════════════════════════

async function readFile(file){
  if(!file) return '';
  if(file.name.endsWith('.docx')){
    try{
      const buf=await file.arrayBuffer();
      if(typeof mammoth!=='undefined'){
        const r=await mammoth.extractRawText({arrayBuffer:buf});
        return r.value;
      }
      return '[mammoth.js not loaded — try .txt or .md]';
    }catch(e){return '[Could not parse .docx]';}
  }
  return new Promise(res=>{
    const r=new FileReader();
    r.onload=e=>res(e.target.result);
    r.readAsText(file);
  });
}

function dlMd(text,fname){
  const b=new Blob([text],{type:'text/markdown;charset=utf-8'});
  const u=URL.createObjectURL(b);
  const a=document.createElement('a');
  a.href=u; a.download=fname;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a); URL.revokeObjectURL(u);
}

function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

function addHelp(parent, text){
  const icon = document.createElement('span');
  icon.className = 'help-icon';
  icon.textContent = '?';
  icon.style.cursor = 'pointer';
  icon.style.marginLeft = '4px';
  const tooltip = document.createElement('div');
  tooltip.className = 'tooltip';
  tooltip.style.display = 'none';
  tooltip.innerHTML = text + '<button class="tooltip-close">×</button>';
  document.body.appendChild(tooltip);
  icon.addEventListener('click',(e)=>{
    e.stopPropagation();
    document.querySelectorAll('.tooltip').forEach(t=>t.style.display='none');
    if(tooltip.style.display === 'none'){
      const rect = icon.getBoundingClientRect();
      tooltip.style.top = (rect.top - 10) + 'px';
      tooltip.style.left = (rect.left - 10) + 'px';
      tooltip.style.display = 'block';
    } else {
      tooltip.style.display = 'none';
    }
  });
  tooltip.querySelector('.tooltip-close').addEventListener('click',(e)=>{
    e.stopPropagation();
    tooltip.style.display = 'none';
  });
  document.addEventListener('click',()=>{
    tooltip.style.display = 'none';
  });
  parent.appendChild(icon);
}

// ═══════════════════════════════════════════════════════════
// SECTION BLOCK RENDERER (used in series/book/chapter tabs)
// ═══════════════════════════════════════════════════════════

function renderSB(containerId, stateRef, key, opts={}){
  const{title='',desc='',rows=5,exportFn=null,uploadId=mkId()}=opts;
  const val=stateRef[key];
  const customWords = val.customWords || 500;
  const el=document.getElementById(containerId);
  if(!el) return;
  el.innerHTML=`
    <div class="sb" id="sb_${containerId}">
      <div class="sb-head">
        <div class="sb-info">
          <span class="sb-title">${esc(title)}</span>
          ${desc?`<span class="sb-desc">${esc(desc)}</span>`:''}
        </div>
        <div class="sb-ctrls">
          <div class="itog">
            <button class="ibtn i-full${val.inclusion==='full'?' on':''}" data-mode="full">Full</button>
            <button class="ibtn i-brief${val.inclusion==='brief'?' on':''}" data-mode="brief">Brief</button>
            <button class="ibtn i-extended${val.inclusion==='extended'?' on':''}" data-mode="extended">Extended</button>
            <button class="ibtn i-custom${val.inclusion==='custom'?' on':''}" data-mode="custom">Custom</button>
            <button class="ibtn i-off${val.inclusion==='off'?' on':''}" data-mode="off">Off</button>
          </div>
          <span id="help_inclusion_${containerId}"></span>
          <input type="file" id="fu_${uploadId}" accept=".md,.txt,.docx" style="display:none">
          <button class="smbtn" id="upbtn_${uploadId}">↑ Upload</button>
          <button class="smbtn" id="expbtn_${containerId}" ${val.text?.trim()?'':'disabled'}>↓ .md</button>
        </div>
      </div>
      <div id="custom_words_row_${containerId}" style="display:${val.inclusion==='custom'?'flex':'none'};padding:4px 8px;background:#0f0d09;border-bottom:1px solid #181510;gap:8px;align-items:center">
        <span style="font-family:'JetBrains Mono',monospace;font-size:8px;color:#60584a">Words:</span>
        <input type="number" id="custom_words_${containerId}" value="${customWords}" min="100" max="5000" step="100" style="width:70px;background:#0a0907;border:1px solid #1e1a12;border-radius:2px;color:#a89868;font-size:12px;padding:2px 5px">
      </div>
      <textarea class="sb-ta" style="min-height:${rows*22}px" placeholder="Paste or upload ${title.toLowerCase()} here…">${esc(val.text)}</textarea>
    </div>`;

  const sbEl=el.querySelector('.sb');
  // Inclusion toggle
  el.querySelectorAll('.ibtn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      stateRef[key]={...val,inclusion:btn.dataset.mode};
      el.querySelectorAll('.ibtn').forEach(b=>b.classList.remove('on'));
      btn.classList.add('on');
      const sbOff=btn.dataset.mode==='off';
      sbEl.classList.toggle('sb-off',sbOff);
      document.getElementById(`custom_words_row_${containerId}`).style.display = btn.dataset.mode === 'custom' ? 'flex' : 'none';
      saveState();
    });
  });
  
  // Custom words input
  const cwInput = document.getElementById(`custom_words_${containerId}`);
  if(cwInput){
    cwInput.addEventListener('input',e=>{
      stateRef[key]={...stateRef[key],customWords:parseInt(e.target.value)||500};
      saveState();
    });
  }
  // Upload
  const fu=el.querySelector(`#fu_${uploadId}`);
  el.querySelector(`#upbtn_${uploadId}`).addEventListener('click',()=>fu.click());
  fu.addEventListener('change',async e=>{
    const f=e.target.files[0]; if(!f) return;
    const text=await readFile(f);
    stateRef[key]={...stateRef[key],text};
    el.querySelector('.sb-ta').value=text;
    e.target.value='';
    saveState();
    el.querySelector(`#expbtn_${containerId}`).disabled=!text.trim();
  });
  // Export
  el.querySelector(`#expbtn_${containerId}`).addEventListener('click',()=>{
    if(!val.text?.trim()) return;
    const fname=exportFn?exportFn():`${title.toLowerCase().replace(/[^a-z0-9]+/g,'-')}.md`;
    dlMd(`# ${title}\n\n${stateRef[key].text}`,fname);
  });
  // Textarea
  el.querySelector('.sb-ta').addEventListener('input',e=>{
    stateRef[key]={...stateRef[key],text:e.target.value};
    el.querySelector(`#expbtn_${containerId}`).disabled=!e.target.value.trim();
    saveState();
  });

  // Add help tooltip for inclusion modes
  const helpEl = el.querySelector(`#help_inclusion_${containerId}`);
  if(helpEl){
    addHelp(helpEl, '<b>Full:</b> Include all text in prompts<br><b>Brief:</b> Include first ~450 words<br><b>Extended:</b> Include first ~1000 words<br><b>Custom:</b> Include your word count<br><b>Off:</b> Exclude from prompts');
  }
}

// ═══════════════════════════════════════════════════════════
// PANEL: HOME
// ═══════════════════════════════════════════════════════════

function renderHome(){
  const p=document.getElementById('panel-home');
  p.innerHTML=`
    <div class="ctx-scroll" style="max-width:700px">
      <div class="ctx-head">
        <h2>Welcome to The Novelist's Atelier</h2>
        <p>Your AI-powered writing assistant for editing and world-building.</p>
      </div>

      <div class="home-section">
        <h3>Contributions</h3>
        <p style="color:#a89868;font-size:14px;margin-bottom:12px">
          Contributions like yours help me fix bugs, smooth out the syntax, and ensure The Novelist's Atelier is the best tool it can be for authors.<br><br>
          Here's to better drafts and fewer red pens!
        </p>
        <a href="https://ko-fi.com/f5alcon" target="_blank" class="kofi-btn">☕ Contribute on Ko-fi</a>
      </div>

      <div class="home-section">
        <h3>Getting Started</h3>
        <ol style="margin:0;padding-left:20px;color:#a89868;font-size:14px;line-height:1.8">
          <li>Go to <b>Settings</b> to configure your API key (or use LM Studio for local models)</li>
          <li>Add your series details in <b>Series</b> (optional but recommended)</li>
          <li>Add your book details in <b>Book</b> (optional)</li>
          <li>Add your current chapter/scene in <b>Chapter</b></li>
          <li>Use <b>Prompts</b> to generate character profiles, edit scenes, and more!</li>
        </ol>
      </div>

      <div class="home-section">
        <h3>How It Works</h3>
        <div class="home-grid">
          <div class="home-card" onclick="showTab('series')" style="cursor:pointer">
            <span class="home-icon">◈</span>
            <h4>Series</h4>
            <p>Global context for your entire series. Genre, tone, world-building, and narrative summary.</p>
          </div>
          <div class="home-card" onclick="showTab('book')" style="cursor:pointer">
            <span class="home-icon">◉</span>
            <h4>Book</h4>
            <p>Individual book details. Characters, plot outline, and book-specific bible.</p>
          </div>
          <div class="home-card" onclick="showTab('chapter')" style="cursor:pointer">
            <span class="home-icon">❒</span>
            <h4>Chapter</h4>
            <p>Current chapter/scene text. Settings and context for the scene you're working on.</p>
          </div>
          <div class="home-card" onclick="showTab('prompts')" style="cursor:pointer">
            <span class="home-icon">◆</span>
            <h4>Prompts</h4>
            <p>AI-powered editing tools. Character creation, copy editing, line editing, and more.</p>
          </div>
          <div class="home-card" onclick="showTab('pipeline')" style="cursor:pointer">
            <span class="home-icon">⟹</span>
            <h4>Pipeline</h4>
            <p>Chain multiple prompts together. Each step builds on the last for complex workflows.</p>
          </div>
          <div class="home-card" onclick="showTab('settings')" style="cursor:pointer">
            <span class="home-icon">⚙</span>
            <h4>Settings</h4>
            <p>Configure API keys, choose models, adjust generation settings, and customize themes.</p>
          </div>
        </div>
      </div>

      <div class="home-section">
        <h3>Tips</h3>
        <ul style="margin:0;padding-left:20px;color:#a89868;font-size:13px;line-height:1.7">
          <li>The more context you provide (Series → Book → Chapter), the better the AI can assist you</li>
          <li>Use "Full" for sections you want fully included in prompts</li>
          <li>Use "Brief" for long sections where you want a summary included</li>
          <li>Use Pipeline to chain multiple edits on the same text</li>
          <li>Local models via LM Studio work offline and keep your data private</li>
        </ul>
      </div>

      <div class="home-section">
        <h3>Inclusion Modes</h3>
        <p style="color:#a89868;font-size:13px;margin-bottom:10px">In Series, Book, and Chapter tabs, each section has toggle buttons:</p>
        <div class="home-modes">
          <span class="mode-badge full">Full</span> Include all text
        </div>
        <div class="home-modes">
          <span class="mode-badge brief">Brief</span> First ~450 words (summary)
        </div>
        <div class="home-modes">
          <span class="mode-badge extended">Extended</span> First ~1000 words
        </div>
        <div class="home-modes">
          <span class="mode-badge custom">Custom</span> Your word count
        </div>
        <div class="home-modes">
          <span class="mode-badge off">Off</span> Exclude from prompts
        </div>
        <p style="color:#60584a;font-size:12px;margin-top:10px">Toggle sections On/Off in the Chapter tab to control what context gets sent to the AI.</p>
      </div>

      <div class="home-section">
        <h3>AI Usage</h3>
        <p style="color:#a89868;font-size:13px;margin-bottom:10px">
          <b>The Novelist's Atelier</b> was built using AI assistance, specifically <b>Claude Sonnet 4.6</b>, <b>MiniMax M2.5</b>, and <b>OpenCode Big Pickle</b>.
        </p>
        <p style="color:#a89868;font-size:13px;margin-bottom:10px">
          For authors concerned about AI usage in their workflow, see the <b>Authors Guild</b> resources on AI best practices:
        </p>
        <ul style="margin:0;padding-left:20px;color:#a89868;font-size:13px;line-height:1.7">
          <li><a href="https://authorsguild.org/resource/ai-best-practices-for-authors/" target="_blank" style="color:#c8a660">AI Best Practices for Authors</a></li>
          <li><a href="https://authorsguild.org/advocacy/artificial-intelligence/faq/" target="_blank" style="color:#c8a660">Authors Guild AI FAQ</a></li>
        </ul>
        <p style="color:#60584a;font-size:12px;margin-top:10px">
          This tool is designed to assist authors, not replace their creative voice. All generated content should be reviewed and refined by you.
        </p>
      </div>
    </div>`;
}

// ═══════════════════════════════════════════════════════════
// PANEL: SERIES
// ═══════════════════════════════════════════════════════════

function renderSeries(){
  const p=document.getElementById('panel-series');
  p.innerHTML=`
    <div class="ctx-scroll">
      <div class="ctx-head">
        <h2>Series & Project</h2>
        <p>Global context for your entire series. These details will be available in all editing prompts.</p>
      </div>
      <div class="meta-row">
        <div class="meta-field">
          <label class="mlabel">Series Name</label>
          <input class="minput" id="s_name" value="${esc(APP.series.name)}" placeholder="e.g. The Shattered Realm">
        </div>
        <div class="meta-field">
          <label class="mlabel">Sub-series / Trilogy Name</label>
          <input class="minput" id="s_sub" value="${esc(APP.series.subName)}" placeholder="e.g. The War of Embers (trilogy)">
        </div>
      </div>
      <div style="margin-bottom:14px">
        <button class="add-btn" id="gen_series_bible" style="background:#0f180d;border-color:#263422;color:#7aac74">⚡ Generate Series Bible from Book</button>
      </div>
      <div id="sb_series_bible"></div>
    </div>`;
  p.querySelector('#s_name').addEventListener('input',e=>{APP.series.name=e.target.value;saveState();updateTabDot();});
  p.querySelector('#s_sub').addEventListener('input',e=>{APP.series.subName=e.target.value;saveState();});
  p.querySelector('#gen_series_bible')?.addEventListener('click',()=>generateSeriesBibleFromBook());
  renderSB('sb_series_bible',APP.series,'bible',{title:'Series Bible',desc:'Genre, tone, POV, narrative summary, world-building, factions, style guide',rows:14,exportFn:()=>'series-bible.md'});
  
  // Add help icons
  addHelp(p.querySelector('#s_name').parentElement, 'The overall series name (e.g., "The Shattered Realm")');
  addHelp(p.querySelector('#s_sub').parentElement, 'Sub-series or trilogy name within the larger series');
}

// ═══════════════════════════════════════════════════════════
// PANEL: BOOK
// ═══════════════════════════════════════════════════════════

function renderBook(){
  const p=document.getElementById('panel-book');
  p.innerHTML=`
    <div class="ctx-scroll">
      <div class="ctx-head">
        <h2>Book</h2>
        <p>Book-level details, bible, outline, and character profiles for this specific volume.</p>
      </div>
      <div class="meta-row">
        <div class="meta-field" style="flex:2">
          <label class="mlabel">Book Title</label>
          <input class="minput" id="b_title" value="${esc(APP.book.title)}" placeholder="e.g. Ashes of the First Tower">
        </div>
        <div class="meta-field narrow"><label class="mlabel">Book #</label><input class="minput" id="b_num" value="${esc(APP.book.bookNum)}" placeholder="2"></div>
        <div class="meta-field narrow"><label class="mlabel">Of Total</label><input class="minput" id="b_tot" value="${esc(APP.book.totalBooks)}" placeholder="10"></div>
        <div class="meta-field narrow"><label class="mlabel">Sub #</label><input class="minput" id="b_snum" value="${esc(APP.book.subNum)}" placeholder="2"></div>
        <div class="meta-field narrow"><label class="mlabel">Of Total</label><input class="minput" id="b_stot" value="${esc(APP.book.totalSub)}" placeholder="3"></div>
      </div>
      <div style="margin-bottom:14px">
        <button class="add-btn" id="gen_book_bible" style="background:#0f180d;border-color:#263422;color:#7aac74">⚡ Generate Book Bible from Chapters</button>
      </div>
      <div id="sb_book_bible"></div>
      <div id="sb_book_outline"></div>
      <hr class="divider">
      <div class="list-hd">
        <span class="list-lbl">Character Profiles (<span id="char_cnt">${APP.book.chars.length}</span>)</span>
        <button class="add-btn" id="add_char">+ Add Character File</button>
      </div>
      <div id="chars_list"></div>
    </div>`;

  ['b_title','b_num','b_tot','b_snum','b_stot'].forEach(id=>{
    const map={b_title:'title',b_num:'bookNum',b_tot:'totalBooks',b_snum:'subNum',b_stot:'totalSub'};
    p.querySelector(`#${id}`).addEventListener('input',e=>{APP.book[map[id]]=e.target.value;saveState();updateTabDot();});
  });

  const bibleKey=`book_bible_${APP.book.title||'x'}`;
  renderSB('sb_book_bible',APP.book,'bible',{title:'Book Bible',desc:'Characters, current plot state, active subplots, unresolved threads, world-building',rows:10,exportFn:()=>`book-bible.md`});
  renderSB('sb_book_outline',APP.book,'outline',{title:'Book Outline',desc:'Chapter-by-chapter outline with POV, function, and plot beats',rows:8,exportFn:()=>'book-outline.md'});

  p.querySelector('#add_char').addEventListener('click',()=>{
    APP.book.chars.push({id:mkId(),...mkSec()});
    saveState();
    renderCharsList();
  });

  p.querySelector('#gen_book_bible').addEventListener('click',()=>{
    generateBookBibleFromChapters();
  });

  // Add help icons
  addHelp(p.querySelector('#b_title').parentElement, 'The title of this specific book');
  addHelp(p.querySelector('#b_num').parentElement, 'This book\'s number in the series (e.g., Book 2)');
  addHelp(p.querySelector('#b_tot').parentElement, 'Total number of books in the series');
  addHelp(p.querySelector('#b_snum').parentElement, 'Sub-series or trilogy number (e.g., Book 3 of 3 in a trilogy)');
  addHelp(p.querySelector('#b_stot').parentElement, 'Total books in the sub-series/trilogy');

  renderCharsList();
}

function renderCharsList(){
  const list=document.getElementById('chars_list');
  if(!list) return;
  const cnt=document.getElementById('char_cnt');
  if(cnt) cnt.textContent=APP.book.chars.length;
  list.innerHTML='';
  APP.book.chars.forEach((char,i)=>{
    const wrap=document.createElement('div');
    wrap.className='list-item';
    wrap.id=`char_wrap_${char.id}`;
    if(APP.book.chars.length>1){
      const rm=document.createElement('button');
      rm.className='rm-btn'; rm.title='Remove';
      rm.innerHTML='×';
      rm.addEventListener('click',()=>{
        APP.book.chars=APP.book.chars.filter(c=>c.id!==char.id);
        saveState(); renderCharsList();
      });
      wrap.appendChild(rm);
    }
    const holder=document.createElement('div');
    holder.id=`sb_char_${char.id}`;
    wrap.appendChild(holder);
    list.appendChild(wrap);
    const charRef={data:char};
    const proxy=new Proxy({},{
      get:(_,k)=>k==='data'?char:undefined,
      set:(_,k,v)=>{if(k==='data'){const idx=APP.book.chars.findIndex(c=>c.id===char.id);if(idx>=0) APP.book.chars[idx]={...APP.book.chars[idx],...v};}return true;}
    });
    // Use a small wrapper to hook into renderSB
    const idx=i;
    const sbId=`sb_char_${char.id}`;
    // render into it
    const tmpState={val:char};
    renderSBDirect(sbId, APP.book.chars, idx, {title:`Character Profile${APP.book.chars.length>1?' '+(i+1):''}`,desc:'Name, role, goal, appearance, psychology, arc, speech style — multiple characters can be in one file',rows:7,exportFn:()=>`characters-${i+1}.md`});
  });
}

// renderSBDirect for list items (operates on array by index)
function renderSBDirect(containerId, arr, idx, opts={}){
  const{title,desc,rows=5,exportFn=null,uploadId=mkId(),allowGenerate=false,generateTitle=''}=opts;
  const val=arr[idx];
  const el=document.getElementById(containerId);
  if(!el) return;
  el.innerHTML=`
    <div class="sb">
      <div class="sb-head">
        <div class="sb-info">
          <span class="sb-title">${esc(title)}</span>
          ${desc?`<span class="sb-desc">${esc(desc)}</span>`:''}
        </div>
        <div class="sb-ctrls">
          ${allowGenerate?`<button class="smbtn" id="genbtn_${containerId}" style="margin-right:8px;color:#7aac74;border-color:#263422;background:#0f180d">✦ Generate ${generateTitle}</button>`:''}
          <div class="itog">
            <button class="ibtn i-full${val.inclusion==='full'?' on':''}" data-mode="full">On</button>
            <button class="ibtn i-off${val.inclusion==='off'?' on':''}" data-mode="off">Off</button>
          </div>
          <input type="file" id="fu_${uploadId}" accept=".md,.txt,.docx" style="display:none">
          <button class="smbtn" id="upbtn_${uploadId}">↑ Upload</button>
          <button class="smbtn" id="expbtn_${containerId}" ${val.text?.trim()?'':'disabled'}>↓ .md</button>
        </div>
      </div>
      <textarea class="sb-ta" style="min-height:${rows*22}px" placeholder="Paste or upload ${title.toLowerCase()} here…">${esc(val.text)}</textarea>
    </div>`;
  el.querySelectorAll('.ibtn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      arr[idx]={...arr[idx],inclusion:btn.dataset.mode};
      el.querySelectorAll('.ibtn').forEach(b=>b.classList.remove('on'));
      btn.classList.add('on');
      saveState();
    });
  });
  const fu=el.querySelector(`#fu_${uploadId}`);
  el.querySelector(`#upbtn_${uploadId}`).addEventListener('click',()=>fu.click());
  fu.addEventListener('change',async e=>{
    const f=e.target.files[0]; if(!f) return;
    const text=await readFile(f);
    arr[idx]={...arr[idx],text};
    el.querySelector('.sb-ta').value=text;
    e.target.value=''; saveState();
    el.querySelector(`#expbtn_${containerId}`).disabled=!text.trim();
  });
  el.querySelector(`#expbtn_${containerId}`).addEventListener('click',()=>{
    if(!arr[idx].text?.trim()) return;
    const fname=exportFn?exportFn():`${title.toLowerCase().replace(/[^a-z0-9]+/g,'-')}.md`;
    dlMd(`# ${title}\n\n${arr[idx].text}`,fname);
  });
  el.querySelector('.sb-ta').addEventListener('input',e=>{
    arr[idx]={...arr[idx],text:e.target.value};
    el.querySelector(`#expbtn_${containerId}`).disabled=!e.target.value.trim();
    saveState();
  });
  if(allowGenerate) {
    el.querySelector(`#genbtn_${containerId}`)?.addEventListener('click',()=>opts.onGenerate(idx));
  }
}

// ═══════════════════════════════════════════════════════════
// PANEL: CHAPTER
// ═══════════════════════════════════════════════════════════

function renderChapter(){
  const p=document.getElementById('panel-chapter');
  const isScene = APP.chapter.mode === 'scene';
  const isChapter = APP.chapter.mode === 'chapter';
  
  p.innerHTML=`
    <div class="ctx-scroll">
      <div class="ctx-head">
        <h2>Chapter / Scene</h2>
        <p>The current chapter or scene you're working on. This granular context is injected into editing prompts.</p>
      </div>
      <div class="mtog">
        <button class="mbtn${isChapter?' mon':''}" id="ch_mode_chapter">◈ Chapter Level</button>
        <button class="mbtn${isScene?' mon':''}" id="ch_mode_scene">◎ Scene Level</button>
      </div>
      <div class="meta-row">
        <div class="meta-field narrow"><label class="mlabel">Chapter #</label><input class="minput" id="ch_num" value="${esc(APP.chapter.chapterNum)}" placeholder="7"></div>
        <div class="meta-field narrow" id="scene_num_wrap" style="display:${isScene?'flex':'none'}">
          <label class="mlabel">Scene #</label><input class="minput" id="ch_snum" value="${esc(APP.chapter.sceneNum)}" placeholder="2">
        </div>
      </div>
      
      ${isChapter ? `
      <div class="fc-toggle" id="fc_toggle">
        <button class="fc-btn${!APP.chapter.useFullChapters?' fcon':''}" id="fc_mode_breakdown">◈ Breakdown Mode</button>
        <button class="fc-btn${APP.chapter.useFullChapters?' fcon':''}" id="fc_mode_full">◉ Full Chapters</button>
      </div>
      
      <div id="ch_breakdown_section" style="display:${APP.chapter.useFullChapters?'none':'block'}">
        <div style="margin-bottom:14px">
          <button class="add-btn" id="add_breakdown" style="background:#0f180d;border-color:#263422;color:#7aac74">+ Add Breakdown</button>
        </div>
        <div id="breakdowns_container"></div>
      </div>
      ` : ''}
      
      <div id="ch_fullchapters_section" style="display:${isScene || APP.chapter.useFullChapters?'block':'none'}">
        <div style="margin-bottom:14px">
          <button class="add-btn" id="add_full_chapter" style="background:#0f180d;border-color:#263422;color:#7aac74">${isScene ? '+ Add Scene' : '+ Add Chapter'}</button>
        </div>
        <div id="fc_chapters_container"></div>
      </div>
      
      <hr class="divider">
      <div class="list-hd">
        <span class="list-lbl">Settings (<span id="set_cnt">${APP.chapter.settings.length}</span>)</span>
        <button class="add-btn" id="add_setting">+ Add Setting</button>
      </div>
      <div id="settings_list"></div>
      <div class="export-bar">
        <span class="export-lbl">Export complete chapter package as a single .md file</span>
        <button class="export-btn" id="ch_export">↓ Export Chapter .md</button>
      </div>
    </div>`;

  // Level toggle (Chapter/Scene)
  ['chapter','scene'].forEach(m=>{
    const btn = p.querySelector(`#ch_mode_${m}`);
    if(btn){
      btn.addEventListener('click',()=>{
        APP.chapter.mode = m;
        APP.chapter.useFullChapters = true;
        p.querySelector('#ch_mode_chapter').classList.toggle('mon',m==='chapter');
        p.querySelector('#ch_mode_scene').classList.toggle('mon',m==='scene');
        const sn = p.querySelector('#scene_num_wrap');
        if(sn) sn.style.display = m==='scene' ? 'flex' : 'none';
        saveState();
        renderChapter();
      });
    }
  });

  // Breakdown/Full Chapters toggle (Chapter level only)
  const bdBtn = p.querySelector('#fc_mode_breakdown');
  if(bdBtn){
    bdBtn.addEventListener('click',()=>{
      APP.chapter.useFullChapters = false;
      p.querySelector('#fc_mode_breakdown').classList.add('fcon');
      p.querySelector('#fc_mode_full').classList.remove('fcon');
      const bd = p.querySelector('#ch_breakdown_section');
      if(bd) bd.style.display = 'block';
      const fc = p.querySelector('#ch_fullchapters_section');
      if(fc) fc.style.display = 'none';
      saveState();
      renderBreakdowns();
    });
  }
  
  const fcBtn = p.querySelector('#fc_mode_full');
  if(fcBtn){
    fcBtn.addEventListener('click',()=>{
      APP.chapter.useFullChapters = true;
      p.querySelector('#fc_mode_full').classList.add('fcon');
      p.querySelector('#fc_mode_breakdown').classList.remove('fcon');
      const bd = p.querySelector('#ch_breakdown_section');
      if(bd) bd.style.display = 'none';
      const fc = p.querySelector('#ch_fullchapters_section');
      if(fc) fc.style.display = 'block';
      saveState();
      renderFullChapters();
    });
  }

  p.querySelector('#ch_num')?.addEventListener('input',e=>{APP.chapter.chapterNum=e.target.value;saveState();});
  p.querySelector('#ch_snum')?.addEventListener('input',e=>{APP.chapter.sceneNum=e.target.value;saveState();});
  
  const addFullBtn = p.querySelector('#add_full_chapter');
  if(addFullBtn){
    addFullBtn.addEventListener('click',()=>{
      const isNowScene = APP.chapter.mode === 'scene';
      APP.chapter.fullChapters.push({
        type: 'chapter', 
        number: APP.chapter.fullChapters.length + 1, 
        sceneNumber: isNowScene ? 1 : 0, 
        label:'', 
        text:''
      });
      saveState();
      renderFullChapters();
    });
  }
  
  const addBdBtn = p.querySelector('#add_breakdown');
  if(addBdBtn){
    addBdBtn.addEventListener('click',()=>{
      APP.chapter.breakdowns = APP.chapter.breakdowns || [];
      APP.chapter.breakdowns.push({type:'chapter', number:APP.chapter.breakdowns.length + 1, text:''});
      saveState();
      renderBreakdowns();
    });
  }
  
  const addSetBtn = p.querySelector('#add_setting');
  if(addSetBtn){
    addSetBtn.addEventListener('click',()=>{
      APP.chapter.settings.push({id:mkId(),...mkSec()});
      saveState(); 
      renderSettingsList();
    });
  }
  
  const chExport = p.querySelector('#ch_export');
  if(chExport){
    chExport.addEventListener('click',exportChapter);
  }

  if(isScene || APP.chapter.useFullChapters){
    renderFullChapters();
  } else {
    renderBreakdowns();
  }
  renderSettingsList();

  // Add help icons
  addHelp(p.querySelector('#ch_mode_chapter'), 'Edit at chapter level - use for full chapters or breakdowns');
  addHelp(p.querySelector('#ch_mode_scene'), 'Edit at scene level - use for individual scenes within a chapter');
  addHelp(p.querySelector('#ch_num').parentElement, 'Current chapter number you\'re working on');
  const sceneNumWrap = p.querySelector('#scene_num_wrap');
  if(sceneNumWrap) addHelp(sceneNumWrap, 'Scene number within the chapter');
  const fcToggle = p.querySelector('#fc_toggle');
  if(fcToggle) addHelp(fcToggle, 'Breakdown = brief summary mode | Full = paste complete text');
}

function renderFullChapters(){
  const container = document.getElementById('fc_chapters_container');
  if(!container) return;
  
  const isSceneLevel = APP.chapter.mode === 'scene';
  
  const sortedChapters = [...APP.chapter.fullChapters].sort((a, b) => {
    const order = {prologue: 0, chapter: 1, epilogue: 2};
    const orderA = order[a.type] ?? 1;
    const orderB = order[b.type] ?? 1;
    if(orderA !== orderB) return orderA - orderB;
    if(a.number !== b.number) return (a.number || 0) - (b.number || 0);
    if(isSceneLevel) return (a.sceneNumber || 0) - (b.sceneNumber || 0);
    return 0;
  });
  
  container.innerHTML = '';
  
  sortedChapters.forEach((chap, idx) => {
    renderFullChapter(container, chap, idx);
  });
  
  if(APP.chapter.fullChapters.length === 0){
    container.innerHTML = '<div style="padding:20px;text-align:center;color:#50483a;font-style:italic">No chapters added yet. Click "+ Add Chapter" to begin.</div>';
  }
}

function renderFullChapter(container, val, idx){
  const div = document.createElement('div');
  div.className = 'fc-chap';
  div.dataset.idx = idx;
  
  const isSceneLevel = APP.chapter.mode === 'scene';
  const typeLabel = val.type === 'prologue' ? 'Prologue' : val.type === 'epilogue' ? 'Epilogue' : (isSceneLevel ? 'Scene' : 'Chapter');
  const displayLabel = val.type !== 'chapter' ? typeLabel : (isSceneLevel ? `Scene ${val.number || ''}.${val.sceneNumber || ''}` : `Chapter ${val.number || ''}`);
  
  const sceneNumField = isSceneLevel ? `<input type="number" class="fc-scene-num" data-field="sceneNumber" value="${val.sceneNumber || ''}" placeholder="Sc#" style="width:50px;background:#0d0b08;border:1px solid #252015;color:#a89868;font-family:'JetBrains Mono',monospace;font-size:11px;padding:3px 5px;border-radius:2px">` : '';
  
  div.innerHTML = `
    <div class="fc-chap-hd" style="display:flex;justify-content:space-between;align-items:center">
      <span class="fc-chap-lbl">${esc(displayLabel)}</span>
      <button class="rm-chap-btn" data-idx="${idx}" style="background:transparent;border:none;color:#c06050;cursor:pointer;font-size:14px">×</button>
    </div>
    <div style="display:flex;gap:8px;padding:8px;background:#0a0807;border-bottom:1px solid #181510">
      <select class="fc-type-select" data-field="type" style="background:#0d0b08;border:1px solid #252015;color:#a89868;font-family:'JetBrains Mono',monospace;font-size:10px;padding:3px 5px;border-radius:2px">
        <option value="prologue" ${val.type==='prologue'?'selected':''}>Prologue</option>
        <option value="chapter" ${val.type==='chapter'?'selected':''}>${isSceneLevel ? 'Chapter/Scene' : 'Chapter'}</option>
        <option value="epilogue" ${val.type==='epilogue'?'selected':''}>Epilogue</option>
      </select>
      <input type="number" class="fc-chap-num" data-field="number" value="${val.number || ''}" placeholder="${isSceneLevel ? 'Ch#' : '#'}" style="width:50px;background:#0d0b08;border:1px solid #252015;color:#a89868;font-family:'JetBrains Mono',monospace;font-size:11px;padding:3px 5px;border-radius:2px">
      ${sceneNumField}
    </div>
    <textarea placeholder="${isSceneLevel ? 'Paste scene text here...' : 'Paste chapter text here...'}">${esc(val.text)}</textarea>
  `;
  container.appendChild(div);
  
  div.querySelector('.rm-chap-btn')?.addEventListener('click',()=>{
    APP.chapter.fullChapters = APP.chapter.fullChapters.filter((_, i) => i !== idx);
    saveState();
    renderFullChapters();
  });
  
  div.querySelector('.fc-type-select')?.addEventListener('change',e=>{
    APP.chapter.fullChapters[idx].type = e.target.value;
    saveState();
    renderFullChapters();
  });
  
  div.querySelector('.fc-chap-num').addEventListener('input',e=>{
    APP.chapter.fullChapters[idx].number = parseInt(e.target.value) || 0;
    saveState();
    renderFullChapters();
  });
  
  div.querySelector('.fc-scene-num')?.addEventListener('input',e=>{
    APP.chapter.fullChapters[idx].sceneNumber = parseInt(e.target.value) || 0;
    saveState();
    renderFullChapters();
  });
  
  div.querySelector('textarea').addEventListener('input',e=>{
    APP.chapter.fullChapters[idx].text = e.target.value;
    saveState();
  });
}

function renderBreakdowns(){
  const container = document.getElementById('breakdowns_container');
  if(!container) return;
  
  const breakdowns = APP.chapter.breakdowns || [];
  const sorted = [...breakdowns].sort((a, b) => {
    const order = {prologue: 0, chapter: 1, epilogue: 2};
    const orderA = order[a.type] ?? 1;
    const orderB = order[b.type] ?? 1;
    if(orderA !== orderB) return orderA - orderB;
    return (a.number || 0) - (b.number || 0);
  });
  
  container.innerHTML = '';
  
  sorted.forEach((val, idx) => {
    const div = document.createElement('div');
    div.className = 'sb';
    div.style.marginBottom = '14px';
    
    const typeLabel = val.type === 'prologue' ? 'Prologue' : val.type === 'epilogue' ? 'Epilogue' : 'Chapter';
    const displayLabel = val.type !== 'chapter' ? typeLabel : `${typeLabel} ${val.number || ''}`;
    
    div.innerHTML = `
      <div class="sb-head" style="display:flex;justify-content:space-between;align-items:center">
        <span class="sb-title">${esc(displayLabel)}</span>
        <button class="rm-chap-btn" data-idx="${idx}" style="background:transparent;border:none;color:#c06050;cursor:pointer;font-size:14px">×</button>
      </div>
      <div style="display:flex;gap:8px;padding:8px;background:#0a0807;border-bottom:1px solid #181510">
        <select class="breakdown-type-select" data-field="type" style="background:#0d0b08;border:1px solid #252015;color:#a89868;font-family:'JetBrains Mono',monospace;font-size:10px;padding:3px 5px;border-radius:2px">
          <option value="prologue" ${val.type==='prologue'?'selected':''}>Prologue</option>
          <option value="chapter" ${val.type==='chapter'?'selected':''}>Chapter</option>
          <option value="epilogue" ${val.type==='epilogue'?'selected':''}>Epilogue</option>
        </select>
        <input type="number" class="breakdown-num" data-field="number" value="${val.number || ''}" placeholder="#" style="width:50px;background:#0d0b08;border:1px solid #252015;color:#a89868;font-family:'JetBrains Mono',monospace;font-size:11px;padding:3px 5px;border-radius:2px">
      </div>
      <textarea class="sb-ta" placeholder="POV, synopsis, theme, hook, conflict, resolution, reader questions, plot points, alternative versions...">${esc(val.text)}</textarea>
    `;
    container.appendChild(div);
    
    div.querySelector('.rm-chap-btn').addEventListener('click',()=>{
      APP.chapter.breakdowns = APP.chapter.breakdowns.filter((_, i) => i !== idx);
      saveState();
      renderBreakdowns();
    });
    
    div.querySelector('.breakdown-type-select').addEventListener('change',e=>{
      APP.chapter.breakdowns[idx].type = e.target.value;
      saveState();
      renderBreakdowns();
    });
    
    div.querySelector('.breakdown-num').addEventListener('input',e=>{
      APP.chapter.breakdowns[idx].number = parseInt(e.target.value) || 0;
      saveState();
      renderBreakdowns();
    });
    
    div.querySelector('.sb-ta').addEventListener('input',e=>{
      APP.chapter.breakdowns[idx].text = e.target.value;
      saveState();
    });
  });
  
  if(breakdowns.length === 0){
    container.innerHTML = '<div style="padding:20px;text-align:center;color:#50483a;font-style:italic">No breakdowns added yet. Click "+ Add Breakdown" to begin.</div>';
  }
}

function renderSettingsList(){
  const list=document.getElementById('settings_list');
  if(!list) return;
  const cnt=document.getElementById('set_cnt');
  if(cnt) cnt.textContent=APP.chapter.settings.length;
  list.innerHTML='';
  APP.chapter.settings.forEach((s,i)=>{
    const wrap=document.createElement('div');
    wrap.className='list-item';
    if(APP.chapter.settings.length>1){
      const rm=document.createElement('button');
      rm.className='rm-btn'; rm.innerHTML='×';
      rm.addEventListener('click',()=>{
        APP.chapter.settings=APP.chapter.settings.filter(x=>x.id!==s.id);
        saveState(); renderSettingsList();
      });
      wrap.appendChild(rm);
    }
    const holder=document.createElement('div');
    holder.id=`sb_setting_${s.id}`;
    wrap.appendChild(holder);
    list.appendChild(wrap);
    renderSBDirect(`sb_setting_${s.id}`,APP.chapter.settings,i,{
      title:`Setting${APP.chapter.settings.length>1?' '+(i+1):''}`,
      desc:'Name, location, role, season, unique features, sights, sounds, smells, notes',
      rows:7,exportFn:()=>`setting-${i+1}.md`,
      allowGenerate: true,
      generateTitle: 'from Chapter/Scene',
      onGenerate: (index) => generateSettingFromChapter(index)
    });
  });
}

function exportChapter(){
  const lbl=APP.chapter.mode==='scene'&&APP.chapter.sceneNum
    ?`Chapter ${APP.chapter.chapterNum} Scene ${APP.chapter.sceneNum}`
    :`Chapter ${APP.chapter.chapterNum||'X'}`;
  let md=`# ${lbl}\n\n`;
  if(APP.chapter.breakdown.text?.trim()) md+=`## Chapter Breakdown\n\n${APP.chapter.breakdown.text}\n\n`;
  APP.chapter.settings.forEach((s,i)=>{
    if(s.text?.trim()) md+=`## Setting ${i+1}\n\n${s.text}\n\n`;
  });
  const prefix=APP.book.title?APP.book.title.replace(/\s+/g,'-').toLowerCase()+'-':'';
  dlMd(md,`${prefix}${lbl.replace(/\s+/g,'-').toLowerCase()}.md`);
}

function generateSettingFromChapter(settingIdx) {
  let sourceText = "";
  
  // Extract text from Full Chapters/Scenes
  const fullChapters = APP.chapter.fullChapters?.filter(c => c.text?.trim()) || [];
  const fullText = fullChapters.map(c => c.text.trim()).join('\n\n');
  
  // Extract text from Breakdowns
  const breakdowns = APP.chapter.breakdowns?.filter(b => b.text?.trim()) || [];
  const breakdownText = breakdowns.map(b => b.text.trim()).join('\n\n');

  // Favor full chapters/scenes over breakdowns if both exist
  if (fullText) {
    sourceText = fullText;
  } else if (breakdownText) {
    sourceText = breakdownText;
  }

  if (!sourceText) {
    alert("Please add text to your Chapter or Scene first to generate a setting.");
    return;
  }

  const promptText = `Analyze the following chapter or scene text and extract all relevant details to create a detailed setting description.

Return the setting details formatted as follows:
- **Name:** [Name of the setting]
- **Location:** [Geographical or relative location]
- **Role:** [Purpose or role of the setting in the story]
- **Season/Time:** [Time of day, season, etc.]
- **Unique Features:** [Distinguishing marks or features]
- **Sights:** [Visual details]
- **Sounds:** [Auditory details]
- **Smells:** [Olfactory details]
- **Notes:** [Any other relevant notes or atmosphere]

Text to analyze:
${sourceText}`;

  const output = showProgress('⚡', 'Generating Setting from text...');
  
  let accumulatedText = "";
  
  callAPI(promptText, 
    chunk => {
      if(chunk) {
        accumulatedText += chunk;
        output.update(chunk);
        // We also update the textarea in real-time
        APP.chapter.settings[settingIdx].text = accumulatedText;
        const containerId = `sb_setting_${APP.chapter.settings[settingIdx].id}`;
        const ta = document.getElementById(containerId)?.querySelector('.sb-ta');
        if(ta) ta.value = accumulatedText;
      }
    },
    () => {
      output.complete('Setting generated successfully!');
      saveState();
      renderSettingsList(); // re-render to ensure state is clean
    },
    err => {
      output.error('Error generating setting: ' + err);
    },
    null
  );
}

// ═══════════════════════════════════════════════════════════
// PANEL: PROMPTS
// ═══════════════════════════════════════════════════════════

function renderPrompts(){
  const p=document.getElementById('panel-prompts');
  if(!p) return;
  const catIds = CATEGORIES.map(c => c.id);
  p.innerHTML=`
    <nav class="p-sidebar">
      <div class="p-sidebar-lbl">Editing Modes</div>
      ${CATEGORY_SECTIONS.map(s=>`
        <div class="p-sidebar-sec">${s.label}</div>
        ${s.cats.map(catId=>{
          const c = CATEGORIES.find(cat => cat.id === catId);
          if(!c) return '';
          return `<button class="pcatbtn${APP.prompts.cat===c.id?' pca':''}" data-cat="${c.id}" style="--cc:${c.color}">
            <span class="pci">${c.icon}</span>${c.label}
          </button>`;
        }).join('')}
      `).join('')}
    </nav>
    <div class="p-list" id="p_list"></div>
    <div class="p-editor" id="p_editor"></div>`;

  p.querySelectorAll('.pcatbtn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      APP.prompts.cat=btn.dataset.cat;
      localStorage.setItem('na_prompts_cat', APP.prompts.cat);
      APP.prompts.promptId=null;
      APP.prompts.fields={};
      p.querySelectorAll('.pcatbtn').forEach(b=>b.classList.toggle('pca',b.dataset.cat===APP.prompts.cat));
      renderPromptList();
      renderPromptEditor();
    });
  });
  renderPromptList();
  renderPromptEditor();
}

function renderPromptList(){
  const list=document.getElementById('p_list'); if(!list) return;
  const cat=CATEGORIES.find(c=>c.id===APP.prompts.cat);
  const catPrompts=PROMPTS[APP.prompts.cat]||[];
  const showExtract = ['character','world','location'].includes(APP.prompts.cat);
  const extractBtn = APP.prompts.cat === 'character' ? '<button class="extract-btn" id="extract_chars">Extract Characters</button>' :
                     APP.prompts.cat === 'world' ? '<button class="extract-btn" id="extract_world">Extract World Building</button>' :
                     '<button class="extract-btn" id="extract_locs">Extract Locations</button>';
  list.innerHTML=`
    <div class="p-list-hd">
      <div class="p-list-bar" style="--cc:${cat.color}"></div>
      <div class="p-list-name" style="--cc:${cat.color}"><span style="color:${cat.color}">${cat.icon}</span>${cat.label}</div>
      <div class="p-list-cnt">${catPrompts.length} prompt${catPrompts.length!==1?'s':''}</div>
    </div>
    ${showExtract ? `
    <div class="extract-section" style="padding:10px;border-bottom:1px solid #181510;margin-bottom:8px">
      <div class="mlabel" style="margin-bottom:6px">Extract from Chapters</div>
      <textarea class="extract-text" id="extract_text" placeholder="Paste chapter text to extract from..." style="width:100%;min-height:60px;background:#0b0908;border:1px solid #1c1912;border-radius:2px;color:#a89868;font-family:'Crimson Pro',serif;font-size:12px;padding:8px;resize:vertical;margin-bottom:8px"></textarea>
      <div class="extract-row">
        ${extractBtn}
      </div>
      <div class="extract-result" id="extract_result" style="display:none">
        <textarea id="extract_output" readonly></textarea>
      </div>
    </div>` : ''}
    ${catPrompts.map(pr=>`
      <button class="pcrd${APP.prompts.promptId===pr.id?' pcra':''}" data-pid="${pr.id}" style="--cc:${cat.color}">
        <div class="pcrd-t">${esc(pr.title)}</div>
        <div class="pcrd-d">${esc(pr.desc)}</div>
      </button>`).join('')}`;

  list.querySelectorAll('.pcrd').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const same=APP.prompts.promptId===btn.dataset.pid;
      APP.prompts.promptId=same?null:btn.dataset.pid;
      APP.prompts.fields={};
      APP.prompts.output='';
      list.querySelectorAll('.pcrd').forEach(b=>b.classList.toggle('pcra',b.dataset.pid===APP.prompts.promptId));
      renderPromptEditor();
    });
  });

  if(showExtract){
    setupExtractButtons();
  }
}

function renderPromptEditor(){
  const editor=document.getElementById('p_editor'); if(!editor) return;
  const pr=APP.prompts.promptId?(PROMPTS[APP.prompts.cat]||[]).find(p=>p.id===APP.prompts.promptId):null;
  if(!pr){
    const pills=getContextPills();
    editor.innerHTML=`<div class="p-empty">
      <h3>Select a prompt to begin</h3>
      <p>${pills.length?pills.length+' context section'+(pills.length>1?'s':'')+' active':'Add context in Series / Book / Chapter tabs'}</p>
    </div>`;
    return;
  }

  const pills=getContextPills();
  editor.innerHTML=`
    <div class="p-ehd">
      <div class="p-etit">${esc(pr.title)}</div>
      <div class="p-edesc">${esc(pr.desc)}</div>
    </div>
    <div class="p-ebody" id="p_fields">
      ${pr.fields.map(f=>`
        <div class="pfl">
          <label>${esc(f.label)}</label>
          ${f.type==='textarea'
            ?`<textarea placeholder="Enter ${esc(f.label.toLowerCase())}…" data-key="${f.key}" rows="5"></textarea>`
            :`<input type="text" placeholder="Enter ${esc(f.label.toLowerCase())}…" data-key="${f.key}">`
          }
        </div>`).join('')}
    </div>
    <div class="ctx-bar">
      <span class="ctx-bar-lbl">Context:</span>
      <div class="ctx-pills">
        ${pills.length===0?'<span class="ctx-none">none</span>':pills.map(pi=>`<span class="cpill c${pi.mode}">${esc(pi.label)}</span>`).join('')}
      </div>
    </div>
    <div class="out-area">
      <div class="out-toolbar">
        <div class="out-status" id="out_status"><span>Ready</span></div>
        <div class="out-btns">
          <button class="sec-btn" id="copy_prompt_btn">Copy Prompt</button>
          <button class="sec-btn" id="copy_out_btn" disabled>Copy Output</button>
          <button class="sec-btn" id="dl_out_btn" disabled>↓ .md</button>
          <button class="stop-btn" id="stop_btn" style="display:none">■ Stop</button>
          <button class="run-btn" id="run_btn" ${APP.apiKey?'':'title="Add API key in Settings"'}>▶ Run</button>
        </div>
      </div>
      <div class="out-text" id="out_text"><span class="out-placeholder">Output will appear here…</span></div>
    </div>`;

  // Restore field values
  pr.fields.forEach(f=>{
    const el=editor.querySelector(`[data-key="${f.key}"]`);
    if(el&&APP.prompts.fields[f.key]) el.value=APP.prompts.fields[f.key];
    if(el) el.addEventListener('input',e=>{APP.prompts.fields[f.key]=e.target.value;});
  });

  // Restore output
  if(APP.prompts.output){
    document.getElementById('out_text').textContent=APP.prompts.output;
    document.getElementById('copy_out_btn').disabled=false;
    document.getElementById('dl_out_btn').disabled=false;
  }

  // Copy prompt
  document.getElementById('copy_prompt_btn').addEventListener('click',()=>{
    const ctx=buildContext();
    const prefs = buildWritingPrefsInstructions();
    const genre = buildGenreCompareInstructions();
    const full=genre+prefs+ctx+pr.tpl(APP.prompts.fields);
    navigator.clipboard.writeText(full).then(()=>{
      const btn=document.getElementById('copy_prompt_btn');
      btn.textContent='✓ Copied'; btn.classList.add('ok');
      setTimeout(()=>{btn.textContent='Copy Prompt';btn.classList.remove('ok');},2000);
    });
  });

  // Copy output
  document.getElementById('copy_out_btn').addEventListener('click',()=>{
    if(!APP.prompts.output) return;
    navigator.clipboard.writeText(APP.prompts.output).then(()=>{
      const btn=document.getElementById('copy_out_btn');
      btn.textContent='✓ Copied'; btn.classList.add('ok');
      setTimeout(()=>{btn.textContent='Copy Output';btn.classList.remove('ok');},2000);
    });
  });

  // Download output
  document.getElementById('dl_out_btn').addEventListener('click',()=>{
    if(!APP.prompts.output) return;
    dlMd(APP.prompts.output,`${pr.id}-output.md`);
  });

  // Stop
  document.getElementById('stop_btn').addEventListener('click',()=>{
    if(APP.prompts.abortCtrl) APP.prompts.abortCtrl.abort();
    APP.prompts.running=false;
    setRunState(false);
  });

  // Token warning function
  function updateTokenWarning(){
    const ctx=buildContext();
    const prefs = buildWritingPrefsInstructions();
    const genre = buildGenreCompareInstructions();
    const full=genre+prefs+ctx+pr.tpl(APP.prompts.fields);
    const estTokens = Math.round(full.length / 4);
    const limit = APP.maxTokens + (parseInt(document.getElementById('tok_boost')?.value)||0);
    const pct = (estTokens / limit) * 100;
    const warningEl = document.getElementById('token_warning');
    if(!warningEl) return;
    if(pct > 100){
      warningEl.className = 'token-warning err';
      warningEl.textContent = `~${(estTokens/1000).toFixed(1)}k / ${(limit/1000).toFixed(0)}k (OVER)`;
    } else if(pct > 80){
      warningEl.className = 'token-warning warn';
      warningEl.textContent = `~${(estTokens/1000).toFixed(1)}k / ${(limit/1000).toFixed(0)}k`;
    } else {
      warningEl.className = 'token-warning ok';
      warningEl.textContent = `~${(estTokens/1000).toFixed(1)}k tokens`;
    }
  }

  // Add token warning element
  const statusEl = document.getElementById('out_status');
  if(statusEl){
    const tw = document.createElement('span');
    tw.id = 'token_warning';
    tw.className = 'token-warning ok';
    tw.style.marginLeft = '8px';
    statusEl.appendChild(tw);
    updateTokenWarning();
  }

  // Add input listeners to update token warning
  pr.fields.forEach(f=>{
    const el=editor.querySelector(`[data-key="${f.key}"]`);
    if(el) el.addEventListener('input',updateTokenWarning);
  });

  // Run
  document.getElementById('run_btn').addEventListener('click',()=>{
    if(APP.prompts.running) return;
    const ctx=buildContext();
    const prefs = buildWritingPrefsInstructions();
    const genre = buildGenreCompareInstructions();
    const prompt=genre+prefs+ctx+pr.tpl(APP.prompts.fields);
    APP.prompts.running=true;
    APP.prompts.output='';
    APP.prompts.abortCtrl=new AbortController();

    const outText=document.getElementById('out_text');
    outText.textContent='';
    const cursor=document.createElement('span');
    cursor.className='cursor-blink';
    outText.appendChild(cursor);

    setRunState(true);
    const t0=Date.now();

    callAPI(prompt,
      chunk=>{
        APP.prompts.output+=chunk;
        outText.textContent=APP.prompts.output;
        outText.appendChild(cursor);
        outText.scrollTop=outText.scrollHeight;
      },
      ()=>{
        APP.prompts.running=false;
        outText.textContent=APP.prompts.output;
        setRunState(false,`Done · ${((Date.now()-t0)/1000).toFixed(1)}s`);
        document.getElementById('copy_out_btn').disabled=false;
        document.getElementById('dl_out_btn').disabled=false;
      },
      err=>{
        APP.prompts.running=false;
        outText.textContent='Error: '+err;
        setRunState(false,'Error');
      },
      APP.prompts.abortCtrl.signal
    );
  });

  // Add help icon to Prompts editor
  const editorHd = editor.querySelector('.p-ehd');
  if(editorHd){
    editorHd.style.position = 'relative';
    addHelp(editorHd, '<b>Context:</b> Shows what context sections (Series, Book, Chapter, Settings) are being included in the prompt.<br><br><b>Run:</b> Sends your prompt + context to the AI using your configured API.<br><br><b>Copy Prompt:</b> Copies the full prompt text (without running) to clipboard.<br><br><b>On/Off:</b> Toggle settings in Chapter tab to include or exclude them from context.');
  }
}

function setRunState(running, statusText=null){
  const runBtn=document.getElementById('run_btn');
  const stopBtn=document.getElementById('stop_btn');
  const status=document.getElementById('out_status');
  if(!runBtn) return;
  if(running){
    runBtn.textContent='Running…'; runBtn.classList.add('running'); runBtn.disabled=true;
    stopBtn.style.display='inline-block';
    status.innerHTML='<span class="spin"></span><span>Generating…</span>';
  } else {
    runBtn.textContent='▶ Run'; runBtn.classList.remove('running'); runBtn.disabled=false;
    stopBtn.style.display='none';
    status.innerHTML=`<span>${statusText||'Ready'}</span>`;
  }
}

// ═══════════════════════════════════════════════════════════
// PANEL: PIPELINE
// ═══════════════════════════════════════════════════════════

function getFirstTextareaKey(promptId, catId){
  const pr=(PROMPTS[catId]||[]).find(p=>p.id===promptId);
  if(!pr) return null;
  const f=pr.fields.find(f=>f.type==='textarea');
  return f?f.key:null;
}

function renderPipeline(){
  const p=document.getElementById('panel-pipeline');
  p.innerHTML=`
    <div class="pipe-layout">
      <div class="pipe-builder">
        <div class="pipe-hd">
          <h2>Pipeline</h2>
          <p>Chain multiple prompts in sequence. Each step builds on the last.</p>
        </div>
        <div class="pipe-mode">
          <button class="pm-btn${APP.pipeline.mode==='refine'?' pmon':''}" id="pm_refine" data-mode="refine">
            ⟹ Refine<span>Each output feeds the next step</span>
          </button>
          <button class="pm-btn${APP.pipeline.mode==='parallel'?' pmon':''}" id="pm_parallel" data-mode="parallel">
            ⊞ Multi-Lens<span>All steps analyze the same text</span>
          </button>
        </div>
        <div class="pipeline-style-opt">
          <input type="checkbox" id="use_writing_style" ${APP.pipeline.useWritingStyle?'checked':''}>
          <label for="use_writing_style">Use captured writing style for rewrites (in addition to new output)</label>
        </div>
        <div class="pipe-controls">
          <button class="pipe-run-btn" id="pipe_run">▶ Run All Steps</button>
          <button class="pipe-clear-btn" id="pipe_add">+ Step</button>
          <button class="pipe-clear-btn" id="pipe_clear">Clear All</button>
          <button class="pipe-save-btn" id="pipe_save" disabled>↓ Save Results</button>
        </div>
        <div id="pipeline_steps"></div>
      </div>
      <div class="pipe-results">
        <div class="res-hd">
          <span class="res-title">Results</span>
          <div class="res-actions">
            <button class="sec-btn" id="pipe_copy_all" disabled>Copy All</button>
            <button class="sec-btn" id="pipe_save_all" disabled>↓ Save All</button>
          </div>
        </div>
        <div id="res_summary" style="font-family:'JetBrains Mono',monospace;font-size:8px;color:#40382a;letter-spacing:.06em;margin-bottom:8px"></div>
        <div id="res_content"><div class="res-empty">Add steps and run to see results here</div></div>
      </div>
    </div>`;

  p.querySelectorAll('.pm-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      APP.pipeline.mode=btn.dataset.mode;
      p.querySelectorAll('.pm-btn').forEach(b=>b.classList.toggle('pmon',b.dataset.mode===APP.pipeline.mode));
    });
  });
  
  // Writing style toggle
  p.querySelector('#use_writing_style').addEventListener('change',e=>{
    APP.pipeline.useWritingStyle = e.target.checked;
  });
  
  p.querySelector('#pipe_add').addEventListener('click',addPipelineStep);
  p.querySelector('#pipe_clear').addEventListener('click',()=>{
    APP.pipeline.steps=[];
    APP.pipeline.results=[];
    renderPipelineSteps();
    renderPipelineResults();
  });
  p.querySelector('#pipe_run').addEventListener('click',runPipeline);
  p.querySelector('#pipe_save').addEventListener('click',savePipelineResults);
  p.querySelector('#pipe_copy_all').addEventListener('click',copyAllPipelineResults);
  p.querySelector('#pipe_save_all').addEventListener('click',saveAllPipelineResults);

  renderPipelineSteps();
  renderPipelineResults();
}

function addPipelineStep(){
  const defCat='punch';
  const defPrompt=PROMPTS[defCat][0];
  APP.pipeline.steps.push({
    id:mkId(), cat:defCat, promptId:defPrompt.id,
    fields:{}, usePrev: APP.pipeline.steps.length>0
  });
  renderPipelineSteps();
}

function renderPipelineSteps(){
  const container=document.getElementById('pipeline_steps'); if(!container) return;
  if(APP.pipeline.steps.length===0){
    container.innerHTML=`<div style="padding:16px;font-family:'Crimson Pro',serif;font-size:13px;color:#40382a;font-style:italic;text-align:center">No steps yet — click "+ Step" to begin</div>`;
    return;
  }
  container.innerHTML='';
  APP.pipeline.steps.forEach((step,i)=>{
    if(i>0){
      const conn=document.createElement('div');
      conn.className='connector';
      conn.textContent=APP.pipeline.mode==='refine'?'↓ output feeds next':'↓';
      container.appendChild(conn);
    }
    const div=document.createElement('div');
    div.className='pipe-step';
    div.id=`step_${step.id}`;

    const cat=CATEGORIES.find(c=>c.id===step.cat)||CATEGORIES[0];
    const stepPrompts=PROMPTS[step.cat]||[];
    const pr=stepPrompts.find(p=>p.id===step.promptId)||stepPrompts[0];

    div.innerHTML=`
      <div class="pipe-step-hd">
        <div class="step-num">${i+1}</div>
        <div class="step-selects">
          <select class="step-sel" id="step_cat_${step.id}">
            ${CATEGORIES.map(c=>`<option value="${c.id}"${c.id===step.cat?' selected':''}>${c.label}</option>`).join('')}
          </select>
          <select class="step-sel" id="step_pr_${step.id}">
            ${stepPrompts.map(sp=>`<option value="${sp.id}"${sp.id===step.promptId?' selected':''}>${esc(sp.title)}</option>`).join('')}
          </select>
        </div>
        <button class="step-rm" data-id="${step.id}">×</button>
      </div>
      <div class="step-body" id="step_body_${step.id}"></div>`;

    container.appendChild(div);

    // Remove
    div.querySelector('.step-rm').addEventListener('click',()=>{
      APP.pipeline.steps=APP.pipeline.steps.filter(s=>s.id!==step.id);
      renderPipelineSteps();
    });

    // Category change
    div.querySelector(`#step_cat_${step.id}`).addEventListener('change',e=>{
      const s=APP.pipeline.steps.find(x=>x.id===step.id);
      s.cat=e.target.value;
      const newPrompts=PROMPTS[s.cat]||[];
      s.promptId=newPrompts[0]?.id||'';
      s.fields={};
      renderPipelineSteps();
    });

    // Prompt change
    div.querySelector(`#step_pr_${step.id}`).addEventListener('change',e=>{
      const s=APP.pipeline.steps.find(x=>x.id===step.id);
      s.promptId=e.target.value;
      s.fields={};
      renderPipelineSteps();
    });

    // Step body
    renderStepBody(step, i, pr);
  });
}

function renderStepBody(step, i, pr){
  const body=document.getElementById(`step_body_${step.id}`); if(!body||!pr) return;
  const firstTA=pr.fields.find(f=>f.type==='textarea');
  const canPipe=i>0&&APP.pipeline.mode==='refine'&&firstTA;

  body.innerHTML=`
    ${canPipe?`
      <div class="pipe-tog">
        <input type="checkbox" id="useprev_${step.id}" ${step.usePrev?'checked':''}>
        <label for="useprev_${step.id}">Use output from previous step as "${esc(firstTA.label)}"</label>
      </div>`:''}
    ${pr.fields.map(f=>{
      const isPiped=canPipe&&step.usePrev&&f===firstTA;
      return `
        <div class="step-field">
          <label>${esc(f.label)}</label>
          ${isPiped
            ?`<div class="step-piped">← Will receive output from Step ${i}</div>`
            :f.type==='textarea'
              ?`<textarea data-key="${f.key}" placeholder="${esc(f.label)}…" rows="3">${esc(step.fields[f.key]||'')}</textarea>`
              :`<input type="text" data-key="${f.key}" placeholder="${esc(f.label)}…" value="${esc(step.fields[f.key]||'')}">`
          }
        </div>`
    }).join('')}`;

  if(canPipe){
    body.querySelector(`#useprev_${step.id}`).addEventListener('change',e=>{
      step.usePrev=e.target.checked;
      renderStepBody(step,i,pr);
    });
  }
  body.querySelectorAll('[data-key]').forEach(el=>{
    el.addEventListener('input',e=>{step.fields[e.target.dataset.key]=e.target.value;});
  });
}

async function runPipeline(){
  if(APP.pipeline.steps.length===0) return;
  const runBtn=document.getElementById('pipe_run'); if(!runBtn) return;
  if(APP.pipeline.running) return;

  APP.pipeline.running=true;
  APP.pipeline.results=APP.pipeline.steps.map(s=>({id:s.id,name:(PROMPTS[s.cat]||[]).find(p=>p.id===s.promptId)?.title||'Step',status:'waiting',text:''}));
  runBtn.textContent='Running…'; runBtn.classList.add('running'); runBtn.disabled=true;
  document.getElementById('pipe_save').disabled=true;
  renderPipelineResults();

  const ctx=buildContext();
  let prevOutput='';

  for(let i=0;i<APP.pipeline.steps.length;i++){
    const step=APP.pipeline.steps[i];
    const pr=(PROMPTS[step.cat]||[]).find(p=>p.id===step.promptId);
    if(!pr) continue;

    // Build fields for this step
    const fields={...step.fields};
    if(i>0&&APP.pipeline.mode==='refine'&&step.usePrev){
      const firstTA=pr.fields.find(f=>f.type==='textarea');
      if(firstTA) fields[firstTA.key]=prevOutput;
    } else if(i>0&&APP.pipeline.mode==='parallel'&&!fields[pr.fields.find(f=>f.type==='textarea')?.key]){
      // parallel: keep original text from step 0's output if available
    }

    const prompt=ctx+pr.tpl(fields);

    // Update result status
    APP.pipeline.results[i].status='running';
    APP.pipeline.results[i].text='';
    renderPipelineResults();

    await new Promise((resolve)=>{
      APP.pipeline.abortCtrl=new AbortController();
      callAPI(prompt,
        chunk=>{
          APP.pipeline.results[i].text+=chunk;
          const el=document.getElementById(`res_text_${step.id}`);
          if(el){el.textContent=APP.pipeline.results[i].text;}
        },
        ()=>{
          APP.pipeline.results[i].status='done';
          prevOutput=APP.pipeline.results[i].text;
          updateResultStatus(step.id,'done');
          resolve();
        },
        err=>{
          APP.pipeline.results[i].status='err';
          APP.pipeline.results[i].text='Error: '+err;
          updateResultStatus(step.id,'err');
          resolve();
        },
        APP.pipeline.abortCtrl.signal
      );
    });
    // Small pause between steps
    if(i<APP.pipeline.steps.length-1) await new Promise(r=>setTimeout(r,300));
  }

  APP.pipeline.running=false;
  runBtn.textContent='▶ Run All Steps'; runBtn.classList.remove('running'); runBtn.disabled=false;
  const allDone=APP.pipeline.results.every(r=>r.status==='done');
  document.getElementById('pipe_save').disabled=!allDone;
  document.getElementById('pipe_copy_all').disabled=!allDone;
  document.getElementById('pipe_save_all').disabled=!allDone;
  document.getElementById('res_summary').textContent=`${APP.pipeline.results.filter(r=>r.status==='done').length}/${APP.pipeline.steps.length} completed`;
}

function updateResultStatus(stepId, status){
  const el=document.getElementById(`res_status_${stepId}`);
  if(el){el.className=`res-step-status ${status}`;el.textContent=status==='done'?'Done':status==='running'?'Running…':'Error';}
}

function renderPipelineResults(){
  const content=document.getElementById('res_content'); if(!content) return;
  if(APP.pipeline.results.length===0){
    content.innerHTML='<div class="res-empty">Add steps and run to see results here</div>';
    return;
  }
  content.innerHTML='';
  APP.pipeline.results.forEach((r,i)=>{
    const div=document.createElement('div');
    div.className='res-step';
    const statusLabel=r.status==='done'?'Done':r.status==='running'?'Running…':r.status==='err'?'Error':'Waiting';
    div.innerHTML=`
      <div class="res-step-hd">
        <div class="res-step-num">${i+1}</div>
        <div class="res-step-name">${esc(r.name)}</div>
        <div class="res-step-status ${r.status}" id="res_status_${r.id}">${statusLabel}</div>
      </div>
      <div class="res-step-text" id="res_text_${r.id}">${esc(r.text)||'<span style="color:#281e14;font-style:italic">Waiting…</span>'}</div>`;
    content.appendChild(div);
  });
}

function savePipelineResults(){
  if(!APP.pipeline.results.length) return;
  let md=`# Pipeline Results\n\nGenerated by The Novelist's Atelier — ${new Date().toLocaleString()}\n\nMode: ${APP.pipeline.mode==='refine'?'Refine (Sequential)':'Multi-Lens (Parallel)'}\n\n`;
  APP.pipeline.results.forEach((r,i)=>{
    md+=`## Step ${i+1}: ${r.name}\n\n${r.text}\n\n---\n\n`;
  });
  dlMd(md,`pipeline-results-${Date.now()}.md`);
}

function copyAllPipelineResults(){
  if(!APP.pipeline.results.length) return;
  let text = `# Pipeline Results\n\nGenerated by The Novelist's Atelier — ${new Date().toLocaleString()}\n\n`;
  APP.pipeline.results.forEach((r,i)=>{
    text+=`\n=== Step ${i+1}: ${r.name} ===\n\n${r.text}\n\n`;
  });
  navigator.clipboard.writeText(text).then(()=>{
    const btn = document.getElementById('pipe_copy_all');
    if(btn){btn.textContent='✓ Copied'; btn.classList.add('ok');}
    setTimeout(()=>{if(btn){btn.textContent='Copy All'; btn.classList.remove('ok');}},2000);
  });
}

function saveAllPipelineResults(){
  if(!APP.pipeline.results.length) return;
  let md=`# Pipeline Results\n\nGenerated by The Novelist's Atelier — ${new Date().toLocaleString()}\n\nMode: ${APP.pipeline.mode==='refine'?'Refine (Sequential)':'Multi-Lens (Parallel)'}\n\n`;
  APP.pipeline.results.forEach((r,i)=>{
    md+=`## Step ${i+1}: ${r.name}\n\n${r.text}\n\n---\n\n`;
  });
  dlMd(md,`pipeline-results-${Date.now()}.md`);
}

// ═══════════════════════════════════════════════════════════
// PANEL: SETTINGS
// ═══════════════════════════════════════════════════════════

function renderSettings(){
  const p=document.getElementById('panel-settings');
  // Filter models by current provider
  const filteredModels = MODELS.filter(m => m.provider === APP.provider);
  const grouped={};
  filteredModels.forEach(m=>{if(!grouped[m.provider]) grouped[m.provider]=[];grouped[m.provider].push(m);});

  p.innerHTML=`
    <div class="settings-scroll">
      <div class="settings-section">
        <div class="settings-hd">
          <h2>Settings</h2>
          <p>Configure your API access and model preferences.</p>
        </div>

        <div class="scard">
          <div class="scard-hd">API Provider</div>
          <div class="scard-body">
            <div class="meta-field">
              <label class="mlabel">Select Provider</label>
              <select id="provider_select" style="background:#0b0908;border:1px solid #252015;color:#c8a660;font-family:'JetBrains Mono',monospace;font-size:12px;padding:6px 10px;border-radius:2px;width:100%">
                <option value="openrouter" ${APP.provider==='openrouter'?'selected':''}>OpenRouter (Default)</option>
                <option value="anthropic" ${APP.provider==='anthropic'?'selected':''}>Anthropic Direct (Claude)</option>
                <option value="openai" ${APP.provider==='openai'?'selected':''}>OpenAI Direct</option>
                <option value="google" ${APP.provider==='google'?'selected':''}>Google Direct (Gemini)</option>
                <option value="lmstudio" ${APP.provider==='lmstudio'?'selected':''}>LM Studio (Local)</option>
              </select>
            </div>
          </div>
        </div>

        <div class="scard" id="openrouter_card" style="display:${APP.provider==='openrouter'?'block':'none'}">
          <div class="scard-hd">OpenRouter API Key</div>
          <div class="scard-body">
            <div class="api-row">
              <div class="meta-field">
                <label class="mlabel">API Key</label>
                <div class="api-key-wrap">
                  <input class="minput" type="password" id="api_key_inp" value="${esc(APP.apiKeys.openrouter)}" placeholder="sk-or-v1-…" autocomplete="off">
                  <button class="api-show" id="api_show">Show</button>
                </div>
              </div>
              <button class="test-btn" id="test_btn">Test</button>
            </div>
            <div class="api-status" id="api_status"></div>
            <p class="api-note">Get your key at <a href="https://openrouter.ai/keys" target="_blank">openrouter.ai/keys</a>.</p>
          </div>
        </div>

        <div class="scard" id="anthropic_card" style="display:${APP.provider==='anthropic'?'block':'none'}">
          <div class="scard-hd">Anthropic API Key</div>
          <div class="scard-body">
            <div class="api-row">
              <div class="meta-field">
                <label class="mlabel">API Key</label>
                <div class="api-key-wrap">
                  <input class="minput" type="password" id="api_key_anthropic" value="${esc(APP.apiKeys.anthropic)}" placeholder="sk-ant-…" autocomplete="off">
                  <button class="api-show" id="api_show_ant">Show</button>
                </div>
              </div>
              <button class="test-btn" id="test_btn_ant">Test</button>
            </div>
            <div class="api-status" id="api_status_ant"></div>
            <p class="api-note">Get your key at <a href="https://console.anthropic.com/settings/keys" target="_blank">console.anthropic.com</a>.</p>
          </div>
        </div>

        <div class="scard" id="openai_card" style="display:${APP.provider==='openai'?'block':'none'}">
          <div class="scard-hd">OpenAI API Key</div>
          <div class="scard-body">
            <div class="api-row">
              <div class="meta-field">
                <label class="mlabel">API Key</label>
                <div class="api-key-wrap">
                  <input class="minput" type="password" id="api_key_openai" value="${esc(APP.apiKeys.openai)}" placeholder="sk-…" autocomplete="off">
                  <button class="api-show" id="api_show_openai">Show</button>
                </div>
              </div>
              <button class="test-btn" id="test_btn_openai">Test</button>
            </div>
            <div class="api-status" id="api_status_openai"></div>
            <p class="api-note">Get your key at <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a>.</p>
          </div>
        </div>

        <div class="scard" id="google_card" style="display:${APP.provider==='google'?'block':'none'}">
          <div class="scard-hd">Google API Key</div>
          <div class="scard-body">
            <div class="api-row">
              <div class="meta-field">
                <label class="mlabel">API Key</label>
                <div class="api-key-wrap">
                  <input class="minput" type="password" id="api_key_google" value="${esc(APP.apiKeys.google)}" placeholder="AIza…" autocomplete="off">
                  <button class="api-show" id="api_show_google">Show</button>
                </div>
              </div>
              <button class="test-btn" id="test_btn_google">Test</button>
            </div>
            <div class="api-status" id="api_status_google"></div>
            <p class="api-note">Get your key at <a href="https://aistudio.google.com/app/apikey" target="_blank">aistudio.google.com</a>. Requires billing enabled.</p>
          </div>
        </div>

        <div class="scard" id="lmstudio_card" style="display:${APP.provider==='lmstudio'?'block':'none'}">
          <div class="scard-hd"><span id="lmstudio_help_hd"></span>LM Studio (Local)</div>
          <div class="scard-body">
            <div class="api-row">
              <div class="meta-field" style="flex:2">
                <label class="mlabel">Base URL</label>
                <input class="minput" type="text" id="lmstudio_url" value="${esc(APP.lmstudioUrl)}" placeholder="http://localhost:1234">
              </div>
            </div>
            <div class="api-row" style="margin-top:10px">
              <div class="meta-field">
                <label class="mlabel">API Key (optional)</label>
                <div class="api-key-wrap">
                  <input class="minput" type="password" id="api_key_lmstudio" value="${esc(APP.apiKeys.lmstudio)}" placeholder="Optional" autocomplete="off">
                  <button class="api-show" id="api_show_lmstudio">Show</button>
                </div>
              </div>
              <button class="test-btn" id="test_btn_lmstudio">Test</button>
            </div>
            <div class="api-status" id="api_status_lmstudio"></div>
            <div class="api-row" style="margin-top:10px">
              <div class="meta-field" style="flex:2">
                <label class="mlabel">Model Name (if not fetched)</label>
                <input class="minput" type="text" id="lmstudio_model" value="" placeholder="e.g. qwen/qwen3-vl-8b">
              </div>
            </div>
            <p class="api-note">Start LM Studio, load a model, enable Server in Developer tab. If models don't fetch, enter name manually above.</p>
          </div>
        </div>

        <div class="scard">
          <div class="scard-hd">Model</div>
          <div class="scard-body">
            <div class="model-collapse-hd" id="model_collapse_hd">
              <span>Select model</span>
              <span class="model-collapse-icon">▼</span>
            </div>
            <div class="model-grid" id="model_grid">
              ${Object.entries(grouped).map(([provider,models])=>`
                <div class="model-section-lbl">${provider}</div>
                ${models.map(m=>`
                  <div class="model-row${APP.model===m.id?' msel':''}" data-mid="${m.id}" style="--mc:${m.color}">
                    <div class="model-radio"><div class="model-radio-dot"></div></div>
                    <div class="model-info">
                      <div class="model-name">${esc(m.name)}</div>
                      <div class="model-meta">${esc(m.id)} · ${m.ctx} ctx</div>
                    </div>
                    <span class="model-provider" style="color:${m.color};border-color:${m.color}22">${esc(provider)}</span>
                  </div>`).join('')}
              `).join('')}
            </div>
            <p class="api-note" style="margin-top:10px">${APP.provider === 'openrouter' ? 'Model IDs are OpenRouter paths. Check <a href="https://openrouter.ai/models" target="_blank">openrouter.ai/models</a> for availability.' : APP.provider === 'anthropic' ? 'Select a Claude model. Check <a href="https://docs.anthropic.com/en/docs/models-overview" target="_blank">docs.anthropic.com</a> for models.' : APP.provider === 'google' ? 'Select a Gemini model. Check <a href="https://ai.google.dev/docs" target="_blank">ai.google.dev/docs</a> for models.' : 'Select a GPT model. Check <a href="https://platform.openai.com/docs/models" target="_blank">platform.openai.com</a> for models.'}</p>
          </div>
        </div>

        <div class="scard">
          <div class="scard-hd">Display Settings</div>
          <div class="scard-body">
            <div class="scale-row">
              <label class="mlabel" style="flex:1">Theme</label>
              <select id="theme_select" style="background:#0b0908;border:1px solid #252015;color:#c8a660;font-family:'JetBrains Mono',monospace;font-size:11px;padding:4px 8px;border-radius:2px">
                <option value="default" ${APP.theme==='default'?'selected':''}>Default Dark</option>
                <option value="soft-beach" ${APP.theme==='soft-beach'?'selected':''}>Soft Beach</option>
                <option value="pink-sand" ${APP.theme==='pink-sand'?'selected':''}>Pink Sand</option>
                <option value="dark-sand" ${APP.theme==='dark-sand'?'selected':''}>Dark Sand</option>
                <option value="ice-cold" ${APP.theme==='ice-cold'?'selected':''}>Ice Cold</option>
                <option value="freeze-purple" ${APP.theme==='freeze-purple'?'selected':''}>Freeze Purple</option>
                <option value="medium-purple" ${APP.theme==='medium-purple'?'selected':''}>Medium Purple</option>
                <option value="purple-pain" ${APP.theme==='purple-pain'?'selected':''}>Purple Pain</option>
                <option value="heavy-purple" ${APP.theme==='heavy-purple'?'selected':''}>Heavy Purple</option>
                <option value="yass-queen" ${APP.theme==='yass-queen'?'selected':''}>Yass Queen</option>
                <option value="sister-sister" ${APP.theme==='sister-sister'?'selected':''}>Sister Sister</option>
                <option value="crown-yellow" ${APP.theme==='crown-yellow'?'selected':''}>Crown Yellow</option>
                <option value="blue-light" ${APP.theme==='blue-light'?'selected':''}>Blue Light</option>
                <option value="brutal-blue" ${APP.theme==='brutal-blue'?'selected':''}>Brutal Blue</option>
              </select>
            </div>
            <div class="scale-row" style="margin-top:12px">
              <label class="mlabel" style="flex:1">Main UI Scale</label>
              <div style="display:flex;align-items:center;gap:8px">
                <button class="smbtn" id="scale_down">−</button>
                <span class="scale-val" id="scale_val" style="min-width:40px;text-align:center">${APP.uiScale}x</span>
                <button class="smbtn" id="scale_up">+</button>
              </div>
            </div>
            <div class="scale-row" style="margin-top:12px">
              <label class="mlabel" style="flex:1">Header Scale</label>
              <div style="display:flex;align-items:center;gap:8px">
                <button class="smbtn" id="hscale_down">−</button>
                <span class="scale-val" id="hscale_val" style="min-width:40px;text-align:center">${APP.headerScale || 1}x</span>
                <button class="smbtn" id="hscale_up">+</button>
              </div>
            </div>
          </div>
        </div>

        <div class="scard">
          <div class="scard-hd">Generation Settings</div>
          <div class="scard-body">
            <div class="max-tok-row">
              <div class="meta-field" style="max-width:120px">
                <label class="mlabel">Max Tokens</label>
                <input class="minput" type="number" id="max_tok" value="${APP.maxTokens}" min="256" max="16000" step="256">
              </div>
              <div class="meta-field" style="max-width:100px">
                <label class="mlabel">Boost (1 run)</label>
                <input class="minput" type="number" id="tok_boost" value="0" min="0" max="16000" step="256" placeholder="+tokens">
              </div>
              <span class="tok-note">Higher = longer responses but may cost more. 4000 is a good default for editing tasks.</span>
            </div>
          </div>
        </div>

        <div class="scard">
          <div class="scard-hd">Writing Preferences</div>
          <div class="scard-body">
            <div class="pref-section">
              <div class="pref-section-lbl">Point of View</div>
              <div class="pref-radio">
                <label><input type="radio" name="pov" value="first" ${APP.writingPrefs.pov==='first'?'checked':''}> 1st Person</label>
                <label><input type="radio" name="pov" value="third" ${APP.writingPrefs.pov==='third'?'checked':''}> 3rd Person</label>
                <label><input type="radio" name="pov" value="mixed" ${APP.writingPrefs.pov==='mixed'?'checked':''}> Mixed</label>
              </div>
            </div>
            <div class="pref-section">
              <div class="pref-row">
                <label>Italics = inner monologue</label>
                <input type="checkbox" id="inner_monologue" ${APP.writingPrefs.innerMonologue?'checked':''}>
              </div>
            </div>
            <div class="pref-section">
              <div class="pref-section-lbl">AI Avoidance Rules (all ON by default)</div>
              <div class="pref-group">
                <div class="pref-group-lbl">
                  <input type="checkbox" id="punctuation_grp" ${APP.writingPrefs.punctuation?'checked':''} style="accent-color:#c8a660">
                  Punctuation Group
                </div>
                <div class="pref-sub" style="display:${APP.writingPrefs.punctuation?'block':'none'}" id="punctuation_sub">
                  <div class="pref-row"><label>No em-dashes (—)</label><input type="checkbox" id="avoid_emdashes" ${APP.writingPrefs.avoidEmDashes?'checked':''}></div>
                  <div class="pref-row"><label>No semicolons</label><input type="checkbox" id="avoid_semicolons" ${APP.writingPrefs.avoidSemicolons?'checked':''}></div>
                  <div class="pref-row"><label>No colons</label><input type="checkbox" id="avoid_colons" ${APP.writingPrefs.avoidColons?'checked':''}></div>
                </div>
              </div>
              <div class="pref-group">
                <div class="pref-group-lbl">
                  <input type="checkbox" id="avoid_triplet" ${APP.writingPrefs.avoidTriplet?'checked':''} style="accent-color:#c8a660">
                  No Triplet Framing
                </div>
              </div>
              <div class="pref-group">
                <div class="pref-group-lbl">
                  <input type="checkbox" id="avoid_golden_sunset" ${APP.writingPrefs.avoidGoldenSunset?'checked':''} style="accent-color:#c8a660">
                  No Golden Sunset (over-description)
                </div>
              </div>
              <div class="pref-group">
                <div class="pref-group-lbl">
                  <input type="checkbox" id="avoid_inspirational" ${APP.writingPrefs.avoidInspirationalPivot?'checked':''} style="accent-color:#c8a660">
                  No Inspirational Pivot
                </div>
              </div>
              <div class="pref-group">
                <div class="pref-group-lbl">
                  <input type="checkbox" id="avoid_show_summarize" ${APP.writingPrefs.avoidShowDontSummarize?'checked':''} style="accent-color:#c8a660">
                  No AI Bookending
                </div>
              </div>
              <div class="pref-row"><label>Vary sentence structure</label><input type="checkbox" id="vary_sentence" ${APP.writingPrefs.varySentenceStructure?'checked':''}></div>
              <div class="pref-row"><label>Avoid filter words</label><input type="checkbox" id="filter_words" ${APP.writingPrefs.filterWords?'checked':''}></div>
              <div class="pref-row"><label>Snappy dialogue</label><input type="checkbox" id="snappy_dialogue" ${APP.writingPrefs.snappyDialogue?'checked':''}></div>
              <div class="pref-row"><label>Specific over generic</label><input type="checkbox" id="specific_generic" ${APP.writingPrefs.specificOverGeneric?'checked':''}></div>
            </div>
            <div class="pref-section">
              <div class="pref-section-lbl">Do Not Use Words (comma-separated)</div>
              <textarea class="dnu-text" id="do_not_use" placeholder="e.g., very, really, actually, basically">${esc(APP.writingPrefs.doNotUseWords||'')}</textarea>
            </div>
          </div>
        </div>

        <div class="scard">
          <div class="scard-hd">Genre/Author Comparison (for Developmental & Line Editing)</div>
          <div class="scard-body">
            <div class="genre-compare-row">
              <div class="meta-field">
                <label class="mlabel">Genre Preset</label>
                <select class="gc-select" id="genre_preset">
                  <option value="fantasy" ${APP.genreCompare.preset==='fantasy'?'selected':''}>Fantasy</option>
                  <option value="sci-fi" ${APP.genreCompare.preset==='sci-fi'?'selected':''}>Science Fiction</option>
                  <option value="thriller" ${APP.genreCompare.preset==='thriller'?'selected':''}>Thriller</option>
                  <option value="romance" ${APP.genreCompare.preset==='romance'?'selected':''}>Romance</option>
                  <option value="horror" ${APP.genreCompare.preset==='horror'?'selected':''}>Horror</option>
                  <option value="literary" ${APP.genreCompare.preset==='literary'?'selected':''}>Literary Fiction</option>
                  <option value="mystery" ${APP.genreCompare.preset==='mystery'?'selected':''}>Mystery</option>
                  <option value="adventure" ${APP.genreCompare.preset==='adventure'?'selected':''}>Adventure</option>
                  <option value="custom" ${APP.genreCompare.preset==='custom'?'selected':''}>Custom</option>
                </select>
              </div>
            </div>
            <div id="custom_genre_row" style="display:${APP.genreCompare.preset==='custom'?'block':'none'}">
              <label class="mlabel">Custom Reference Text</label>
              <textarea class="gc-ref-text" id="genre_custom" placeholder="Paste reference text to compare against...">${esc(APP.genreCompare.customText||'')}</textarea>
            </div>
          </div>
        </div>

        <div class="scard">
          <div class="scard-hd">Data Management</div>
          <div class="scard-body">
            <p class="api-note" style="margin-bottom:10px">All project data (Series, Book, Chapter) is automatically saved to your browser's local storage.</p>
            <button class="clear-all-btn" id="clear_data_btn">Clear All Saved Data</button>
          </div>
        </div>
      </div>
    </div>`;

  // Provider selector
  p.querySelector('#provider_select').addEventListener('change', e => {
    APP.provider = e.target.value;
    localStorage.setItem('na_provider', APP.provider);
    // Show/hide relevant cards
    p.querySelector('#openrouter_card').style.display = APP.provider === 'openrouter' ? 'block' : 'none';
    p.querySelector('#anthropic_card').style.display = APP.provider === 'anthropic' ? 'block' : 'none';
    p.querySelector('#openai_card').style.display = APP.provider === 'openai' ? 'block' : 'none';
    p.querySelector('#google_card').style.display = APP.provider === 'google' ? 'block' : 'none';
    p.querySelector('#lmstudio_card').style.display = APP.provider === 'lmstudio' ? 'block' : 'none';
    // Auto-select first available model for provider
    const availableModels = MODELS.filter(m => m.provider === APP.provider);
    if(availableModels.length > 0 && !availableModels.find(m => m.id === APP.model)){
      APP.model = availableModels[0].id;
      localStorage.setItem('na_model', APP.model);
    }
    renderSettings(); // Re-render to update model list
    updateTabDot();
  });

  // OpenRouter key
  const keyInp = p.querySelector('#api_key_inp');
  p.querySelector('#api_show').addEventListener('click', function() {
    const show = keyInp.type === 'password';
    keyInp.type = show ? 'text' : 'password';
    this.textContent = show ? 'Hide' : 'Show';
  });
  keyInp.addEventListener('input', e => {
    APP.apiKeys.openrouter = e.target.value.trim();
    localStorage.setItem('na_key', APP.apiKeys.openrouter);
    updateTabDot();
  });

  // Anthropic key
  const keyAnt = p.querySelector('#api_key_anthropic');
  p.querySelector('#api_show_ant').addEventListener('click', function() {
    const show = keyAnt.type === 'password';
    keyAnt.type = show ? 'text' : 'password';
    this.textContent = show ? 'Hide' : 'Show';
  });
  keyAnt.addEventListener('input', e => {
    APP.apiKeys.anthropic = e.target.value.trim();
    localStorage.setItem('na_anthropic_key', APP.apiKeys.anthropic);
    updateTabDot();
  });

  // OpenAI key
  const keyOai = p.querySelector('#api_key_openai');
  p.querySelector('#api_show_openai').addEventListener('click', function() {
    const show = keyOai.type === 'password';
    keyOai.type = show ? 'text' : 'password';
    this.textContent = show ? 'Hide' : 'Show';
  });
  keyOai.addEventListener('input', e => {
    APP.apiKeys.openai = e.target.value.trim();
    localStorage.setItem('na_openai_key', APP.apiKeys.openai);
    updateTabDot();
  });

  // Test OpenRouter
  p.querySelector('#test_btn').addEventListener('click', async() => {
    const status = p.querySelector('#api_status');
    status.className = 'api-status checking'; status.textContent = 'Testing…';
    try {
      const res = await fetch('https://openrouter.ai/api/v1/auth/key', {
        headers: { 'Authorization': `Bearer ${APP.apiKeys.openrouter}` }
      });
      if (res.ok) {
        const j = await res.json();
        status.className = 'api-status ok';
        status.textContent = `✓ Connected${j.data?.label ? ' — ' + j.data.label : ''}`;
      } else {
        const j = await res.json().catch(() => ({ error: { message: 'Unknown error' } }));
        status.className = 'api-status err';
        status.textContent = '✗ ' + ((j.error?.message) || `HTTP ${res.status}`);
      }
    } catch(e) {
      status.className = 'api-status err';
      status.textContent = '✗ ' + e.message;
    }
  });

  // Test Anthropic
  p.querySelector('#test_btn_ant').addEventListener('click', async() => {
    const status = p.querySelector('#api_status_ant');
    status.className = 'api-status checking'; status.textContent = 'Testing…';
    try {
      const res = await fetch('https://api.anthropic.com/v1/auth_checks', {
        method: 'POST',
        headers: {
          'x-api-key': APP.apiKeys.anthropic,
          'anthropic-version': '2023-06-01',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({})
      });
      if (res.ok) {
        status.className = 'api-status ok';
        status.textContent = '✓ Connected';
      } else {
        const j = await res.json().catch(() => ({ error: { message: 'Unknown error' } }));
        status.className = 'api-status err';
        status.textContent = '✗ ' + ((j.error?.message) || `HTTP ${res.status}`);
      }
    } catch(e) {
      status.className = 'api-status err';
      status.textContent = '✗ ' + e.message;
    }
  });

  // Test OpenAI
  p.querySelector('#test_btn_openai').addEventListener('click', async() => {
    const status = p.querySelector('#api_status_openai');
    status.className = 'api-status checking'; status.textContent = 'Testing…';
    try {
      const res = await fetch('https://api.openai.com/v1/models', {
        headers: { 'Authorization': `Bearer ${APP.apiKeys.openai}` }
      });
      if (res.ok) {
        status.className = 'api-status ok';
        status.textContent = '✓ Connected';
      } else {
        const j = await res.json().catch(() => ({ error: { message: 'Unknown error' } }));
        status.className = 'api-status err';
        status.textContent = '✗ ' + ((j.error?.message) || `HTTP ${res.status}`);
      }
    } catch(e) {
      status.className = 'api-status err';
      status.textContent = '✗ ' + e.message;
    }
  });

  // Google key
  const keyGoogle = p.querySelector('#api_key_google');
  p.querySelector('#api_show_google').addEventListener('click', function() {
    const show = keyGoogle.type === 'password';
    keyGoogle.type = show ? 'text' : 'password';
    this.textContent = show ? 'Hide' : 'Show';
  });
  keyGoogle.addEventListener('input', e => {
    APP.apiKeys.google = e.target.value.trim();
    localStorage.setItem('na_google_key', APP.apiKeys.google);
    updateTabDot();
  });

  // Test Google
  p.querySelector('#test_btn_google').addEventListener('click', async() => {
    const status = p.querySelector('#api_status_google');
    status.className = 'api-status checking'; status.textContent = 'Testing…';
    try {
      const res = await fetch('https://generativelanguage.googleapis.com/v1beta/models?key=' + APP.apiKeys.google);
      if (res.ok) {
        status.className = 'api-status ok';
        status.textContent = '✓ Connected';
      } else {
        const j = await res.json().catch(() => ({ error: { message: 'Unknown error' } }));
        status.className = 'api-status err';
        status.textContent = '✗ ' + ((j.error?.message) || `HTTP ${res.status}`);
      }
    } catch(e) {
      status.className = 'api-status err';
      status.textContent = '✗ ' + e.message;
    }
  });

  // LM Studio URL
  const lmstudioUrlInp = p.querySelector('#lmstudio_url');
  lmstudioUrlInp.addEventListener('input', e => {
    APP.lmstudioUrl = e.target.value.trim();
    localStorage.setItem('na_lmstudio_url', APP.lmstudioUrl);
  });

  // LM Studio key
  const keyLmstudio = p.querySelector('#api_key_lmstudio');
  p.querySelector('#api_show_lmstudio').addEventListener('click', function() {
    const show = keyLmstudio.type === 'password';
    keyLmstudio.type = show ? 'text' : 'password';
    this.textContent = show ? 'Hide' : 'Show';
  });
  keyLmstudio.addEventListener('input', e => {
    APP.apiKeys.lmstudio = e.target.value.trim();
    localStorage.setItem('na_lmstudio_key', APP.apiKeys.lmstudio);
    updateTabDot();
  });

  // Test LM Studio & Fetch Models
  p.querySelector('#test_btn_lmstudio').addEventListener('click', async() => {
    const status = p.querySelector('#api_status_lmstudio');
    const baseUrl = (p.querySelector('#lmstudio_url').value || 'http://localhost:1234').replace(/\/$/, '');
    status.className = 'api-status checking'; status.textContent = 'Testing…';
    try {
      // Try LM Studio's native API endpoint first
      let models = [];
      let foundModels = false;
      let errorMsg = '';
      
      // Try the LM Studio native models endpoint
      try {
        const res = await fetch(`${baseUrl}/api/v0/models`);
        if (res.ok) {
          const j = await res.json();
          models = j.models || [];
          foundModels = true;
        } else {
          errorMsg = `HTTP ${res.status}`;
        }
      } catch(e) { errorMsg = e.message; }
      
      // If not found, try OpenAI compatible endpoint
      if(!foundModels || models.length === 0){
        try {
          const res = await fetch(`${baseUrl}/v1/models`, { 
            method: 'GET',
            mode: 'cors',
            headers: { 'Content-Type': 'application/json' }
          });
          if (res.ok) {
            const j = await res.json();
            models = j.data || [];
            foundModels = true;
          } else {
            errorMsg = `HTTP ${res.status}`;
          }
        } catch(e) { errorMsg = e.message; }
      }
      
      status.className = 'api-status ok';
      if(models.length > 0){
        status.textContent = `✓ Connected (${models.length} models found)`;
        // Add models to MODELS array dynamically
        models.forEach(m => {
          const modelId = m.id || m;
          const existing = MODELS.find(ex => ex.id === modelId && ex.provider === 'lmstudio');
          if(!existing){
            MODELS.push({
              id: modelId,
              name: modelId,
              provider: 'lmstudio',
              ctx: 'varies',
              color: '#888888'
            });
          }
        });
        // Switch to LM Studio provider and update model list
        APP.provider = 'lmstudio';
        localStorage.setItem('na_provider', 'lmstudio');
        renderSettings();
      } else if(errorMsg) {
        status.textContent = `✓ Connected (enter model name manually below)`;
        // Still switch to LM Studio so user can manually enter model
        APP.provider = 'lmstudio';
        localStorage.setItem('na_provider', 'lmstudio');
        renderSettings();
      } else if(!foundModels) {
        status.textContent = `✓ Connected (enter model name manually below)`;
        APP.provider = 'lmstudio';
        localStorage.setItem('na_provider', 'lmstudio');
        renderSettings();
      } else {
        status.textContent = '✓ Connected (no models loaded - load a model in LM Studio first)';
      }
    } catch(e) {
      status.className = 'api-status err';
      let msg = e.message;
      if(msg.includes('Failed to fetch') || msg.includes('NetworkError')){
        msg = 'Could not connect. Is LM Studio running with Server enabled?';
      }
      status.textContent = '✗ ' + msg;
    }
  });

  // Model selection
  p.querySelectorAll('.model-row').forEach(row=>{
    row.addEventListener('click',()=>{
      APP.model=row.dataset.mid;
      localStorage.setItem('na_model',APP.model);
      p.querySelectorAll('.model-row').forEach(r=>r.classList.toggle('msel',r.dataset.mid===APP.model));
    });
  });

  // Model collapse toggle
  const mch = document.getElementById('model_collapse_hd');
  const mg = document.getElementById('model_grid');
  mch.addEventListener('click',()=>{
    mch.classList.toggle('collapsed');
    mg.classList.toggle('collapsed');
  });

  // Max tokens
  p.querySelector('#max_tok').addEventListener('input',e=>{
    APP.maxTokens=parseInt(e.target.value)||4000;
    localStorage.setItem('na_maxtok',APP.maxTokens);
  });

  // Clear data
  p.querySelector('#clear_data_btn').addEventListener('click',()=>{
    if(confirm('Clear all saved project data (Series, Book, Chapter)? This cannot be undone.')){
      localStorage.removeItem('na_state');
      APP.series={name:'',subName:'',bible:mkSec()};
      APP.book={title:'',bookNum:'',totalBooks:'',subNum:'',totalSub:'',bible:mkSec(),outline:mkSec(),chars:[{id:mkId(),...mkSec()}]};
      APP.chapter={mode:'chapter',chapterNum:'',sceneNum:'',useFullChapters:false,sceneLevel:false,fullChapters:[],breakdowns:[],breakdown:mkSec(),settings:[{id:mkId(),...mkSec()}]};
      // Re-render context tabs
      renderSeries(); renderBook(); renderChapter();
    }
  });

  // Theme
  document.getElementById('theme_select').addEventListener('change',(e)=>{
    APP.theme = e.target.value;
    localStorage.setItem('na_theme', APP.theme);
    document.body.className = APP.theme === 'default' ? '' : 'theme-' + APP.theme;
  });

  // UI Scale
  document.getElementById('scale_up').addEventListener('click',()=>{
    APP.uiScale = Math.min(2, APP.uiScale + 0.1);
    document.getElementById('scale_val').textContent = APP.uiScale.toFixed(1) + 'x';
    document.documentElement.style.setProperty('--ui-scale', APP.uiScale);
    localStorage.setItem('na_uiscale', APP.uiScale);
  });
  document.getElementById('scale_down').addEventListener('click',()=>{
    APP.uiScale = Math.max(0.5, APP.uiScale - 0.1);
    document.getElementById('scale_val').textContent = APP.uiScale.toFixed(1) + 'x';
    document.documentElement.style.setProperty('--ui-scale', APP.uiScale);
    localStorage.setItem('na_uiscale', APP.uiScale);
  });
  
  // Header Scale
  document.getElementById('hscale_up').addEventListener('click',()=>{
    APP.headerScale = Math.min(2, (APP.headerScale || 1) + 0.1);
    document.getElementById('hscale_val').textContent = APP.headerScale.toFixed(1) + 'x';
    const h = document.getElementById('app-header');
    h.style.fontSize = (17 * APP.headerScale) + 'px';
    h.style.height = (50 * APP.headerScale) + 'px';
    h.style.padding = '0 ' + (20 * APP.headerScale) + 'px';
    h.style.gap = (10 * APP.headerScale) + 'px';
    localStorage.setItem('na_hscale', APP.headerScale);
  });
  document.getElementById('hscale_down').addEventListener('click',()=>{
    APP.headerScale = Math.max(0.5, (APP.headerScale || 1) - 0.1);
    document.getElementById('hscale_val').textContent = APP.headerScale.toFixed(1) + 'x';
    const h = document.getElementById('app-header');
    h.style.fontSize = (17 * APP.headerScale) + 'px';
    h.style.height = (50 * APP.headerScale) + 'px';
    h.style.padding = '0 ' + (20 * APP.headerScale) + 'px';
    h.style.gap = (10 * APP.headerScale) + 'px';
    localStorage.setItem('na_hscale', APP.headerScale);
  });

  // Writing Preferences
  const wpPrefs = ['inner_monologue','avoid_emdashes','avoid_semicolons','avoid_colons','avoid_triplet','avoid_golden_sunset','avoid_inspirational','avoid_show_summarize','vary_sentence','filter_words','snappy_dialogue','specific_generic'];
  wpPrefs.forEach(id => {
    const el = p.querySelector('#'+id);
    if(el) el.addEventListener('change',e=>{
      const key = id.replace(/_([a-z])/g,(m,c)=>c.toUpperCase());
      APP.writingPrefs[key] = e.target.checked;
      saveWritingPrefs();
    });
  });

  // Punctuation group toggle
  p.querySelector('#punctuation_grp').addEventListener('change',e=>{
    APP.writingPrefs.punctuation = e.target.checked;
    document.getElementById('punctuation_sub').style.display = e.target.checked ? 'block' : 'none';
    saveWritingPrefs();
  });

  // POV
  p.querySelectorAll('input[name="pov"]').forEach(el=>{
    el.addEventListener('change',e=>{
      APP.writingPrefs.pov = e.target.value;
      saveWritingPrefs();
    });
  });

  // Do Not Use Words
  p.querySelector('#do_not_use').addEventListener('input',e=>{
    APP.writingPrefs.doNotUseWords = e.target.value;
    saveWritingPrefs();
  });

  // Genre Compare
  p.querySelector('#genre_preset').addEventListener('change',e=>{
    APP.genreCompare.preset = e.target.value;
    document.getElementById('custom_genre_row').style.display = e.target.value === 'custom' ? 'block' : 'none';
    localStorage.setItem('na_genre', JSON.stringify(APP.genreCompare));
  });

  p.querySelector('#genre_custom').addEventListener('input',e=>{
    APP.genreCompare.customText = e.target.value;
    localStorage.setItem('na_genre', JSON.stringify(APP.genreCompare));
  });

  // Add help icons for Settings
  addHelp(p.querySelector('#provider_select').parentElement, 'Choose which AI service to use. OpenRouter routes to multiple providers.');
  const openrouterCard = p.querySelector('#openrouter_card');
  if(openrouterCard) addHelp(openrouterCard.querySelector('.scard-hd'), 'Get your key at openrouter.ai/keys');
  const anthropicCard = p.querySelector('#anthropic_card');
  if(anthropicCard) addHelp(anthropicCard.querySelector('.scard-hd'), 'Get your key at console.anthropic.com');
  const openaiCard = p.querySelector('#openai_card');
  if(openaiCard) addHelp(openaiCard.querySelector('.scard-hd'), 'Get your key at platform.openai.com');
  const googleCard = p.querySelector('#google_card');
  if(googleCard) addHelp(googleCard.querySelector('.scard-hd'), 'Get your key at aistudio.google.com. Requires billing.');
  const lmstudioCard = p.querySelector('#lmstudio_card');
  if(lmstudioCard){
    addHelp(lmstudioCard.querySelector('#lmstudio_help_hd'), '1. Download LM Studio<br>2. Load a model<br>3. Go to Developer tab, enable "Start Server"<br>4. Go to Settings → App Settings → Enable "Allow CORS"<br>5. Click Test to fetch models');
    addHelp(lmstudioCard.querySelector('#lmstudio_url').parentElement, 'Server address for local models (default: http://localhost:1234)');
    addHelp(lmstudioCard.querySelector('#api_key_lmstudio').parentElement, 'Optional API key for network access to LM Studio');
  }
  addHelp(p.querySelector('#max_tok').parentElement, 'Maximum words in AI response. Higher = longer output.');
  addHelp(p.querySelector('#tok_boost').parentElement, 'Add extra tokens for this single run (doesn\'t change default).');
  addHelp(p.querySelector('#genre_preset').parentElement, 'Choose a genre to optimize prompts for that writing style.');
}

// ═══════════════════════════════════════════════════════════
// TAB NAVIGATION
// ═══════════════════════════════════════════════════════════

const RENDER_FNS={home:renderHome,series:renderSeries,book:renderBook,chapter:renderChapter,prompts:renderPrompts,pipeline:renderPipeline,settings:renderSettings};
const rendered={};

function showTab(id){
  APP.tab=id;
  localStorage.setItem('na_tab', id);
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.toggle('active',b.dataset.tab===id));
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.getElementById(`panel-${id}`)?.classList.add('active');
  if(!rendered[id]){RENDER_FNS[id]?.();rendered[id]=true;}
}

function updateTabDot(){
  const hasCtx=getContextPills().length>0;
  const hasKey=!!APP.apiKey;
  const prBtn=document.querySelector('[data-tab="prompts"]');
  const setBtn=document.querySelector('[data-tab="settings"]');
  if(prBtn){
    const dot=prBtn.querySelector('.tab-dot');
    if(hasCtx&&!dot){
      const d=document.createElement('span'); d.className='tab-dot';
      prBtn.appendChild(d);
    } else if(!hasCtx&&dot) dot.remove();
  }
}

// Extract from Chapters function
function runExtract(type){
  const text = document.getElementById('extract_text').value;
  if(!text.trim()){alert('Please paste chapter text first.');return;}
  
  let prompt = '';
  if(type === 'character'){
    prompt = `Extract all distinct characters from the following text. For each character, provide: Name, Role, Key Traits, Physical Description (if mentioned), Speech Style, and any character development moments.\n\nTEXT:\n${text}`;
  } else if(type === 'world'){
    prompt = `Extract all world-building elements from the following text. Include: Magic/Technology systems, Factions/Groups, Historical events mentioned, Social structures, Geography/Setting details, Rules or laws, and any unique terminology.\n\nTEXT:\n${text}`;
  } else if(type === 'location'){
    prompt = `Extract all locations from the following text. For each location provide: Name, Description, Atmosphere/Mood, Key features, and any significance to the plot.\n\nTEXT:\n${text}`;
  }
  
  const outputEl = document.getElementById('extract_output');
  const resultEl = document.getElementById('extract_result');
  resultEl.style.display = 'block';
  outputEl.value = 'Processing...';
  
  callAPI(prompt,
    chunk => { outputEl.value += chunk; },
    () => { outputEl.value += '\n\n[Done]'; },
    err => { outputEl.value = 'Error: ' + err; },
    null
  );
}

function setupExtractButtons(){
  document.getElementById('extract_chars')?.addEventListener('click',()=>runExtract('character'));
  document.getElementById('extract_world')?.addEventListener('click',()=>runExtract('world'));
  document.getElementById('extract_locs')?.addEventListener('click',()=>runExtract('location'));
}

function generateBookBibleFromChapters(){
  console.log('generateBookBibleFromChapters called');
  const chapters = APP.chapter.fullChapters?.filter(c => c.text?.trim()) || [];
  console.log('Chapters found:', chapters.length);
  if(chapters.length === 0){
    alert('No chapters found. Add chapters in the Chapter tab first.');
    return;
  }

  const allText = chapters.map(c => `### ${c.label || 'Chapter'}\n\n${c.text.trim()}`).join('\n\n---\n\n');

  const promptText = `You are a Senior Continuity Architect and Narrative Analyst. Process the following manuscript chapters and extract information to build a comprehensive Book Bible.

Process sequentially, chapter by chapter. Do NOT summarize—EXTRACT and ENCODE specific data. Generalizations are forbidden.

---

## 1. GENRE & BASIC INFO

* **Genre:** [Extract from text]
* **Tone:** [Extract tone, mood, atmosphere]
* **Point of View:** [Note POV style - first person, third limited, etc.]
* **Current Status:** End of [last chapter name/number]

## 2. NARRATIVE SUMMARY (The "So Far")

* **Logline:** One sentence summary of the core conflict.
* **Main Plot Progression:** Bulleted list of major events across all chapters.
* **Active Subplots:** List of side plots currently in motion.
* **Unresolved Threads:** List of clues, mysteries, or items not yet resolved.

## 3. CHARACTER PROFILES

For each character that appears:

**[Character Name]**
* **Role:** Protagonist/Antagonist/Sidekick/Minor
* **Current Goal:** What do they want right now?
* **Internal Conflict:** What is stopping them?
* **Physical Appearance:** Brief description
* **Speech Style:** Note any speech patterns
* **Character Arc:** How they have changed since Chapter 1

## 4. WORLD-BUILDING & LORE

* **Setting/Location:** Primary locations where story takes place
* **Rules of Magic/Tech:** Hard limits and costs if applicable
* **Factions/Politics:** Current power dynamics
* **Glossary of Terms:** Unique slang, names of cities, made-up currencies

## 5. STYLE GUIDE & EXAMPLES

* **Writing Style Notes:** Show vs tell ratio, sentence variation, key stylistic choices
* **Example Dialogue:** [Extract 1-2 lines of dialogue that exemplify the voice]
* **Example Action:** [Extract a brief action scene passage]
* **Example Description:** [Extract a descriptive passage]

---

MANUSCRIPT:
---
${allText}
---`;

  const output = showProgress('Generating Book Bible...', `Generating Book Bible from ${chapters.length} chapter(s)...`);
  
  let accumulatedText = '';
  
  callAPI(promptText,
    chunk => { if(chunk) { accumulatedText += chunk; output.update(chunk); } },
    () => {
      output.complete('Book Bible generated!');
      if(accumulatedText && accumulatedText.trim()){
        showGeneratedOutput(accumulatedText, 'Book Bible');
      } else {
        alert('Generation completed but result was empty. Check console for details.');
      }
    },
    err => { 
      console.error('API Error:', err);
      output.error(err || 'Unknown error'); 
    }
  );
}

function generateSeriesBibleFromBook(){
  const bookBible = APP.book.bible?.text?.trim();
  const bookTitle = APP.book.title || 'Untitled Book';
  const bookNum = APP.book.bookNum || '?';
  const totalBooks = APP.book.totalBooks || '?';
  const subNum = APP.book.subNum || '?';
  const totalSub = APP.book.totalSub || '?';

  if(!bookBible){
    alert('No Book Bible found. Generate a Book Bible from chapters in the Book tab first.');
    return;
  }

  const promptText = `You are a Senior Continuity Architect. Expand the following Book Bible into a comprehensive Series Bible that could apply to multiple books in a series.

Include:
- How this book fits into the larger series arc
- Series-level world-building that extends beyond this book
- Potential future character development arcs
- Series-wide themes and motifs
- How the setting/rules might evolve across books

BOOK BIBLE (Book ${bookNum} of ${totalBooks}${subNum && totalSub ? `, Subseries ${subNum} of ${totalSub}` : ''}):
---
${bookBible}
---

SERIES BIBLE:
---`;

  const output = showProgress('Generating Series Bible...', `
Generating Series Bible from Book "${bookTitle}"...

This will expand the book-level bible into a series-level reference.`);

  let accumulatedText = '';
  
  callAPI(promptText,
    chunk => { if(chunk) { accumulatedText += chunk; output.update(chunk); } },
    () => {
      output.complete('Series Bible generated!');
      if(accumulatedText && accumulatedText.trim()){
        showGeneratedOutput(accumulatedText, 'Series Bible');
      } else {
        alert('Generation completed but result was empty. Please try again.');
      }
    },
    err => { 
      console.error('API Error:', err);
      output.error(err || 'Unknown error'); 
    }
  );
}

function showProgress(initial, message){
  const div = document.createElement('div');
  div.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#111009;border:1px solid #c8a660;padding:20px 30px;border-radius:4px;z-index:9999;color:#e0d3bc;font-family:Crimson Pro,serif;font-size:14px;box-shadow:0 4px 20px rgba(0,0,0,0.5)';
  div.innerHTML = `<div style="text-align:center"><div style="margin-bottom:10px">⚡</div>${message}</div><pre id="prompt_output" style="margin-top:15px;max-height:200px;overflow:auto;background:#0b0908;padding:10px;border-radius:2px;font-size:11px;color:#a89868;white-space:pre-wrap;text-align:left"></pre>`;
  document.body.appendChild(div);
  let text = '';
  return {
    update: (chunk) => { 
      try {
        if(chunk) { 
          text += chunk; 
          const pre = document.getElementById('prompt_output'); 
          if(pre) pre.textContent = text; 
        }
      } catch(e) { console.error('Update error:', e); }
    },
    complete: (msg) => { 
      try {
        if(div && div.parentNode) {
          div.innerHTML = `<div style="color:#7aac74">✓ ${msg}</div>`; 
          setTimeout(()=>{if(div.parentNode)div.remove();},1500); 
        }
      } catch(e) { console.error('Complete error:', e); }
      return text || '';
    },
    error: (msg) => { 
      try {
        if(div && div.parentNode) {
          div.innerHTML = `<div style="color:#c06050">✗ ${msg}</div>`; 
          setTimeout(()=>{if(div.parentNode)div.remove();},3000); 
        }
      } catch(e) { console.error('Error display error:', e); }
    }
  };
}

function showGeneratedOutput(text, title){
  const div = document.createElement('div');
  div.style.cssText = 'position:fixed;top:5%;left:5%;width:90%;height:90%;background:#111009;border:1px solid #c8a660;padding:20px;border-radius:4px;z-index:9999;color:#e0d3bc;font-family:Crimson Pro,serif;font-size:14px;box-shadow:0 4px 30px rgba(0,0,0,0.7)';
  div.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;border-bottom:1px solid #252015;padding-bottom:10px">
      <h3 style="margin:0;color:#c8a660">${title}</h3>
      <button id="gen_output_close" style="background:transparent;border:none;color:#80786a;font-size:20px;cursor:pointer">✕</button>
    </div>
    <textarea id="gen_output_text" style="width:100%;height:calc(100% - 60px);background:#0b0908;border:1px solid #252015;color:#a89868;font-family:Crimson Pro,serif;font-size:13px;padding:10px;resize:none">${esc(text)}</textarea>
    <div style="margin-top:10px;display:flex;gap:10px;justify-content:flex-end">
      <button id="gen_copy_btn" style="padding:8px 16px;background:#141209;border:1px solid #3a3020;border-radius:2px;color:#c8a660;font-family:'JetBrains Mono',monospace;font-size:11px;cursor:pointer">Copy to Clipboard</button>
      <button id="gen_save_btn" style="padding:8px 16px;background:#0f180d;border:1px solid #263422;border-radius:2px;color:#7aac74;font-family:'JetBrains Mono',monospace;font-size:11px;cursor:pointer">Save as .md</button>
    </div>
  `;
  document.body.appendChild(div);
  
  div.querySelector('#gen_output_close').addEventListener('click', () => div.remove());
  div.querySelector('#gen_copy_btn').addEventListener('click', () => {
    const ta = div.querySelector('#gen_output_text');
    ta.select();
    document.execCommand('copy');
    div.querySelector('#gen_copy_btn').textContent = 'Copied!';
    setTimeout(() => div.querySelector('#gen_copy_btn').textContent = 'Copy to Clipboard', 2000);
  });
  div.querySelector('#gen_save_btn').addEventListener('click', () => {
    const text = div.querySelector('#gen_output_text').value;
    const blob = new Blob([text], {type: 'text/markdown'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = title.toLowerCase().replace(/\s+/g, '-') + '.md';
    a.click();
    URL.revokeObjectURL(a.href);
  });
}

// Build nav
function initNav(){
  const nav=document.getElementById('tab-nav');
  nav.innerHTML=TABS.map(t=>`
    <button class="tab-btn${t.id===APP.tab?' active':''}" data-tab="${t.id}">
      <span class="tab-icon">${t.icon}</span>${t.label}
    </button>`).join('');
  nav.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click',()=>showTab(btn.dataset.tab));
  });
}

// ═══════════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════════

window.onerror = function(msg, url, line, col, error) {
  document.getElementById('app-main').innerHTML = '<div style="padding:20px;color:#c06060;font-size:14px"><b>JavaScript Error:</b><br>'+msg+'<br>Line: '+line+'</div>';
  return true;
};

try {
  console.log('Starting init...');
  initNav();
  console.log('Nav initialized');
  showTab(APP.tab);
  console.log('Tab shown');
  updateTabDot();
  console.log('Init complete');
} catch(e) {
  console.error('Init error:', e);
  document.getElementById('app-main').innerHTML = '<div style="padding:20px;color:#c06060">Error: '+e.message+'<br><pre style="font-size:10px">'+e.stack+'</pre></div>';
}
</script>
</body>
</html>
